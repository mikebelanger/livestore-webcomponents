const m2=e=>typeof e=="function",y=function(e,t){if(typeof e=="function")return function(){return e(arguments)?t.apply(this,arguments):n=>t(n,...arguments)};switch(e){case 0:case 1:throw new RangeError(`Invalid arity ${e}`);case 2:return function(n,r){return arguments.length>=2?t(n,r):function(s){return t(s,n)}};case 3:return function(n,r,s){return arguments.length>=3?t(n,r,s):function(o){return t(o,n,r)}};case 4:return function(n,r,s,o){return arguments.length>=4?t(n,r,s,o):function(a){return t(a,n,r,s)}};case 5:return function(n,r,s,o,a){return arguments.length>=5?t(n,r,s,o,a):function(u){return t(u,n,r,s,o)}};default:return function(){if(arguments.length>=e)return t.apply(this,arguments);const n=arguments;return function(r){return t(r,...n)}}}},oe=e=>e,$p=e=>()=>e,GE=$p(!0),Nn=$p(!1),hT=$p(void 0),sl=hT;function b(e,t,n,r,s,o,a,u,f){switch(arguments.length){case 1:return e;case 2:return t(e);case 3:return n(t(e));case 4:return r(n(t(e)));case 5:return s(r(n(t(e))));case 6:return o(s(r(n(t(e)))));case 7:return a(o(s(r(n(t(e))))));case 8:return u(a(o(s(r(n(t(e)))))));case 9:return f(u(a(o(s(r(n(t(e))))))));default:{let d=arguments[0];for(let p=1;p<arguments.length;p++)d=arguments[p](d);return d}}}const nf=e=>(t,n)=>t===n||e(t,n),g2=(e,t)=>e===t,_2=()=>g2,y2=_2(),pT=y(2,(e,t)=>nf((n,r)=>e(t(n),t(r)))),b2=pT(y2,e=>e.getTime()),S2=e=>nf((t,n)=>{if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(!e(t[r],n[r]))return!1;return!0});let w2="3.15.2";const Tp=()=>w2,QE=`effect/GlobalValue/globalStoreId/${Tp()}`;let vu;const Se=(e,t)=>(vu||(globalThis[QE]??=new Map,vu=globalThis[QE]),vu.has(e)||vu.set(e,t()),vu.get(e)),v2=e=>e instanceof Set,An=e=>typeof e=="string",Ls=e=>typeof e=="number",Ri=e=>typeof e=="boolean",Cp=e=>typeof e=="bigint",ch=e=>typeof e=="symbol",xc=m2,E2=e=>e===void 0,k2=e=>!1,jb=e=>typeof e=="object"&&e!==null,hs=e=>jb(e)||xc(e),X=y(2,(e,t)=>hs(e)&&t in e),Ub=y(2,(e,t)=>X(e,"_tag")&&e._tag===t),va=e=>e==null,$2=e=>e!=null,T2=e=>e instanceof Uint8Array,mT=e=>e instanceof Date,zb=e=>X(e,Symbol.iterator),C2=e=>jb(e)&&!Array.isArray(e),gT=e=>X(e,"then")&&xc(e.then),Ip=e=>`BUG: ${e} - please report an issue at https://github.com/Effect-TS/effect/issues`;let _T=class yT{self;called=!1;constructor(t){this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new yT(this.self)}};const I2=335903614,O2=4150755663,R2=1481765933,q2=1284865837,A2=9007199254740992,F2=134217728;class P2{_state;constructor(t,n,r,s){return va(n)&&va(t)?(n=Math.random()*4294967295>>>0,t=0):va(n)&&(n=t,t=0),va(s)&&va(r)?(s=this._state?this._state[3]:O2,r=this._state?this._state[2]:I2):va(s)&&(s=r,r=0),this._state=new Int32Array([0,0,r>>>0,((s||0)|1)>>>0]),this._next(),YE(this._state,this._state[0],this._state[1],t>>>0,n>>>0),this._next(),this}getState(){return[this._state[0],this._state[1],this._state[2],this._state[3]]}setState(t){this._state[0]=t[0],this._state[1]=t[1],this._state[2]=t[2],this._state[3]=t[3]|1}integer(t){return Math.round(this.number()*Number.MAX_SAFE_INTEGER)%t}number(){const t=(this._next()&67108863)*1,n=(this._next()&134217727)*1;return(t*F2+n)/A2}_next(){const t=this._state[0]>>>0,n=this._state[1]>>>0;x2(this._state,t,n,R2,q2),YE(this._state,this._state[0],this._state[1],this._state[2],this._state[3]);let r=t>>>18,s=(n>>>18|t<<14)>>>0;r=(r^t)>>>0,s=(s^n)>>>0;const o=(s>>>27|r<<5)>>>0,a=t>>>27,u=(-a>>>0&31)>>>0;return(o>>>a|o<<u)>>>0}}function x2(e,t,n,r,s){let o=(n>>>16)*(s&65535)>>>0,a=(n&65535)*(s>>>16)>>>0,u=(n&65535)*(s&65535)>>>0,f=(n>>>16)*(s>>>16)+((a>>>16)+(o>>>16))>>>0;a=a<<16>>>0,u=u+a>>>0,u>>>0<a>>>0&&(f=f+1>>>0),o=o<<16>>>0,u=u+o>>>0,u>>>0<o>>>0&&(f=f+1>>>0),f=f+Math.imul(n,r)>>>0,f=f+Math.imul(t,s)>>>0,e[0]=f,e[1]=u}function YE(e,t,n,r,s){let o=t+r>>>0;const a=n+s>>>0;a>>>0<n>>>0&&(o=o+1|0),e[0]=o,e[1]=a}const j_=Symbol.for("effect/Utils/YieldWrap");class Nc{#e;constructor(t){this.#e=t}[j_](){return this.#e}}function bT(e){if(typeof e=="object"&&e!==null&&j_ in e)return e[j_]();throw new Error(Ip("yieldWrapGet"))}const lr=Se("effect/Utils/isStructuralRegion",()=>({enabled:!1,tester:void 0})),ST={effect_internal_function:e=>e()},N2={effect_internal_function:e=>{try{return e()}finally{}}},D2=ST.effect_internal_function(()=>new Error().stack)?.includes("effect_internal_function")===!0,ct=D2?ST.effect_internal_function:N2.effect_internal_function,M2=function*(){}.constructor,L2=e=>hs(e)&&e.constructor===M2,Gg=Se(Symbol.for("effect/Hash/randomHashCache"),()=>new WeakMap),he=Symbol.for("effect/Hash"),J=e=>{if(lr.enabled===!0)return 0;switch(typeof e){case"number":return Bb(e);case"bigint":return Ot(e.toString(10));case"boolean":return Ot(String(e));case"symbol":return Ot(String(e));case"string":return Ot(e);case"undefined":return Ot("undefined");case"function":case"object":return e===null?Ot("null"):e instanceof Date?J(e.toISOString()):e instanceof URL?J(e.href):j2(e)?e[he]():Op(e);default:throw new Error(`BUG: unhandled typeof ${typeof e} - please report an issue at https://github.com/Effect-TS/effect/issues`)}},Op=e=>(Gg.has(e)||Gg.set(e,Bb(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER))),Gg.get(e)),ue=e=>t=>t*53^e,Rp=e=>e&3221225471|e>>>1&1073741824,j2=e=>X(e,he),Bb=e=>{if(e!==e||e===1/0)return 0;let t=e|0;for(t!==e&&(t^=e*4294967295);e>4294967295;)t^=e/=4294967295;return Rp(t)},Ot=e=>{let t=5381,n=e.length;for(;n;)t=t*33^e.charCodeAt(--n);return Rp(t)},U2=(e,t)=>{let n=12289;for(let r=0;r<t.length;r++)n^=b(Ot(t[r]),ue(J(e[t[r]])));return Rp(n)},wT=e=>U2(e,Object.keys(e)),rf=e=>{let t=6151;for(let n=0;n<e.length;n++)t=b(t,ue(J(e[n])));return Rp(t)},tt=function(){if(arguments.length===1){const n=arguments[0];return function(r){return Object.defineProperty(n,he,{value(){return r},enumerable:!1}),r}}const e=arguments[0],t=arguments[1];return Object.defineProperty(e,he,{value(){return t},enumerable:!1}),t},pe=Symbol.for("effect/Equal");function le(){return arguments.length===1?e=>uh(e,arguments[0]):uh(arguments[0],arguments[1])}function uh(e,t){if(e===t)return!0;const n=typeof e;if(n!==typeof t)return!1;if(n==="object"||n==="function"){if(e!==null&&t!==null){if(ol(e)&&ol(t))return J(e)===J(t)&&e[pe](t)?!0:lr.enabled&&lr.tester?lr.tester(e,t):!1;if(e instanceof Date&&t instanceof Date)return e.toISOString()===t.toISOString();if(e instanceof URL&&t instanceof URL)return e.href===t.href}if(lr.enabled){if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((r,s)=>uh(r,t[s]));if(Object.getPrototypeOf(e)===Object.prototype&&Object.getPrototypeOf(e)===Object.prototype){const r=Object.keys(e),s=Object.keys(t);if(r.length===s.length){for(const o of r)if(!(o in t&&uh(e[o],t[o])))return lr.tester?lr.tester(e,t):!1;return!0}}return lr.tester?lr.tester(e,t):!1}}return lr.enabled&&lr.tester?lr.tester(e,t):!1}const ol=e=>X(e,pe),Hb=()=>le,Le=Symbol.for("nodejs.util.inspect.custom"),yt=e=>{try{if(X(e,"toJSON")&&xc(e.toJSON)&&e.toJSON.length===0)return e.toJSON();if(Array.isArray(e))return e.map(yt)}catch{return{}}return Ai(e)},st=e=>JSON.stringify(e,null,2),qp={toJSON(){return yt(this)},[Le](){return this.toJSON()},toString(){return st(this.toJSON())}};let z2=class{[Le](){return this.toJSON()}toString(){return st(this.toJSON())}};const qi=(e,t=2)=>{if(typeof e=="string")return e;try{return typeof e=="object"?vT(e,t):String(e)}catch{return String(e)}},vT=(e,t)=>{let n=[];const r=JSON.stringify(e,(s,o)=>typeof o=="object"&&o!==null?n.includes(o)?void 0:n.push(o)&&(yi.fiberRefs!==void 0&&ET(o)?o[Ap](yi.fiberRefs):o):o,t);return n=void 0,r},Ap=Symbol.for("effect/Inspectable/Redactable"),ET=e=>typeof e=="object"&&e!==null&&Ap in e,yi=Se("effect/Inspectable/redactableState",()=>({fiberRefs:void 0})),B2=(e,t)=>{const n=yi.fiberRefs;yi.fiberRefs=e;try{return t()}finally{yi.fiberRefs=n}},Ai=e=>ET(e)&&yi.fiberRefs!==void 0?e[Ap](yi.fiberRefs):e,Y=(e,t)=>{switch(t.length){case 0:return e;case 1:return t[0](e);case 2:return t[1](t[0](e));case 3:return t[2](t[1](t[0](e)));case 4:return t[3](t[2](t[1](t[0](e))));case 5:return t[4](t[3](t[2](t[1](t[0](e)))));case 6:return t[5](t[4](t[3](t[2](t[1](t[0](e))))));case 7:return t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))));case 8:return t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e))))))));case 9:return t[8](t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))))));default:{let n=e;for(let r=0,s=t.length;r<s;r++)n=t[r](n);return n}}},Bu="Async",sf="Commit",Zt="Failure",Pd="OnFailure",lh="OnSuccess",fh="OnSuccessAndFailure",en="Success",kT="Sync",H2="Tag",Dc="UpdateRuntimeFlags",dh="While",Hu="Iterator",$T="WithRuntime",xd="Yield",Vb="RevertFlags",V2=Symbol.for("effect/Effect"),U_=Symbol.for("effect/Stream"),W2=Symbol.for("effect/Sink"),K2=Symbol.for("effect/Channel"),Fi={_R:e=>e,_E:e=>e,_A:e=>e,_V:Tp()},J2={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e},G2={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},of={[V2]:Fi,[U_]:Fi,[W2]:J2,[K2]:G2,[pe](e){return this===e},[he](){return tt(this,Op(this))},[Symbol.iterator](){return new _T(new Nc(this))},pipe(){return Y(this,arguments)}},Wb={[he](){return tt(this,wT(this))},[pe](e){const t=Object.keys(this),n=Object.keys(e);if(t.length!==n.length)return!1;for(const r of t)if(!(r in e&&le(this[r],e[r])))return!1;return!0}},af={...of,_op:sf},Q2={...af,...Wb},Y2=function(){function e(){}return e.prototype=af,e}(),TT=Symbol.for("effect/Option"),CT={...of,[TT]:{_A:e=>e},[Le](){return this.toJSON()},toString(){return st(this.toJSON())}},X2=Object.assign(Object.create(CT),{_tag:"Some",_op:"Some",[pe](e){return Kb(e)&&OT(e)&&le(this.value,e.value)},[he](){return tt(this,ue(J(this._tag))(J(this.value)))},toJSON(){return{_id:"Option",_tag:this._tag,value:yt(this.value)}}}),Z2=J("None"),e3=Object.assign(Object.create(CT),{_tag:"None",_op:"None",[pe](e){return Kb(e)&&IT(e)},[he](){return Z2},toJSON(){return{_id:"Option",_tag:this._tag}}}),Kb=e=>X(e,TT),IT=e=>e._tag==="None",OT=e=>e._tag==="Some",RT=Object.create(e3),z_=e=>{const t=Object.create(X2);return t.value=e,t},qT=Symbol.for("effect/Either"),AT={...of,[qT]:{_R:e=>e},[Le](){return this.toJSON()},toString(){return st(this.toJSON())}},t3=Object.assign(Object.create(AT),{_tag:"Right",_op:"Right",[pe](e){return Jb(e)&&PT(e)&&le(this.right,e.right)},[he](){return ue(J(this._tag))(J(this.right))},toJSON(){return{_id:"Either",_tag:this._tag,right:yt(this.right)}}}),n3=Object.assign(Object.create(AT),{_tag:"Left",_op:"Left",[pe](e){return Jb(e)&&FT(e)&&le(this.left,e.left)},[he](){return ue(J(this._tag))(J(this.left))},toJSON(){return{_id:"Either",_tag:this._tag,left:yt(this.left)}}}),Jb=e=>X(e,qT),FT=e=>e._tag==="Left",PT=e=>e._tag==="Right",r3=e=>{const t=Object.create(n3);return t.left=e,t},s3=e=>{const t=Object.create(t3);return t.right=e,t},ie=s3,se=r3,o3=e=>{if(xc(e))try{return ie(e())}catch(t){return se(t)}else try{return ie(e.try())}catch(t){return se(e.catch(t))}},xT=Jb,Kt=FT,Qr=PT,i3=y(2,(e,{onLeft:t,onRight:n})=>Kt(e)?se(t(e.left)):ie(n(e.right))),cf=y(2,(e,t)=>Kt(e)?se(t(e.left)):ie(e.right)),a3=y(2,(e,t)=>Qr(e)?ie(t(e.right)):se(e.left)),Yt=y(2,(e,{onLeft:t,onRight:n})=>Kt(e)?t(e.left):n(e.right)),c3=Yt({onLeft:oe,onRight:oe}),NT=y(2,(e,t)=>{if(Qr(e))return e.right;throw t(e.left)}),u3=NT(()=>new Error("getOrThrow called on a Left")),Gb=e=>e.length>0,DT=e=>(t,n)=>t===n?0:e(t,n),l3=DT((e,t)=>e<t?-1:1),MT=y(2,(e,t)=>DT((n,r)=>e(t(n),t(r)))),f3=e=>y(2,(t,n)=>e(t,n)===1),H=()=>RT,V=z_,d3=Kb,kt=IT,nt=OT,Xe=y(2,(e,{onNone:t,onSome:n})=>kt(e)?t():n(e.value)),pt=y(2,(e,t)=>kt(e)?t():e.value),Rs=y(2,(e,t)=>kt(e)?t():e),h3=y(2,(e,t)=>kt(e)?V(t()):e),na=e=>e==null?H():V(e),hr=pt(hT),p3=e=>(...t)=>{try{return V(e(...t))}catch{return H()}},yo=y(2,(e,t)=>kt(e)?H():V(t(e.value))),Mc=y(2,(e,t)=>kt(e)?H():t(e.value)),m3=y(2,(e,t)=>kt(e)?H():na(t(e.value))),g3=Mc(oe),_3=e=>nf((t,n)=>kt(t)?kt(n):kt(n)?!1:e(t.value,n.value)),y3=e=>y(2,(t,n)=>kt(t)?!1:e(t.value,n)),b3=Hb(),S3=y3(b3),w3=y(2,(e,t)=>kt(e)?!1:t(e.value)),XE=e=>(t,n)=>kt(t)?n:kt(n)?t:V(e(t.value,n.value)),v3=(...e)=>e,E3=e=>{const n=e[Symbol.iterator]().next();if(n.done)throw new Error("unsafeHead: empty iterable");return n.value},k3=y(2,(e,t)=>{let n=0;for(const r of e){const s=t(r,n);if(Ri(s)){if(s)return V(r)}else if(nt(s))return s;n++}return H()}),$3={[Symbol.iterator](){return T3}},T3={next(){return{done:!0,value:void 0}}},LT=()=>$3,C3=y(2,(e,t)=>({[Symbol.iterator](){const n=e[Symbol.iterator]();let r=0;return{next(){const s=n.next();return s.done?{done:!0,value:void 0}:{done:!1,value:t(s.value,r++)}}}}})),I3=y(2,(e,t)=>{const n={...e};for(const r of O3(e))n[r]=t(e[r],r);return n}),O3=e=>Object.keys(e),Fp=e=>new Array(e),R3=y(2,(e,t)=>{const n=Math.max(1,Math.floor(e)),r=new Array(n);for(let s=0;s<n;s++)r[s]=t(s);return r}),Me=e=>Array.isArray(e)?e:Array.from(e),Qb=e=>Array.isArray(e)?e:[e],q3=y(2,(e,{onEmpty:t,onNonEmpty:n})=>ft(e)?n(e):t()),A3=y(2,(e,{onEmpty:t,onNonEmpty:n})=>ft(e)?n(In(e),Pi(e)):t()),hh=y(2,(e,t)=>[t,...e]),F3=y(2,(e,t)=>[...e,t]),Pp=y(2,(e,t)=>Me(e).concat(Me(t))),P3=Array.isArray,x3=e=>e.length===0,N3=x3,Nd=Gb,ft=Gb,jT=(e,t)=>e<0||e>=t.length,D3=(e,t)=>Math.floor(Math.min(Math.max(0,e),t.length)),M3=y(2,(e,t)=>{const n=Math.floor(t);return jT(n,e)?H():V(e[n])}),UT=y(2,(e,t)=>{const n=Math.floor(t);if(jT(n,e))throw new Error(`Index ${n} out of bounds`);return e[n]}),Ba=M3(0),In=UT(0),L3=e=>ft(e)?V(zT(e)):H(),zT=e=>e[e.length-1],Pi=e=>e.slice(1),BT=(e,t)=>{let n=0;for(const r of e){if(!t(r,n))break;n++}return n},HT=y(2,(e,t)=>WT(e,BT(e,t))),j3=y(2,(e,t)=>{const n=Me(e);return n.slice(D3(t,n),n.length)}),U3=y(2,(e,t)=>Me(e).slice(BT(e,t))),z3=k3,ZE=e=>Array.from(e).reverse(),il=y(2,(e,t)=>{const n=Array.from(e);return n.sort(t),n}),e0=y(2,(e,t)=>B3(e,t,v3)),B3=y(3,(e,t,n)=>{const r=Me(e),s=Me(t);if(ft(r)&&ft(s)){const o=[n(In(r),In(s))],a=Math.min(r.length,s.length);for(let u=1;u<a;u++)o[u]=n(r[u],s[u]);return o}return[]}),H3=e=>{const t=Me(e);if(ft(t)){const n=[t[0][0]],r=[t[0][1]];for(let s=1;s<t.length;s++)n[s]=t[s][0],r[s]=t[s][1];return[n,r]}return[[],[]]},V3=e=>y(2,(t,n)=>{for(const r of t)if(e(n,r))return!0;return!1}),VT=Hb(),W3=y(2,(e,t)=>{const n=Me(e);if(ft(n)){const[r,s]=t(n),o=[r];let a=s;for(;Gb(a);){const[u,f]=t(a);o.push(u),a=f}return o}return[]}),WT=y(2,(e,t)=>{const n=Array.from(e),r=Math.floor(t);return ft(n)?r>=1?KT(n,r):[[],n]:[n,[]]}),KT=y(2,(e,t)=>{const n=Math.max(1,Math.floor(t));return n>=e.length?[Fu(e),[]]:[hh(e.slice(1,n),In(e)),e.slice(n)]}),JT=y(2,(e,t)=>HT(e,(n,r)=>!t(n,r))),Fu=e=>e.slice(),K3=y(2,(e,t)=>{const n=Me(e);return ft(n)?W3(n,KT(t)):[]}),J3=y(3,(e,t,n)=>{const r=Me(e),s=Me(t);return ft(r)?ft(s)?YT(n)(Pp(r,s)):r:s}),Dd=y(2,(e,t)=>J3(e,t,VT)),G3=e=>{const t=V3(e);return y(2,(n,r)=>Me(n).filter(s=>t(r,s)))},Q3=G3(VT),ko=()=>[],Qn=e=>[e],qs=y(2,(e,t)=>e.map(t)),ph=y(2,(e,t)=>{if(N3(e))return[];const n=[];for(let r=0;r<e.length;r++){const s=t(e[r],r);for(let o=0;o<s.length;o++)n.push(s[o])}return n}),Y3=ph(oe),GT=y(2,(e,t)=>{const n=Me(e),r=[];for(let s=0;s<n.length;s++){const o=t(n[s],s);nt(o)&&r.push(o.value)}return r}),QT=y(2,(e,t)=>{const n=Me(e),r=[];for(let s=0;s<n.length;s++)t(n[s],s)&&r.push(n[s]);return r}),Yb=y(3,(e,t,n)=>Me(e).reduce((r,s,o)=>n(r,s,o),t)),t0=(e,t)=>{const n=[];let r=e,s;for(;nt(s=t(r));){const[o,a]=s.value;n.push(o),r=a}return n},uf=S2,YT=y(2,(e,t)=>{const n=Me(e);if(ft(n)){const r=[In(n)],s=Pi(n);for(const o of s)r.every(a=>!t(o,a))&&r.push(o);return r}return[]}),X3=e=>YT(e,Hb()),ra=y(2,(e,t)=>Me(e).join(t)),XT=(e,t)=>{switch(t._tag){case"StringKeyword":case"TemplateLiteral":return Object.keys(e);case"SymbolKeyword":return Object.getOwnPropertySymbols(e);case"Refinement":return XT(e,t.from)}},es=e=>Object.keys(e).concat(Object.getOwnPropertySymbols(e)),ZT=e=>{let t=!1,n;return()=>(t||(n=e(),t=!0),n)},eC=e=>{try{return e.toISOString()}catch{return String(e)}},yr=(e,t=!0)=>{if(Array.isArray(e))return`[${e.map(n=>yr(n,t)).join(",")}]`;if(mT(e))return eC(e);if(X(e,"toString")&&xc(e.toString)&&e.toString!==Object.prototype.toString)return e.toString();if(An(e))return JSON.stringify(e);if(Ls(e)||e==null||Ri(e)||ch(e))return String(e);if(Cp(e))return String(e)+"n";if(zb(e))return`${e.constructor.name}(${yr(Array.from(e),t)})`;try{t&&JSON.stringify(e);const n=`{${es(e).map(s=>`${An(s)?JSON.stringify(s):String(s)}:${yr(e[s],!1)}`).join(",")}}`,r=e.constructor.name;return e.constructor!==Object.prototype.constructor?`${r}(${n})`:n}catch{return"<circular structure>"}},Xb=e=>typeof e=="string"?JSON.stringify(e):String(e),tC=e=>Array.isArray(e),Z3=e=>!Array.isArray(e),n0=e=>`[${Xb(e)}]`,nC=e=>tC(e)?e.map(n0).join(""):n0(e),Zs=(e,t,n,r)=>{let s=e;return n&&ft(n)&&(s+=`
at path: ${nC(n)}`),t!==void 0&&(s+=`
details: ${t}`),r&&(s+=`
schema (${r._tag}): ${r}`),s},eD=(e,t,n)=>Zs("Unsupported schema",e,t,n),rC=(e,t,n)=>Zs("Unsupported schema or overlapping types",`cannot extend ${e} with ${t}`,n),al=e=>eD(void 0,void 0,e),tD=e=>Zs("Unsupported key schema",void 0,void 0,e),nD=e=>Zs("Unsupported literal",`literal value: ${yr(e)}`),r0=e=>Zs("Duplicate index signature",`${e} index signature`),rD=Zs("Unsupported index signature parameter","An index signature parameter type must be `string`, `symbol`, a template literal type or a refinement of the previous types"),sD=Zs("Invalid element","A required element cannot follow an optional element. ts(1257)"),s0=e=>Zs("Duplicate property signature transformation",`Duplicate key ${yr(e)}`),sC=e=>Zs("Duplicate property signature",`Duplicate key ${yr(e)}`),oD=Symbol.for("effect/SchemaId/DateFromSelf"),iD=Symbol.for("effect/SchemaId/GreaterThanOrEqualTo"),aD=Symbol.for("effect/SchemaId/Int"),cD=Symbol.for("effect/SchemaId/Between"),oc=l3,mh=e=>e.replace(/[/\\^$*+?.()|[\]{}]/g,"\\$&"),oC=Symbol.for("effect/annotation/Brand"),uD=Symbol.for("effect/annotation/SchemaId"),iC=Symbol.for("effect/annotation/Message"),Zb=Symbol.for("effect/annotation/MissingMessage"),eS=Symbol.for("effect/annotation/Identifier"),ps=Symbol.for("effect/annotation/Title"),Ha=Symbol.for("effect/annotation/AutoTitle"),lf=Symbol.for("effect/annotation/Description"),aC=Symbol.for("effect/annotation/Examples"),cC=Symbol.for("effect/annotation/Default"),uC=Symbol.for("effect/annotation/JSONSchema"),lC=Symbol.for("effect/annotation/Arbitrary"),fC=Symbol.for("effect/annotation/Pretty"),dC=Symbol.for("effect/annotation/Equivalence"),lD=Symbol.for("effect/annotation/Documentation"),hC=Symbol.for("effect/annotation/Concurrency"),pC=Symbol.for("effect/annotation/Batching"),mC=Symbol.for("effect/annotation/ParseIssueTitle"),gC=Symbol.for("effect/annotation/ParseOptions"),_C=Symbol.for("effect/annotation/DecodingFallback"),gh=Symbol.for("effect/annotation/Surrogate"),fD=Symbol.for("effect/annotation/StableFilter"),Fn=y(2,(e,t)=>Object.prototype.hasOwnProperty.call(e.annotations,t)?V(e.annotations[t]):H()),yC=Fn(oC),dD=Fn(iC),hD=Fn(Zb),bC=Fn(ps),SC=Fn(Ha),xp=Fn(eS),wC=Fn(lf),pD=Fn(hC),mD=Fn(pC),gD=Fn(mC),_D=Fn(gC),yD=Fn(_C),Lc=Fn(gh),bD=Fn(fD),SD=e=>w3(bD(e),t=>t===!0),Np=Symbol.for("effect/annotation/JSONIdentifier"),wD=Fn(Np),vD=e=>Rs(wD(e),()=>xp(e)),ED=Symbol.for("effect/schema/ParseJson");class Dp{typeParameters;decodeUnknown;encodeUnknown;annotations;_tag="Declaration";constructor(t,n,r,s={}){this.typeParameters=t,this.decodeUnknown=n,this.encodeUnknown=r,this.annotations=s}toString(){return pt(os(this),()=>"<declaration schema>")}toJSON(){return{_tag:this._tag,typeParameters:this.typeParameters.map(t=>t.toJSON()),annotations:Vt(this.annotations)}}}const ms=e=>t=>t._tag===e;let _h=class{literal;annotations;_tag="Literal";constructor(t,n={}){this.literal=t,this.annotations=n}toString(){return pt(os(this),()=>yr(this.literal))}toJSON(){return{_tag:this._tag,literal:Cp(this.literal)?String(this.literal):this.literal,annotations:Vt(this.annotations)}}};const Vu=ms("Literal"),kD=new _h(null);class vC{symbol;annotations;_tag="UniqueSymbol";constructor(t,n={}){this.symbol=t,this.annotations=n}toString(){return pt(os(this),()=>yr(this.symbol))}toJSON(){return{_tag:this._tag,symbol:String(this.symbol),annotations:Vt(this.annotations)}}}class $D{annotations;_tag="UndefinedKeyword";constructor(t={}){this.annotations=t}toString(){return Do(this)}toJSON(){return{_tag:this._tag,annotations:Vt(this.annotations)}}}const ic=new $D({[ps]:"undefined"});class TD{annotations;_tag="VoidKeyword";constructor(t={}){this.annotations=t}toString(){return Do(this)}toJSON(){return{_tag:this._tag,annotations:Vt(this.annotations)}}}const CD=new TD({[ps]:"void"});class ID{annotations;_tag="NeverKeyword";constructor(t={}){this.annotations=t}toString(){return Do(this)}toJSON(){return{_tag:this._tag,annotations:Vt(this.annotations)}}}const Mp=new ID({[ps]:"never"}),OD=ms("NeverKeyword");class RD{annotations;_tag="UnknownKeyword";constructor(t={}){this.annotations=t}toString(){return Do(this)}toJSON(){return{_tag:this._tag,annotations:Vt(this.annotations)}}}const EC=new RD({[ps]:"unknown"});class qD{annotations;_tag="AnyKeyword";constructor(t={}){this.annotations=t}toString(){return Do(this)}toJSON(){return{_tag:this._tag,annotations:Vt(this.annotations)}}}const kC=new qD({[ps]:"any"});class AD{annotations;_tag="StringKeyword";constructor(t={}){this.annotations=t}toString(){return Do(this)}toJSON(){return{_tag:this._tag,annotations:Vt(this.annotations)}}}const B_=new AD({[ps]:"string",[lf]:"a string"}),H_=ms("StringKeyword");class FD{annotations;_tag="NumberKeyword";constructor(t={}){this.annotations=t}toString(){return Do(this)}toJSON(){return{_tag:this._tag,annotations:Vt(this.annotations)}}}const V_=new FD({[ps]:"number",[lf]:"a number"}),o0=ms("NumberKeyword");class PD{annotations;_tag="BooleanKeyword";constructor(t={}){this.annotations=t}toString(){return Do(this)}toJSON(){return{_tag:this._tag,annotations:Vt(this.annotations)}}}const W_=new PD({[ps]:"boolean",[lf]:"a boolean"}),i0=ms("BooleanKeyword"),$C=ms("SymbolKeyword");let ff=class{type;annotations;constructor(t,n={}){this.type=t,this.annotations=n}toJSON(){return{type:this.type.toJSON(),annotations:Vt(this.annotations)}}toString(){return String(this.type)}};class No extends ff{isOptional;constructor(t,n,r={}){super(t,r),this.isOptional=n}toJSON(){return{type:this.type.toJSON(),isOptional:this.isOptional,annotations:Vt(this.annotations)}}toString(){return String(this.type)+(this.isOptional?"?":"")}}const Lp=e=>e.map(t=>t.type);class df{elements;rest;isReadonly;annotations;_tag="TupleType";constructor(t,n,r,s={}){this.elements=t,this.rest=n,this.isReadonly=r,this.annotations=s;let o=!1,a=!1;for(const u of t)if(u.isOptional)o=!0;else if(o){a=!0;break}if(a||o&&n.length>1)throw new Error(sD)}toString(){return pt(os(this),()=>xD(this))}toJSON(){return{_tag:this._tag,elements:this.elements.map(t=>t.toJSON()),rest:this.rest.map(t=>t.toJSON()),isReadonly:this.isReadonly,annotations:Vt(this.annotations)}}}const xD=e=>{const t=e.elements.map(String).join(", ");return A3(e.rest,{onEmpty:()=>`readonly [${t}]`,onNonEmpty:(n,r)=>{const s=String(n),o=s.includes(" | ")?`(${s})`:s;if(r.length>0){const a=r.map(String).join(", ");return e.elements.length>0?`readonly [${t}, ...${o}[], ${a}]`:`readonly [...${o}[], ${a}]`}else return e.elements.length>0?`readonly [${t}, ...${o}[]]`:`ReadonlyArray<${s}>`}})};class Ct extends No{name;isReadonly;constructor(t,n,r,s,o){super(n,r,o),this.name=t,this.isReadonly=s}toString(){return(this.isReadonly?"readonly ":"")+String(this.name)+(this.isOptional?"?":"")+": "+this.type}toJSON(){return{name:String(this.name),type:this.type.toJSON(),isOptional:this.isOptional,isReadonly:this.isReadonly,annotations:Vt(this.annotations)}}}const TC=e=>{switch(e._tag){case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":return!0;case"Refinement":return TC(e.from)}return!1};class jc{type;isReadonly;parameter;constructor(t,n,r){if(this.type=n,this.isReadonly=r,TC(t))this.parameter=t;else throw new Error(rD)}toString(){return(this.isReadonly?"readonly ":"")+`[x: ${this.parameter}]: ${this.type}`}toJSON(){return{parameter:this.parameter.toJSON(),type:this.type.toJSON(),isReadonly:this.isReadonly}}}class br{annotations;_tag="TypeLiteral";propertySignatures;indexSignatures;constructor(t,n,r={}){this.annotations=r;const s={};for(let a=0;a<t.length;a++){const u=t[a].name;if(Object.prototype.hasOwnProperty.call(s,u))throw new Error(sC(u));s[u]=null}const o={string:!1,symbol:!1};for(let a=0;a<n.length;a++){const u=bh(n[a].parameter);if(H_(u)){if(o.string)throw new Error(r0("string"));o.string=!0}else if($C(u)){if(o.symbol)throw new Error(r0("symbol"));o.symbol=!0}}this.propertySignatures=t,this.indexSignatures=n}toString(){return pt(os(this),()=>ND(this))}toJSON(){return{_tag:this._tag,propertySignatures:this.propertySignatures.map(t=>t.toJSON()),indexSignatures:this.indexSignatures.map(t=>t.toJSON()),annotations:Vt(this.annotations)}}}const a0=e=>e.map(String).join("; "),ND=e=>{if(e.propertySignatures.length>0){const t=e.propertySignatures.map(String).join("; ");return e.indexSignatures.length>0?`{ ${t}; ${a0(e.indexSignatures)} }`:`{ ${t} }`}else return e.indexSignatures.length>0?`{ ${a0(e.indexSignatures)} }`:"{}"},c0=ms("TypeLiteral"),DD=il(MT(oc,e=>{switch(e._tag){case"AnyKeyword":return 0;case"UnknownKeyword":return 1;case"ObjectKeyword":return 2;case"StringKeyword":case"NumberKeyword":case"BooleanKeyword":case"BigIntKeyword":case"SymbolKeyword":return 3}return 4})),MD={string:"StringKeyword",number:"NumberKeyword",boolean:"BooleanKeyword",bigint:"BigIntKeyword"},CC=e=>ph(e,t=>nS(t)?CC(t.types):[t]),LD=e=>{const t=DD(e),n=[],r={},s=[];for(const o of t)switch(o._tag){case"NeverKeyword":break;case"AnyKeyword":return[kC];case"UnknownKeyword":return[EC];case"ObjectKeyword":case"UndefinedKeyword":case"VoidKeyword":case"StringKeyword":case"NumberKeyword":case"BooleanKeyword":case"BigIntKeyword":case"SymbolKeyword":{r[o._tag]||(r[o._tag]=o,n.push(o));break}case"Literal":{const a=typeof o.literal;switch(a){case"string":case"number":case"bigint":case"boolean":{const u=MD[a];!r[u]&&!s.includes(o.literal)&&(s.push(o.literal),n.push(o));break}case"object":{s.includes(o.literal)||(s.push(o.literal),n.push(o));break}}break}case"UniqueSymbol":{!r.SymbolKeyword&&!s.includes(o.symbol)&&(s.push(o.symbol),n.push(o));break}case"TupleType":{r.ObjectKeyword||n.push(o);break}case"TypeLiteral":{o.propertySignatures.length===0&&o.indexSignatures.length===0?r["{}"]||(r["{}"]=o,n.push(o)):r.ObjectKeyword||n.push(o);break}default:n.push(o)}return n};let Jt=class K_{types;annotations;static make=(t,n)=>tS(t)?new K_(t,n):t.length===1?t[0]:Mp;static unify=(t,n)=>K_.make(LD(CC(t)),n);_tag="Union";constructor(t,n={}){this.types=t,this.annotations=n}toString(){return pt(os(this),()=>this.types.map(String).join(" | "))}toJSON(){return{_tag:this._tag,types:this.types.map(t=>t.toJSON()),annotations:Vt(this.annotations)}}};const jD=(e,t)=>e.map(t),tS=e=>e.length>1,nS=ms("Union"),Qg=Se(Symbol.for("effect/Schema/AST/toJSONMemoMap"),()=>new WeakMap);class xi{f;annotations;_tag="Suspend";constructor(t,n={}){this.f=t,this.annotations=n,this.f=ZT(t)}toString(){return os(this).pipe(Rs(()=>Mc(p3(this.f)(),t=>os(t))),pt(()=>"<suspended schema>"))}toJSON(){const t=this.f();let n=Qg.get(t);return n||(Qg.set(t,{_tag:this._tag}),n={_tag:this._tag,ast:t.toJSON(),annotations:Vt(this.annotations)},Qg.set(t,n),n)}}let hf=class{from;filter;annotations;_tag="Refinement";constructor(t,n,r={}){this.from=t,this.filter=n,this.annotations=r}toString(){return xp(this).pipe(pt(()=>Xe(PC(this),{onNone:()=>`{ ${this.from} | filter }`,onSome:t=>Va(this.from)?String(this.from)+" & "+t:t})))}toJSON(){return{_tag:this._tag,from:this.from.toJSON(),annotations:Vt(this.annotations)}}};const Va=ms("Refinement"),Yg={};let _r=class{from;to;transformation;annotations;_tag="Transformation";constructor(t,n,r,s={}){this.from=t,this.to=n,this.transformation=r,this.annotations=s}toString(){return pt(os(this),()=>`(${String(this.from)} <-> ${String(this.to)})`)}toJSON(){return{_tag:this._tag,from:this.from.toJSON(),to:this.to.toJSON(),annotations:Vt(this.annotations)}}};const UD=ms("Transformation");class IC{decode;encode;_tag="FinalTransformation";constructor(t,n){this.decode=t,this.encode=n}}const zD=e=>t=>t._tag===e;class BD{_tag="ComposeTransformation"}const rS=new BD;let HD=class{from;to;decode;encode;constructor(t,n,r,s){this.from=t,this.to=n,this.decode=r,this.encode=s}};const VD=e=>e.decode===oe&&e.encode===oe;class yh{propertySignatureTransformations;_tag="TypeLiteralTransformation";constructor(t){this.propertySignatureTransformations=t;const n={},r={};for(const s of t){const o=s.from;if(n[o])throw new Error(s0(o));n[o]=!0;const a=s.to;if(r[a])throw new Error(s0(a));r[a]=!0}}}const J_=zD("TypeLiteralTransformation"),Ni=(e,t)=>{const n=Object.getOwnPropertyDescriptors(e),r={...e.annotations,...t},s=Lc(e);return nt(s)&&(r[gh]=Ni(s.value,t)),n.annotations.value=r,Object.create(Object.getPrototypeOf(e),n)},WD="[\\s\\S]*",KD="[+-]?\\d*\\.?\\d+(?:[Ee][+-]?\\d+)?",OC=(e,t)=>{switch(e._tag){case"Literal":return mh(String(e.literal));case"StringKeyword":return WD;case"NumberKeyword":return KD;case"TemplateLiteral":return RC(e);case"Union":return e.types.map(n=>OC(n)).join("|")}},JD=(e,t,n,r)=>nS(e)?`(${t})`:t,RC=(e,t,n)=>{let r="";if(e.head!==""){const s=mh(e.head);r+=s}for(const s of e.spans){const o=OC(s.type);if(r+=JD(s.type,o),s.literal!==""){const a=mh(s.literal);r+=a}}return r},qC=e=>new RegExp(`^${RC(e)}$`),Md=e=>{const t=Lc(e);if(nt(t))return Md(t.value);switch(e._tag){case"TypeLiteral":return e.propertySignatures.slice();case"Suspend":return Md(e.f());case"Refinement":return Md(e.from)}return ti(e).map(n=>ui(e,n))},Ld=e=>{switch(e._tag){case"TupleType":{let t=!1,n=[];for(const r of e.elements)r.isOptional&&(t=!0),n.push(r.type);return t&&n.push(ic),n=n.concat(Lp(e.rest)),Jt.make(n)}case"Refinement":return Ld(e.from);case"Union":return Jt.make(e.types.map(Ld));case"Suspend":return Ld(e.f())}throw new Error(al(e))},AC=(e,t)=>{const n=z3(e.propertySignatures,r=>r.name===t);if(nt(n))return n.value;if(An(t)){let r;for(const s of e.indexSignatures){const o=bh(s.parameter);switch(o._tag){case"TemplateLiteral":{if(qC(o).test(t))return new Ct(t,s.type,!1,!0);break}case"StringKeyword":r===void 0&&(r=new Ct(t,s.type,!1,!0))}}if(r)return r}else if(ch(t))for(const r of e.indexSignatures){const s=bh(r.parameter);if($C(s))return new Ct(t,r.type,!1,!0)}},ui=(e,t)=>{const n=Lc(e);if(nt(n))return ui(n.value,t);switch(e._tag){case"TypeLiteral":{const r=AC(e,t);if(r)return r;break}case"Union":return new Ct(t,Jt.make(e.types.map(r=>ui(r,t).type)),!1,!0);case"Suspend":return ui(e.f(),t);case"Refinement":return ui(e.from,t)}throw new Error(al(e))},ti=e=>{const t=Lc(e);if(nt(t))return ti(t.value);switch(e._tag){case"TypeLiteral":return e.propertySignatures.map(n=>n.name);case"Union":return e.types.slice(1).reduce((n,r)=>Q3(n,ti(r)),ti(e.types[0]));case"Suspend":return ti(e.f());case"Refinement":return ti(e.from);case"Transformation":return ti(e.to)}return[]},u0=(e,t)=>{const n=[],r=[],s=o=>{switch(o._tag){case"NeverKeyword":break;case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":case"Refinement":r.push(new jc(o,t,!0));break;case"Literal":if(An(o.literal)||Ls(o.literal))n.push(new Ct(o.literal,t,!1,!0));else throw new Error(nD(o.literal));break;case"Enums":{for(const[a,u]of o.enums)n.push(new Ct(u,t,!1,!0));break}case"UniqueSymbol":n.push(new Ct(o.symbol,t,!1,!0));break;case"Union":o.types.forEach(s);break;default:throw new Error(tD(o))}};return s(e),{propertySignatures:n,indexSignatures:r}},ws=(e,t)=>{const n=Lc(e);if(nt(n))return ws(n.value,t);switch(e._tag){case"TypeLiteral":{const r=[],s={};for(const o of e.propertySignatures)s[o.name]=null,t.includes(o.name)&&r.push(o);for(const o of t)if(!(o in s)){const a=AC(e,o);a&&r.push(a)}return new br(r,[])}case"Union":return new br(t.map(r=>ui(e,r)),[]);case"Suspend":return ws(e.f(),t);case"Refinement":return ws(e.from,t);case"Transformation":switch(e.transformation._tag){case"ComposeTransformation":return new _r(ws(e.from,t),ws(e.to,t),rS);case"TypeLiteralTransformation":{const r=[],s=[];for(const o of t){const a=e.transformation.propertySignatureTransformations.find(u=>u.to===o);a?(r.push(a),s.push(a.from)):s.push(o)}return ft(r)?new _r(ws(e.from,s),ws(e.to,t),new yh(r)):ws(e.from,s)}}}throw new Error(al(e))},jd=e=>Jt.make([e,ic]),Pu=(e,t)=>{switch(e._tag){case"TupleType":return new df(e.elements.map(n=>new No(jd(n.type),!0)),q3(e.rest,{onEmpty:()=>e.rest,onNonEmpty:n=>[new ff(Jt.make([...Lp(n),ic]))]}),e.isReadonly);case"TypeLiteral":return new br(e.propertySignatures.map(n=>new Ct(n.name,jd(n.type),!0,n.isReadonly,n.annotations)),e.indexSignatures.map(n=>new jc(n.parameter,jd(n.type),n.isReadonly)));case"Union":return Jt.make(e.types.map(n=>Pu(n)));case"Suspend":return new xi(()=>Pu(e.f()));case"Declaration":case"Refinement":throw new Error(al(e));case"Transformation":{if(J_(e.transformation)&&e.transformation.propertySignatureTransformations.every(VD))return new _r(Pu(e.from),Pu(e.to),e.transformation);throw new Error(al(e))}}return e},Oa=e=>{switch(e._tag){case"TupleType":return e.isReadonly===!1?e:new df(e.elements,e.rest,!1,e.annotations);case"TypeLiteral":{const t=Cn(e.propertySignatures,r=>r.isReadonly===!1?r:new Ct(r.name,r.type,r.isOptional,!1,r.annotations)),n=Cn(e.indexSignatures,r=>r.isReadonly===!1?r:new jc(r.parameter,r.type,!1));return t===e.propertySignatures&&n===e.indexSignatures?e:new br(t,n,e.annotations)}case"Union":{const t=Cn(e.types,Oa);return t===e.types?e:Jt.make(t,e.annotations)}case"Suspend":return new xi(()=>Oa(e.f()),e.annotations);case"Refinement":{const t=Oa(e.from);return t===e.from?e:new hf(t,e.filter,e.annotations)}case"Transformation":{const t=Oa(e.from),n=Oa(e.to);return t===e.from&&n===e.to?e:new _r(t,n,e.transformation,e.annotations)}}return e},FC=e=>t=>{let n;for(const r of e)Object.prototype.hasOwnProperty.call(t.annotations,r)&&(n===void 0&&(n={}),n[r]=t.annotations[r]);return n},GD=e=>t=>{const n={...t.annotations};for(const r of e)delete n[r];return n},QD=FC([aC,cC,uC,lC,fC,dC]),It=e=>{switch(e._tag){case"Declaration":{const t=Cn(e.typeParameters,It);return t===e.typeParameters?e:new Dp(t,e.decodeUnknown,e.encodeUnknown,e.annotations)}case"TupleType":{const t=Cn(e.elements,s=>{const o=It(s.type);return o===s.type?s:new No(o,s.isOptional)}),n=Lp(e.rest),r=Cn(n,It);return t===e.elements&&r===n?e:new df(t,r.map(s=>new ff(s)),e.isReadonly,e.annotations)}case"TypeLiteral":{const t=Cn(e.propertySignatures,r=>{const s=It(r.type);return s===r.type?r:new Ct(r.name,s,r.isOptional,r.isReadonly)}),n=Cn(e.indexSignatures,r=>{const s=It(r.type);return s===r.type?r:new jc(r.parameter,s,r.isReadonly)});return t===e.propertySignatures&&n===e.indexSignatures?e:new br(t,n,e.annotations)}case"Union":{const t=Cn(e.types,It);return t===e.types?e:Jt.make(t,e.annotations)}case"Suspend":return new xi(()=>It(e.f()),e.annotations);case"Refinement":{const t=It(e.from);return t===e.from?e:new hf(t,e.filter,e.annotations)}case"Transformation":{const t=QD(e);return It(t!==void 0?Ni(e.to,t):e.to)}}return e},Ea=e=>Xe(vD(e),{onNone:()=>{},onSome:t=>({[Np]:t})});function Cn(e,t){let n=!1;const r=Fp(e.length);for(let s=0;s<e.length;s++){const o=e[s],a=t(o);a!==o&&(n=!0),r[s]=a}return n?r:e}const Ur=(e,t)=>{switch(e._tag){case"Declaration":{const n=Cn(e.typeParameters,r=>Ur(r));return n===e.typeParameters?e:new Dp(n,e.decodeUnknown,e.encodeUnknown,e.annotations)}case"TupleType":{const n=Cn(e.elements,o=>{const a=Ur(o.type);return a===o.type?o:new No(a,o.isOptional)}),r=Lp(e.rest),s=Cn(r,o=>Ur(o));return n===e.elements&&s===r?e:new df(n,s.map(o=>new ff(o)),e.isReadonly,Ea(e))}case"TypeLiteral":{const n=Cn(e.propertySignatures,s=>{const o=Ur(s.type);return o===s.type?s:new Ct(s.name,o,s.isOptional,s.isReadonly)}),r=Cn(e.indexSignatures,s=>{const o=Ur(s.type);return o===s.type?s:new jc(s.parameter,o,s.isReadonly)});return n===e.propertySignatures&&r===e.indexSignatures?e:new br(n,r,Ea(e))}case"Union":{const n=Cn(e.types,r=>Ur(r));return n===e.types?e:Jt.make(n,Ea(e))}case"Suspend":return new xi(()=>Ur(e.f()),Ea(e));case"Refinement":{const n=Ur(e.from),r=Ea(e);return r?Ni(n,r):n}case"Transformation":{const n=Ea(e);return Ur(n?Ni(e.from,n):e.from)}}return e},G_=e=>Ur(e),Vt=e=>{const t={};for(const n of Object.getOwnPropertySymbols(e))t[String(n)]=e[n];return t},bh=e=>{switch(e._tag){case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":return e;case"Refinement":return bh(e.from)}},YD=(e,t)=>new _r(e,t,rS),Do=e=>pt(os(e),()=>e._tag);function XD(e){return Xe(yC(e),{onNone:()=>"",onSome:t=>t.map(n=>` & Brand<${yr(n)}>`).join("")})}const PC=e=>bC(e).pipe(Rs(()=>wC(e)),Rs(()=>SC(e)),yo(t=>t+XD(e))),os=e=>Rs(xp(e),()=>PC(e)),ZD=(e,t,n)=>{switch(e._tag){case"UndefinedKeyword":return Mp;case"Union":{const r=[];let s=!1;for(const o of e.types){const a=t(o);a?(s=!0,OD(a)||r.push(a)):r.push(o)}if(s)return Jt.make(r);break}case"Suspend":return t(e.f());case"Transformation":return n(e)}},l0=Symbol.for("effect/Brand/Refined"),xC=()=>Object.assign(e=>e,{[l0]:l0,option:e=>V(e),either:e=>ie(e),is:e=>!0}),NC=Symbol.for("effect/Context/Tag"),Sh=Symbol.for("effect/Context/Reference"),eM="effect/STM",tM=Symbol.for(eM),sS={...of,_op:"Tag",[tM]:Fi,[NC]:{_Service:e=>e,_Identifier:e=>e},toString(){return st(this.toJSON())},toJSON(){return{_id:"Tag",key:this.key,stack:this.stack}},[Le](){return this.toJSON()},of(e){return e},context(e){return LC(this,e)}},nM={...sS,[Sh]:Sh},rM=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=2;const n=new Error;Error.stackTraceLimit=t;const r=Object.create(sS);return Object.defineProperty(r,"stack",{get(){return n.stack}}),r.key=e,r},sM=e=>()=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=2;const n=new Error;Error.stackTraceLimit=t;function r(){}return Object.setPrototypeOf(r,sS),r.key=e,Object.defineProperty(r,"stack",{get(){return n.stack}}),r},oM=()=>(e,t)=>{const n=Error.stackTraceLimit;Error.stackTraceLimit=2;const r=new Error;Error.stackTraceLimit=n;function s(){}return Object.setPrototypeOf(s,nM),s.key=e,s.defaultValue=t.defaultValue,Object.defineProperty(s,"stack",{get(){return r.stack}}),s},DC=Symbol.for("effect/Context"),iM={[DC]:{_Services:e=>e},[pe](e){if(MC(e)&&this.unsafeMap.size===e.unsafeMap.size){for(const t of this.unsafeMap.keys())if(!e.unsafeMap.has(t)||!le(this.unsafeMap.get(t),e.unsafeMap.get(t)))return!1;return!0}return!1},[he](){return tt(this,Bb(this.unsafeMap.size))},pipe(){return Y(this,arguments)},toString(){return st(this.toJSON())},toJSON(){return{_id:"Context",services:Array.from(this.unsafeMap).map(yt)}},[Le](){return this.toJSON()}},Di=e=>{const t=Object.create(iM);return t.unsafeMap=e,t},aM=e=>{const t=new Error(`Service not found${e.key?`: ${String(e.key)}`:""}`);if(e.stack){const n=e.stack.split(`
`);if(n.length>2){const r=n[2].match(/at (.*)/);r&&(t.message=t.message+` (defined at ${r[1]})`)}}if(t.stack){const n=t.stack.split(`
`);n.splice(1,3),t.stack=n.join(`
`)}return t},MC=e=>X(e,DC),cM=e=>X(e,NC),uM=e=>X(e,Sh),lM=Di(new Map),fM=()=>lM,LC=(e,t)=>Di(new Map([[e.key,t]])),dM=y(3,(e,t,n)=>{const r=new Map(e.unsafeMap);return r.set(t.key,n),Di(r)}),Xg=Se("effect/Context/defaultValueCache",()=>new Map),oS=e=>{if(Xg.has(e.key))return Xg.get(e.key);const t=e.defaultValue();return Xg.set(e.key,t),t},hM=(e,t)=>e.unsafeMap.has(t.key)?e.unsafeMap.get(t.key):oS(t),jC=y(2,(e,t)=>{if(!e.unsafeMap.has(t.key)){if(Sh in t)return oS(t);throw aM(t)}return e.unsafeMap.get(t.key)}),pM=jC,mM=y(2,(e,t)=>e.unsafeMap.has(t.key)?z_(e.unsafeMap.get(t.key)):uM(t)?z_(oS(t)):RT),gM=y(2,(e,t)=>{const n=new Map(e.unsafeMap);for(const[r,s]of t.unsafeMap)n.set(r,s);return Di(n)}),_M=(...e)=>t=>{const n=new Map(t.unsafeMap);for(const r of e)n.delete(r.key);return Di(n)},Bn=rM,yM=MC,jp=cM,js=fM,pf=LC,Kr=dM,Dn=pM,Up=jC,vr=mM,eo=gM,bM=_M,iS=sM,Uc=oM,UC=Symbol.for("effect/Chunk");function SM(e,t,n,r,s){for(let o=t;o<Math.min(e.length,t+s);o++)n[r+o-t]=e[o];return n}const zC=[],wM=e=>nf((t,n)=>t.length===n.length&&er(t).every((r,s)=>e(r,As(n,s)))),vM=wM(le),EM={[UC]:{_A:e=>e},toString(){return st(this.toJSON())},toJSON(){return{_id:"Chunk",values:er(this).map(yt)}},[Le](){return this.toJSON()},[pe](e){return bi(e)&&vM(this,e)},[he](){return tt(this,rf(er(this)))},[Symbol.iterator](){switch(this.backing._tag){case"IArray":return this.backing.array[Symbol.iterator]();case"IEmpty":return zC[Symbol.iterator]();default:return er(this)[Symbol.iterator]()}},pipe(){return Y(this,arguments)}},Ft=e=>{const t=Object.create(EM);switch(t.backing=e,e._tag){case"IEmpty":{t.length=0,t.depth=0,t.left=t,t.right=t;break}case"IConcat":{t.length=e.left.length+e.right.length,t.depth=1+Math.max(e.left.depth,e.right.depth),t.left=e.left,t.right=e.right;break}case"IArray":{t.length=e.array.length,t.depth=0,t.left=Ir,t.right=Ir;break}case"ISingleton":{t.length=1,t.depth=0,t.left=Ir,t.right=Ir;break}case"ISlice":{t.length=e.length,t.depth=e.chunk.depth+1,t.left=Ir,t.right=Ir;break}}return t},bi=e=>X(e,UC),Ir=Ft({_tag:"IEmpty"}),lt=()=>Ir,Zg=(...e)=>TM(e),rt=e=>Ft({_tag:"ISingleton",a:e}),Us=e=>bi(e)?e:Pt(Me(e)),Q_=(e,t,n)=>{switch(e.backing._tag){case"IArray":{SM(e.backing.array,0,t,n,e.length);break}case"IConcat":{Q_(e.left,t,n),Q_(e.right,t,n+e.left.length);break}case"ISingleton":{t[n]=e.backing.a;break}case"ISlice":{let r=0,s=n;for(;r<e.length;)t[s]=As(e,r),r+=1,s+=1;break}}},kM=e=>{switch(e.backing._tag){case"IEmpty":return zC;case"IArray":return e.backing.array;default:{const t=new Array(e.length);return Q_(e,t,0),e.backing={_tag:"IArray",array:t},e.left=Ir,e.right=Ir,e.depth=0,t}}},er=kM,$M=e=>{switch(e.backing._tag){case"IEmpty":case"ISingleton":return e;case"IArray":return Ft({_tag:"IArray",array:ZE(e.backing.array)});case"IConcat":return Ft({_tag:"IConcat",left:zs(e.backing.right),right:zs(e.backing.left)});case"ISlice":return Pt(ZE(er(e)))}},zs=$M,BC=y(2,(e,t)=>t<0||t>=e.length?H():V(As(e,t))),Pt=e=>e.length===0?lt():e.length===1?rt(e[0]):Ft({_tag:"IArray",array:e}),TM=e=>Pt(e),As=y(2,(e,t)=>{switch(e.backing._tag){case"IEmpty":throw new Error("Index out of bounds");case"ISingleton":{if(t!==0)throw new Error("Index out of bounds");return e.backing.a}case"IArray":{if(t>=e.length||t<0)throw new Error("Index out of bounds");return e.backing.array[t]}case"IConcat":return t<e.left.length?As(e.left,t):As(e.right,t-e.left.length);case"ISlice":return As(e.backing.chunk,t+e.backing.offset)}}),cl=y(2,(e,t)=>_t(e,rt(t))),pn=y(2,(e,t)=>_t(rt(t),e)),ac=y(2,(e,t)=>{if(t<=0)return Ir;if(t>=e.length)return e;switch(e.backing._tag){case"ISlice":return Ft({_tag:"ISlice",chunk:e.backing.chunk,length:t,offset:e.backing.offset});case"IConcat":return t>e.left.length?Ft({_tag:"IConcat",left:e.left,right:ac(e.right,t-e.left.length)}):ac(e.left,t);default:return Ft({_tag:"ISlice",chunk:e,offset:0,length:t})}}),Es=y(2,(e,t)=>{if(t<=0)return e;if(t>=e.length)return Ir;switch(e.backing._tag){case"ISlice":return Ft({_tag:"ISlice",chunk:e.backing.chunk,offset:e.backing.offset+t,length:e.backing.length-t});case"IConcat":return t>e.left.length?Es(e.right,t-e.left.length):Ft({_tag:"IConcat",left:Es(e.left,t),right:e.right});default:return Ft({_tag:"ISlice",chunk:e,offset:t,length:e.length-t})}}),_t=y(2,(e,t)=>{if(e.backing._tag==="IEmpty")return t;if(t.backing._tag==="IEmpty")return e;const n=t.depth-e.depth;if(Math.abs(n)<=1)return Ft({_tag:"IConcat",left:e,right:t});if(n<-1)if(e.left.depth>=e.right.depth){const r=_t(e.right,t);return Ft({_tag:"IConcat",left:e.left,right:r})}else{const r=_t(e.right.right,t);if(r.depth===e.depth-3){const s=Ft({_tag:"IConcat",left:e.right.left,right:r});return Ft({_tag:"IConcat",left:e.left,right:s})}else{const s=Ft({_tag:"IConcat",left:e.left,right:e.right.left});return Ft({_tag:"IConcat",left:s,right:r})}}else if(t.right.depth>=t.left.depth){const r=_t(e,t.left);return Ft({_tag:"IConcat",left:r,right:t.right})}else{const r=_t(e,t.left.left);if(r.depth===t.depth-3){const s=Ft({_tag:"IConcat",left:r,right:t.left.right});return Ft({_tag:"IConcat",left:s,right:t.right})}else{const s=Ft({_tag:"IConcat",left:t.left.right,right:t.right});return Ft({_tag:"IConcat",left:r,right:s})}}}),HC=y(2,(e,t)=>Pt(GT(e,t))),zp=y(2,(e,t)=>Pt(QT(e,t))),mf=e=>e.length===0,Bs=e=>e.length>0,Bp=BC(0),Hp=e=>As(e,0),Yr=Hp,CM=e=>BC(e,e.length-1),ka=e=>As(e,e.length-1),xa=y(2,(e,t)=>e.backing._tag==="ISingleton"?rt(t(e.backing.a,0)):Pt(b(er(e),qs((n,r)=>t(n,r))))),VC=y(2,(e,t)=>[ac(e,t),Es(e,t)]),IM=y(2,(e,t)=>{let n=0;for(const r of er(e)){if(t(r))break;n++}return VC(e,n)}),ks=e=>Es(e,1),OM=y(2,(e,t)=>Es(e,e.length-t)),RM=Yb,Y_=Symbol.for("effect/Duration"),WC=BigInt(0),f0=BigInt(24),pd=BigInt(60),X_=BigInt(1e3),d0=BigInt(1e6),h0=BigInt(1e9),qM=/^(-?\d+(?:\.\d+)?)\s+(nanos?|micros?|millis?|seconds?|minutes?|hours?|days?|weeks?)$/,sr=e=>{if(aS(e))return e;if(Ls(e))return Mi(e);if(Cp(e))return Ud(e);if(Array.isArray(e)&&e.length===2&&e.every(Ls))return e[0]===-1/0||e[1]===-1/0||Number.isNaN(e[0])||Number.isNaN(e[1])?KC:e[0]===1/0||e[1]===1/0?JC:Ud(BigInt(Math.round(e[0]*1e9))+BigInt(Math.round(e[1])));if(An(e)){const t=qM.exec(e);if(t){const[n,r,s]=t,o=Number(r);switch(s){case"nano":case"nanos":return Ud(BigInt(r));case"micro":case"micros":return xM(BigInt(r));case"milli":case"millis":return Mi(o);case"second":case"seconds":return cS(o);case"minute":case"minutes":return GC(o);case"hour":case"hours":return NM(o);case"day":case"days":return DM(o);case"week":case"weeks":return MM(o)}}}throw new Error("Invalid DurationInput")},p0={_tag:"Millis",millis:0},AM={_tag:"Infinity"},FM={[Y_]:Y_,[he](){return tt(this,wT(this.value))},[pe](e){return aS(e)&&VM(this,e)},toString(){return`Duration(${XC(this)})`},toJSON(){switch(this.value._tag){case"Millis":return{_id:"Duration",_tag:"Millis",millis:this.value.millis};case"Nanos":return{_id:"Duration",_tag:"Nanos",hrtime:jM(this)};case"Infinity":return{_id:"Duration",_tag:"Infinity"}}},[Le](){return this.toJSON()},pipe(){return Y(this,arguments)}},Ln=e=>{const t=Object.create(FM);return Ls(e)?isNaN(e)||e<=0?t.value=p0:Number.isFinite(e)?Number.isInteger(e)?t.value={_tag:"Millis",millis:e}:t.value={_tag:"Nanos",nanos:BigInt(Math.round(e*1e6))}:t.value=AM:e<=WC?t.value=p0:t.value={_tag:"Nanos",nanos:e},t},aS=e=>X(e,Y_),PM=e=>{switch(e.value._tag){case"Millis":return e.value.millis===0;case"Nanos":return e.value.nanos===WC;case"Infinity":return!1}},KC=Ln(0),JC=Ln(1/0),Ud=e=>Ln(e),xM=e=>Ln(e*X_),Mi=e=>Ln(e),cS=e=>Ln(e*1e3),GC=e=>Ln(e*6e4),NM=e=>Ln(e*36e5),DM=e=>Ln(e*864e5),MM=e=>Ln(e*6048e5),cc=e=>QC(e,{onMillis:t=>t,onNanos:t=>Number(t)/1e6}),LM=e=>{const t=sr(e);switch(t.value._tag){case"Infinity":throw new Error("Cannot convert infinite duration to nanos");case"Nanos":return t.value.nanos;case"Millis":return BigInt(Math.round(t.value.millis*1e6))}},jM=e=>{const t=sr(e);switch(t.value._tag){case"Infinity":return[1/0,0];case"Nanos":return[Number(t.value.nanos/h0),Number(t.value.nanos%h0)];case"Millis":return[Math.floor(t.value.millis/1e3),Math.round(t.value.millis%1e3*1e6)]}},QC=y(2,(e,t)=>{const n=sr(e);switch(n.value._tag){case"Nanos":return t.onNanos(n.value.nanos);case"Infinity":return t.onMillis(1/0);case"Millis":return t.onMillis(n.value.millis)}}),Vp=y(3,(e,t,n)=>{const r=sr(e),s=sr(t);if(r.value._tag==="Infinity"||s.value._tag==="Infinity")return n.onMillis(cc(r),cc(s));if(r.value._tag==="Nanos"||s.value._tag==="Nanos"){const o=r.value._tag==="Nanos"?r.value.nanos:BigInt(Math.round(r.value.millis*1e6)),a=s.value._tag==="Nanos"?s.value.nanos:BigInt(Math.round(s.value.millis*1e6));return n.onNanos(o,a)}return n.onMillis(r.value.millis,s.value.millis)}),YC=(e,t)=>Vp(e,t,{onMillis:(n,r)=>n===r,onNanos:(n,r)=>n===r}),UM=y(2,(e,t)=>QC(e,{onMillis:n=>Ln(n*t),onNanos:n=>Ln(n*BigInt(t))})),zM=y(2,(e,t)=>Vp(e,t,{onMillis:(n,r)=>Ln(n+r),onNanos:(n,r)=>Ln(n+r)})),BM=y(2,(e,t)=>Vp(e,t,{onMillis:(n,r)=>n<=r,onNanos:(n,r)=>n<=r})),HM=y(2,(e,t)=>Vp(e,t,{onMillis:(n,r)=>n>=r,onNanos:(n,r)=>n>=r})),VM=y(2,(e,t)=>YC(sr(e),sr(t))),WM=e=>{const t=sr(e);if(t.value._tag==="Infinity")return{days:1/0,hours:1/0,minutes:1/0,seconds:1/0,millis:1/0,nanos:1/0};const n=LM(t),r=n/d0,s=r/X_,o=s/pd,a=o/pd,u=a/f0;return{days:Number(u),hours:Number(a%f0),minutes:Number(o%pd),seconds:Number(s%pd),millis:Number(r%X_),nanos:Number(n%d0)}},XC=e=>{const t=sr(e);if(t.value._tag==="Infinity")return"Infinity";if(PM(t))return"0";const n=WM(t),r=[];return n.days!==0&&r.push(`${n.days}d`),n.hours!==0&&r.push(`${n.hours}h`),n.minutes!==0&&r.push(`${n.minutes}m`),n.seconds!==0&&r.push(`${n.seconds}s`),n.millis!==0&&r.push(`${n.millis}ms`),n.nanos!==0&&r.push(`${n.nanos}ns`),r.join(" ")},Li=5,uS=Math.pow(2,Li),KM=uS-1,JM=uS/2,GM=uS/4;function QM(e){return e-=e>>1&1431655765,e=(e&858993459)+(e>>2&858993459),e=e+(e>>4)&252645135,e+=e>>8,e+=e>>16,e&127}function uc(e,t){return t>>>e&KM}function Na(e){return 1<<e}function ZC(e,t){return QM(e&t-1)}const YM=(e,t)=>({value:e,previous:t});function Wa(e,t,n,r){let s=r;if(!e){const o=r.length;s=new Array(o);for(let a=0;a<o;++a)s[a]=r[a]}return s[t]=n,s}function eI(e,t,n){const r=n.length-1;let s=0,o=0,a=n;if(e)s=o=t;else for(a=new Array(r);s<t;)a[o++]=n[s++];for(++s;s<=r;)a[o++]=n[s++];return e&&(a.length=r),a}function XM(e,t,n,r){const s=r.length;if(e){let f=s;for(;f>=t;)r[f--]=r[f];return r[t]=n,r}let o=0,a=0;const u=new Array(s+1);for(;o<t;)u[a++]=r[o++];for(u[t]=n;o<s;)u[++a]=r[o++];return u}class $o{_tag="EmptyNode";modify(t,n,r,s,o,a){const u=r(H());return kt(u)?new $o:(++a.value,new Si(t,s,o,u))}}function Rr(e){return Ub(e,"EmptyNode")}function ZM(e){return Rr(e)||e._tag==="LeafNode"||e._tag==="CollisionNode"}function Wp(e,t){return Rr(e)?!1:t===e.edit}class Si{edit;hash;key;value;_tag="LeafNode";constructor(t,n,r,s){this.edit=t,this.hash=n,this.key=r,this.value=s}modify(t,n,r,s,o,a){if(le(o,this.key)){const f=r(this.value);return f===this.value?this:kt(f)?(--a.value,new $o):Wp(this,t)?(this.value=f,this):new Si(t,s,o,f)}const u=r(H());return kt(u)?this:(++a.value,tI(t,n,this.hash,this,s,new Si(t,s,o,u)))}}class lS{edit;hash;children;_tag="CollisionNode";constructor(t,n,r){this.edit=t,this.hash=n,this.children=r}modify(t,n,r,s,o,a){if(s===this.hash){const f=Wp(this,t),d=this.updateCollisionList(f,t,this.hash,this.children,r,o,a);return d===this.children?this:d.length>1?new lS(t,this.hash,d):d[0]}const u=r(H());return kt(u)?this:(++a.value,tI(t,n,this.hash,this,s,new Si(t,s,o,u)))}updateCollisionList(t,n,r,s,o,a,u){const f=s.length;for(let p=0;p<f;++p){const m=s[p];if("key"in m&&le(a,m.key)){const $=m.value,C=o($);return C===$?s:kt(C)?(--u.value,eI(t,p,s)):Wa(t,p,new Si(n,r,a,C),s)}}const d=o(H());return kt(d)?s:(++u.value,Wa(t,f,new Si(n,r,a,d),s))}}class lc{edit;mask;children;_tag="IndexedNode";constructor(t,n,r){this.edit=t,this.mask=n,this.children=r}modify(t,n,r,s,o,a){const u=this.mask,f=this.children,d=uc(n,s),p=Na(d),m=ZC(u,p),$=u&p,C=Wp(this,t);if(!$){const g=new $o().modify(t,n+Li,r,s,o,a);return g?f.length>=JM?tL(t,d,g,u,f):new lc(t,u|p,XM(C,m,g,f)):this}const O=f[m],N=O.modify(t,n+Li,r,s,o,a);if(O===N)return this;let v=u,w;if(Rr(N)){if(v&=~p,!v)return new $o;if(f.length<=2&&ZM(f[m^1]))return f[m^1];w=eI(C,m,f)}else w=Wa(C,m,N,f);return C?(this.mask=v,this.children=w,this):new lc(t,v,w)}}class fS{edit;size;children;_tag="ArrayNode";constructor(t,n,r){this.edit=t,this.size=n,this.children=r}modify(t,n,r,s,o,a){let u=this.size;const f=this.children,d=uc(n,s),p=f[d],m=(p||new $o).modify(t,n+Li,r,s,o,a);if(p===m)return this;const $=Wp(this,t);let C;if(Rr(p)&&!Rr(m))++u,C=Wa($,d,m,f);else if(!Rr(p)&&Rr(m)){if(--u,u<=GM)return eL(t,u,d,f);C=Wa($,d,new $o,f)}else C=Wa($,d,m,f);return $?(this.size=u,this.children=C,this):new fS(t,u,C)}}function eL(e,t,n,r){const s=new Array(t-1);let o=0,a=0;for(let u=0,f=r.length;u<f;++u)if(u!==n){const d=r[u];d&&!Rr(d)&&(s[o++]=d,a|=1<<u)}return new lc(e,a,s)}function tL(e,t,n,r,s){const o=[];let a=r,u=0;for(let f=0;a;++f)a&1&&(o[f]=s[u++]),a>>>=1;return o[t]=n,new fS(e,u+1,o)}function nL(e,t,n,r,s,o){if(n===s)return new lS(e,n,[o,r]);const a=uc(t,n),u=uc(t,s);if(a===u)return f=>new lc(e,Na(a)|Na(u),[f]);{const f=a<u?[r,o]:[o,r];return new lc(e,Na(a)|Na(u),f)}}function tI(e,t,n,r,s,o){let a,u=t;for(;;){const f=nL(e,u,n,r,s,o);if(typeof f=="function")a=YM(f,a),u=u+Li;else{let d=f;for(;a!=null;)d=a.value(d),a=a.previous;return d}}}const nI="effect/HashMap",Z_=Symbol.for(nI),rL={[Z_]:Z_,[Symbol.iterator](){return new Kp(this,(e,t)=>[e,t])},[he](){let e=J(nI);for(const t of this)e^=b(J(t[0]),ue(J(t[1])));return tt(this,e)},[pe](e){if(iL(e)){if(e._size!==this._size)return!1;for(const t of this){const n=b(e,hS(t[0],J(t[0])));if(kt(n))return!1;if(!le(t[1],n.value))return!1}return!0}return!1},toString(){return st(this.toJSON())},toJSON(){return{_id:"HashMap",values:Array.from(this).map(yt)}},[Le](){return this.toJSON()},pipe(){return Y(this,arguments)}},dS=(e,t,n,r)=>{const s=Object.create(rL);return s._editable=e,s._edit=t,s._root=n,s._size=r,s};class Kp{map;f;v;constructor(t,n){this.map=t,this.f=n,this.v=rI(this.map._root,this.f,void 0)}next(){if(kt(this.v))return{done:!0,value:void 0};const t=this.v.value;return this.v=wh(t.cont),{done:!1,value:t.value}}[Symbol.iterator](){return new Kp(this.map,this.f)}}const wh=e=>e?sI(e[0],e[1],e[2],e[3],e[4]):H(),rI=(e,t,n=void 0)=>{switch(e._tag){case"LeafNode":return nt(e.value)?V({value:t(e.key,e.value.value),cont:n}):wh(n);case"CollisionNode":case"ArrayNode":case"IndexedNode":{const r=e.children;return sI(r.length,r,0,t,n)}default:return wh(n)}},sI=(e,t,n,r,s)=>{for(;n<e;){const o=t[n++];if(o&&!Rr(o))return rI(o,r,[e,t,n,r,s])}return wh(s)},sL=dS(!1,0,new $o,0),Jp=()=>sL,oL=e=>{const t=iI(Jp());for(const n of e)ul(t,n[0],n[1]);return fL(t)},iL=e=>X(e,Z_),aL=e=>e&&Rr(e._root),cL=y(2,(e,t)=>hS(e,t,J(t))),hS=y(3,(e,t,n)=>{let r=e._root,s=0;for(;;)switch(r._tag){case"LeafNode":return le(t,r.key)?r.value:H();case"CollisionNode":{if(n===r.hash){const o=r.children;for(let a=0,u=o.length;a<u;++a){const f=o[a];if("key"in f&&le(t,f.key))return f.value}}return H()}case"IndexedNode":{const o=uc(s,n),a=Na(o);if(r.mask&a){r=r.children[ZC(r.mask,a)],s+=Li;break}return H()}case"ArrayNode":{if(r=r.children[uc(s,n)],r){s+=Li;break}return H()}default:return H()}}),uL=y(2,(e,t)=>nt(hS(e,t,J(t)))),ul=y(3,(e,t,n)=>pS(e,t,()=>V(n))),lL=y(3,(e,t,n)=>e._editable?(e._root=t,e._size=n,e):t===e._root?e:dS(e._editable,e._edit,t,n)),oI=e=>new Kp(e,t=>t),vh=e=>e._size,iI=e=>dS(!0,e._edit+1,e._root,e._size),fL=e=>(e._editable=!1,e),pS=y(3,(e,t,n)=>dL(e,t,J(t),n)),dL=y(4,(e,t,n,r)=>{const s={value:e._size},o=e._root.modify(e._editable?e._edit:NaN,0,r,n,t,s);return b(e,lL(o,s.value))}),m0=y(2,(e,t)=>pS(e,t,H)),hL=y(2,(e,t)=>Gp(e,Jp(),(n,r,s)=>ul(n,s,t(r,s)))),aI=y(2,(e,t)=>Gp(e,void 0,(n,r,s)=>t(r,s))),Gp=y(3,(e,t,n)=>{const r=e._root;if(r._tag==="LeafNode")return nt(r.value)?n(t,r.value.value,r.key):t;if(r._tag==="EmptyNode")return t;const s=[r.children];let o;for(;o=s.pop();)for(let a=0,u=o.length;a<u;){const f=o[a++];f&&!Rr(f)&&(f._tag==="LeafNode"?nt(f.value)&&(t=n(t,f.value.value,f.key)):s.push(f.children))}return t}),cI="effect/HashSet",ey=Symbol.for(cI),pL={[ey]:ey,[Symbol.iterator](){return oI(this._keyMap)},[he](){return tt(this,ue(J(this._keyMap))(J(cI)))},[pe](e){return mL(e)?vh(this._keyMap)===vh(e._keyMap)&&le(this._keyMap,e._keyMap):!1},toString(){return st(this.toJSON())},toJSON(){return{_id:"HashSet",values:Array.from(this).map(yt)}},[Le](){return this.toJSON()},pipe(){return Y(this,arguments)}},Qp=e=>{const t=Object.create(pL);return t._keyMap=e,t},mL=e=>X(e,ey),gL=Qp(Jp()),Yp=()=>gL,_L=e=>{const t=mS(Yp());for(const n of e)ll(t,n);return gS(t)},yL=(...e)=>{const t=mS(Yp());for(const n of e)ll(t,n);return gS(t)},bL=y(2,(e,t)=>uL(e._keyMap,t)),SL=e=>vh(e._keyMap),mS=e=>Qp(iI(e._keyMap)),gS=e=>(e._keyMap._editable=!1,e),uI=y(2,(e,t)=>{const n=mS(e);return t(n),gS(n)}),ll=y(2,(e,t)=>e._keyMap._editable?(ul(t,!0)(e._keyMap),e):Qp(ul(t,!0)(e._keyMap))),lI=y(2,(e,t)=>e._keyMap._editable?(m0(t)(e._keyMap),e):Qp(m0(t)(e._keyMap))),wL=y(2,(e,t)=>uI(e,n=>{for(const r of t)lI(n,r)})),vL=y(2,(e,t)=>uI(Yp(),n=>{EL(e,r=>ll(n,r));for(const r of t)ll(n,r)})),EL=y(2,(e,t)=>aI(e._keyMap,(n,r)=>t(r))),kL=y(3,(e,t,n)=>Gp(e._keyMap,t,(r,s,o)=>n(r,o))),ji=Yp,$L=_L,Xp=yL,Zp=bL,_S=SL,Ka=ll,yS=lI,g0=wL,fl=vL,dl=kL,_0=Symbol.for("effect/MutableRef"),TL={[_0]:_0,toString(){return st(this.toJSON())},toJSON(){return{_id:"MutableRef",current:yt(this.current)}},[Le](){return this.toJSON()},pipe(){return Y(this,arguments)}},sa=e=>{const t=Object.create(TL);return t.current=e,t},CL=y(3,(e,t,n)=>le(t,e.current)?(e.current=n,!0):!1),je=e=>e.current,oa=y(2,(e,t)=>(e.current=t,e)),em="effect/FiberId",Ui=Symbol.for(em),fc="None",ty="Runtime",ny="Composite",IL=Ot(`${em}-${fc}`);let OL=class{[Ui]=Ui;_tag=fc;id=-1;startTimeMillis=-1;[he](){return IL}[pe](t){return SS(t)&&t._tag===fc}toString(){return st(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag}}[Le](){return this.toJSON()}};class bS{id;startTimeMillis;[Ui]=Ui;_tag=ty;constructor(t,n){this.id=t,this.startTimeMillis=n}[he](){return tt(this,Ot(`${em}-${this._tag}-${this.id}-${this.startTimeMillis}`))}[pe](t){return SS(t)&&t._tag===ty&&this.id===t.id&&this.startTimeMillis===t.startTimeMillis}toString(){return st(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag,id:this.id,startTimeMillis:this.startTimeMillis}}[Le](){return this.toJSON()}}let fI=class{left;right;[Ui]=Ui;_tag=ny;constructor(t,n){this.left=t,this.right=n}_hash;[he](){return b(Ot(`${em}-${this._tag}`),ue(J(this.left)),ue(J(this.right)),tt(this))}[pe](t){return SS(t)&&t._tag===ny&&le(this.left,t.left)&&le(this.right,t.right)}toString(){return st(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag,left:yt(this.left),right:yt(this.right)}}[Le](){return this.toJSON()}};const dI=new OL,RL=(e,t)=>new bS(e,t),qL=(e,t)=>new fI(e,t),SS=e=>X(e,Ui),hI=y(2,(e,t)=>e._tag===fc?t:t._tag===fc?e:new fI(e,t)),AL=e=>b(e,dl(dI,(t,n)=>hI(n)(t))),Eh=e=>{switch(e._tag){case fc:return ji();case ty:return Xp(e.id);case ny:return b(Eh(e.left),fl(Eh(e.right)))}},y0=Se(Symbol.for("effect/Fiber/Id/_fiberCounter"),()=>sa(0)),FL=(e,t)=>new bS(e,t),tm=e=>Array.from(Eh(e)).map(n=>`#${n}`).join(","),PL=()=>{const e=je(y0);return b(y0,oa(e+1)),new bS(e,Date.now())},On=dI,xL=RL,NL=qL,tr=hI,DL=AL,nm=Eh,wS=FL,ML=tm,pI=PL,rm=Jp,LL=oL,jL=aL,mI=cL,dc=ul,gI=oI,_I=vh,UL=pS,zL=hL,BL=aI,yI=Gp,hl=Symbol.for("effect/List"),ry=e=>Me(e),HL=e=>pT(uf(e),ry),VL=HL(le),WL={[hl]:hl,_tag:"Cons",toString(){return st(this.toJSON())},toJSON(){return{_id:"List",_tag:"Cons",values:ry(this).map(yt)}},[Le](){return this.toJSON()},[pe](e){return SI(e)&&this._tag===e._tag&&VL(this,e)},[he](){return tt(this,rf(ry(this)))},[Symbol.iterator](){let e=!1,t=this;return{next(){if(e)return this.return();if(t._tag==="Nil")return e=!0,this.return();const n=t.head;return t=t.tail,{done:e,value:n}},return(n){return e||(e=!0),{done:!0,value:n}}}},pipe(){return Y(this,arguments)}},kh=(e,t)=>{const n=Object.create(WL);return n.head=e,n.tail=t,n},KL=Ot("Nil"),JL={[hl]:hl,_tag:"Nil",toString(){return st(this.toJSON())},toJSON(){return{_id:"List",_tag:"Nil"}},[Le](){return this.toJSON()},[he](){return KL},[pe](e){return SI(e)&&this._tag===e._tag},[Symbol.iterator](){return{next(){return{done:!0,value:void 0}}}},pipe(){return Y(this,arguments)}},bI=Object.create(JL),SI=e=>X(e,hl),Fs=e=>e._tag==="Nil",vS=e=>e._tag==="Cons",GL=()=>bI,zi=(e,t)=>kh(e,t),hc=GL,ES=e=>kh(e,bI),QL=y(2,(e,t)=>XL(t,e)),YL=y(2,(e,t)=>zi(t,e)),XL=y(2,(e,t)=>{if(Fs(e))return t;if(Fs(t))return e;{const n=kh(t.head,e);let r=n,s=t.tail;for(;!Fs(s);){const o=kh(s.head,e);r.tail=o,r=o,s=s.tail}return n}}),ZL=y(3,(e,t,n)=>{let r=t,s=e;for(;!Fs(s);)r=n(r,s.head),s=s.tail;return r}),ej=e=>{let t=hc(),n=e;for(;!Fs(n);)t=YL(t,n.head),n=n.tail;return t},sm=function(){function e(t){t&&Object.assign(this,t)}return e.prototype=Wb,e}(),tj=Symbol.for("effect/DifferContextPatch");function b0(e){return e}const gf={...sm.prototype,[tj]:{_Value:b0,_Patch:b0}},nj=Object.assign(Object.create(gf),{_tag:"Empty"}),rj=Object.create(nj),wI=()=>rj,sj=Object.assign(Object.create(gf),{_tag:"AndThen"}),oj=(e,t)=>{const n=Object.create(sj);return n.first=e,n.second=t,n},ij=Object.assign(Object.create(gf),{_tag:"AddService"}),aj=(e,t)=>{const n=Object.create(ij);return n.key=e,n.service=t,n},cj=Object.assign(Object.create(gf),{_tag:"RemoveService"}),uj=e=>{const t=Object.create(cj);return t.key=e,t},lj=Object.assign(Object.create(gf),{_tag:"UpdateService"}),fj=(e,t)=>{const n=Object.create(lj);return n.key=e,n.update=t,n},dj=(e,t)=>{const n=new Map(e.unsafeMap);let r=wI();for(const[s,o]of t.unsafeMap.entries())if(n.has(s)){const a=n.get(s);n.delete(s),le(a,o)||(r=zd(fj(s,()=>o))(r))}else n.delete(s),r=zd(aj(s,o))(r);for(const[s]of n.entries())r=zd(uj(s))(r);return r},zd=y(2,(e,t)=>oj(e,t)),hj=y(2,(e,t)=>{if(e._tag==="Empty")return t;let n=!1,r=rt(e);const s=new Map(t.unsafeMap);for(;Bs(r);){const a=Yr(r),u=ks(r);switch(a._tag){case"Empty":{r=u;break}case"AddService":{s.set(a.key,a.service),r=u;break}case"AndThen":{r=pn(pn(u,a.second),a.first);break}case"RemoveService":{s.delete(a.key),r=u;break}case"UpdateService":{s.set(a.key,a.update(s.get(a.key))),n=!0,r=u;break}}}if(!n)return Di(s);const o=new Map;for(const[a]of t.unsafeMap)s.has(a)&&(o.set(a,s.get(a)),s.delete(a));for(const[a,u]of s)o.set(a,u);return Di(o)}),pj=Symbol.for("effect/DifferHashSetPatch");function e_(e){return e}const om={...sm.prototype,[pj]:{_Value:e_,_Key:e_,_Patch:e_}},mj=Object.assign(Object.create(om),{_tag:"Empty"}),gj=Object.create(mj),vI=()=>gj,_j=Object.assign(Object.create(om),{_tag:"AndThen"}),yj=(e,t)=>{const n=Object.create(_j);return n.first=e,n.second=t,n},bj=Object.assign(Object.create(om),{_tag:"Add"}),Sj=e=>{const t=Object.create(bj);return t.value=e,t},wj=Object.assign(Object.create(om),{_tag:"Remove"}),vj=e=>{const t=Object.create(wj);return t.value=e,t},Ej=(e,t)=>{const[n,r]=dl([e,vI()],([s,o],a)=>Zp(a)(s)?[yS(a)(s),o]:[s,sy(Sj(a))(o)])(t);return dl(r,(s,o)=>sy(vj(o))(s))(n)},sy=y(2,(e,t)=>yj(e,t)),kj=y(2,(e,t)=>{if(e._tag==="Empty")return t;let n=t,r=rt(e);for(;Bs(r);){const s=Yr(r),o=ks(r);switch(s._tag){case"Empty":{r=o;break}case"AndThen":{r=pn(s.first)(pn(s.second)(o));break}case"Add":{n=Ka(s.value)(n),r=o;break}case"Remove":n=yS(s.value)(n),r=o}}return n}),$j=Symbol.for("effect/DifferReadonlyArrayPatch");function S0(e){return e}const _f={...sm.prototype,[$j]:{_Value:S0,_Patch:S0}},Tj=Object.assign(Object.create(_f),{_tag:"Empty"}),Cj=Object.create(Tj),EI=()=>Cj,Ij=Object.assign(Object.create(_f),{_tag:"AndThen"}),Oj=(e,t)=>{const n=Object.create(Ij);return n.first=e,n.second=t,n},Rj=Object.assign(Object.create(_f),{_tag:"Append"}),qj=e=>{const t=Object.create(Rj);return t.values=e,t},Aj=Object.assign(Object.create(_f),{_tag:"Slice"}),Fj=(e,t)=>{const n=Object.create(Aj);return n.from=e,n.until=t,n},Pj=Object.assign(Object.create(_f),{_tag:"Update"}),xj=(e,t)=>{const n=Object.create(Pj);return n.index=e,n.patch=t,n},Nj=e=>{let t=0,n=EI();for(;t<e.oldValue.length&&t<e.newValue.length;){const r=e.oldValue[t],s=e.newValue[t],o=e.differ.diff(r,s);le(o,e.differ.empty)||(n=Bd(n,xj(t,o))),t=t+1}return t<e.oldValue.length&&(n=Bd(n,Fj(0,t))),t<e.newValue.length&&(n=Bd(n,qj(j3(t)(e.newValue)))),n},Bd=y(2,(e,t)=>Oj(e,t)),Dj=y(3,(e,t,n)=>{if(e._tag==="Empty")return t;let r=t.slice(),s=Qn(e);for(;Nd(s);){const o=In(s),a=Pi(s);switch(o._tag){case"Empty":{s=a;break}case"AndThen":{a.unshift(o.first,o.second),s=a;break}case"Append":{for(const u of o.values)r.push(u);s=a;break}case"Slice":{r=r.slice(o.from,o.until),s=a;break}case"Update":{r[o.index]=n.patch(o.patch,r[o.index]),s=a;break}}}return r}),Mj=Symbol.for("effect/Differ"),Lj={[Mj]:{_P:oe,_V:oe},pipe(){return Y(this,arguments)}},zc=e=>{const t=Object.create(Lj);return t.empty=e.empty,t.diff=e.diff,t.combine=e.combine,t.patch=e.patch,t},jj=()=>zc({empty:wI(),combine:(e,t)=>zd(t)(e),diff:(e,t)=>dj(e,t),patch:(e,t)=>hj(t)(e)}),Uj=()=>zc({empty:vI(),combine:(e,t)=>sy(t)(e),diff:(e,t)=>Ej(e,t),patch:(e,t)=>kj(t)(e)}),zj=e=>zc({empty:EI(),combine:(t,n)=>Bd(t,n),diff:(t,n)=>Nj({oldValue:t,newValue:n,differ:e}),patch:(t,n)=>Dj(t,n,e)}),kI=()=>Bj((e,t)=>t),Bj=e=>zc({empty:oe,combine:(t,n)=>t===oe?n:n===oe?t:r=>n(t(r)),diff:(t,n)=>le(t,n)?oe:$p(n),patch:(t,n)=>e(n,t(n))}),pl=255,$I=8,oy=e=>e&pl,iy=e=>e>>$I&pl,yf=(e,t)=>(e&pl)+((t&e&pl)<<$I),Hj=yf(0,0),Vj=e=>yf(e,e),Wj=e=>yf(e,0),Kj=y(2,(e,t)=>yf(oy(e)&~t,iy(e))),Jj=y(2,(e,t)=>e|t),Gj=e=>~e>>>0&pl,Qj=0,Bc=1,Yj=2,TI=4,ay=16,CI=32,Xj=e=>im(e,CI),Zj=y(2,(e,t)=>e|t),ho=e=>II(e)&&!tU(e),II=e=>im(e,Bc),im=y(2,(e,t)=>(e&t)!==0),OI=(...e)=>e.reduce((t,n)=>t|n,0),eU=OI(Qj),w0=e=>im(e,TI),tU=e=>im(e,ay),bo=y(2,(e,t)=>yf(e^t,t)),Ja=y(2,(e,t)=>e&(Gj(oy(t))|iy(t))|oy(t)&iy(t)),v0=zc({empty:Hj,diff:(e,t)=>bo(e,t),combine:(e,t)=>Jj(t)(e),patch:(e,t)=>Ja(t,e)}),nU=Vj,RI=Wj,E0=Kj,qI=(e,t)=>({_tag:"Par",left:e,right:t}),md=(e,t)=>({_tag:"Seq",left:e,right:t}),rU=e=>{let t=ES(e),n=hc();for(;;){const[r,s]=ZL(t,[AI(),hc()],([o,a],u)=>{const[f,d]=sU(u);return[uU(o,f),QL(a,d)]});if(n=oU(n,r),Fs(s))return ej(n);t=s}throw new Error("BUG: BlockedRequests.flatten - please report an issue at https://github.com/Effect-TS/effect/issues")},sU=e=>{let t=e,n=AI(),r=hc(),s=hc();for(;;)switch(t._tag){case"Empty":{if(Fs(r))return[n,s];t=r.head,r=r.tail;break}case"Par":{r=zi(t.right,r),t=t.left;break}case"Seq":{const o=t.left,a=t.right;switch(o._tag){case"Empty":{t=a;break}case"Par":{const u=o.left,f=o.right;t=qI(md(u,a),md(f,a));break}case"Seq":{const u=o.left,f=o.right;t=md(u,md(f,a));break}case"Single":{t=o,s=zi(a,s);break}}break}case"Single":{if(n=cU(n,t),Fs(r))return[n,s];t=r.head,r=r.tail;break}}throw new Error("BUG: BlockedRequests.step - please report an issue at https://github.com/Effect-TS/effect/issues")},oU=(e,t)=>{if(Fs(e))return ES(t_(t));if(lU(t))return e;const n=gU(e.head),r=fU(t);return n.length===1&&r.length===1&&le(n[0],r[0])?zi(mU(e.head,t_(t)),e.tail):zi(t_(t),e)},iU=Symbol.for("effect/RequestBlock/RequestBlockParallel"),aU={_R:e=>e};class kS{map;[iU]=aU;constructor(t){this.map=t}}const AI=()=>new kS(rm()),cU=(e,t)=>new kS(UL(e.map,t.dataSource,n=>h3(yo(n,cl(t.blockedRequest)),()=>rt(t.blockedRequest)))),uU=(e,t)=>new kS(yI(e.map,t.map,(n,r,s)=>dc(n,s,Xe(mI(n,s),{onNone:()=>r,onSome:o=>_t(r,o)})))),lU=e=>jL(e.map),fU=e=>Array.from(gI(e.map)),t_=e=>pU(zL(e.map,t=>rt(t))),dU=Symbol.for("effect/RequestBlock/RequestBlockSequential"),hU={_R:e=>e};class FI{map;[dU]=hU;constructor(t){this.map=t}}const pU=e=>new FI(e),mU=(e,t)=>new FI(yI(t.map,e.map,(n,r,s)=>dc(n,s,Xe(mI(n,s),{onNone:()=>lt(),onSome:o=>_t(o,r)})))),gU=e=>Array.from(gI(e.map)),_U=e=>Array.from(e.map),Hc="Die",Bi="Empty",ia="Fail",Vc="Interrupt",pc="Parallel",mc="Sequential",PI="effect/Cause",xI=Symbol.for(PI),yU={_E:e=>e},Wc={[xI]:yU,[he](){return b(J(PI),ue(J(CU(this))),tt(this))},[pe](e){return $S(e)&&TU(this,e)},pipe(){return Y(this,arguments)},toJSON(){switch(this._tag){case"Empty":return{_id:"Cause",_tag:this._tag};case"Die":return{_id:"Cause",_tag:this._tag,defect:yt(this.defect)};case"Interrupt":return{_id:"Cause",_tag:this._tag,fiberId:this.fiberId.toJSON()};case"Fail":return{_id:"Cause",_tag:this._tag,failure:yt(this.error)};case"Sequential":case"Parallel":return{_id:"Cause",_tag:this._tag,left:yt(this.left),right:yt(this.right)}}},toString(){return Mo(this)},[Le](){return this.toJSON()}},Hs=(()=>{const e=Object.create(Wc);return e._tag=Bi,e})(),Hi=e=>{const t=Object.create(Wc);return t._tag=ia,t.error=e,t},Rn=e=>{const t=Object.create(Wc);return t._tag=Hc,t.defect=e,t},pr=e=>{const t=Object.create(Wc);return t._tag=Vc,t.fiberId=e,t},Vs=(e,t)=>{const n=Object.create(Wc);return n._tag=pc,n.left=e,n.right=t,n},zt=(e,t)=>{const n=Object.create(Wc);return n._tag=mc,n.left=e,n.right=t,n},$S=e=>X(e,xI),bU=e=>e._tag===Bi,SU=e=>e._tag===ia,TS=e=>e._tag===Hc,CS=e=>e._tag===Bi?!0:gc(e,!0,(t,n)=>{switch(n._tag){case Bi:return V(t);case Hc:case ia:case Vc:return V(!1);default:return H()}}),IS=e=>nt(EU(e)),am=e=>lm(void 0,OU)(e),wU=e=>zs(gc(e,lt(),(t,n)=>n._tag===ia?V(b(t,pn(n.error))):H())),NI=e=>zs(gc(e,lt(),(t,n)=>n._tag===Hc?V(b(t,pn(n.defect))):H())),OS=e=>gc(e,ji(),(t,n)=>n._tag===Vc?V(b(t,Ka(n.fiberId))):H()),DI=e=>cm(e,t=>t._tag===ia?V(t.error):H()),RS=e=>{const t=DI(e);switch(t._tag){case"None":return ie(e);case"Some":return se(t.value)}},vU=e=>um(e,{onEmpty:V(Hs),onFail:yo(Hi),onDie:t=>V(Rn(t)),onInterrupt:t=>V(pr(t)),onSequential:XE(zt),onParallel:XE(Vs)}),EU=e=>cm(e,t=>t._tag===Vc?V(t.fiberId):H()),k0=e=>um(e,{onEmpty:Hs,onFail:()=>Hs,onDie:Rn,onInterrupt:pr,onSequential:zt,onParallel:Vs}),kU=e=>um(e,{onEmpty:Hs,onFail:Rn,onDie:Rn,onInterrupt:pr,onSequential:zt,onParallel:Vs}),MI=y(2,(e,t)=>$U(e,n=>Hi(t(n)))),$U=y(2,(e,t)=>um(e,{onEmpty:Hs,onFail:n=>t(n),onDie:n=>Rn(n),onInterrupt:n=>pr(n),onSequential:(n,r)=>zt(n,r),onParallel:(n,r)=>Vs(n,r)})),TU=(e,t)=>{let n=rt(e),r=rt(t);for(;Bs(n)&&Bs(r);){const[s,o]=b(Yr(n),gc([ji(),lt()],([f,d],p)=>{const[m,$]=cy(p);return V([b(f,fl(m)),b(d,_t($))])})),[a,u]=b(Yr(r),gc([ji(),lt()],([f,d],p)=>{const[m,$]=cy(p);return V([b(f,fl(m)),b(d,_t($))])}));if(!le(s,a))return!1;n=o,r=u}return!0},CU=e=>IU(rt(e),lt()),IU=(e,t)=>{for(;;){const[n,r]=b(e,Yb([ji(),lt()],([o,a],u)=>{const[f,d]=cy(u);return[b(o,fl(f)),b(a,_t(d))]})),s=_S(n)>0?b(t,pn(n)):t;if(mf(r))return zs(s);e=r,t=s}throw new Error(Ip("Cause.flattenCauseLoop"))},cm=y(2,(e,t)=>{const n=[e];for(;n.length>0;){const r=n.pop(),s=t(r);switch(s._tag){case"None":{switch(r._tag){case mc:case pc:{n.push(r.right),n.push(r.left);break}}break}case"Some":return s}}return H()}),cy=e=>{let t=e;const n=[];let r=ji(),s=lt();for(;t!==void 0;)switch(t._tag){case Bi:{if(n.length===0)return[r,s];t=n.pop();break}case ia:{if(r=Ka(r,Zg(t._tag,t.error)),n.length===0)return[r,s];t=n.pop();break}case Hc:{if(r=Ka(r,Zg(t._tag,t.defect)),n.length===0)return[r,s];t=n.pop();break}case Vc:{if(r=Ka(r,Zg(t._tag,t.fiberId)),n.length===0)return[r,s];t=n.pop();break}case mc:{switch(t.left._tag){case Bi:{t=t.right;break}case mc:{t=zt(t.left.left,zt(t.left.right,t.right));break}case pc:{t=Vs(zt(t.left.left,t.right),zt(t.left.right,t.right));break}default:{s=pn(s,t.right),t=t.left;break}}break}case pc:{n.push(t.right),t=t.left;break}}throw new Error(Ip("Cause.evaluateCauseLoop"))},OU={emptyCase:GE,failCase:Nn,dieCase:Nn,interruptCase:GE,sequentialCase:(e,t,n)=>t&&n,parallelCase:(e,t,n)=>t&&n},$0="SequentialCase",T0="ParallelCase",um=y(2,(e,{onDie:t,onEmpty:n,onFail:r,onInterrupt:s,onParallel:o,onSequential:a})=>lm(e,void 0,{emptyCase:()=>n,failCase:(u,f)=>r(f),dieCase:(u,f)=>t(f),interruptCase:(u,f)=>s(f),sequentialCase:(u,f,d)=>a(f,d),parallelCase:(u,f,d)=>o(f,d)})),gc=y(3,(e,t,n)=>{let r=t,s=e;const o=[];for(;s!==void 0;){const a=n(r,s);switch(r=nt(a)?a.value:r,s._tag){case mc:{o.push(s.right),s=s.left;break}case pc:{o.push(s.right),s=s.left;break}default:{s=void 0;break}}s===void 0&&o.length>0&&(s=o.pop())}return r}),lm=y(3,(e,t,n)=>{const r=[e],s=[];for(;r.length>0;){const a=r.pop();switch(a._tag){case Bi:{s.push(ie(n.emptyCase(t)));break}case ia:{s.push(ie(n.failCase(t,a.error)));break}case Hc:{s.push(ie(n.dieCase(t,a.defect)));break}case Vc:{s.push(ie(n.interruptCase(t,a.fiberId)));break}case mc:{r.push(a.right),r.push(a.left),s.push(se({_tag:$0}));break}case pc:{r.push(a.right),r.push(a.left),s.push(se({_tag:T0}));break}}}const o=[];for(;s.length>0;){const a=s.pop();switch(a._tag){case"Left":{switch(a.left._tag){case $0:{const u=o.pop(),f=o.pop(),d=n.sequentialCase(t,u,f);o.push(d);break}case T0:{const u=o.pop(),f=o.pop(),d=n.parallelCase(t,u,f);o.push(d);break}}break}case"Right":{o.push(a.right);break}}}if(o.length===0)throw new Error("BUG: Cause.reduceWithContext - please report an issue at https://github.com/Effect-TS/effect/issues");return o.pop()}),Mo=(e,t)=>am(e)?"All fibers interrupted without errors.":qS(e).map(function(n){return t?.renderErrorCause!==!0||n.cause===void 0?n.stack:`${n.stack} {
${LI(n.cause,"  ")}
}`}).join(`
`),LI=(e,t)=>{const n=e.stack.split(`
`);let r=`${t}[cause]: ${n[0]}`;for(let s=1,o=n.length;s<o;s++)r+=`
${t}${n[s]}`;return e.cause&&(r+=` {
${LI(e.cause,`${t}  `)}
${t}}`),r};class $h extends globalThis.Error{span=void 0;constructor(t){const n=typeof t=="object"&&t!==null,r=Error.stackTraceLimit;Error.stackTraceLimit=1,super(jI(t),n&&"cause"in t&&typeof t.cause<"u"?{cause:new $h(t.cause)}:void 0),this.message===""&&(this.message="An error has occurred"),Error.stackTraceLimit=r,this.name=t instanceof Error?t.name:"Error",n&&(_c in t&&(this.span=t[_c]),Object.keys(t).forEach(s=>{s in this||(this[s]=t[s])})),this.stack=qU(`${this.name}: ${this.message}`,t instanceof Error&&t.stack?t.stack:"",this.span)}}const jI=e=>{if(typeof e=="string")return e;if(typeof e=="object"&&e!==null&&e instanceof Error)return e.message;try{if(X(e,"toString")&&xc(e.toString)&&e.toString!==Object.prototype.toString&&e.toString!==globalThis.Array.prototype.toString)return e.toString()}catch{}return vT(e)},RU=/\((.*)\)/g,Th=Se("effect/Tracer/spanToTrace",()=>new WeakMap),qU=(e,t,n)=>{const r=[e],s=t.startsWith(e)?t.slice(e.length).split(`
`):t.split(`
`);for(let o=1;o<s.length;o++){if(s[o].includes(" at new BaseEffectError")||s[o].includes(" at new YieldableError")){o++;continue}if(s[o].includes("Generator.next")||s[o].includes("effect_internal_function"))break;r.push(s[o].replace(/at .*effect_instruction_i.*\((.*)\)/,"at $1").replace(/EffectPrimitive\.\w+/,"<anonymous>"))}if(n){let o=n,a=0;for(;o&&o._tag==="Span"&&a<10;){const u=Th.get(o);if(typeof u=="function"){const f=u();if(typeof f=="string"){const d=f.matchAll(RU);let p=!1;for(const[,m]of d)p=!0,r.push(`    at ${o.name} (${m})`);p||r.push(`    at ${o.name} (${f.replace(/^at /,"")})`)}else r.push(`    at ${o.name}`)}else r.push(`    at ${o.name}`);o=hr(o.parent),a++}}return r.join(`
`)},_c=Symbol.for("effect/SpanAnnotation"),qS=e=>lm(e,void 0,{emptyCase:()=>[],dieCase:(t,n)=>[new $h(n)],failCase:(t,n)=>[new $h(n)],interruptCase:()=>[],parallelCase:(t,n,r)=>[...n,...r],sequentialCase:(t,n,r)=>[...n,...r]}),bf="Pending",fm="Done",AU="effect/Deferred",FU=Symbol.for(AU),PU={_E:e=>e,_A:e=>e},xU=e=>({_tag:bf,joiners:e}),UI=e=>({_tag:fm,effect:e});class Kc{self;called=!1;constructor(t){this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new Kc(this.self)}}const zI=(e,t)=>{const n=new Wt("Blocked");return n.effect_instruction_i0=e,n.effect_instruction_i1=t,n},NU=e=>{const t=new Wt("RunBlocked");return t.effect_instruction_i0=e,t},Vi=Symbol.for("effect/Effect");class DU{patch;op;_op=Vb;constructor(t,n){this.patch=t,this.op=n}}class Wt{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Vi]=Fi;constructor(t){this._op=t}[pe](t){return this===t}[he](){return tt(this,Op(this))}pipe(){return Y(this,arguments)}toJSON(){return{_id:"Effect",_op:this._op,effect_instruction_i0:yt(this.effect_instruction_i0),effect_instruction_i1:yt(this.effect_instruction_i1),effect_instruction_i2:yt(this.effect_instruction_i2)}}toString(){return st(this.toJSON())}[Le](){return this.toJSON()}[Symbol.iterator](){return new Kc(new Nc(this))}}class BI{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Vi]=Fi;constructor(t){this._op=t,this._tag=t}[pe](t){return km(t)&&t._op==="Failure"&&le(this.effect_instruction_i0,t.effect_instruction_i0)}[he](){return b(Ot(this._tag),ue(J(this.effect_instruction_i0)),tt(this))}get cause(){return this.effect_instruction_i0}pipe(){return Y(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,cause:this.cause.toJSON()}}toString(){return st(this.toJSON())}[Le](){return this.toJSON()}[Symbol.iterator](){return new Kc(new Nc(this))}}class HI{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Vi]=Fi;constructor(t){this._op=t,this._tag=t}[pe](t){return km(t)&&t._op==="Success"&&le(this.effect_instruction_i0,t.effect_instruction_i0)}[he](){return b(Ot(this._tag),ue(J(this.effect_instruction_i0)),tt(this))}get value(){return this.effect_instruction_i0}pipe(){return Y(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,value:yt(this.value)}}toString(){return st(this.toJSON())}[Le](){return this.toJSON()}[Symbol.iterator](){return new Kc(new Nc(this))}}const ir=e=>X(e,Vi),qe=e=>{const t=new Wt($T);return t.effect_instruction_i0=e,t},VI=y(3,(e,t,n)=>or(r=>M(e,s=>M(ts(de(()=>r(t(s)))),o=>de(()=>n(s,o)).pipe(jn({onFailure:a=>{switch(o._tag){case Zt:return $t(zt(o.effect_instruction_i0,a));case en:return $t(a)}},onSuccess:()=>o})))))),Ht=y(2,(e,t)=>M(e,()=>W(t))),Hn=e=>Ht(e,void 0),WI=function(){const e=new Wt(sf);switch(arguments.length){case 2:{e.effect_instruction_i0=arguments[0],e.commit=arguments[1];break}case 3:{e.effect_instruction_i0=arguments[0],e.effect_instruction_i1=arguments[1],e.commit=arguments[2];break}case 4:{e.effect_instruction_i0=arguments[0],e.effect_instruction_i1=arguments[1],e.effect_instruction_i2=arguments[2],e.commit=arguments[3];break}default:throw new Error(Ip("you're not supposed to end up here"))}return e},ml=(e,t=On)=>{const n=new Wt(Bu);let r;return n.effect_instruction_i0=s=>{r=e(s)},n.effect_instruction_i1=t,ca(n,s=>ir(r)?r:Ve)},po=(e,t=On)=>de(()=>ml(e,t)),Fr=(e,t=On)=>WI(e,function(){let n,r;function s(f){n?n(f):r===void 0&&(r=f)}const o=new Wt(Bu);o.effect_instruction_i0=f=>{n=f,r&&f(r)},o.effect_instruction_i1=t;let a,u;return this.effect_instruction_i0.length!==1?(u=new AbortController,a=ct(()=>this.effect_instruction_i0(s,u.signal))):a=ct(()=>this.effect_instruction_i0(s)),a||u?ca(o,f=>(u&&u.abort(),a??Ve)):o}),dm=y(2,(e,t)=>{const n=new Wt(Pd);return n.effect_instruction_i0=e,n.effect_instruction_i1=t,n}),yc=y(2,(e,t)=>Ws(e,{onFailure:t,onSuccess:W})),KI=y(3,(e,t,n)=>dm(e,r=>{const s=RS(r);switch(s._tag){case"Left":return t(s.left)?n(s.left):$t(r);case"Right":return $t(s.right)}})),C0=Symbol.for("effect/OriginalAnnotation"),AS=(e,t)=>nt(t)?new Proxy(e,{has(n,r){return r===_c||r===C0||r in n},get(n,r){return r===_c?t.value:r===C0?e:n[r]}}):e,gl=e=>hs(e)&&!(_c in e)?qe(t=>$t(Rn(AS(e,HS(t))))):$t(Rn(e)),uy=e=>JI(()=>Rn(new _z(e))),bc=e=>Ws(e,{onFailure:t=>W(se(t)),onSuccess:t=>W(ie(t))}),ts=e=>GI(e,{onFailure:Ye,onSuccess:Be}),ht=e=>hs(e)&&!(_c in e)?qe(t=>$t(Hi(AS(e,HS(t))))):$t(Hi(e)),Sf=e=>M(B(e),ht),$t=e=>{const t=new BI(Zt);return t.effect_instruction_i0=e,t},JI=e=>M(B(e),$t),hm=qe(e=>W(e.id())),aa=e=>qe(t=>e(t.id())),M=y(2,(e,t)=>{const n=new Wt(lh);return n.effect_instruction_i0=e,n.effect_instruction_i1=t,n}),MU=y(2,(e,t)=>M(e,n=>{const r=typeof t=="function"?t(n):t;return ir(r)?r:gT(r)?ml(s=>{r.then(o=>s(W(o)),o=>s(ht(new Em(o,"An unknown error occurred in Effect.andThen"))))}):W(r)})),LU=e=>{const t=new Wt("OnStep");return t.effect_instruction_i0=e,t},Jc=e=>M(e,oe),GI=y(2,(e,t)=>jn(e,{onFailure:n=>W(t.onFailure(n)),onSuccess:n=>W(t.onSuccess(n))})),jn=y(2,(e,t)=>{const n=new Wt(fh);return n.effect_instruction_i0=e,n.effect_instruction_i1=t.onFailure,n.effect_instruction_i2=t.onSuccess,n}),Ws=y(2,(e,t)=>jn(e,{onFailure:n=>{if(NI(n).length>0)return $t(kU(n));const s=wU(n);return s.length>0?t.onFailure(Hp(s)):$t(n)},onSuccess:t.onSuccess})),$s=y(2,(e,t)=>de(()=>{const n=Me(e),r=Fp(n.length);let s=0;return Ht(xS({while:()=>s<n.length,body:()=>t(n[s],s),step:o=>{r[s++]=o}}),r)})),Sc=y(2,(e,t)=>de(()=>{const n=Me(e);let r=0;return xS({while:()=>r<n.length,body:()=>t(n[r],r),step:()=>{r++}})})),rn=M(hm,e=>QI(e)),QI=e=>$t(pr(e)),pm=e=>{const t=new Wt(Dc);return t.effect_instruction_i0=nU(Bc),t.effect_instruction_i1=()=>e,t},YI=y(2,(e,t)=>or(n=>M(ts(n(e)),r=>f1(t,r)))),ge=y(2,(e,t)=>M(e,n=>B(()=>t(n)))),FS=y(2,(e,t)=>Ws(e,{onFailure:n=>Sf(()=>t.onFailure(n)),onSuccess:n=>B(()=>t.onSuccess(n))})),mm=y(2,(e,t)=>jn(e,{onFailure:n=>{const r=RS(n);switch(r._tag){case"Left":return Sf(()=>t(r.left));case"Right":return $t(r.right)}},onSuccess:W})),jU=y(2,(e,t)=>is(e,n=>u1(n)?Ve:t(n.effect_instruction_i0))),is=y(2,(e,t)=>or(n=>jn(n(e),{onFailure:r=>{const s=Ye(r);return jn(t(s),{onFailure:o=>Ye(zt(r,o)),onSuccess:()=>s})},onSuccess:r=>{const s=Be(r);return wt(t(s),s)}}))),ca=y(2,(e,t)=>is(e,$m({onFailure:n=>am(n)?Hn(t(OS(n))):Ve,onSuccess:()=>Ve}))),PS=e=>UU(e,oe),UU=y(2,(e,t)=>Ws(e,{onFailure:n=>gl(t(n)),onSuccess:W})),zU=qe((e,t)=>W(t.runtimeFlags)),W=e=>{const t=new HI(en);return t.effect_instruction_i0=e,t},de=e=>{const t=new Wt(sf);return t.commit=e,t},B=e=>{const t=new Wt(kT);return t.effect_instruction_i0=e,t},gm=y(e=>e.length===3||e.length===2&&!(hs(e[1])&&"onlyEffect"in e[1]),(e,t)=>M(e,n=>{const r=typeof t=="function"?t(n):t;return ir(r)?Ht(r,n):gT(r)?ml(s=>{r.then(o=>s(W(n)),o=>s(ht(new Em(o,"An unknown error occurred in Effect.tap"))))}):W(n)})),BU=e=>qe(t=>{const n=t.getFiberRef(fy),r=b(n,pt(()=>t.scope()));return e(to(fy,V(r)))}),Lo=e=>{const t=new Wt(Dc);return t.effect_instruction_i0=RI(Bc),t.effect_instruction_i1=()=>e,t},or=e=>WI(e,function(){const t=new Wt(Dc);return t.effect_instruction_i0=RI(Bc),t.effect_instruction_i1=n=>II(n)?ct(()=>this.effect_instruction_i0(pm)):ct(()=>this.effect_instruction_i0(Lo)),t}),Ve=W(void 0),XI=e=>{const t=new Wt(Dc);return t.effect_instruction_i0=e,t.effect_instruction_i1=void 0,t},wf=y(2,(e,t)=>M(t,n=>n?b(e,ge(V)):W(H()))),xS=e=>{const t=new Wt(dh);return t.effect_instruction_i0=e.while,t.effect_instruction_i1=e.body,t.effect_instruction_i2=e.step,t},Ch=e=>de(()=>{const t=new Wt(Hu);return t.effect_instruction_i0=e(),t}),HU=function(){const e=arguments.length===1?arguments[0]:arguments[1].bind(arguments[0]);return Ch(()=>e(b))},VU=(e,...t)=>Object.defineProperty(t.length===0?function(...n){return Ch(()=>e.apply(this,n))}:function(...n){let r=Ch(()=>e.apply(this,n));for(const s of t)r=s(r,...n);return r},"length",{value:e.length,configurable:!0}),WU=y(2,(e,t)=>{const n=new Wt(Dc);return n.effect_instruction_i0=t,n.effect_instruction_i1=()=>e,n}),_m=e=>{const t=new Wt(xd);return typeof e?.priority<"u"?uz(t,e.priority):t},ym=y(2,(e,t)=>M(e,n=>ge(t,r=>[n,r]))),NS=y(2,(e,t)=>M(e,n=>Ht(t,n))),wt=y(2,(e,t)=>M(e,()=>t)),ZI=y(3,(e,t,n)=>M(e,r=>ge(t,s=>n(r,s)))),KU=po(()=>{const e=setInterval(()=>{},2147483647);return B(()=>clearInterval(e))}),DS=e=>M(hm,t=>b(e,Ts(t))),Ts=y(2,(e,t)=>M(e.interruptAsFork(t),()=>e.await)),JU={_tag:"All",syslog:0,label:"ALL",ordinal:Number.MIN_SAFE_INTEGER,pipe(){return Y(this,arguments)}},GU={_tag:"Fatal",syslog:2,label:"FATAL",ordinal:5e4,pipe(){return Y(this,arguments)}},QU={_tag:"Error",syslog:3,label:"ERROR",ordinal:4e4,pipe(){return Y(this,arguments)}},YU={_tag:"Warning",syslog:4,label:"WARN",ordinal:3e4,pipe(){return Y(this,arguments)}},e1={_tag:"Info",syslog:6,label:"INFO",ordinal:2e4,pipe(){return Y(this,arguments)}},t1={_tag:"Debug",syslog:7,label:"DEBUG",ordinal:1e4,pipe(){return Y(this,arguments)}},XU={_tag:"Trace",syslog:7,label:"TRACE",ordinal:0,pipe(){return Y(this,arguments)}},ZU={_tag:"None",syslog:7,label:"OFF",ordinal:Number.MAX_SAFE_INTEGER,pipe(){return Y(this,arguments)}},ez="effect/FiberRef",tz=Symbol.for(ez),nz={_A:e=>e},vf=e=>qe(t=>Be(t.getFiberRef(e))),Gc=y(2,(e,t)=>M(vf(e),t)),Ih=y(2,(e,t)=>rz(e,()=>[void 0,t])),rz=y(2,(e,t)=>qe(n=>{const[r,s]=t(n.getFiberRef(e));return n.setFiberRef(e,s),W(r)})),to=y(3,(e,t,n)=>VI(NS(vf(t),Ih(t,n)),()=>e,r=>Ih(t,r))),bm=y(3,(e,t,n)=>Gc(t,r=>to(e,t,n(r)))),an=(e,t)=>Qc(e,{differ:kI(),fork:t?.fork??oe,join:t?.join}),sz=e=>{const t=Uj();return Qc(e,{differ:t,fork:t.empty})},oz=e=>{const t=zj(kI());return Qc(e,{differ:t,fork:t.empty})},n1=e=>{const t=jj();return Qc(e,{differ:t,fork:t.empty})},Qc=(e,t)=>({...af,[tz]:nz,initial:e,commit(){return vf(this)},diff:(r,s)=>t.differ.diff(r,s),combine:(r,s)=>t.differ.combine(r,s),patch:r=>s=>t.differ.patch(r,s),fork:t.fork,join:t.join??((r,s)=>s)}),iz=e=>Qc(e,{differ:v0,fork:v0.empty}),Dr=Se(Symbol.for("effect/FiberRef/currentContext"),()=>n1(js())),jo=Se(Symbol.for("effect/FiberRef/currentSchedulingPriority"),()=>an(0)),Sm=Se(Symbol.for("effect/FiberRef/currentMaxOpsBeforeYield"),()=>an(2048)),r1=Se(Symbol.for("effect/FiberRef/currentLogAnnotation"),()=>an(rm())),az=Se(Symbol.for("effect/FiberRef/currentLogLevel"),()=>an(e1)),cz=Se(Symbol.for("effect/FiberRef/currentLogSpan"),()=>an(hc())),uz=y(2,(e,t)=>to(e,jo,t)),lz=y(2,(e,t)=>to(e,Sm,t)),fz=Se(Symbol.for("effect/FiberRef/currentConcurrency"),()=>an("unbounded")),dz=Se(Symbol.for("effect/FiberRef/currentRequestBatching"),()=>an(!0)),s1=Se(Symbol.for("effect/FiberRef/currentUnhandledErrorLogLevel"),()=>an(V(t1))),hz=y(2,(e,t)=>to(e,s1,t)),ly=Se(Symbol.for("effect/FiberRef/currentMetricLabels"),()=>oz(ko())),fy=Se(Symbol.for("effect/FiberRef/currentForkScopeOverride"),()=>an(H(),{fork:()=>H(),join:(e,t)=>e})),gd=Se(Symbol.for("effect/FiberRef/currentInterruptedCause"),()=>an(Hs,{fork:()=>Hs,join:(e,t)=>e})),o1=Se(Symbol.for("effect/FiberRef/currentTracerEnabled"),()=>an(!0)),wm=Se(Symbol.for("effect/FiberRef/currentTracerTiming"),()=>an(!0)),i1=Se(Symbol.for("effect/FiberRef/currentTracerSpanAnnotations"),()=>an(rm())),pz=Se(Symbol.for("effect/FiberRef/currentTracerSpanLinks"),()=>an(lt())),I0=Symbol.for("effect/Scope"),O0=Symbol.for("effect/CloseableScope"),a1=(e,t)=>e.addFinalizer(()=>Hn(t)),_l=(e,t)=>e.addFinalizer(t),dy=(e,t)=>e.close(t),vm=(e,t)=>e.fork(t),mz=e=>gz(oe)(e),gz=y(2,(e,t)=>{const n=b(e,DI,yo(t));switch(n._tag){case"None":return b(NI(e),Bp,Xe({onNone:()=>{const r=Me(OS(e)).flatMap(s=>Me(nm(s)).map(o=>`#${o}`));return new yz(r?`Interrupted by fibers: ${r.join(", ")}`:void 0)},onSome:oe}));case"Some":return n.value}}),MS=function(){class e extends globalThis.Error{commit(){return ht(this)}toJSON(){const n={...this};return this.message&&(n.message=this.message),this.cause&&(n.cause=this.cause),n}[Le](){return this.toString!==globalThis.Error.prototype.toString?this.stack?`${this.toString()}
${this.stack.split(`
`).slice(1).join(`
`)}`:this.toString():"Bun"in globalThis?Mo(Hi(this),{renderErrorCause:!0}):this}}return Object.assign(e.prototype,Q2),e}(),Ef=(e,t)=>{class n extends MS{_tag=t}return Object.assign(n.prototype,e),n.prototype.name=t,n},R0=Symbol.for("effect/Cause/errors/RuntimeException"),_z=Ef({[R0]:R0},"RuntimeException"),hy=Symbol.for("effect/Cause/errors/InterruptedException"),yz=Ef({[hy]:hy},"InterruptedException"),bz=e=>X(e,hy),q0=Symbol.for("effect/Cause/errors/IllegalArgument"),Sz=Ef({[q0]:q0},"IllegalArgumentException"),A0=Symbol.for("effect/Cause/errors/NoSuchElement"),kf=Ef({[A0]:A0},"NoSuchElementException"),F0=Symbol.for("effect/Cause/errors/Timeout"),wz=Ef({[F0]:F0},"TimeoutException"),vz=e=>new wz(`Operation timed out after '${XC(e)}'`),P0=Symbol.for("effect/Cause/errors/UnknownException"),Em=function(){class e extends MS{_tag="UnknownException";error;constructor(n,r){super(r??"An unknown error occurred",{cause:n}),this.error=n}}return Object.assign(e.prototype,{[P0]:P0,name:"UnknownException"}),e}(),km=e=>ir(e)&&"_tag"in e&&(e._tag==="Success"||e._tag==="Failure"),c1=e=>e._tag==="Failure",u1=e=>e._tag==="Success",Ez=e=>{switch(e._tag){case Zt:return IS(e.effect_instruction_i0);case en:return!1}},Hd=y(2,(e,t)=>{switch(e._tag){case Zt:return Ye(e.effect_instruction_i0);case en:return Be(t)}}),n_=e=>Hd(e,void 0),Ga=(e,t)=>Tz(e,t?.parallel?Vs:zt),Da=e=>Ye(Rn(e)),yl=e=>Ye(Hi(e)),Ye=e=>{const t=new BI(Zt);return t.effect_instruction_i0=e,t},LS=e=>Ye(pr(e)),Vd=y(2,(e,t)=>{switch(e._tag){case Zt:return Ye(e.effect_instruction_i0);case en:return Be(t(e.effect_instruction_i0))}}),kz=y(2,(e,{onFailure:t,onSuccess:n})=>{switch(e._tag){case Zt:return Ye(b(e.effect_instruction_i0,MI(t)));case en:return Be(n(e.effect_instruction_i0))}}),$m=y(2,(e,{onFailure:t,onSuccess:n})=>{switch(e._tag){case Zt:return t(e.effect_instruction_i0);case en:return n(e.effect_instruction_i0)}}),py=y(2,(e,{onFailure:t,onSuccess:n})=>{switch(e._tag){case Zt:return t(e.effect_instruction_i0);case en:return n(e.effect_instruction_i0)}}),Be=e=>{const t=new HI(en);return t.effect_instruction_i0=e,t},bn=Be(void 0),$z=y(2,(e,t)=>jS(e,t,{onSuccess:(n,r)=>[n,r],onFailure:zt})),l1=y(2,(e,t)=>jS(e,t,{onSuccess:(n,r)=>r,onFailure:zt})),jS=y(3,(e,t,{onFailure:n,onSuccess:r})=>{switch(e._tag){case Zt:switch(t._tag){case en:return Ye(e.effect_instruction_i0);case Zt:return Ye(n(e.effect_instruction_i0,t.effect_instruction_i0))}case en:switch(t._tag){case en:return Be(r(e.effect_instruction_i0,t.effect_instruction_i0));case Zt:return Ye(t.effect_instruction_i0)}}}),Tz=(e,t)=>{const n=Us(e);return Bs(n)?b(ks(n),Yb(b(Yr(n),Vd(rt)),(r,s)=>b(r,jS(s,{onSuccess:(o,a)=>b(o,pn(a)),onFailure:t}))),Vd(zs),Vd(r=>er(r)),V):H()},Yc=e=>({...af,[FU]:PU,state:sa(xU([])),commit(){return Pr(this)},blockingOn:e}),Xc=()=>M(hm,e=>Cz(e)),Cz=e=>B(()=>Yc(e)),Pr=e=>po(t=>{const n=je(e.state);switch(n._tag){case fm:return t(n.effect);case bf:return n.joiners.push(t),Rz(e,t)}},e.blockingOn),$f=y(2,(e,t)=>B(()=>{const n=je(e.state);switch(n._tag){case fm:return!1;case bf:{oa(e.state,UI(t));for(let r=0,s=n.joiners.length;r<s;r++)n.joiners[r](t);return!0}}})),f1=y(2,(e,t)=>$f(e,t)),Iz=y(2,(e,t)=>$f(e,ht(t))),d1=y(2,(e,t)=>$f(e,$t(t))),US=y(2,(e,t)=>$f(e,QI(t))),Oz=e=>B(()=>je(e.state)._tag===fm),Tf=y(2,(e,t)=>$f(e,W(t))),Cf=(e,t)=>{const n=je(e.state);if(n._tag===bf){oa(e.state,UI(t));for(let r=0,s=n.joiners.length;r<s;r++)n.joiners[r](t)}},Rz=(e,t)=>B(()=>{const n=je(e.state);if(n._tag===bf){const r=n.joiners.indexOf(t);r>=0&&n.joiners.splice(r,1)}}),qz=qe(e=>Be(e.currentContext)),If=()=>qz,Zc=e=>M(If(),e),zS=y(2,(e,t)=>to(Dr,t)(e)),BS=y(2,(e,t)=>bm(Dr,n=>eo(n,t))(e)),h1=y(2,(e,t)=>Zc(n=>zS(e,t(n)))),HS=e=>{const t=e.currentSpan;return t!==void 0&&t._tag==="Span"?V(t):H()},Az={_tag:"Span",spanId:"noop",traceId:"noop",sampled:!1,status:{_tag:"Ended",startTime:BigInt(0),endTime:BigInt(0),exit:bn},attributes:new Map,links:[],kind:"internal",attribute(){},event(){},end(){},addLinks(){}},Fz=e=>Object.assign(Object.create(Az),e),Ue=Xc,Nt=Pr,ua=f1,p1=Iz,m1=d1,my=Oz,vt=Tf,Pz=Yc,li=Cf,xz=km,eu=c1,wc=u1,Nz=Ez,Dz=Ga,bl=Da,Of=yl,Xt=Ye,Mz=LS,Lz=Vd,jz=kz,qr=$m,Mt=Be,Un=bn,x0=$z,Sl=l1,N0=Symbol.for("effect/MutableHashMap"),Uz={[N0]:N0,[Symbol.iterator](){return new VS(this)},toString(){return st(this.toJSON())},toJSON(){return{_id:"MutableHashMap",values:Array.from(this).map(yt)}},[Le](){return this.toJSON()},pipe(){return Y(this,arguments)}};class VS{self;referentialIterator;bucketIterator;constructor(t){this.self=t,this.referentialIterator=t.referential[Symbol.iterator]()}next(){if(this.bucketIterator!==void 0)return this.bucketIterator.next();const t=this.referentialIterator.next();return t.done?(this.bucketIterator=new zz(this.self.buckets.values()),this.next()):t}[Symbol.iterator](){return new VS(this.self)}}class zz{backing;constructor(t){this.backing=t}currentBucket;next(){if(this.currentBucket===void 0){const n=this.backing.next();if(n.done)return n;this.currentBucket=n.value[Symbol.iterator]()}const t=this.currentBucket.next();return t.done?(this.currentBucket=void 0,this.next()):t}}const g1=()=>{const e=Object.create(Uz);return e.referential=new Map,e.buckets=new Map,e.bucketsSize=0,e},Br=y(2,(e,t)=>{if(ol(t)===!1)return e.referential.has(t)?V(e.referential.get(t)):H();const n=t[he](),r=e.buckets.get(n);return r===void 0?H():Bz(e,r,t)}),Bz=(e,t,n,r=!1)=>{for(let s=0,o=t.length;s<o;s++)if(n[pe](t[s][0])){const a=t[s][1];return r&&(t.splice(s,1),e.bucketsSize--),V(a)}return H()},Ra=y(2,(e,t)=>nt(Br(e,t))),qa=y(3,(e,t,n)=>{if(ol(t)===!1)return e.referential.set(t,n),e;const r=t[he](),s=e.buckets.get(r);return s===void 0?(e.buckets.set(r,[[t,n]]),e.bucketsSize++,e):(_1(e,s,t),s.push([t,n]),e.bucketsSize++,e)}),_1=(e,t,n)=>{for(let r=0,s=t.length;r<s;r++)if(n[pe](t[r][0])){t.splice(r,1),e.bucketsSize--;return}},Hz=y(2,(e,t)=>{if(ol(t)===!1)return e.referential.delete(t),e;const n=t[he](),r=e.buckets.get(n);return r===void 0||(_1(e,r,t),r.length===0&&e.buckets.delete(n)),e}),D0=Symbol.for("effect/MutableList"),Vz={[D0]:D0,[Symbol.iterator](){let e=!1,t=this.head;return{next(){if(e)return this.return();if(t==null)return e=!0,this.return();const n=t.value;return t=t.next,{done:e,value:n}},return(n){return e||(e=!0),{done:!0,value:n}}}},toString(){return st(this.toJSON())},toJSON(){return{_id:"MutableList",values:Array.from(this).map(yt)}},[Le](){return this.toJSON()},pipe(){return Y(this,arguments)}},Wz=e=>({value:e,removed:!1,prev:void 0,next:void 0}),Kz=()=>{const e=Object.create(Vz);return e.head=void 0,e.tail=void 0,e._length=0,e},y1=e=>WS(e)===0,WS=e=>e._length,Jz=y(2,(e,t)=>{const n=Wz(t);return e.head===void 0&&(e.head=n),e.tail===void 0||(e.tail.next=n,n.prev=e.tail),e.tail=n,e._length+=1,e}),Gz=e=>{const t=e.head;if(t!==void 0)return Qz(e,t),t.value},Qz=(e,t)=>{t.removed||(t.removed=!0,t.prev!==void 0&&t.next!==void 0?(t.prev.next=t.next,t.next.prev=t.prev):t.prev!==void 0?(e.tail=t.prev,t.prev.next=void 0):t.next!==void 0?(e.head=t.next,t.next.prev=void 0):(e.tail=void 0,e.head=void 0),e._length>0&&(e._length-=1))},M0=Symbol.for("effect/MutableQueue"),Dt=Symbol.for("effect/mutable/MutableQueue/Empty"),Yz={[M0]:M0,[Symbol.iterator](){return Array.from(this.queue)[Symbol.iterator]()},toString(){return st(this.toJSON())},toJSON(){return{_id:"MutableQueue",values:Array.from(this).map(yt)}},[Le](){return this.toJSON()},pipe(){return Y(this,arguments)}},b1=e=>{const t=Object.create(Yz);return t.queue=Kz(),t.capacity=e,t},KS=e=>b1(e),Tm=()=>b1(void 0),JS=e=>WS(e.queue),wi=e=>y1(e.queue),Xz=e=>e.capacity===void 0?1/0:e.capacity,vc=y(2,(e,t)=>{const n=WS(e.queue);return e.capacity!==void 0&&n===e.capacity?!1:(Jz(t)(e.queue),!0)}),GS=y(2,(e,t)=>{const n=t[Symbol.iterator]();let r,s=lt(),o=!0;for(;o&&(r=n.next())&&!r.done;)o=vc(r.value)(e);for(;r!=null&&!r.done;)s=pn(r.value)(s),r=n.next();return zs(s)}),Ps=y(2,(e,t)=>y1(e.queue)?t:Gz(e.queue)),Cm=y(2,(e,t)=>{let n=lt(),r=0;for(;r<t;){const s=Ps(Dt)(e);if(s===Dt)break;n=pn(s)(n),r+=1}return zs(n)}),Zz="effect/Clock",L0=Symbol.for(Zz),la=Bn("effect/Clock"),eB=2**31-1,j0={unsafeSchedule(e,t){const n=cc(t);if(n>eB)return Nn;let r=!1;const s=setTimeout(()=>{r=!0,e()},n);return()=>(clearTimeout(s),!r)}},U0=function(){const e=BigInt(1e6);if(typeof performance>"u")return()=>BigInt(Date.now())*e;let t;return()=>(t===void 0&&(t=BigInt(Date.now())*e-BigInt(Math.round(performance.now()*1e6))),t+BigInt(Math.round(performance.now()*1e6)))}(),tB=function(){const e=typeof process=="object"&&"hrtime"in process&&typeof process.hrtime.bigint=="function"?process.hrtime:void 0;if(!e)return U0;const t=U0()-e.bigint();return()=>t+e.bigint()}();class nB{[L0]=L0;unsafeCurrentTimeMillis(){return Date.now()}unsafeCurrentTimeNanos(){return tB()}currentTimeMillis=B(()=>this.unsafeCurrentTimeMillis());currentTimeNanos=B(()=>this.unsafeCurrentTimeNanos());scheduler(){return W(j0)}sleep(t){return Fr(n=>{const r=j0.unsafeSchedule(()=>n(Ve),t);return Hn(B(r))})}}const rB=()=>new nB,S1="And",w1="Or",v1="InvalidData",E1="MissingData",k1="SourceUnavailable",$1="Unsupported",sB="effect/ConfigError",z0=Symbol.for(sB),tu={_tag:"ConfigError",[z0]:z0},T1=(e,t)=>{const n=Object.create(tu);return n._op=S1,n.left=e,n.right=t,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`${this.left} and ${this.right}`}}),Object.defineProperty(n,"message",{enumerable:!1,get(){return this.toString()}}),n},C1=(e,t)=>{const n=Object.create(tu);return n._op=w1,n.left=e,n.right=t,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`${this.left} or ${this.right}`}}),Object.defineProperty(n,"message",{enumerable:!1,get(){return this.toString()}}),n},oB=(e,t,n={pathDelim:"."})=>{const r=Object.create(tu);return r._op=v1,r.path=e,r.message=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Invalid data at ${b(this.path,ra(n.pathDelim))}: "${this.message}")`}}),r},Wi=(e,t,n={pathDelim:"."})=>{const r=Object.create(tu);return r._op=E1,r.path=e,r.message=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Missing data at ${b(this.path,ra(n.pathDelim))}: "${this.message}")`}}),r},iB=(e,t,n,r={pathDelim:"."})=>{const s=Object.create(tu);return s._op=k1,s.path=e,s.message=t,s.cause=n,Object.defineProperty(s,"toString",{enumerable:!1,value(){return`(Source unavailable at ${b(this.path,ra(r.pathDelim))}: "${this.message}")`}}),s},aB=(e,t,n={pathDelim:"."})=>{const r=Object.create(tu);return r._op=$1,r.path=e,r.message=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Unsupported operation at ${b(this.path,ra(n.pathDelim))}: "${this.message}")`}}),r},fi=y(2,(e,t)=>{switch(e._op){case S1:return T1(fi(e.left,t),fi(e.right,t));case w1:return C1(fi(e.left,t),fi(e.right,t));case v1:return oB([...t,...e.path],e.message);case E1:return Wi([...t,...e.path],e.message);case k1:return iB([...t,...e.path],e.message,e.cause);case $1:return aB([...t,...e.path],e.message)}}),cB={_tag:"Empty"},r_=y(2,(e,t)=>{let n=ES(t),r=e;for(;vS(n);){const s=n.head;switch(s._tag){case"Empty":{n=n.tail;break}case"AndThen":{n=zi(s.first,zi(s.second,n.tail));break}case"MapName":{r=qs(r,s.f),n=n.tail;break}case"Nested":{r=hh(r,s.name),n=n.tail;break}case"Unnested":{if(b(Ba(r),S3(s.name)))r=Pi(r),n=n.tail;else return se(Wi(r,`Expected ${s.name} to be in path in ConfigProvider#unnested`));break}}}return ie(r)}),uB="Constant",lB="Fail",fB="Fallback",dB="Described",hB="Lazy",pB="MapOrFail",mB="Nested",gB="Primitive",_B="Sequence",yB="HashMap",bB="ZipWith";var B0={};const Oh=(e,t)=>[...e,...t],SB="effect/ConfigProvider",H0=Symbol.for(SB),wB=Bn("effect/ConfigProvider"),vB="effect/ConfigProviderFlat",V0=Symbol.for(vB),EB=e=>({[H0]:H0,pipe(){return Y(this,arguments)},...e}),kB=e=>({[V0]:V0,patch:e.patch,load:(t,n,r=!0)=>e.load(t,n,r),enumerateChildren:e.enumerateChildren}),$B=e=>EB({load:t=>M(fr(e,ko(),t,!1),n=>Xe(Ba(n),{onNone:()=>ht(Wi(ko(),`Expected a single value having structure: ${t}`)),onSome:W})),flattened:e}),TB=e=>{const{pathDelim:t,seqDelim:n}=Object.assign({},{pathDelim:"_",seqDelim:","},e),r=f=>b(f,ra(t)),s=f=>f.split(t),o=()=>typeof process<"u"&&"env"in process&&typeof B0=="object"?B0:{};return $B(kB({load:(f,d,p=!0)=>{const m=r(f),$=o(),C=m in $?V($[m]):H();return b(C,mm(()=>Wi(f,`Expected ${m} to exist in the process context`)),M(O=>qB(O,f,d,n,p)))},enumerateChildren:f=>B(()=>{const d=o(),$=Object.keys(d).map(C=>s(C.toUpperCase())).filter(C=>{for(let O=0;O<f.length;O++){const N=b(f,UT(O)),v=C[O];if(v===void 0||N!==v)return!1}return!0}).flatMap(C=>C.slice(f.length,f.length+1));return $L($)}),patch:cB}))},CB=(e,t,n,r)=>{const s=t0(n.length,f=>f>=r.length?H():V([e(f),f+1])),o=t0(r.length,f=>f>=n.length?H():V([t(f),f+1])),a=Oh(n,s),u=Oh(r,o);return[a,u]},IB=(e,t)=>{let n=t;if(n._tag==="Nested"){const r=e.slice();for(;n._tag==="Nested";)r.push(n.name),n=n.config;return r}return e},fr=(e,t,n,r)=>{const s=n;switch(s._tag){case uB:return W(Qn(s.value));case dB:return de(()=>fr(e,t,s.config,r));case lB:return ht(Wi(t,s.message));case fB:return b(de(()=>fr(e,t,s.first,r)),yc(o=>s.condition(o)?b(fr(e,t,s.second,r),yc(a=>ht(C1(o,a)))):ht(o)));case hB:return de(()=>fr(e,t,s.config(),r));case pB:return de(()=>b(fr(e,t,s.original,r),M($s(o=>b(s.mapOrFail(o),mm(fi(IB(t,s.original))))))));case mB:return de(()=>fr(e,Oh(t,Qn(s.name)),s.config,r));case gB:return b(r_(t,e.patch),M(o=>b(e.load(o,s,r),M(a=>{if(a.length===0){const u=b(L3(o),pt(()=>"<n/a>"));return ht(Wi([],`Expected ${s.description} with name ${u}`))}return W(a)}))));case _B:return b(r_(t,e.patch),M(o=>b(e.enumerateChildren(o),M(FB),M(a=>a.length===0?de(()=>ge(fr(e,t,s.config,!0),Qn)):b($s(a,u=>fr(e,F3(t,`[${u}]`),s.config,!0)),ge(u=>{const f=Y3(u);return f.length===0?Qn(ko()):Qn(f)}))))));case yB:return de(()=>b(r_(t,e.patch),M(o=>b(e.enumerateChildren(o),M(a=>b(a,$s(u=>fr(e,Oh(o,Qn(u)),s.valueConfig,r)),ge(u=>u.length===0?Qn(rm()):b(AB(u),qs(f=>LL(e0(Me(a),f)))))))))));case bB:return de(()=>b(fr(e,t,s.left,r),bc,M(o=>b(fr(e,t,s.right,r),bc,M(a=>{if(Kt(o)&&Kt(a))return ht(T1(o.left,a.left));if(Kt(o)&&Qr(a))return ht(o.left);if(Qr(o)&&Kt(a))return ht(a.left);if(Qr(o)&&Qr(a)){const u=b(t,ra(".")),f=OB(t,u),[d,p]=CB(f,f,b(o.right,qs(ie)),b(a.right,qs(ie)));return b(d,e0(p),$s(([m,$])=>b(ym(m,$),ge(([C,O])=>s.zip(C,O)))))}throw new Error("BUG: ConfigProvider.fromFlatLoop - please report an issue at https://github.com/Effect-TS/effect/issues")})))))}},OB=(e,t)=>n=>se(Wi(e,`The element at index ${n} in a sequence at path "${t}" was missing`)),RB=(e,t)=>e.split(new RegExp(`\\s*${mh(t)}\\s*`)),qB=(e,t,n,r,s)=>s?b(RB(e,r),$s(o=>n.parse(o.trim())),mm(fi(t))):b(n.parse(e),FS({onFailure:fi(t),onSuccess:Qn})),AB=e=>Object.keys(e[0]).map(t=>e.map(n=>n[t])),FB=e=>b($s(e,xB),FS({onFailure:()=>ko(),onSuccess:il(oc)}),bc,ge(c3)),PB=/^(\[(\d+)\])$/,xB=e=>{const t=e.match(PB);if(t!==null){const n=t[2];return b(n!==void 0&&n.length>0?V(n):H(),Mc(NB))}return H()},NB=e=>{const t=Number.parseInt(e);return Number.isNaN(t)?H():V(t)},W0=Symbol.for("effect/Console"),Im=Bn("effect/Console"),DB={[W0]:W0,assert(e,...t){return B(()=>{console.assert(e,...t)})},clear:B(()=>{console.clear()}),count(e){return B(()=>{console.count(e)})},countReset(e){return B(()=>{console.countReset(e)})},debug(...e){return B(()=>{console.debug(...e)})},dir(e,t){return B(()=>{console.dir(e,t)})},dirxml(...e){return B(()=>{console.dirxml(...e)})},error(...e){return B(()=>{console.error(...e)})},group(e){return e?.collapsed?B(()=>console.groupCollapsed(e?.label)):B(()=>console.group(e?.label))},groupEnd:B(()=>{console.groupEnd()}),info(...e){return B(()=>{console.info(...e)})},log(...e){return B(()=>{console.log(...e)})},table(e,t){return B(()=>{console.table(e,t)})},time(e){return B(()=>console.time(e))},timeEnd(e){return B(()=>console.timeEnd(e))},timeLog(e,...t){return B(()=>{console.timeLog(e,...t)})},trace(...e){return B(()=>{console.trace(...e)})},warn(...e){return B(()=>{console.warn(...e)})},unsafe:console},MB="effect/Random",K0=Symbol.for(MB),LB=Bn("effect/Random");class jB{seed;[K0]=K0;PRNG;constructor(t){this.seed=t,this.PRNG=new P2(t)}get next(){return B(()=>this.PRNG.number())}get nextBoolean(){return ge(this.next,t=>t>.5)}get nextInt(){return B(()=>this.PRNG.integer(Number.MAX_SAFE_INTEGER))}nextRange(t,n){return ge(this.next,r=>(n-t)*r+t)}nextIntBetween(t,n){return B(()=>this.PRNG.integer(n-t)+t)}shuffle(t){return UB(t,n=>this.nextIntBetween(0,n))}}const UB=(e,t)=>de(()=>b(B(()=>Array.from(e)),M(n=>{const r=[];for(let s=n.length;s>=2;s=s-1)r.push(s);return b(r,Sc(s=>b(t(s),ge(o=>zB(n,s-1,o)))),Ht(Us(n)))}))),zB=(e,t,n)=>{const r=e[t];return e[t]=e[n],e[n]=r,e},BB=e=>new jB(J(e)),J0=Symbol.for("effect/Tracer"),I1=e=>({[J0]:J0,...e}),Rf=Bn("effect/Tracer"),as=Bn("effect/ParentSpan"),G0=function(){const e="abcdef0123456789",t=e.length;return function(n){let r="";for(let s=0;s<n;s++)r+=e.charAt(Math.floor(Math.random()*t));return r}}();class HB{name;parent;context;startTime;kind;_tag="Span";spanId;traceId="native";sampled=!0;status;attributes;events=[];links;constructor(t,n,r,s,o,a){this.name=t,this.parent=n,this.context=r,this.startTime=o,this.kind=a,this.status={_tag:"Started",startTime:o},this.attributes=new Map,this.traceId=n._tag==="Some"?n.value.traceId:G0(32),this.spanId=G0(16),this.links=Array.from(s)}end(t,n){this.status={_tag:"Ended",endTime:t,exit:n,startTime:this.status.startTime}}attribute(t,n){this.attributes.set(t,n)}event(t,n,r){this.events.push([t,n,r??{}])}addLinks(t){this.links.push(...t)}}const VB=I1({span:(e,t,n,r,s,o)=>new HB(e,t,n,r,s,o),context:e=>e()}),xs=e=>{if(e?.captureStackTrace===!1)return e;if(e?.captureStackTrace!==void 0&&typeof e.captureStackTrace!="boolean")return e;const t=Error.stackTraceLimit;Error.stackTraceLimit=3;const n=new Error;Error.stackTraceLimit=t;let r=!1;return{...e,captureStackTrace:()=>{if(r!==!1)return r;if(n.stack!==void 0){const s=n.stack.split(`
`);if(s[3]!==void 0)return r=s[3].trim(),r}}}},Rh=Uc()("effect/Tracer/DisablePropagation",{defaultValue:Nn}),WB=b(js(),Kr(la,rB()),Kr(Im,DB),Kr(LB,BB(Math.random())),Kr(wB,TB()),Kr(Rf,VB)),cs=Se(Symbol.for("effect/DefaultServices/currentServices"),()=>n1(WB)),KB=e=>{const t=sr(e);return QS(n=>n.sleep(t))},O1=e=>qe(t=>e(t.currentDefaultServices)),QS=e=>O1(t=>e(t.unsafeMap.get(la.key))),JB=QS(e=>e.currentTimeMillis),GB=e=>O1(t=>e(t.unsafeMap.get(Rf.key))),R1=KB,QB=JB,YB=QS,XB=la;function ZB(e){return new To(e)}function eH(){return ZB(new Map)}const Q0=Symbol.for("effect/FiberRefs");class To{locals;[Q0]=Q0;constructor(t){this.locals=t}pipe(){return Y(this,arguments)}}const tH=(e,t,n,r=!1)=>{const s=e;let o=t,a=n,u=r,f;for(;f===void 0;)if(ft(o)&&ft(a)){const d=In(o)[0],p=Pi(o),m=In(a)[0],$=In(a)[1],C=Pi(a);d.startTimeMillis<m.startTimeMillis?(a=C,u=!0):d.startTimeMillis>m.startTimeMillis?o=p:d.id<m.id?(a=C,u=!0):d.id>m.id?o=p:f=[$,u]}else f=[s.initial,!0];return f},nH=y(3,(e,t,n)=>{const r=new Map(e.locals);return n.locals.forEach((s,o)=>{const a=s[0][1];if(!s[0][0][pe](t)){if(!r.has(o)){if(le(a,o.initial))return;r.set(o,[[t,o.join(o.initial,a)]]);return}const u=r.get(o),[f,d]=tH(o,u,s);if(d){const p=o.diff(f,a),m=u[0][1],$=o.join(m,o.patch(p)(m));if(!le(m,$)){let C;const O=u[0][0];O[pe](t)?C=[[O,$],...u.slice(1)]:C=[[t,$],...u],r.set(o,C)}}}}),new To(r)}),rH=y(2,(e,t)=>{const n=new Map;return q1(e,n,t),new To(n)}),q1=(e,t,n)=>{e.locals.forEach((r,s)=>{const o=r[0][1],a=s.patch(s.fork)(o);le(o,a)?t.set(s,r):t.set(s,[[n,a],...r])})},A1=y(2,(e,t)=>{const n=new Map(e.locals);return n.delete(t),new To(n)}),F1=y(2,(e,t)=>e.locals.has(t)?V(In(e.locals.get(t))[1]):H()),wl=y(2,(e,t)=>b(F1(e,t),pt(()=>t.initial))),gy=y(2,(e,{fiberId:t,fiberRef:n,value:r})=>{if(e.locals.size===0)return new To(new Map([[n,[[t,r]]]]));const s=new Map(e.locals);return _y(s,t,n,r),new To(s)}),_y=(e,t,n,r)=>{const s=e.get(n)??[];let o;if(ft(s)){const[a,u]=In(s);if(a[pe](t)){if(le(u,r))return;o=[[t,r],...s.slice(1)]}else o=[[t,r],...s]}else o=[[t,r]];e.set(n,o)},sH=y(2,(e,{entries:t,forkAs:n})=>{if(e.locals.size===0)return new To(new Map(t));const r=new Map(e.locals);return n!==void 0&&q1(e,r,n),t.forEach(([s,o])=>{o.length===1?_y(r,o[0][0],s,o[0][1]):o.forEach(([a,u])=>{_y(r,a,s,u)})}),new To(r)}),Y0=F1,Om=wl,oH=sH,iH=eH,aH=JU,cH=GU,P1=QU,x1=YU,uH=e1,YS=t1,lH=XU,fH=ZU,dH=b(oc,MT(e=>e.ordinal)),hH=f3(dH),pH=e=>{switch(e){case"All":return aH;case"Debug":return YS;case"Error":return P1;case"Fatal":return cH;case"Info":return uH;case"Trace":return lH;case"None":return fH;case"Warning":return x1}},N1=e=>e.replace(/[\s="]/g,"_"),XS=e=>t=>`${N1(t.label)}=${e-t.startTime}ms`,mH=of,gH=Y2;let no=class extends gH{};const Co=Symbol.for("effect/Readable"),ZS=Symbol.for("effect/Ref"),ew={_A:e=>e};class _H extends no{ref;commit(){return this.get}[ZS]=ew;[Co]=Co;constructor(t){super(),this.ref=t,this.get=B(()=>je(this.ref))}get;modify(t){return B(()=>{const n=je(this.ref),[r,s]=t(n);return n!==s&&oa(s)(this.ref),r})}}const D1=e=>new _H(sa(e)),qh=e=>B(()=>D1(e)),So=e=>e.get,vl=y(2,(e,t)=>e.modify(()=>[void 0,t])),yH=y(2,(e,t)=>e.modify(n=>[n,t])),M1=y(2,(e,t)=>e.modify(t)),yy=y(2,(e,t)=>e.modify(n=>[void 0,t(n)])),bH=ZS,Uo=qh,vi=So,SH=yH,ri=M1,Ec=vl,wH=yy,vH=as,L1=I1,EH=GB,j1="Empty",U1="Add",z1="Remove",B1="Update",H1="AndThen",kH={_tag:j1},tw=(e,t)=>{const n=new Map(e.locals);let r=kH;for(const[s,o]of t.locals.entries()){const a=In(o)[1],u=n.get(s);if(u!==void 0){const f=In(u)[1];le(f,a)||(r=s_({_tag:B1,fiberRef:s,patch:s.diff(f,a)})(r))}else r=s_({_tag:U1,fiberRef:s,value:a})(r);n.delete(s)}for(const[s]of n.entries())r=s_({_tag:z1,fiberRef:s})(r);return r},s_=y(2,(e,t)=>({_tag:H1,first:e,second:t})),V1=y(3,(e,t,n)=>{let r=n,s=Qn(e);for(;ft(s);){const o=In(s),a=Pi(s);switch(o._tag){case j1:{s=a;break}case U1:{r=gy(r,{fiberId:t,fiberRef:o.fiberRef,value:o.value}),s=a;break}case z1:{r=A1(r,o.fiberRef),s=a;break}case B1:{const u=wl(r,o.fiberRef);r=gy(r,{fiberId:t,fiberRef:o.fiberRef,value:o.fiberRef.patch(o.patch)(u)}),s=a;break}case H1:{s=hh(o.first)(hh(o.second)(a));break}}}return r}),W1="effect/MetricLabel",by=Symbol.for(W1);class $H{key;value;[by]=by;_hash;constructor(t,n){this.key=t,this.value=n,this._hash=Ot(W1+this.key+this.value)}[he](){return this._hash}[pe](t){return CH(t)&&this.key===t.key&&this.value===t.value}pipe(){return Y(this,arguments)}}const TH=(e,t)=>new $H(e,t),CH=e=>X(e,by),IH=y(e=>ir(e[0]),function(){const e=arguments;return bm(e[0],r1,typeof e[1]=="string"?dc(e[1],e[2]):t=>Object.entries(e[1]).reduce((n,[r,s])=>dc(n,r,s),t))}),OH=e=>ge(e,V),K1=e=>{let t,n;return typeof e=="function"?t=e:(t=e.try,n=e.catch),de(()=>{try{return W(ct(t))}catch(r){return ht(n?ct(()=>n(r)):new Em(r,"An unknown error occurred in Effect.try"))}})},RH=y(2,(e,t)=>dm(e,n=>{const r=cm(n,s=>TS(s)?V(s):H());switch(r._tag){case"None":return $t(n);case"Some":return t(r.value.defect)}})),qH=y(2,(e,t)=>jn(e,{onFailure:n=>{const r=t(n);switch(r._tag){case"None":return $t(n);case"Some":return r.value}},onSuccess:W})),AH=y(e=>ir(e[0]),(e,...t)=>{const n=t[t.length-1];let r;return t.length===2?r=Ub(t[0]):r=s=>{const o=X(s,"_tag")?s._tag:void 0;if(!o)return!1;for(let a=0;a<t.length-1;a++)if(t[a]===o)return!0;return!1},KI(e,r,n)}),FH=YB,PH=FH(W),xH=y(2,(e,t)=>wt(R1(t),e)),NH=e=>Z1(e,G1,tw),DH=e=>Z1(e,ym(G1,zU),([t,n],[r,s])=>[tw(t,r),bo(n,s)]),J1=y(2,(e,t)=>Ws(e,{onFailure:n=>W(t.onFailure(n)),onSuccess:n=>W(t.onSuccess(n))})),MH=e=>{const t=M(M(e,()=>_m()),()=>t);return t},G1=qe(e=>W(e.getFiberRefs())),Q1=e=>J1(e,{onFailure:sl,onSuccess:sl}),LH=e=>jn(e,{onFailure:t=>Y1(t,"An error was silently ignored because it is not anticipated to be useful"),onSuccess:()=>Ve}),Rm=e=>(...t)=>{const n=na(e);let r;for(let s=0,o=t.length;s<o;s++){const a=t[s];$S(a)&&(r!==void 0?r=zt(r,a):r=a,t=[...t.slice(0,s),...t.slice(s+1)],s--)}return r===void 0&&(r=Hs),qe(s=>(s.log(t,r,n),Ve))},jH=Rm(),Y1=Rm(YS),UH=Rm(x1),zH=Rm(P1),X0=y(2,(e,t)=>jn(e,{onFailure:n=>JI(()=>t(n)),onSuccess:W})),BH=e=>b(Xc(),M(t=>b(DH(e),YI(t),VH,ge(n=>wt(n,b(Pr(t),M(([r,s])=>Ht(ym(X1(r[0]),XI(r[1])),s)))))))),HH=e=>ge(e,t=>!t),VH=e=>ge(Uo(!0),t=>Hn(wf(e,SH(t,!1)))),X1=e=>ZH((t,n)=>b(e,V1(t,n))),WH=e=>e.length>=1?Fr((t,n)=>{try{e(n).then(r=>t(Be(r)),r=>t(Da(r)))}catch(r){t(Da(r))}}):Fr(t=>{try{e().then(n=>t(Be(n)),n=>t(Da(n)))}catch(n){t(Da(n))}}),El=y(3,(e,t,n)=>Zc(r=>zS(e,Kr(r,t,n)))),nw=R1,KH=W(H()),Z1=y(3,(e,t,n)=>M(t,r=>M(e,s=>ge(t,o=>[n(r,o),s])))),JH=y(2,(e,t)=>jn(e,{onFailure:n=>wt(t(n),$t(n)),onSuccess:W})),GH=EH,QH=GH(W),YH=e=>{let t,n;typeof e=="function"?t=e:(t=e.try,n=e.catch);const r=s=>n?Sf(()=>n(s)):ht(new Em(s,"An unknown error occurred in Effect.tryPromise"));return t.length>=1?Fr((s,o)=>{try{t(o).then(a=>s(Be(a)),a=>s(r(a)))}catch(a){s(r(a))}}):Fr(s=>{try{t().then(o=>s(Be(o)),o=>s(r(o)))}catch(o){s(r(o))}})},XH=y(2,(e,t)=>M(e,n=>K1({try:()=>t.try(n),catch:t.catch}))),ZH=e=>qe(t=>(t.setFiberRefs(e(t.id(),t.getFiberRefs())),Ve)),e4=y(2,(e,t)=>de(()=>t()?ge(e,V):W(H()))),t4=e=>new Proxy({},{get(t,n,r){return(...s)=>M(e,o=>o[n](...s))}}),n4=e=>ge(If(),vr(e)),r4=function(){const e=arguments;return Q1(M(eO,t=>B(()=>{if(typeof e[0]=="string")t.attribute(e[0],e[1]);else for(const n in e[0])t.attribute(n,e[0][n])})))},s4=y(e=>ir(e[0]),function(){const e=arguments;return bm(e[0],i1,typeof e[1]=="string"?dc(e[1],e[2]):t=>Object.entries(e[1]).reduce((n,[r,s])=>dc(n,r,s),t))}),eO=M(If(),e=>{const t=e.unsafeMap.get(as.key);return t!==void 0&&t._tag==="Span"?W(t):ht(new kf)}),tO=BigInt(0),nO=Mc(e=>Dn(e.context,Rh)?e._tag==="Span"?nO(e.parent):H():V(e)),rw=(e,t,n)=>{const r=!e.getFiberRef(o1)||n.context&&Dn(n.context,Rh),s=e.getFiberRef(Dr),o=n.parent?V(n.parent):n.root?H():nO(vr(s,as));let a;if(r)a=Fz({name:t,parent:o,context:Kr(n.context??js(),Rh,!0)});else{const u=e.getFiberRef(cs),f=Dn(u,Rf),d=Dn(u,XB),p=e.getFiberRef(wm),m=e.getFiberRefs(),$=Y0(m,i1),C=Y0(m,pz),O=C._tag==="Some"?n.links!==void 0?[...er(C.value),...n.links??[]]:er(C.value):n.links??ko();a=f.span(t,o,n.context??js(),O,p?d.unsafeCurrentTimeNanos():tO,n.kind??"internal"),$._tag==="Some"&&BL($.value,(N,v)=>a.attribute(v,N)),n.attributes!==void 0&&Object.entries(n.attributes).forEach(([N,v])=>a.attribute(N,v))}return typeof n.captureStackTrace=="function"&&Th.set(a,n.captureStackTrace),a},o4=(e,t)=>(t=xs(t),qe(n=>W(rw(n,e,t)))),Ah=(e,t,n,r)=>B(()=>{e.status._tag!=="Ended"&&(c1(t)&&Th.has(e)&&e.attribute("code.stacktrace",Th.get(e)()),e.end(r?n.unsafeCurrentTimeNanos():tO,t))}),Sy=(e,...t)=>{const n=xs(t.length===1?void 0:t[0]),r=t[t.length-1];return qe(s=>{const o=rw(s,e,n),a=s.getFiberRef(wm),u=Dn(s.getFiberRef(cs),la);return is(r(o),f=>Ah(o,f,u,a))})},wy=y(2,(e,t)=>El(e,as,t)),i4=function(){const e=typeof arguments[0]!="string",t=e?arguments[1]:arguments[0],n=xs(e?arguments[2]:arguments[1]);if(e){const r=arguments[0];return Sy(t,n,s=>wy(r,s))}return r=>Sy(t,n,s=>wy(r,s))},rO="Sequential",sO="Parallel",a4="ParallelN",qf={_tag:rO},c4={_tag:sO},u4=e=>({_tag:a4,parallelism:e}),l4=e=>e._tag===rO,f4=e=>e._tag===sO,kl=qf,vy=c4,Ey=u4,$l=tw,Tl=V1,qm="effect/FiberStatus",Ki=Symbol.for(qm),Fh="Done",Z0="Running",ek="Suspended",d4=Ot(`${qm}-${Fh}`);let h4=class{[Ki]=Ki;_tag=Fh;[he](){return d4}[pe](t){return sw(t)&&t._tag===Fh}};class p4{runtimeFlags;[Ki]=Ki;_tag=Z0;constructor(t){this.runtimeFlags=t}[he](){return b(J(qm),ue(J(this._tag)),ue(J(this.runtimeFlags)),tt(this))}[pe](t){return sw(t)&&t._tag===Z0&&this.runtimeFlags===t.runtimeFlags}}class m4{runtimeFlags;blockingOn;[Ki]=Ki;_tag=ek;constructor(t,n){this.runtimeFlags=t,this.blockingOn=n}[he](){return b(J(qm),ue(J(this._tag)),ue(J(this.runtimeFlags)),ue(J(this.blockingOn)),tt(this))}[pe](t){return sw(t)&&t._tag===ek&&this.runtimeFlags===t.runtimeFlags&&le(this.blockingOn,t.blockingOn)}}const g4=new h4,_4=e=>new p4(e),y4=(e,t)=>new m4(e,t),sw=e=>X(e,Ki),b4=e=>e._tag===Fh,S4=g4,oO=_4,w4=y4,v4=b4,E4=Symbol.for("effect/Micro"),Ph=Symbol.for("effect/Micro/MicroExit"),tk=Symbol.for("effect/Micro/MicroCause"),k4={_E:oe};class iO extends globalThis.Error{_tag;traces;[tk];constructor(t,n,r){const s=`MicroCause.${t}`;let o,a,u;if(n instanceof globalThis.Error){o=`(${s}) ${n.name}`,a=n.message;const f=a.split(`
`).length;u=n.stack?`(${s}) ${n.stack.split(`
`).slice(0,f+3).join(`
`)}`:`${o}: ${a}`}else o=s,a=qi(n,0),u=`${o}: ${a}`;r.length>0&&(u+=`
    ${r.join(`
    `)}`),super(a),this._tag=t,this.traces=r,this[tk]=k4,this.name=o,this.stack=u}pipe(){return Y(this,arguments)}toString(){return this.stack}[Le](){return this.stack}}class $4 extends iO{defect;constructor(t,n=[]){super("Die",t,n),this.defect=t}}const T4=(e,t=[])=>new $4(e,t);class C4 extends iO{constructor(t=[]){super("Interrupt","interrupted",t)}}const I4=(e=[])=>new C4(e),O4=e=>e._tag==="Interrupt",nk=Symbol.for("effect/Micro/MicroFiber"),R4={_A:oe,_E:oe};class q4{context;interruptible;[nk];_stack=[];_observers=[];_exit;_children;currentOpCount=0;constructor(t,n=!0){this.context=t,this.interruptible=n,this[nk]=R4}getRef(t){return hM(this.context,t)}addObserver(t){return this._exit?(t(this._exit),sl):(this._observers.push(t),()=>{const n=this._observers.indexOf(t);n>=0&&this._observers.splice(n,1)})}_interrupted=!1;unsafeInterrupt(){this._exit||(this._interrupted=!0,this.interruptible&&this.evaluate(uw))}unsafePoll(){return this._exit}evaluate(t){if(this._exit)return;if(this._yielded!==void 0){const s=this._yielded;this._yielded=void 0,s()}const n=this.runLoop(t);if(n===_d)return;const r=rk.interruptChildren&&rk.interruptChildren(this);if(r!==void 0)return this.evaluate(Nh(r,()=>n));this._exit=n;for(let s=0;s<this._observers.length;s++)this._observers[s](n);this._observers.length=0}runLoop(t){let n=!1,r=t;this.currentOpCount=0;try{for(;;){if(this.currentOpCount++,!n&&this.getRef(lw).shouldYield(this)){n=!0;const s=r;r=Nh(N4,()=>s)}if(r=r[ky](this),r===_d){const s=this._yielded;return Ph in s?(this._yielded=void 0,s):_d}}}catch(s){return X(r,ky)?$y(s):$y(`MicroFiber.runLoop: Not a valid effect: ${String(r)}`)}}getCont(t){for(;;){const n=this._stack.pop();if(!n)return;const r=n[xh]&&n[xh](this);if(r)return{[t]:r};if(n[t])return n}}_yielded=void 0;yieldWith(t){return this._yielded=t,_d}children(){return this._children??=new Set}}const rk=Se("effect/Micro/fiberMiddleware",()=>({interruptChildren:void 0})),aO=Symbol.for("effect/Micro/identifier"),Gt=Symbol.for("effect/Micro/args"),ky=Symbol.for("effect/Micro/evaluate"),kc=Symbol.for("effect/Micro/successCont"),Qa=Symbol.for("effect/Micro/failureCont"),xh=Symbol.for("effect/Micro/ensureCont"),_d=Symbol.for("effect/Micro/Yield"),A4={_A:oe,_E:oe,_R:oe},F4={...mH,_op:"Micro",[E4]:A4,pipe(){return Y(this,arguments)},[Symbol.iterator](){return new _T(new Nc(this))},toJSON(){return{_id:"Micro",op:this[aO],...Gt in this?{args:this[Gt]}:void 0}},toString(){return st(this)},[Le](){return st(this)}};function P4(e){return $y("Micro.evaluate: Not implemented")}const Am=e=>({...F4,[aO]:e.op,[ky]:e.eval??P4,[kc]:e.contA,[Qa]:e.contE,[xh]:e.ensure}),ow=e=>{const t=Am(e);return function(){const n=Object.create(t);return n[Gt]=e.single===!1?arguments:arguments[0],n}},cO=e=>{const t={...Am(e),[Ph]:Ph,_tag:e.op,get[e.prop](){return this[Gt]},toJSON(){return{_id:"MicroExit",_tag:e.op,[e.prop]:this[Gt]}},[pe](n){return L4(n)&&n._tag===e.op&&le(this[Gt],n[Gt])},[he](){return tt(this,ue(Ot(e.op))(J(this[Gt])))}};return function(n){const r=Object.create(t);return r[Gt]=n,r[kc]=void 0,r[Qa]=void 0,r[xh]=void 0,r}},iw=cO({op:"Success",prop:"value",eval(e){const t=e.getCont(kc);return t?t[kc](this[Gt],e):e.yieldWith(this)}}),uO=cO({op:"Failure",prop:"cause",eval(e){let t=e.getCont(Qa);for(;O4(this[Gt])&&t&&e.interruptible;)t=e.getCont(Qa);return t?t[Qa](this[Gt],e):e.yieldWith(this)}}),x4=ow({op:"Yield",eval(e){let t=!1;return e.getRef(lw).scheduleTask(()=>{t||e.evaluate(j4)},this[Gt]??0),e.yieldWith(()=>{t=!0})}}),N4=x4(0),D4=iw(void 0),aw=ow({op:"WithMicroFiber",eval(e){return this[Gt](e)}}),Nh=y(2,(e,t)=>{const n=Object.create(M4);return n[Gt]=e,n[kc]=t,n}),M4=Am({op:"OnSuccess",eval(e){return e._stack.push(this),this[Gt]}}),L4=e=>X(e,Ph),lO=iw,cw=uO,uw=cw(I4()),$y=e=>cw(T4(e)),j4=lO(void 0),U4="setImmediate"in globalThis?globalThis.setImmediate:e=>setTimeout(e,0);class fO{tasks=[];running=!1;scheduleTask(t,n){this.tasks.push(t),this.running||(this.running=!0,U4(this.afterScheduled))}afterScheduled=()=>{this.running=!1,this.runTasks()};runTasks(){const t=this.tasks;this.tasks=[];for(let n=0,r=t.length;n<r;n++)t[n]()}shouldYield(t){return t.currentOpCount>=t.getRef(H4)}flush(){for(;this.tasks.length>0;)this.runTasks()}}const z4=y(2,(e,t)=>aw(n=>{const r=n.context;return n.context=t(r),K4(e,()=>(n.context=r,D4))})),B4=y(2,(e,t)=>z4(e,eo(t)));class H4 extends Uc()("effect/Micro/currentMaxOpsBeforeYield",{defaultValue:()=>2048}){}class lw extends Uc()("effect/Micro/currentScheduler",{defaultValue:()=>new fO}){}const V4=y(2,(e,t)=>{const n=Object.create(W4);return n[Gt]=e,n[kc]=t.onSuccess,n[Qa]=t.onFailure,n}),W4=Am({op:"OnSuccessAndFailure",eval(e){return e._stack.push(this),this[Gt]}}),K4=y(2,(e,t)=>G4(n=>V4(n(e),{onFailure:r=>Nh(t(cw(r)),()=>uO(r)),onSuccess:r=>Nh(t(lO(r)),()=>iw(r))}))),dO=ow({op:"SetInterruptible",ensure(e){if(e.interruptible=this[Gt],e._interrupted&&e.interruptible)return()=>uw}}),J4=e=>aw(t=>t.interruptible?e:(t.interruptible=!0,t._stack.push(dO(!1)),t._interrupted?uw:e)),G4=e=>aw(t=>t.interruptible?(t.interruptible=!1,t._stack.push(dO(!0)),e(J4)):e(oe)),Q4=(e,t)=>{const n=new q4(lw.context(new fO));return n.evaluate(e),n};class fw{buckets=[];scheduleTask(t,n){const r=this.buckets.length;let s,o=0;for(;o<r&&this.buckets[o][0]<=n;o++)s=this.buckets[o];s&&s[0]===n?s[1].push(t):o===r?this.buckets.push([n,[t]]):this.buckets.splice(o,0,[n,[t]])}}class Y4{maxNextTickBeforeTimer;running=!1;tasks=new fw;constructor(t){this.maxNextTickBeforeTimer=t}starveInternal(t){const n=this.tasks.buckets;this.tasks.buckets=[];for(const[r,s]of n)for(let o=0;o<s.length;o++)s[o]();this.tasks.buckets.length===0?this.running=!1:this.starve(t)}starve(t=0){t>=this.maxNextTickBeforeTimer?setTimeout(()=>this.starveInternal(0),0):Promise.resolve(void 0).then(()=>this.starveInternal(t+1))}shouldYield(t){return t.currentOpCount>t.getFiberRef(Sm)?t.getFiberRef(jo):!1}scheduleTask(t,n){this.tasks.scheduleTask(t,n),this.running||(this.running=!0,this.starve())}}const hO=Se(Symbol.for("effect/Scheduler/defaultScheduler"),()=>new Y4(2048));class pO{tasks=new fw;deferred=!1;scheduleTask(t,n){this.deferred?hO.scheduleTask(t,n):this.tasks.scheduleTask(t,n)}shouldYield(t){return t.currentOpCount>t.getFiberRef(Sm)?t.getFiberRef(jo):!1}flush(){for(;this.tasks.buckets.length>0;){const t=this.tasks.buckets;this.tasks.buckets=[];for(const[n,r]of t)for(let s=0;s<r.length;s++)r[s]()}this.deferred=!0}}const dw=e=>e.currentOpCount>e.getFiberRef(Sm)?e.getFiberRef(jo):!1,X4=(e,t=dw)=>({scheduleTask:e,shouldYield:t}),Z4=(e,t=dw)=>{let n=!1;const r=new fw,s=()=>{const a=r.buckets;r.buckets=[];for(const[u,f]of a)for(let d=0;d<f.length;d++)f[d]();r.buckets.length===0?n=!1:o()},o=()=>e(s);return X4((a,u)=>{r.scheduleTask(a,u),n||(n=!0,o())},t)},Af=Se(Symbol.for("effect/FiberRef/currentScheduler"),()=>an(hO)),e6=y(2,(e,t)=>to(e,Af,t)),mO=Se(Symbol.for("effect/FiberRef/currentRequestMap"),()=>an(new Map)),sk=(e,t,n,r)=>{switch(e){case void 0:return t();case"unbounded":return n();case"inherit":return Gc(fz,s=>s==="unbounded"?n():s>1?r(s):t());default:return e>1?r(e):t()}},hw="InterruptSignal",pw="Stateful",mw="Resume",gw="YieldNow",o_=e=>({_tag:hw,cause:e}),Wd=e=>({_tag:pw,onFiber:e}),$a=e=>({_tag:mw,effect:e}),t6=()=>({_tag:gw}),n6="effect/FiberScope",Dh=Symbol.for(n6);class r6{[Dh]=Dh;fiberId=On;roots=new Set;add(t,n){this.roots.add(n),n.addObserver(()=>{this.roots.delete(n)})}}class s6{fiberId;parent;[Dh]=Dh;constructor(t,n){this.fiberId=t,this.parent=n}add(t,n){this.parent.tell(Wd(r=>{r.addChild(n),n.addObserver(()=>{r.removeChild(n)})}))}}const o6=e=>new s6(e.id(),e),Ff=Se(Symbol.for("effect/FiberScope/Global"),()=>new r6),i6="effect/Fiber",a6=Symbol.for(i6),c6={_E:e=>e,_A:e=>e},u6="effect/Fiber",l6=Symbol.for(u6),gO=e=>e.await,f6=e=>e.inheritAll,d6=y(2,(e,t)=>b(Sc(e,_O(t)),wt(b(e,Sc(gO))))),_O=y(2,(e,t)=>e.interruptAsFork(t)),$c=e=>NS(Jc(e.await),e.inheritAll);({...af});const fo="effect/FiberCurrent",h6=()=>na(globalThis[fo]),p6="effect/Logger",m6=Symbol.for(p6),g6={_Message:e=>e,_Output:e=>e},Pf=e=>({[m6]:g6,log:e,pipe(){return Y(this,arguments)}}),_6=/^[^\s"=]*$/,y6=(e,t)=>({annotations:n,cause:r,date:s,fiberId:o,logLevel:a,message:u,spans:f})=>{const d=O=>O.match(_6)?O:e(O),p=(O,N)=>`${N1(O)}=${d(N)}`,m=(O,N)=>" "+p(O,N);let $=p("timestamp",s.toISOString());$+=m("level",a.label),$+=m("fiber",tm(o));const C=Qb(u);for(let O=0;O<C.length;O++)$+=m("message",qi(C[O],t));bU(r)||($+=m("cause",Mo(r,{renderErrorCause:!0})));for(const O of f)$+=" "+XS(s.getTime())(O);for(const[O,N]of n)$+=m(O,qi(N,t));return $},b6=e=>`"${e.replace(/\\([\s\S])|(")/g,"\\$1$2")}"`,S6=Pf(y6(b6)),yO=e=>{switch(typeof e){case"bigint":case"function":case"symbol":return String(e);default:return yt(e)}},w6=(e,...t)=>{let n="";for(let r=0;r<t.length;r++)n+=`\x1B[${t[r]}m`;return n+e+"\x1B[0m"},v6=(e,...t)=>e,dr={bold:"1",red:"31",green:"32",yellow:"33",blue:"34",cyan:"36",white:"37",gray:"90",black:"30",bgBrightRed:"101"},E6={None:[],All:[],Trace:[dr.gray],Debug:[dr.blue],Info:[dr.green],Warning:[dr.yellow],Error:[dr.red],Fatal:[dr.bgBrightRed,dr.black]},k6={None:"",All:"",Trace:"color:gray",Debug:"color:blue",Info:"color:green",Warning:"color:orange",Error:"color:red",Fatal:"background-color:red;color:white"},$6=e=>`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}.${e.getMilliseconds().toString().padStart(3,"0")}`,bO=typeof process=="object"&&process!==null&&typeof process.stdout=="object"&&process.stdout!==null,T6=bO&&process.stdout.isTTY===!0,C6=bO||"Deno"in globalThis,I6=e=>{const t=e?.mode??"auto",r=(t==="auto"?C6?"tty":"browser":t)==="browser",s=typeof e?.colors=="boolean"?e.colors:T6||r,o=e?.formatDate??$6;return r?R6({colors:s,formatDate:o}):O6({colors:s,formatDate:o,stderr:e?.stderr===!0})},O6=e=>{const t=typeof process=="object"&&"isBun"in process&&process.isBun===!0,n=e.colors?w6:v6;return Pf(({annotations:r,cause:s,context:o,date:a,fiberId:u,logLevel:f,message:d,spans:p})=>{const m=Om(o,cs),$=Dn(m,Im).unsafe,C=e.stderr===!0?$.error:$.log,O=Qb(d);let N=n(`[${e.formatDate(a)}]`,dr.white)+` ${n(f.label,...E6[f._tag])} (${tm(u)})`;if(vS(p)){const w=a.getTime(),g=XS(w);for(const E of p)N+=" "+g(E)}N+=":";let v=0;if(O.length>0){const w=yO(O[0]);typeof w=="string"&&(N+=" "+n(w,dr.bold,dr.cyan),v++)}if(C(N),t||$.group(),CS(s)||C(Mo(s,{renderErrorCause:!0})),v<O.length)for(;v<O.length;v++)C(Ai(O[v]));if(_I(r)>0)for(const[w,g]of r)C(n(`${w}:`,dr.bold,dr.white),Ai(g));t||$.groupEnd()})},R6=e=>{const t=e.colors?"%c":"";return Pf(({annotations:n,cause:r,context:s,date:o,fiberId:a,logLevel:u,message:f,spans:d})=>{const p=Om(s,cs),m=Dn(p,Im).unsafe,$=Qb(f);let C=`${t}[${e.formatDate(o)}]`;const O=[];if(e.colors&&O.push("color:gray"),C+=` ${t}${u.label}${t} (${tm(a)})`,e.colors&&O.push(k6[u._tag],""),vS(d)){const v=o.getTime(),w=XS(v);for(const g of d)C+=" "+w(g)}C+=":";let N=0;if($.length>0){const v=yO($[0]);typeof v=="string"&&(C+=` ${t}${v}`,e.colors&&O.push("color:deepskyblue"),N++)}if(m.groupCollapsed(C,...O),CS(r)||m.error(Mo(r,{renderErrorCause:!0})),N<$.length)for(;N<$.length;N++)m.log(Ai($[N]));if(_I(n)>0)for(const[v,w]of n){const g=Ai(w);e.colors?m.log(`%c${v}:`,"color:gray",g):m.log(`${v}:`,g)}m.groupEnd()})},SO="effect/MetricBoundaries",Ty=Symbol.for(SO);class q6{values;[Ty]=Ty;constructor(t){this.values=t,this._hash=b(Ot(SO),ue(rf(this.values)))}_hash;[he](){return this._hash}[pe](t){return A6(t)&&le(this.values,t.values)}pipe(){return Y(this,arguments)}}const A6=e=>X(e,Ty),F6=e=>{const t=b(e,Pp(rt(Number.POSITIVE_INFINITY)),X3);return new q6(t)},P6=e=>b(R3(e.count-1,t=>e.start*Math.pow(e.factor,t)),Pt,F6),x6="effect/MetricKeyType",wO=Symbol.for(x6),vO="effect/MetricKeyType/Counter",Cy=Symbol.for(vO),N6="effect/MetricKeyType/Frequency",D6=Symbol.for(N6),M6="effect/MetricKeyType/Gauge",L6=Symbol.for(M6),EO="effect/MetricKeyType/Histogram",Iy=Symbol.for(EO),j6="effect/MetricKeyType/Summary",U6=Symbol.for(j6),kO={_In:e=>e,_Out:e=>e};class z6{incremental;bigint;[wO]=kO;[Cy]=Cy;constructor(t,n){this.incremental=t,this.bigint=n,this._hash=Ot(vO)}_hash;[he](){return this._hash}[pe](t){return $O(t)}pipe(){return Y(this,arguments)}}class B6{boundaries;[wO]=kO;[Iy]=Iy;constructor(t){this.boundaries=t,this._hash=b(Ot(EO),ue(J(this.boundaries)))}_hash;[he](){return this._hash}[pe](t){return TO(t)&&le(this.boundaries,t.boundaries)}pipe(){return Y(this,arguments)}}const H6=e=>new z6(e?.incremental??!1,e?.bigint??!1),V6=e=>new B6(e),$O=e=>X(e,Cy),W6=e=>X(e,D6),K6=e=>X(e,L6),TO=e=>X(e,Iy),J6=e=>X(e,U6),G6="effect/MetricKey",CO=Symbol.for(G6),Q6={_Type:e=>e},Y6=uf(le);class _w{name;keyType;description;tags;[CO]=Q6;constructor(t,n,r,s=[]){this.name=t,this.keyType=n,this.description=r,this.tags=s,this._hash=b(Ot(this.name+this.description),ue(J(this.keyType)),ue(rf(this.tags)))}_hash;[he](){return this._hash}[pe](t){return X6(t)&&this.name===t.name&&le(this.keyType,t.keyType)&&le(this.description,t.description)&&Y6(this.tags,t.tags)}pipe(){return Y(this,arguments)}}const X6=e=>X(e,CO),Z6=(e,t)=>new _w(e,H6(t),na(t?.description)),e5=(e,t,n)=>new _w(e,V6(t),na(n)),t5=y(2,(e,t)=>t.length===0?e:new _w(e.name,e.keyType,e.description,Dd(e.tags,t))),n5="effect/MetricState",xf=Symbol.for(n5),IO="effect/MetricState/Counter",Oy=Symbol.for(IO),OO="effect/MetricState/Frequency",Ry=Symbol.for(OO),RO="effect/MetricState/Gauge",qy=Symbol.for(RO),qO="effect/MetricState/Histogram",Ay=Symbol.for(qO),AO="effect/MetricState/Summary",Fy=Symbol.for(AO),Nf={_A:e=>e};class r5{count;[xf]=Nf;[Oy]=Oy;constructor(t){this.count=t}[he](){return b(J(IO),ue(J(this.count)),tt(this))}[pe](t){return p5(t)&&this.count===t.count}pipe(){return Y(this,arguments)}}const s5=uf(le);class o5{occurrences;[xf]=Nf;[Ry]=Ry;constructor(t){this.occurrences=t}_hash;[he](){return b(Ot(OO),ue(rf(Me(this.occurrences.entries()))),tt(this))}[pe](t){return m5(t)&&s5(Me(this.occurrences.entries()),Me(t.occurrences.entries()))}pipe(){return Y(this,arguments)}}class i5{value;[xf]=Nf;[qy]=qy;constructor(t){this.value=t}[he](){return b(J(RO),ue(J(this.value)),tt(this))}[pe](t){return g5(t)&&this.value===t.value}pipe(){return Y(this,arguments)}}class a5{buckets;count;min;max;sum;[xf]=Nf;[Ay]=Ay;constructor(t,n,r,s,o){this.buckets=t,this.count=n,this.min=r,this.max=s,this.sum=o}[he](){return b(J(qO),ue(J(this.buckets)),ue(J(this.count)),ue(J(this.min)),ue(J(this.max)),ue(J(this.sum)),tt(this))}[pe](t){return _5(t)&&le(this.buckets,t.buckets)&&this.count===t.count&&this.min===t.min&&this.max===t.max&&this.sum===t.sum}pipe(){return Y(this,arguments)}}class c5{error;quantiles;count;min;max;sum;[xf]=Nf;[Fy]=Fy;constructor(t,n,r,s,o,a){this.error=t,this.quantiles=n,this.count=r,this.min=s,this.max=o,this.sum=a}[he](){return b(J(AO),ue(J(this.error)),ue(J(this.quantiles)),ue(J(this.count)),ue(J(this.min)),ue(J(this.max)),ue(J(this.sum)),tt(this))}[pe](t){return y5(t)&&this.error===t.error&&le(this.quantiles,t.quantiles)&&this.count===t.count&&this.min===t.min&&this.max===t.max&&this.sum===t.sum}pipe(){return Y(this,arguments)}}const u5=e=>new r5(e),l5=e=>new o5(e),f5=e=>new i5(e),d5=e=>new a5(e.buckets,e.count,e.min,e.max,e.sum),h5=e=>new c5(e.error,e.quantiles,e.count,e.min,e.max,e.sum),p5=e=>X(e,Oy),m5=e=>X(e,Ry),g5=e=>X(e,qy),_5=e=>X(e,Ay),y5=e=>X(e,Fy),b5="effect/MetricHook",S5=Symbol.for(b5),w5={_In:e=>e,_Out:e=>e},Df=e=>({[S5]:w5,pipe(){return Y(this,arguments)},...e}),ok=BigInt(0),v5=e=>{let t=e.keyType.bigint?ok:0;const n=e.keyType.incremental?e.keyType.bigint?s=>s>=ok:s=>s>=0:s=>!0,r=s=>{n(s)&&(t=t+s)};return Df({get:()=>u5(t),update:r,modify:r})},E5=e=>{const t=new Map;for(const r of e.keyType.preregisteredWords)t.set(r,0);const n=r=>{const s=t.get(r)??0;t.set(r,s+1)};return Df({get:()=>l5(t),update:n,modify:n})},k5=(e,t)=>{let n=t;return Df({get:()=>f5(n),update:r=>{n=r},modify:r=>{n=n+r}})},$5=e=>{const t=e.keyType.boundaries.values,n=t.length,r=new Uint32Array(n+1),s=new Float32Array(n);let o=0,a=0,u=Number.MAX_VALUE,f=Number.MIN_VALUE;b(t,il(oc),qs((m,$)=>{s[$]=m}));const d=m=>{let $=0,C=n;for(;$!==C;){const O=Math.floor($+(C-$)/2),N=s[O];m<=N?C=O:$=O,C===$+1&&(m<=s[$]?C=$:$=C)}r[$]=r[$]+1,o=o+1,a=a+m,m<u&&(u=m),m>f&&(f=m)},p=()=>{const m=Fp(n);let $=0;for(let C=0;C<n;C++){const O=s[C],N=r[C];$=$+N,m[C]=[O,$]}return m};return Df({get:()=>d5({buckets:p(),count:o,min:u,max:f,sum:a}),update:d,modify:d})},T5=e=>{const{error:t,maxAge:n,maxSize:r,quantiles:s}=e.keyType,o=b(s,il(oc)),a=Fp(r);let u=0,f=0,d=0,p=Number.MAX_VALUE,m=Number.MIN_VALUE;const $=O=>{const N=[];let v=0;for(;v!==r-1;){const w=a[v];if(w!=null){const[g,E]=w,k=Mi(O-g);HM(k,KC)&&BM(k,n)&&N.push(E)}v=v+1}return C5(t,o,il(N,oc))},C=(O,N)=>{if(r>0){u=u+1;const v=u%r;a[v]=[N,O]}f=f+1,d=d+O,O<p&&(p=O),O>m&&(m=O)};return Df({get:()=>h5({error:t,quantiles:$(Date.now()),count:f,min:p,max:m,sum:d}),update:([O,N])=>C(O,N),modify:([O,N])=>C(O,N)})},C5=(e,t,n)=>{const r=n.length;if(!ft(t))return ko();const s=t[0],o=t.slice(1),a=ik(e,r,H(),0,s,n),u=Qn(a);return o.forEach(f=>{u.push(ik(e,r,a.value,a.consumed,f,a.rest))}),qs(u,f=>[f.quantile,f.value])},ik=(e,t,n,r,s,o)=>{let a=e,u=t,f=n,d=r,p=s,m=o,$=e,C=t,O=n,N=r,v=s,w=o;for(;;){if(!ft(m))return{quantile:p,value:H(),consumed:d,rest:[]};if(p===1)return{quantile:p,value:V(zT(m)),consumed:d+m.length,rest:[]};const g=In(m),E=HT(m,D=>D===g),k=p*u,R=a/2*k,q=d+E[0].length,x=Math.abs(q-k);if(q<k-R){$=a,C=u,O=Ba(m),N=q,v=p,w=E[1],a=$,u=C,f=O,d=N,p=v,m=w;continue}if(q>k+R){const D=kt(f)?V(g):f;return{quantile:p,value:D,consumed:d,rest:m}}switch(f._tag){case"None":{$=a,C=u,O=Ba(m),N=q,v=p,w=E[1],a=$,u=C,f=O,d=N,p=v,m=w;continue}case"Some":{const D=Math.abs(k-f.value);if(x<D){$=a,C=u,O=Ba(m),N=q,v=p,w=E[1],a=$,u=C,f=O,d=N,p=v,m=w;continue}return{quantile:p,value:V(f.value),consumed:d,rest:m}}}}throw new Error("BUG: MetricHook.resolveQuantiles - please report an issue at https://github.com/Effect-TS/effect/issues")},I5="effect/MetricPair",O5=Symbol.for(I5),R5={_Type:e=>e},q5=(e,t)=>({[O5]:R5,metricKey:e,metricState:t,pipe(){return Y(this,arguments)}}),A5="effect/MetricRegistry",ak=Symbol.for(A5);class F5{[ak]=ak;map=g1();snapshot(){const t=[];for(const[n,r]of this.map)t.push(q5(n,r.get()));return t}get(t){const n=b(this.map,Br(t),hr);if(n==null){if($O(t.keyType))return this.getCounter(t);if(K6(t.keyType))return this.getGauge(t);if(W6(t.keyType))return this.getFrequency(t);if(TO(t.keyType))return this.getHistogram(t);if(J6(t.keyType))return this.getSummary(t);throw new Error("BUG: MetricRegistry.get - unknown MetricKeyType - please report an issue at https://github.com/Effect-TS/effect/issues")}else return n}getCounter(t){let n=b(this.map,Br(t),hr);if(n==null){const r=v5(t);b(this.map,Ra(t))||b(this.map,qa(t,r)),n=r}return n}getFrequency(t){let n=b(this.map,Br(t),hr);if(n==null){const r=E5(t);b(this.map,Ra(t))||b(this.map,qa(t,r)),n=r}return n}getGauge(t){let n=b(this.map,Br(t),hr);if(n==null){const r=k5(t,t.keyType.bigint?BigInt(0):0);b(this.map,Ra(t))||b(this.map,qa(t,r)),n=r}return n}getHistogram(t){let n=b(this.map,Br(t),hr);if(n==null){const r=$5(t);b(this.map,Ra(t))||b(this.map,qa(t,r)),n=r}return n}getSummary(t){let n=b(this.map,Br(t),hr);if(n==null){const r=T5(t);b(this.map,Ra(t))||b(this.map,qa(t,r)),n=r}return n}}const P5=()=>new F5,x5="effect/Metric",N5=Symbol.for(x5),D5={_Type:e=>e,_In:e=>e,_Out:e=>e},ck=Se(Symbol.for("effect/Metric/globalMetricRegistry"),()=>P5()),FO=function(e,t,n,r){const s=Object.assign(o=>gm(o,a=>U5(s,a)),{[N5]:D5,keyType:e,unsafeUpdate:t,unsafeValue:n,unsafeModify:r,register(){return this.unsafeValue([]),this},pipe(){return Y(this,arguments)}});return s},Fm=(e,t)=>PO(Z6(e,t)),PO=e=>{let t;const n=new WeakMap,r=s=>{if(s.length===0)return t!==void 0||(t=ck.get(e)),t;let o=n.get(s);return o!==void 0||(o=ck.get(t5(e,s)),n.set(s,o)),o};return FO(e.keyType,(s,o)=>r(o).update(s),s=>r(s).get(),(s,o)=>r(o).modify(s))},M5=(e,t,n)=>PO(e5(e,t,n)),L5=y(3,(e,t,n)=>j5(e,[TH(t,n)])),j5=y(2,(e,t)=>FO(e.keyType,(n,r)=>e.unsafeUpdate(n,Dd(t,r)),n=>e.unsafeValue(Dd(t,n)),(n,r)=>e.unsafeModify(n,Dd(t,r)))),U5=y(2,(e,t)=>Gc(ly,n=>B(()=>e.unsafeUpdate(t,n)))),z5="effect/Request",B5=Symbol.for(z5),H5={_E:e=>e,_A:e=>e},V5={...Wb,[B5]:H5},W5=function(){function e(t){t&&Object.assign(this,t)}return e.prototype=V5,e}(),K5=y(2,(e,t)=>Gc(mO,n=>B(()=>{if(n.has(e)){const r=n.get(e);r.state.completed||(r.state.completed=!0,Cf(r.result,t))}}))),J5="effect/Supervisor",Pm=Symbol.for(J5),yw={_T:e=>e};class xm{underlying;value0;[Pm]=yw;constructor(t,n){this.underlying=t,this.value0=n}get value(){return this.value0}onStart(t,n,r,s){this.underlying.onStart(t,n,r,s)}onEnd(t,n){this.underlying.onEnd(t,n)}onEffect(t,n){this.underlying.onEffect(t,n)}onSuspend(t){this.underlying.onSuspend(t)}onResume(t){this.underlying.onResume(t)}map(t){return new xm(this,b(this.value,ge(t)))}zip(t){return new Nm(this,t)}}class Nm{left;right;_tag="Zip";[Pm]=yw;constructor(t,n){this.left=t,this.right=n}get value(){return ym(this.left.value,this.right.value)}onStart(t,n,r,s){this.left.onStart(t,n,r,s),this.right.onStart(t,n,r,s)}onEnd(t,n){this.left.onEnd(t,n),this.right.onEnd(t,n)}onEffect(t,n){this.left.onEffect(t,n),this.right.onEffect(t,n)}onSuspend(t){this.left.onSuspend(t),this.right.onSuspend(t)}onResume(t){this.left.onResume(t),this.right.onResume(t)}map(t){return new xm(this,b(this.value,ge(t)))}zip(t){return new Nm(this,t)}}const xO=e=>X(e,Pm)&&Ub(e,"Zip");class G5{effect;[Pm]=yw;constructor(t){this.effect=t}get value(){return this.effect}onStart(t,n,r,s){}onEnd(t,n){}onEffect(t,n){}onSuspend(t){}onResume(t){}map(t){return new xm(this,b(this.value,ge(t)))}zip(t){return new Nm(this,t)}onRun(t,n){return t()}}const Q5=e=>new G5(e),Dm=Se("effect/Supervisor/none",()=>Q5(Ve)),Y5=zc,NO="Empty",DO="AddSupervisor",MO="RemoveSupervisor",LO="AndThen",Wu={_tag:NO},Kd=(e,t)=>({_tag:LO,first:e,second:t}),X5=(e,t)=>Z5(t,rt(e)),Z5=(e,t)=>{let n=e,r=t;for(;Bs(r);){const s=Yr(r);switch(s._tag){case NO:{r=ks(r);break}case DO:{n=n.zip(s.supervisor),r=ks(r);break}case MO:{n=Py(n,s.supervisor),r=ks(r);break}case LO:{r=pn(s.first)(pn(s.second)(ks(r)));break}}}return n},Py=(e,t)=>le(e,t)?Dm:xO(e)?Py(e.left,t).zip(Py(e.right,t)):e,Mh=e=>le(e,Dm)?ji():xO(e)?b(Mh(e.left),fl(Mh(e.right))):Xp(e),eV=(e,t)=>{if(le(e,t))return Wu;const n=Mh(e),r=Mh(t),s=b(r,g0(n),dl(Wu,(a,u)=>Kd(a,{_tag:DO,supervisor:u}))),o=b(n,g0(r),dl(Wu,(a,u)=>Kd(a,{_tag:MO,supervisor:u})));return Kd(s,o)},tV=Y5({empty:Wu,patch:X5,combine:Kd,diff:eV}),nV=Fm("effect_fiber_started",{incremental:!0}),uk=Fm("effect_fiber_active"),rV=Fm("effect_fiber_successes",{incremental:!0}),sV=Fm("effect_fiber_failures",{incremental:!0}),oV=L5(M5("effect_fiber_lifetimes",P6({start:.5,factor:2,count:35})),"time_unit","milliseconds"),Eu="Continue",iV="Done",lk="Yield",aV={_E:e=>e,_A:e=>e},yd=e=>{throw new Error(`BUG: FiberRuntime - ${qi(e)} - please report an issue at https://github.com/Effect-TS/effect/issues`)},gs=Symbol.for("effect/internal/fiberRuntime/YieldedOp"),_s=Se("effect/internal/fiberRuntime/yieldedOpChannel",()=>({currentOp:null})),ku={[lh]:(e,t,n)=>ct(()=>t.effect_instruction_i1(n)),OnStep:(e,t,n)=>Be(Be(n)),[fh]:(e,t,n)=>ct(()=>t.effect_instruction_i2(n)),[Vb]:(e,t,n)=>(e.patchRuntimeFlags(e.currentRuntimeFlags,t.patch),ho(e.currentRuntimeFlags)&&e.isInterrupted()?Ye(e.getInterruptedCause()):Be(n)),[dh]:(e,t,n)=>(ct(()=>t.effect_instruction_i2(n)),ct(()=>t.effect_instruction_i0())?(e.pushStack(t),ct(()=>t.effect_instruction_i1())):Ve),[Hu]:(e,t,n)=>{const r=ct(()=>t.effect_instruction_i0.next(n));return r.done?Be(r.value):(e.pushStack(t),bT(r.value))}},cV={[hw]:(e,t,n,r)=>(e.processNewInterruptSignal(r.cause),ho(t)?Ye(r.cause):n),[mw]:(e,t,n,r)=>{throw new Error("It is illegal to have multiple concurrent run loops in a single fiber")},[pw]:(e,t,n,r)=>(r.onFiber(e,oO(t)),n),[gw]:(e,t,n,r)=>M(_m(),()=>n)},uV=e=>Sc(rU(e),t=>Ns(_U(t),([n,r])=>{const s=new Map,o=[];for(const u of r){o.push(er(u));for(const f of u)s.set(f.request,f)}const a=o.flat();return to(OV(n.runAll(o),a,()=>a.forEach(u=>{u.listeners.interrupted=!0})),mO,s)},!1,!1)),lV=Tp();class jO extends no{[a6]=c6;[l6]=aV;_fiberRefs;_fiberId;_queue=new Array;_children=null;_observers=new Array;_running=!1;_stack=[];_asyncInterruptor=null;_asyncBlockingOn=null;_exitValue=null;_steps=[];_isYielding=!1;currentRuntimeFlags;currentOpCount=0;currentSupervisor;currentScheduler;currentTracer;currentSpan;currentContext;currentDefaultServices;constructor(t,n,r){if(super(),this.currentRuntimeFlags=r,this._fiberId=t,this._fiberRefs=n,w0(r)){const s=this.getFiberRef(ly);nV.unsafeUpdate(1,s),uk.unsafeUpdate(1,s)}this.refreshRefCache()}commit(){return $c(this)}id(){return this._fiberId}resume(t){this.tell($a(t))}get status(){return this.ask((t,n)=>n)}get runtimeFlags(){return this.ask((t,n)=>v4(n)?t.currentRuntimeFlags:n.runtimeFlags)}scope(){return o6(this)}get children(){return this.ask(t=>Array.from(t.getChildren()))}getChildren(){return this._children===null&&(this._children=new Set),this._children}getInterruptedCause(){return this.getFiberRef(gd)}fiberRefs(){return this.ask(t=>t.getFiberRefs())}ask(t){return de(()=>{const n=Yc(this._fiberId);return this.tell(Wd((r,s)=>{Cf(n,B(()=>t(r,s)))})),Pr(n)})}tell(t){this._queue.push(t),this._running||(this._running=!0,this.drainQueueLaterOnExecutor())}get await(){return Fr(t=>{const n=r=>t(W(r));return this.tell(Wd((r,s)=>{r._exitValue!==null?n(this._exitValue):r.addObserver(n)})),B(()=>this.tell(Wd((r,s)=>{r.removeObserver(n)})))},this.id())}get inheritAll(){return qe((t,n)=>{const r=t.id(),s=t.getFiberRefs(),o=n.runtimeFlags,a=this.getFiberRefs(),u=nH(s,r,a);t.setFiberRefs(u);const f=t.getFiberRef(pk),d=b(bo(o,f),E0(Bc),E0(ay));return XI(d)})}get poll(){return B(()=>na(this._exitValue))}unsafePoll(){return this._exitValue}interruptAsFork(t){return B(()=>this.tell(o_(pr(t))))}unsafeInterruptAsFork(t){this.tell(o_(pr(t)))}addObserver(t){this._exitValue!==null?t(this._exitValue):this._observers.push(t)}removeObserver(t){this._observers=this._observers.filter(n=>n!==t)}getFiberRefs(){return this.setFiberRef(pk,this.currentRuntimeFlags),this._fiberRefs}unsafeDeleteFiberRef(t){this._fiberRefs=A1(this._fiberRefs,t)}getFiberRef(t){return this._fiberRefs.locals.has(t)?this._fiberRefs.locals.get(t)[0][1]:t.initial}setFiberRef(t,n){this._fiberRefs=gy(this._fiberRefs,{fiberId:this._fiberId,fiberRef:t,value:n}),this.refreshRefCache()}refreshRefCache(){this.currentDefaultServices=this.getFiberRef(cs),this.currentTracer=this.currentDefaultServices.unsafeMap.get(Rf.key),this.currentSupervisor=this.getFiberRef(CV),this.currentScheduler=this.getFiberRef(Af),this.currentContext=this.getFiberRef(Dr),this.currentSpan=this.currentContext.unsafeMap.get(as.key)}setFiberRefs(t){this._fiberRefs=t,this.refreshRefCache()}addChild(t){this.getChildren().add(t)}removeChild(t){this.getChildren().delete(t)}transferChildren(t){const n=this._children;if(this._children=null,n!==null&&n.size>0)for(const r of n)r._exitValue===null&&t.add(this.currentRuntimeFlags,r)}drainQueueOnCurrentThread(){let t=!0;for(;t;){let n=Eu;const r=globalThis[fo];globalThis[fo]=this;try{for(;n===Eu;)n=this._queue.length===0?iV:this.evaluateMessageWhileSuspended(this._queue.splice(0,1)[0])}finally{this._running=!1,globalThis[fo]=r}this._queue.length>0&&!this._running?(this._running=!0,n===lk?(this.drainQueueLaterOnExecutor(),t=!1):t=!0):t=!1}}drainQueueLaterOnExecutor(){this.currentScheduler.scheduleTask(this.run,this.getFiberRef(jo))}drainQueueWhileRunning(t,n){let r=n;for(;this._queue.length>0;){const s=this._queue.splice(0,1)[0];r=cV[s._tag](this,t,r,s)}return r}isInterrupted(){return!CS(this.getFiberRef(gd))}addInterruptedCause(t){const n=this.getFiberRef(gd);this.setFiberRef(gd,zt(n,t))}processNewInterruptSignal(t){this.addInterruptedCause(t),this.sendInterruptSignalToAllChildren()}sendInterruptSignalToAllChildren(){if(this._children===null||this._children.size===0)return!1;let t=!1;for(const n of this._children)n.tell(o_(pr(this.id()))),t=!0;return t}interruptAllChildren(){if(this.sendInterruptSignalToAllChildren()){const t=this._children.values();this._children=null;let n=!1;return xS({while:()=>!n,body:()=>{const s=t.next();return s.done?B(()=>{n=!0}):Hn(s.value.await)},step:()=>{}})}return null}reportExitValue(t){if(w0(this.currentRuntimeFlags)){const n=this.getFiberRef(ly),r=this.id().startTimeMillis,s=Date.now();switch(oV.unsafeUpdate(s-r,n),uk.unsafeUpdate(-1,n),t._tag){case en:{rV.unsafeUpdate(1,n);break}case Zt:{sV.unsafeUpdate(1,n);break}}}if(t._tag==="Failure"){const n=this.getFiberRef(s1);!am(t.cause)&&n._tag==="Some"&&this.log("Fiber terminated with an unhandled error",t.cause,n)}}setExitValue(t){this._exitValue=t,this.reportExitValue(t);for(let n=this._observers.length-1;n>=0;n--)this._observers[n](t);this._observers=[]}getLoggers(){return this.getFiberRef(Mm)}log(t,n,r){const s=nt(r)?r.value:this.getFiberRef(az),o=this.getFiberRef(UO);if(hH(o,s))return;const a=this.getFiberRef(cz),u=this.getFiberRef(r1),f=this.getLoggers(),d=this.getFiberRefs();if(_S(f)>0){const p=Dn(this.getFiberRef(cs),la),m=new Date(p.unsafeCurrentTimeMillis());B2(d,()=>{for(const $ of f)$.log({fiberId:this.id(),logLevel:s,message:t,cause:n,context:d,spans:a,annotations:u,date:m})})}}evaluateMessageWhileSuspended(t){switch(t._tag){case gw:return lk;case hw:return this.processNewInterruptSignal(t.cause),this._asyncInterruptor!==null&&(this._asyncInterruptor(Ye(t.cause)),this._asyncInterruptor=null),Eu;case mw:return this._asyncInterruptor=null,this._asyncBlockingOn=null,this.evaluateEffect(t.effect),Eu;case pw:return t.onFiber(this,this._exitValue!==null?S4:w4(this.currentRuntimeFlags,this._asyncBlockingOn)),Eu;default:return yd(t)}}evaluateEffect(t){this.currentSupervisor.onResume(this);try{let n=ho(this.currentRuntimeFlags)&&this.isInterrupted()?Ye(this.getInterruptedCause()):t;for(;n!==null;){const r=n,s=this.runLoop(r);if(s===gs){const o=_s.currentOp;_s.currentOp=null,o._op===xd?Xj(this.currentRuntimeFlags)?(this.tell(t6()),this.tell($a(bn)),n=null):n=bn:o._op===Bu&&(n=null)}else{this.currentRuntimeFlags=b(this.currentRuntimeFlags,Zj(ay));const o=this.interruptAllChildren();o!==null?n=M(o,()=>s):(this._queue.length===0?this.setExitValue(s):this.tell($a(s)),n=null)}}}finally{this.currentSupervisor.onSuspend(this)}}start(t){if(this._running)this.tell($a(t));else{this._running=!0;const n=globalThis[fo];globalThis[fo]=this;try{this.evaluateEffect(t)}finally{this._running=!1,globalThis[fo]=n,this._queue.length>0&&this.drainQueueLaterOnExecutor()}}}startFork(t){this.tell($a(t))}patchRuntimeFlags(t,n){const r=Ja(t,n);return globalThis[fo]=this,this.currentRuntimeFlags=r,r}initiateAsync(t,n){let r=!1;const s=o=>{r||(r=!0,this.tell($a(o)))};ho(t)&&(this._asyncInterruptor=s);try{n(s)}catch(o){s($t(Rn(o)))}}pushStack(t){this._stack.push(t),t._op==="OnStep"&&this._steps.push({refs:this.getFiberRefs(),flags:this.currentRuntimeFlags})}popStack(){const t=this._stack.pop();if(t)return t._op==="OnStep"&&this._steps.pop(),t}getNextSuccessCont(){let t=this.popStack();for(;t;){if(t._op!==Pd)return t;t=this.popStack()}}getNextFailCont(){let t=this.popStack();for(;t;){if(t._op!==lh&&t._op!==dh&&t._op!==Hu)return t;t=this.popStack()}}[H2](t){return B(()=>Up(this.currentContext,t))}Left(t){return ht(t.left)}None(t){return ht(new kf)}Right(t){return Be(t.right)}Some(t){return Be(t.value)}Micro(t){return ml(n=>{let r=n;const s=Q4(B4(t,this.currentContext));return s.addObserver(o=>{if(o._tag==="Success")return r(Be(o.value));switch(o.cause._tag){case"Interrupt":return r(Ye(pr(On)));case"Fail":return r(ht(o.cause.error));case"Die":return r(gl(o.cause.defect))}}),ml(o=>{r=a=>{o(Ve)},s.unsafeInterrupt()})})}[kT](t){const n=ct(()=>t.effect_instruction_i0()),r=this.getNextSuccessCont();return r!==void 0?(r._op in ku||yd(r),ku[r._op](this,r,n)):(_s.currentOp=Be(n),gs)}[en](t){const n=t,r=this.getNextSuccessCont();return r!==void 0?(r._op in ku||yd(r),ku[r._op](this,r,n.effect_instruction_i0)):(_s.currentOp=n,gs)}[Zt](t){const n=t.effect_instruction_i0,r=this.getNextFailCont();if(r!==void 0)switch(r._op){case Pd:case fh:return ho(this.currentRuntimeFlags)&&this.isInterrupted()?Ye(k0(n)):ct(()=>r.effect_instruction_i1(n));case"OnStep":return ho(this.currentRuntimeFlags)&&this.isInterrupted()?Ye(k0(n)):Be(Ye(n));case Vb:return this.patchRuntimeFlags(this.currentRuntimeFlags,r.patch),ho(this.currentRuntimeFlags)&&this.isInterrupted()?Ye(zt(n,this.getInterruptedCause())):Ye(n);default:yd(r)}else return _s.currentOp=Ye(n),gs}[$T](t){return ct(()=>t.effect_instruction_i0(this,oO(this.currentRuntimeFlags)))}Blocked(t){const n=this.getFiberRefs(),r=this.currentRuntimeFlags;if(this._steps.length>0){const s=[],o=this._steps[this._steps.length-1];let a=this.popStack();for(;a&&a._op!=="OnStep";)s.push(a),a=this.popStack();this.setFiberRefs(o.refs),this.currentRuntimeFlags=o.flags;const u=$l(o.refs,n),f=bo(o.flags,r);return Be(zI(t.effect_instruction_i0,qe(d=>{for(;s.length>0;)d.pushStack(s.pop());return d.setFiberRefs(Tl(d.id(),d.getFiberRefs())(u)),d.currentRuntimeFlags=Ja(f)(d.currentRuntimeFlags),t.effect_instruction_i1})))}return or(s=>M(Lm(NU(t.effect_instruction_i0)),()=>s(t.effect_instruction_i1)))}RunBlocked(t){return uV(t.effect_instruction_i0)}[Dc](t){const n=t.effect_instruction_i0,r=this.currentRuntimeFlags,s=Ja(r,n);if(ho(s)&&this.isInterrupted())return Ye(this.getInterruptedCause());if(this.patchRuntimeFlags(this.currentRuntimeFlags,n),t.effect_instruction_i1){const o=bo(s,r);return this.pushStack(new DU(o,t)),ct(()=>t.effect_instruction_i1(r))}else return bn}[lh](t){return this.pushStack(t),t.effect_instruction_i0}OnStep(t){return this.pushStack(t),t.effect_instruction_i0}[Pd](t){return this.pushStack(t),t.effect_instruction_i0}[fh](t){return this.pushStack(t),t.effect_instruction_i0}[Bu](t){return this._asyncBlockingOn=t.effect_instruction_i1,this.initiateAsync(this.currentRuntimeFlags,t.effect_instruction_i0),_s.currentOp=t,gs}[xd](t){return this._isYielding=!1,_s.currentOp=t,gs}[dh](t){const n=t.effect_instruction_i0,r=t.effect_instruction_i1;return n()?(this.pushStack(t),r()):bn}[Hu](t){return ku[Hu](this,t,void 0)}[sf](t){return ct(()=>t.commit())}runLoop(t){let n=t;for(this.currentOpCount=0;;){if((this.currentRuntimeFlags&Yj)!==0&&this.currentSupervisor.onEffect(this,n),this._queue.length>0&&(n=this.drainQueueWhileRunning(this.currentRuntimeFlags,n)),!this._isYielding){this.currentOpCount+=1;const r=this.currentScheduler.shouldYield(this);if(r!==!1){this._isYielding=!0,this.currentOpCount=0;const s=n;n=M(_m({priority:r}),()=>s)}}try{if(n=this.currentTracer.context(()=>lV!==n[Vi]._V?uy(`Cannot execute an Effect versioned ${n[Vi]._V} with a Runtime of version ${Tp()}`):this[n._op](n),this),n===gs){const r=_s.currentOp;return r._op===xd||r._op===Bu?gs:(_s.currentOp=null,r._op===en||r._op===Zt?r:Ye(Rn(r)))}}catch(r){n!==gs&&!X(n,"_op")||!(n._op in this)?n=uy(`Not a valid effect: ${qi(n)}`):bz(r)?n=Ye(zt(Rn(r),pr(On))):n=gl(r)}}}run=()=>{this.drainQueueOnCurrentThread()}}const UO=Se("effect/FiberRef/currentMinimumLogLevel",()=>an(pH("Info"))),fV=e=>Pf(t=>{const n=Om(t.context,cs);Dn(n,Im).unsafe.log(e.log(t))}),zO=Se(Symbol.for("effect/Logger/defaultLogger"),()=>fV(S6)),BO=Se(Symbol.for("effect/Logger/tracerLogger"),()=>Pf(({annotations:e,cause:t,context:n,fiberId:r,logLevel:s,message:o})=>{const a=vr(wl(n,Dr),as);if(a._tag==="None"||a.value._tag==="ExternalSpan")return;const u=Up(wl(n,cs),la),f={};for(const[d,p]of e)f[d]=p;f["effect.fiberId"]=ML(r),f["effect.logLevel"]=s.label,t!==null&&t._tag!=="Empty"&&(f["effect.cause"]=Mo(t,{renderErrorCause:!0})),a.value.event(qi(Array.isArray(o)?o[0]:o),u.unsafeCurrentTimeNanos(),f)})),Mm=Se(Symbol.for("effect/FiberRef/currentLoggers"),()=>sz(Xp(zO,BO))),bw=y(e=>ir(e[0]),(e,t)=>Lo(gm(e,n=>HO(r=>t(n,r))))),HO=e=>qe(t=>{const n=t.getFiberRefs(),r=t.currentRuntimeFlags;return M(WO,s=>_l(s,o=>qe(a=>{const u=a.getFiberRefs(),f=a.currentRuntimeFlags,d=$l(u,n),p=bo(f,r),m=$l(n,u);return a.setFiberRefs(Tl(d,a.id(),n)),Cl(WU(e(o),p),B(()=>{a.setFiberRefs(Tl(m,a.id(),a.getFiberRefs()))}))})))}),dV=e=>{if(Array.isArray(e)||zb(e))return[e,H()];const t=Object.keys(e),n=t.length;return[t.map(r=>e[r]),V(r=>{const s={};for(let o=0;o<n;o++)s[t[o]]=r[o];return s})]},hV=(e,t,n)=>{const r=[];for(const s of e)r.push(bc(s));return M(Tc(r,oe,{concurrency:n?.concurrency,batching:n?.batching,concurrentFinalizers:n?.concurrentFinalizers}),s=>{const o=H(),a=s.length,u=new Array(a),f=new Array(a);let d=!1;for(let p=0;p<a;p++){const m=s[p];m._tag==="Left"?(u[p]=V(m.left),d=!0):(f[p]=m.right,u[p]=o)}return d?t._tag==="Some"?ht(t.value(u)):ht(u):n?.discard?Ve:t._tag==="Some"?W(t.value(f)):W(f)})},pV=(e,t,n)=>{const r=[];for(const s of e)r.push(bc(s));return n?.discard?Tc(r,oe,{concurrency:n?.concurrency,batching:n?.batching,discard:!0,concurrentFinalizers:n?.concurrentFinalizers}):ge(Tc(r,oe,{concurrency:n?.concurrency,batching:n?.batching,concurrentFinalizers:n?.concurrentFinalizers}),s=>t._tag==="Some"?t.value(s):s)},Sw=(e,t)=>{const[n,r]=dV(e);return t?.mode==="validate"?hV(n,r,t):t?.mode==="either"?pV(n,r,t):t?.discard!==!0&&r._tag==="Some"?ge(Tc(n,oe,t),r.value):Tc(n,oe,t)},Tc=y(e=>zb(e[0]),(e,t,n)=>qe(r=>{const s=n?.batching===!0||n?.batching==="inherit"&&r.getFiberRef(dz);return n?.discard?sk(n.concurrency,()=>Ta(kl,n?.concurrentFinalizers)(o=>s?Ns(e,(a,u)=>o(t(a,u)),!0,!1,1):Sc(e,(a,u)=>o(t(a,u)))),()=>Ta(vy,n?.concurrentFinalizers)(o=>Ns(e,(a,u)=>o(t(a,u)),s,!1)),o=>Ta(Ey(o),n?.concurrentFinalizers)(a=>Ns(e,(u,f)=>a(t(u,f)),s,!1,o))):sk(n?.concurrency,()=>Ta(kl,n?.concurrentFinalizers)(o=>s?xy(e,1,(a,u)=>o(t(a,u)),!0):$s(e,(a,u)=>o(t(a,u)))),()=>Ta(vy,n?.concurrentFinalizers)(o=>ww(e,(a,u)=>o(t(a,u)),s)),o=>Ta(Ey(o),n?.concurrentFinalizers)(a=>xy(e,o,(u,f)=>a(t(u,f)),s)))})),ww=(e,t,n)=>de(()=>{const r=Me(e),s=new Array(r.length);return wt(Ns(r,(a,u)=>M(t(a,u),f=>B(()=>s[u]=f)),n,!1),W(s))}),Ns=(e,t,n,r,s)=>or(o=>BU(a=>qe(u=>{let f=Array.from(e).reverse(),d=f.length;if(d===0)return Ve;let p=0,m=!1;const $=s?Math.min(f.length,s):f.length,C=new Set,O=new Array,N=()=>C.forEach(D=>{D.currentScheduler.scheduleTask(()=>{D.unsafeInterruptAsFork(u.id())},0)}),v=new Array,w=new Array,g=new Array,E=()=>{const D=O.filter(({exit:G})=>G._tag==="Failure").sort((G,P)=>G.index<P.index?-1:G.index===P.index?0:1).map(({exit:G})=>G);return D.length===0&&D.push(bn),D},k=(D,G=!1)=>{const P=Lo(a(D)),L=gV(P,u,u.currentRuntimeFlags,Ff);return u.currentScheduler.scheduleTask(()=>{G&&L.unsafeInterruptAsFork(u.id()),L.resume(P)},0),L},R=()=>{r||(d-=f.length,f=[]),m=!0,N()},q=n?LU:ts,x=k(Fr(D=>{const G=(L,Z)=>{L._op==="Blocked"?g.push(L):(O.push({index:Z,exit:L}),L._op==="Failure"&&!m&&R())},P=()=>{if(f.length>0){const L=f.pop();let Z=p++;const ae=()=>{const Je=f.pop();return Z=p++,M(_m(),()=>M(q(o(t(Je,Z))),K))},K=Je=>f.length>0&&(G(Je,Z),f.length>0)?ae():W(Je),Ee=M(q(o(t(L,Z))),K),Ce=k(Ee);v.push(Ce),C.add(Ce),m&&Ce.currentScheduler.scheduleTask(()=>{Ce.unsafeInterruptAsFork(u.id())},0),Ce.addObserver(Je=>{let Ie;if(Je._op==="Failure"?Ie=Je:Ie=Je.effect_instruction_i0,w.push(Ce),C.delete(Ce),G(Ie,Z),O.length===d)D(W(pt(Ga(E(),{parallel:!0}),()=>bn)));else if(g.length+O.length===d){const et=E(),vn=g.map(Vn=>Vn.effect_instruction_i0).reduce(qI);D(W(zI(vn,Ns([pt(Ga(et,{parallel:!0}),()=>bn),...g.map(Vn=>Vn.effect_instruction_i1)],Vn=>Vn,n,!0,s))))}else P()})}};for(let L=0;L<$;L++)P()}));return Hn(is(Jc(o($c(x))),$m({onFailure:D=>{R();const G=g.length+1,P=Math.min(typeof s=="number"?s:g.length,g.length),L=Array.from(g);return Fr(Z=>{let ae=0,K=0;const Ee=(Je,Ie)=>et=>{ae++,ae===G&&Z(Be(Ye(D))),L.length>0&&Ie&&Ce()},Ce=()=>{k(L.pop(),!0).addObserver(Ee(K,!0)),K++};x.addObserver(Ee(K,!1)),K++;for(let Je=0;Je<P;Je++)Ce()})},onSuccess:()=>$s(w,D=>D.inheritAll)})))}))),xy=(e,t,n,r)=>de(()=>{const s=Me(e),o=new Array(s.length);return wt(Ns(s,(u,f)=>ge(n(u,f),d=>o[f]=d),r,!1,t),W(o))}),mV=e=>qe((t,n)=>W(vw(e,t,n.runtimeFlags))),Lm=e=>_V(e,Ff),vw=(e,t,n,r=null)=>{const s=Lh(e,t,n,r);return s.resume(e),s},gV=(e,t,n,r=null)=>Lh(e,t,n,r),Lh=(e,t,n,r=null)=>{const s=pI(),o=t.getFiberRefs(),a=rH(o,s),u=new jO(s,a,n),f=wl(a,Dr),d=u.currentSupervisor;return d.onStart(f,e,V(t),u),u.addObserver(m=>d.onEnd(m,u)),(r!==null?r:b(t.getFiberRef(fy),pt(()=>t.scope()))).add(n,u),u},_V=(e,t)=>qe((n,r)=>W(vw(e,n,r.runtimeFlags,t))),fk=e=>Zc(t=>Xe(vr(t,ro),{onNone:()=>e,onSome:n=>{switch(n.strategy._tag){case"Parallel":return e;case"Sequential":case"ParallelN":return M(vm(n,vy),r=>nu(e,r))}}})),dk=e=>t=>Zc(n=>Xe(vr(n,ro),{onNone:()=>t,onSome:r=>r.strategy._tag==="ParallelN"&&r.strategy.parallelism===e?t:M(vm(r,Ey(e)),s=>nu(t,s))})),Ta=(e,t)=>n=>Zc(r=>Xe(vr(r,ro),{onNone:()=>n(oe),onSome:s=>{if(t===!0){const o=e._tag==="Parallel"?fk:e._tag==="Sequential"?hk:dk(e.parallelism);switch(s.strategy._tag){case"Parallel":return o(n(fk));case"Sequential":return o(n(hk));case"ParallelN":return o(n(dk(s.strategy.parallelism)))}}else return n(oe)}})),Ew=e=>M(ro,e),VO=e=>M(Lf(),t=>is(e(t),n=>t.close(n))),yV=e=>M(Lf(),t=>kV(e,t)),hk=e=>Zc(t=>Xe(vr(t,ro),{onNone:()=>e,onSome:n=>{switch(n.strategy._tag){case"Sequential":return e;case"Parallel":case"ParallelN":return M(vm(n,kl),r=>nu(e,r))}}})),bV=y(e=>ir(e[1]),(e,t,n)=>Mf(e,t,(r,s)=>[r,s],n)),SV=y(e=>ir(e[1]),(e,t,n)=>n?.concurrent!==!0&&(n?.batching===void 0||n.batching===!1)?NS(e,t):Mf(e,t,(r,s)=>r,n)),wV=y(e=>ir(e[1]),(e,t,n)=>n?.concurrent!==!0&&(n?.batching===void 0||n.batching===!1)?wt(e,t):Mf(e,t,(r,s)=>s,n)),Mf=y(e=>ir(e[1]),(e,t,n,r)=>ge(Sw([e,t],{concurrency:r?.concurrent?2:1,batching:r?.batching,concurrentFinalizers:r?.concurrentFinalizers}),([s,o])=>n(s,o))),ro=Bn("effect/Scope"),WO=ro,vV=(e,t)=>{e.state._tag==="Open"&&e.state.finalizers.set({},t)},EV={[I0]:I0,[O0]:O0,pipe(){return Y(this,arguments)},fork(e){return B(()=>{const t=KO(e);if(this.state._tag==="Closed")return t.state=this.state,t;const n={},r=s=>t.close(s);return this.state.finalizers.set(n,r),vV(t,s=>B(()=>{this.state._tag==="Open"&&this.state.finalizers.delete(n)})),t})},close(e){return de(()=>{if(this.state._tag==="Closed")return Ve;const t=Array.from(this.state.finalizers.values()).reverse();return this.state={_tag:"Closed",exit:e},t.length===0?Ve:l4(this.strategy)?b($s(t,n=>ts(n(e))),M(n=>b(Ga(n),yo(n_),pt(()=>bn)))):f4(this.strategy)?b(ww(t,n=>ts(n(e)),!1),M(n=>b(Ga(n,{parallel:!0}),yo(n_),pt(()=>bn)))):b(xy(t,this.strategy.parallelism,n=>ts(n(e)),!1),M(n=>b(Ga(n,{parallel:!0}),yo(n_),pt(()=>bn))))})},addFinalizer(e){return de(()=>this.state._tag==="Closed"?e(this.state.exit):(this.state.finalizers.set({},e),Ve))}},KO=(e=qf)=>{const t=Object.create(EV);return t.strategy=e,t.state={_tag:"Open",finalizers:new Map},t},Lf=(e=qf)=>B(()=>KO(e)),nu=y(2,(e,t)=>h1(e,eo(pf(ro,t)))),kV=y(2,(e,t)=>b(e,nu(t),is(n=>t.close(n)))),$V=e=>Qc(e,{differ:tV,fork:Wu}),TV=y(2,(e,t)=>Hn(bw(M(vf(e),n=>Ht(Ih(e,t),n)),n=>Ih(e,n)))),kw=y(2,(e,t)=>Gc(e,n=>TV(e,t(n)))),pk=iz(eU),CV=$V(Dm),JO=y(3,(e,t,n)=>QO(e,t,{onSelfWin:(r,s)=>M(r.await,o=>{switch(o._tag){case en:return M(r.inheritAll,()=>n.onSelfDone(o,s));case Zt:return n.onSelfDone(o,s)}}),onOtherWin:(r,s)=>M(r.await,o=>{switch(o._tag){case en:return M(r.inheritAll,()=>n.onOtherDone(o,s));case Zt:return n.onOtherDone(o,s)}})})),IV=e=>or(t=>aa(n=>M(Lm(t(e)),r=>b(t($c(r)),ca(()=>b(r,_O(n))))))),GO=y(2,(e,t)=>aa(n=>JO(e,t,{onSelfDone:(r,s)=>py(r,{onFailure:o=>b($c(s),X0(a=>Vs(o,a))),onSuccess:o=>b(s,Ts(n),Ht(o))}),onOtherDone:(r,s)=>py(r,{onFailure:o=>b($c(s),X0(a=>Vs(a,o))),onSuccess:o=>b(s,Ts(n),Ht(o))})}))),QO=y(3,(e,t,n)=>qe((r,s)=>{const o=s.runtimeFlags,a=sa(!0),u=Lh(e,r,o,n.selfScope),f=Lh(t,r,o,n.otherScope);return Fr(d=>{u.addObserver(()=>mk(u,f,n.onSelfWin,a,d)),f.addObserver(()=>mk(f,u,n.onOtherWin,a,d)),u.startFork(e),f.startFork(t)},tr(u.id(),f.id()))})),mk=(e,t,n,r,s)=>{CL(!0,!1)(r)&&s(n(e,t))},Cl=y(2,(e,t)=>or(n=>jn(n(e),{onFailure:r=>jn(t,{onFailure:s=>$t(zt(r,s)),onSuccess:()=>$t(r)}),onSuccess:r=>Ht(t,r)}))),OV=(e,t,n)=>aa(r=>M(M(Lm(pm(e)),s=>Fr(o=>{const a=t.map(d=>d.listeners.count),u=()=>{a.every(d=>d===0)&&t.every(d=>d.result.state.current._tag==="Pending"?!0:!!(d.result.state.current._tag==="Done"&&km(d.result.state.current.effect)&&d.result.state.current.effect._tag==="Failure"&&IS(d.result.state.current.effect.cause)))&&(f.forEach(d=>d()),n?.(),o(DS(s)))};s.addObserver(d=>{f.forEach(p=>p()),o(d)});const f=t.map((d,p)=>{const m=$=>{a[p]=$,u()};return d.listeners.addObserver(m),()=>d.listeners.removeObserver(m)});return u(),B(()=>{f.forEach(d=>d())})})),()=>de(()=>{const s=t.flatMap(o=>o.state.completed?[]:[o]);return Sc(s,o=>K5(o.request,LS(r)))}))),gk=(e,t)=>(t=xs(t),Lo(qe(n=>{const r=Up(n.getFiberRef(Dr),ro),s=rw(n,e,t),o=n.getFiberRef(wm),a=Dn(n.getFiberRef(cs),la);return Ht(_l(r,u=>Ah(s,u,a,o)),s)}))),RV=e=>kw(cs,Kr(Rf,e)),qV=function(){const e=typeof arguments[0]!="string",t=e?arguments[1]:arguments[0],n=xs(e?arguments[2]:arguments[1]);if(e){const r=arguments[0];return M(gk(t,xs(n)),s=>El(r,as,s))}return r=>M(gk(t,xs(n)),s=>El(r,as,s))},AV=Hs,ru=Hi,Ji=Rn,jm=pr,FV=Vs,PV=zt,xV=$S,YO=SU,NV=TS,Il=IS,Ds=am,DV=OS,Um=RS,$w=vU,zm=MI,Tw=mz,Cw=lm,MV=Sz,Bm=kf,jh=Mo,LV=qS,jV="effect/ScheduleInterval",Uh=Symbol.for(jV),XO={[Uh]:Uh,startMillis:0,endMillis:0},Iw=(e,t)=>e>t?XO:{[Uh]:Uh,startMillis:e,endMillis:t},UV=y(2,(e,t)=>zV(e,t)===e),zV=y(2,(e,t)=>e.endMillis<=t.startMillis?e:t.endMillis<=e.startMillis?t:e.startMillis<t.startMillis?e:t.startMillis<e.startMillis?t:e.endMillis<=t.endMillis?e:t),BV=e=>e.startMillis>=e.endMillis,HV=y(2,(e,t)=>{const n=Math.max(e.startMillis,t.startMillis),r=Math.min(e.endMillis,t.endMillis);return Iw(n,r)}),VV=e=>Mi(e.endMillis-e.startMillis),WV=e=>Iw(e,Number.POSITIVE_INFINITY),_k=Iw,ZO=XO,KV=UV,JV=BV,GV=HV,QV=VV,YV=WV,XV="effect/ScheduleIntervals",yk=Symbol.for(XV),eR=e=>({[yk]:yk,intervals:e}),ZV=y(2,(e,t)=>eW(e.intervals,t.intervals,lt())),eW=(e,t,n)=>{let r=e,s=t,o=n;for(;Bs(r)&&Bs(s);){const a=b(Yr(r),GV(Yr(s))),u=JV(a)?o:b(o,pn(a));b(Yr(r),KV(Yr(s)))?r=ks(r):s=ks(s),o=u}return eR(zs(o))},Ny=e=>b(e.intervals,Bp,pt(()=>ZO)).startMillis,tW=e=>b(e.intervals,Bp,pt(()=>ZO)).endMillis,nW=y(2,(e,t)=>Ny(e)<Ny(t)),rW=e=>Bs(e.intervals),sW=eR,oW=ZV,Dy=Ny,My=tW,iW=nW,aW=rW,Ow="Continue",tR="Done",cW=e=>({_tag:Ow,intervals:e}),uW=e=>({_tag:Ow,intervals:sW(rt(e))}),lW={_tag:tR},fW=e=>e._tag===Ow,dW=e=>e._tag===tR,hW=cW,nR=uW,Ol=lW,bk=fW,Rl=dW,pW=ro,wo=a1,mW=_l,ln=dy,Rw=nu,qw=vm,Aw=Lf,gW=sm,Fw=function(){const e=Symbol.for("effect/Data/Error/plainArgs");return{BaseEffectError:class extends MS{constructor(n){super(n?.message,n?.cause?{cause:n.cause}:void 0),n&&(Object.assign(this,n),Object.defineProperty(this,e,{value:n,enumerable:!1}))}toJSON(){return{...this[e],...this}}}}.BaseEffectError}(),_W=e=>{const t={BaseEffectError:class extends Fw{_tag=e}};return t.BaseEffectError.prototype.name=e,t.BaseEffectError},yW="effect/Schedule",rR=Symbol.for(yW),sR=e=>X(e,rR),bW="effect/ScheduleDriver",SW=Symbol.for(bW),wW={_Out:e=>e,_In:e=>e,_R:e=>e},vW={_Out:e=>e,_In:e=>e,_R:e=>e};class EW{initial;step;[rR]=wW;constructor(t,n){this.initial=t,this.step=n}pipe(){return Y(this,arguments)}}class kW{schedule;ref;[SW]=vW;constructor(t,n){this.schedule=t,this.ref=n}get state(){return ge(So(this.ref),t=>t[1])}get last(){return M(So(this.ref),([t,n])=>{switch(t._tag){case"None":return Sf(()=>new kf);case"Some":return W(t.value)}})}get reset(){return vl(this.ref,[H(),this.schedule.initial])}next(t){return b(ge(So(this.ref),n=>n[1]),M(n=>b(QB,M(r=>b(de(()=>this.schedule.step(r,t,n)),M(([s,o,a])=>{const u=vl(this.ref,[V(o),s]);if(Rl(a))return wt(u,ht(H()));const f=Dy(a.intervals)-r;return f<=0?Ht(u,o):b(u,wt(nw(Mi(f))),Ht(o))}))))))}}const su=(e,t)=>new EW(e,t),$W=y(2,(e,t)=>TW(e,n=>B(()=>t(n)))),TW=y(2,(e,t)=>AW(e,(n,r)=>ge(t(n),s=>zM(r,sr(s))))),CW=y(2,(e,t)=>Pw(e,(n,r)=>B(()=>t(n,r)))),Pw=y(2,(e,t)=>su(e.initial,(n,r,s)=>M(e.step(n,r,s),([o,a,u])=>Rl(u)?W([o,a,Ol]):ge(t(r,a),f=>f?[o,a,u]:[o,a,Ol])))),IW=e=>$W(e,t=>t),oR=e=>b(qh([H(),e.initial]),ge(t=>new kW(e,t))),OW=(e,t=2)=>{const n=sr(e);return IW(aR(Hm,r=>UM(n,Math.pow(t,r))))},iR=y(2,(e,t)=>RW(e,t,oW)),RW=y(3,(e,t,n)=>su([e.initial,t.initial],(r,s,o)=>b(ZI(e.step(r,s,o[0]),t.step(r,s,o[1]),(a,u)=>[a,u]),M(([[a,u,f],[d,p,m]])=>bk(f)&&bk(m)?Ly(e,t,s,a,u,f.intervals,d,p,m.intervals,n):W([[a,d],[u,p],Ol]))))),Ly=(e,t,n,r,s,o,a,u,f,d)=>{const p=d(o,f);return aW(p)?W([[r,a],[s,u],hW(p)]):b(o,iW(f))?M(e.step(My(o),n,r),([m,$,C])=>Rl(C)?W([[m,a],[$,u],Ol]):Ly(e,t,n,m,$,C.intervals,a,u,f,d)):M(t.step(My(f),n,a),([m,$,C])=>Rl(C)?W([[r,m],[s,$],Ol]):Ly(e,t,n,r,s,o,m,$,C.intervals,d))},aR=y(2,(e,t)=>qW(e,n=>B(()=>t(n)))),qW=y(2,(e,t)=>su(e.initial,(n,r,s)=>M(e.step(n,r,s),([o,a,u])=>ge(t(a),f=>[o,f,u])))),AW=y(2,(e,t)=>su(e.initial,(n,r,s)=>M(e.step(n,r,s),([o,a,u])=>{if(Rl(u))return W([o,a,u]);const f=u.intervals,d=QV(_k(n,Dy(f)));return ge(t(a,d),p=>{const m=sr(p),$=Dy(f),C=n+cc(m),O=C-$,N=Math.max(0,My(f)+O),v=_k(C,N);return[o,a,nR(v)]})}))),FW=e=>su(e.initial,(t,n,r)=>b(e.step(t,n,r),ge(([s,o,a])=>[s,n,a]))),cR=e=>xW(Hm,t=>t<e),PW=(e,t)=>su(e,(n,r,s)=>B(()=>[t(s),s,nR(YV(n))])),uR=y(2,(e,t)=>Pw(e,(n,r)=>HH(t(n)))),lR=y(2,(e,t)=>Pw(e,(n,r)=>t(n))),xW=y(2,(e,t)=>CW(e,(n,r)=>t(r))),Jd=Symbol.for("effect/Schedule/ScheduleDefect");class NW{error;[Jd];constructor(t){this.error=t,this[Jd]=Jd}}const DW=e=>X(e,Jd),zh=e=>yc(e,t=>gl(new NW(t))),fR=e=>dm(e,t=>Xe(cm(t,n=>TS(n)&&DW(n.defect)?V(n.defect):H()),{onNone:()=>$t(t),onSome:n=>ht(n.error)})),Sk=y(2,(e,t)=>LW(e,t,(n,r)=>ht(n))),MW=y(2,(e,t)=>{if(sR(t))return Sk(e,t);const n=t.schedule??FW(Hm),r=t.while?lR(n,a=>{const u=t.while(a);return typeof u=="boolean"?W(u):zh(u)}):n,s=t.until?uR(r,a=>{const u=t.until(a);return typeof u=="boolean"?W(u):zh(u)}):r,o=t.times?iR(s,cR(t.times)).pipe(aR(a=>a[0])):s;return fR(Sk(e,o))}),LW=y(3,(e,t,n)=>M(oR(t),r=>Ws(e,{onFailure:s=>n(s,H()),onSuccess:s=>dR(e,r,n,s)}))),dR=(e,t,n,r)=>Ws(t.next(r),{onFailure:()=>PS(t.last),onSuccess:s=>Ws(e,{onFailure:o=>n(o,V(s)),onSuccess:o=>dR(e,t,n,o)})}),wk=y(2,(e,t)=>UW(e,t,(n,r)=>ht(n))),jW=y(2,(e,t)=>{if(sR(t))return wk(e,t);const n=t.schedule??Hm,r=t.while?lR(n,a=>{const u=t.while(a);return typeof u=="boolean"?W(u):zh(u)}):n,s=t.until?uR(r,a=>{const u=t.until(a);return typeof u=="boolean"?W(u):zh(u)}):r,o=t.times?iR(s,cR(t.times)):s;return fR(wk(e,o))}),UW=y(3,(e,t,n)=>M(oR(t),r=>hR(e,r,n))),hR=(e,t,n)=>yc(e,r=>Ws(t.next(r),{onFailure:()=>b(t.last,PS,M(s=>n(r,s))),onSuccess:()=>hR(e,t,n)})),Hm=PW(0,e=>e+1);class zW{permits;waiters=new Set;taken=0;constructor(t){this.permits=t}get free(){return this.permits-this.taken}take=t=>po(n=>{if(this.free<t){const r=()=>{this.free<t||(this.waiters.delete(r),this.taken+=t,n(W(t)))};return this.waiters.add(r),B(()=>{this.waiters.delete(r)})}return this.taken+=t,n(W(t))});updateTaken=t=>qe(n=>(this.taken=t(this.taken),this.waiters.size>0&&n.getFiberRef(Af).scheduleTask(()=>{const r=this.waiters.values();let s=r.next();for(;s.done===!1&&this.free>0;)s.value(),s=r.next()},n.getFiberRef(jo)),W(this.free)));release=t=>this.updateTaken(n=>n-t);releaseAll=this.updateTaken(t=>0);withPermits=t=>n=>or(r=>M(r(this.take(t)),s=>Cl(r(n),this.release(s))));withPermitsIfAvailable=t=>n=>or(r=>de(()=>this.free<t?KH:(this.taken+=t,Cl(r(OH(n)),this.release(t)))))}const pR=e=>new zW(e),BW=e=>B(()=>pR(e));class HW extends no{isOpen;waiters=[];scheduled=!1;constructor(t){super(),this.isOpen=t}commit(){return this.await}unsafeSchedule(t){return this.scheduled||this.waiters.length===0||(this.scheduled=!0,t.currentScheduler.scheduleTask(this.flushWaiters,t.getFiberRef(jo))),Ve}flushWaiters=()=>{this.scheduled=!1;const t=this.waiters;this.waiters=[];for(let n=0;n<t.length;n++)t[n](bn)};open=qe(t=>this.isOpen?Ve:(this.isOpen=!0,this.unsafeSchedule(t)));unsafeOpen(){this.isOpen||(this.isOpen=!0,this.flushWaiters())}release=qe(t=>this.isOpen?Ve:this.unsafeSchedule(t));await=po(t=>this.isOpen?t(Ve):(this.waiters.push(t),B(()=>{const n=this.waiters.indexOf(t);n!==-1&&this.waiters.splice(n,1)})));unsafeClose(){this.isOpen=!1}close=B(()=>{this.isOpen=!1});whenOpen=t=>wt(this.await,t)}const mR=e=>new HW(e??!1),VW=e=>B(()=>mR(e)),gR=y(2,(e,t)=>qe((n,r)=>{const s=t,o=vw(e,n,r.runtimeFlags,Ff);if(s.state._tag==="Open"){const a=()=>aa(f=>le(f,o.id())?Ve:Hn(DS(o))),u={};s.state.finalizers.set(u,a),o.addObserver(()=>{s.state._tag!=="Closed"&&s.state.finalizers.delete(u)})}else o.unsafeInterruptAsFork(n.id());return W(o)})),WW=e=>Ew(t=>gR(e,t)),KW=y(2,(e,t)=>b(ts(e),GO(ts(t)),n=>Jc(n))),JW=y(2,(e,t)=>GW(e,{onTimeout:()=>vz(t),duration:t})),GW=y(2,(e,{duration:t,onTimeout:n})=>Jc(QW(e,{onTimeout:()=>Sf(n),onSuccess:W,duration:t}))),QW=y(2,(e,{duration:t,onSuccess:n,onTimeout:r})=>aa(s=>or(o=>QO(o(e),pm(nw(t)),{onSelfWin:(a,u)=>M(a.await,f=>f._tag==="Success"?M(a.inheritAll,()=>Ht(Ts(u,s),n(f.value))):M(Ts(u,s),()=>Ye(f.cause))),onOtherWin:(a,u)=>M(a.await,f=>f._tag==="Success"?M(a.inheritAll,()=>Ht(Ts(u,s),r())):M(Ts(u,s),()=>Ye(f.cause))),otherScope:Ff})))),YW="effect/Ref/SynchronizedRef",_R=Symbol.for(YW),yR={_A:e=>e};class XW extends no{ref;withLock;[_R]=yR;[ZS]=ew;[Co]=Co;constructor(t,n){super(),this.ref=t,this.withLock=n,this.get=So(this.ref)}get;commit(){return this.get}modify(t){return this.modifyEffect(n=>W(t(n)))}modifyEffect(t){return this.withLock(b(M(So(this.ref),t),M(([n,r])=>Ht(vl(this.ref,r),n))))}}const ZW=e=>B(()=>bR(e)),bR=e=>{const t=D1(e),n=pR(1);return new XW(t,n.withPermits(1))},eK=Symbol.for("effect/ManagedRuntime"),tK="Fold",nK="Fresh",rK="FromEffect",sK="Scoped",oK="Suspend",iK="Provide",SR="ProvideMerge",aK="ZipWith",wR=gO,cK=h6,vk=f6,Sr=DS,Vm=Ts,vR=d6,Bh=$c,jf=e=>function(){if(arguments.length===1){const t=arguments[0];return(n,...r)=>e(t,n,...r)}return e.apply(this,arguments)},Wm=jf((e,t,n)=>{const r=pI(),s=[[Dr,[[r,e.context]]]];n?.scheduler&&s.push([Af,[[r,n.scheduler]]]);let o=oH(e.fiberRefs,{entries:s,forkAs:r});n?.updateRefs&&(o=n.updateRefs(o,r));const a=new jO(r,o,e.runtimeFlags);let u=t;n?.scope&&(u=M(qw(n.scope,qf),d=>wt(a1(d,aa(p=>le(p,a.id())?Ve:Ts(a,p))),is(t,p=>ln(d,p)))));const f=a.currentSupervisor;return f!==Dm&&(f.onStart(e.context,u,H(),a),a.addObserver(d=>f.onEnd(d,a))),Ff.add(e.runtimeFlags,a),n?.immediate===!1?a.resume(u):a.start(u),a}),uK=jf((e,t)=>{const n=hK(e)(t);if(n._tag==="Failure")throw ER(n.effect_instruction_i0);return n.effect_instruction_i0});class lK extends Error{fiber;_tag="AsyncFiberException";constructor(t){super(`Fiber #${t.id().id} cannot be resolved synchronously. This is caused by using runSync on an effect that performs async work`),this.fiber=t,this.name=this._tag,this.stack=this.message}}const fK=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=0;const n=new lK(e);return Error.stackTraceLimit=t,n},i_=Symbol.for("effect/Runtime/FiberFailure"),bd=Symbol.for("effect/Runtime/FiberFailure/Cause");class dK extends Error{[i_];[bd];constructor(t){const n=qS(t)[0];super(n?.message||"An error has occurred"),this[i_]=i_,this[bd]=t,this.name=n?`(FiberFailure) ${n.name}`:"FiberFailure",n?.stack&&(this.stack=n.stack)}toJSON(){return{_id:"FiberFailure",cause:this[bd].toJSON()}}toString(){return"(FiberFailure) "+Mo(this[bd],{renderErrorCause:!0})}[Le](){return this.toString()}}const ER=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=0;const n=new dK(e);return Error.stackTraceLimit=t,n},kR=e=>{const t=e;switch(t._op){case"Failure":case"Success":return t;case"Left":return yl(t.left);case"Right":return Be(t.right);case"Some":return Be(t.value);case"None":return yl(kf())}},hK=jf((e,t)=>{const n=kR(t);if(n)return n;const r=new pO,s=Wm(e)(t,{scheduler:r});r.flush();const o=s.unsafePoll();return o||Da(AS(fK(s),HS(s)))}),pK=jf((e,t,n)=>$R(e,t,n).then(r=>{switch(r._tag){case en:return r.effect_instruction_i0;case Zt:throw ER(r.effect_instruction_i0)}})),$R=jf((e,t,n)=>new Promise(r=>{const s=kR(t);s&&r(s);const o=Wm(e)(t);o.addObserver(a=>{r(a)}),n?.signal!==void 0&&(n.signal.aborted?o.unsafeInterruptAsFork(o.id()):n.signal.addEventListener("abort",()=>{o.unsafeInterruptAsFork(o.id())},{once:!0}))}));class TR{context;runtimeFlags;fiberRefs;constructor(t,n,r){this.context=t,this.runtimeFlags=n,this.fiberRefs=r}pipe(){return Y(this,arguments)}}const CR=e=>new TR(e.context,e.runtimeFlags,e.fiberRefs),mK=()=>qe((e,t)=>W(new TR(e.getFiberRef(Dr),t.runtimeFlags,e.getFiberRefs()))),gK=OI(Bc,CI,TI),ql=CR({context:js(),runtimeFlags:gK,fiberRefs:iH()}),_K=y(2,(e,t)=>CR({context:t(e.context),runtimeFlags:e.runtimeFlags,fiberRefs:e.fiberRefs})),yK=Wm(ql),bK=pK(ql),SK=uK(ql),wK=y(2,(e,t)=>e.modifyEffect(t)),vK="effect/Layer",IR=Symbol.for(vK),EK={_RIn:e=>e,_E:e=>e,_ROut:e=>e},Io={[IR]:EK,pipe(){return Y(this,arguments)}},kK="effect/Layer/MemoMap",a_=Symbol.for(kK),$K=Uc()("effect/Layer/CurrentMemoMap",{defaultValue:()=>IK()}),OR=e=>X(e,IR),TK=e=>e._op_layer===nK;class RR{ref;[a_];constructor(t){this.ref=t,this[a_]=a_}getOrElseMemoize(t,n){return b(wK(this.ref,r=>{const s=r.get(t);if(s!==void 0){const[o,a]=s,u=b(o,M(([f,d])=>b(X1(f),Ht(d))),is($m({onFailure:()=>Ve,onSuccess:()=>_l(n,a)})));return W([u,r])}return b(qh(0),M(o=>b(Xc(),M(a=>b(qh(()=>Ve),ge(u=>{const f=or(p=>b(Lf(),M(m=>b(p(M(qR(t,m,!0),$=>NH($(this)))),ts,M($=>{switch($._tag){case Zt:return b(d1(a,$.effect_instruction_i0),wt(dy(m,$)),wt($t($.effect_instruction_i0)));case en:return b(vl(u,C=>b(dy(m,C),wf(M1(o,O=>[O===1,O-1])),Hn)),wt(yy(o,C=>C+1)),wt(_l(n,C=>b(B(()=>r.delete(t)),wt(So(u)),M(O=>O(C))))),wt(Tf(a,$.effect_instruction_i0)),Ht($.effect_instruction_i0[1]))}}))))),d=[b(Pr(a),is(py({onFailure:()=>Ve,onSuccess:()=>yy(o,p=>p+1)}))),p=>b(So(u),M(m=>m(p)))];return[f,TK(t)?r:r.set(t,d)]}))))))}),Jc)}}const CK=de(()=>ge(ZW(new Map),e=>new RR(e))),IK=()=>new RR(bR(new Map)),xw=y(2,(e,t)=>M(CK,n=>OK(e,n,t))),OK=y(3,(e,t,n)=>M(qR(e,n),r=>El(r(t),$K,t))),qR=(e,t,n=!1)=>{const r=e;switch(r._op_layer){case"Locally":return B(()=>s=>r.f(s.getOrElseMemoize(r.self,t)));case"ExtendScope":return B(()=>s=>Ew(o=>s.getOrElseMemoize(r.layer,o)));case"Fold":return B(()=>s=>b(s.getOrElseMemoize(r.layer,t),jn({onFailure:o=>s.getOrElseMemoize(r.failureK(o),t),onSuccess:o=>s.getOrElseMemoize(r.successK(o),t)})));case"Fresh":return B(()=>s=>b(r.layer,xw(t)));case"FromEffect":return B(n?()=>s=>r.effect:()=>s=>s.getOrElseMemoize(e,t));case"Provide":return B(()=>s=>b(s.getOrElseMemoize(r.first,t),M(o=>b(s.getOrElseMemoize(r.second,t),zS(o)))));case"Scoped":return B(n?()=>s=>nu(r.effect,t):()=>s=>s.getOrElseMemoize(e,t));case"Suspend":return B(()=>s=>s.getOrElseMemoize(r.evaluate(),t));case"ProvideMerge":return B(()=>s=>b(s.getOrElseMemoize(r.first,t),ZI(s.getOrElseMemoize(r.second,t),r.zipK)));case"ZipWith":return B(()=>s=>b(s.getOrElseMemoize(r.first,t),Mf(s.getOrElseMemoize(r.second,t),r.zipK,{concurrent:!0})))}},RK=()=>ou(If()),qK=e=>AR(ru(e)),AR=e=>ou($t(e)),Nw=y(2,(e,t)=>FK(e,{onFailure:qK,onSuccess:t})),FR=y(2,(e,t)=>{const n=jp(e),r=n?e:t;return ou(ge(n?t:e,o=>pf(r,o)))});function ou(e){const t=Object.create(Io);return t._op_layer=rK,t.effect=e,t}const AK=y(2,(e,{onFailure:t,onSuccess:n})=>{const r=Object.create(Io);return r._op_layer=tK,r.layer=e,r.failureK=t,r.successK=n,r}),FK=y(2,(e,{onFailure:t,onSuccess:n})=>AK(e,{onFailure:r=>{const s=Um(r);switch(s._tag){case"Left":return t(s.left);case"Right":return AR(s.right)}},onSuccess:n})),PK=y(2,(e,t)=>jK(e,t,(n,r)=>eo(n,r))),PR=(...e)=>{let t=e[0];for(let n=1;n<e.length;n++)t=PK(t,e[n]);return t},xR=y(2,(e,t)=>{const n=jp(e),r=n?e:t;return NR(ge(n?t:e,o=>pf(r,o)))}),Km=e=>NR(b(e,Ht(js()))),NR=e=>{const t=Object.create(Io);return t._op_layer=sK,t.effect=e,t},xK=y(2,(e,t)=>{const n=jp(e);return ou(W(pf(n?e:t,n?t:e)))}),NK=e=>ou(W(e)),DK=NK(js()),DR=e=>{const t=Object.create(Io);return t._op_layer=oK,t.evaluate=e,t},MK=y(2,(e,t)=>{const n=jp(e),r=n?e:t,s=n?t:e;return ou(B(()=>pf(r,s())))}),MR=y(2,(e,t)=>DR(()=>{const n=Object.create(Io);return n._op_layer=iK,n.first=Object.create(Io,{_op_layer:{value:SR,enumerable:!0},first:{value:RK(),enumerable:!0},second:{value:Array.isArray(t)?PR(...t):t},zipK:{value:(r,s)=>b(r,eo(s))}}),n.second=e,n})),LK=y(2,(e,t)=>{const n=Object.create(Io);return n._op_layer=SR,n.first=t,n.second=MR(e,t),n.zipK=(r,s)=>b(r,eo(s)),n}),jK=y(3,(e,t,n)=>DR(()=>{const r=Object.create(Io);return r._op_layer=aK,r.first=e,r.second=t,r.zipK=n,r})),UK=e=>{const t=Bn("effect/Layer/unwrapEffect/Layer.Layer<R1, E1, A>");return Nw(FR(t,e),n=>Dn(n,t))},zK=e=>{const t=Bn("effect/Layer/unwrapScoped/Layer.Layer<R1, E1, A>");return Nw(xR(t,e),n=>Dn(n,t))},Ek=y(2,(e,t)=>VO(n=>M(xw(t,n),r=>BS(e,r)))),kk=y(2,(e,t)=>{const n=$l(ql.fiberRefs,t.fiberRefs),r=bo(ql.runtimeFlags,t.runtimeFlags);return or(s=>qe(o=>{const a=o.getFiberRef(Dr),u=o.getFiberRefs(),f=Tl(o.id(),u)(n),d=o.currentRuntimeFlags,p=Ja(r)(d),m=$l(f,u),$=bo(p,d);return o.setFiberRefs(f),o.currentRuntimeFlags=p,Cl(BS(s(e),eo(a,t.context)),qe(C=>(C.setFiberRefs(Tl(C.id(),C.getFiberRefs())(m)),C.currentRuntimeFlags=Ja($)(C.currentRuntimeFlags),Ve)))}))}),BK=y(2,(e,t)=>Array.isArray(t)?Ek(e,PR(...t)):OR(t)?Ek(e,t):yM(t)?BS(e,t):eK in t?M(t.runtimeEffect,n=>kk(e,n)):kk(e,t)),HK=W5,$k=Vi,kr=ir,c_=BH,Uf=Sw,dn=Tc,VK=Fr,us=qe,Er=ht,Mn=$t,Gi=gl,LR=uy,z=HU,Dw=KU,Jm=WH,We=W,ut=de,$e=B,me=Ve,Gm=yc,ns=dm,WK=RH,KK=KI,u_=qH,Mw=AH,JK=Q1,zf=LH,jR=jW,zo=K1,GK=XH,Ku=YH,QK=IV,Hr=rn,Rt=pm,YK=ca,mo=Lo,Oo=or,Ms=Ht,ls=Hn,ye=ge,UR=FS,Ks=mm,it=bw,zR=VI,xr=HO,di=Cl,XK=jU,ZK=is,Qm=WO,e8=Ew,Hh=VO,Qi=yV,Lw=aa,jw=mV,Uw=Lm,nr=gR,Bt=WW,t8=e6,n8=lz,r8=PH,s8=xH,Ym=nw,zw=JW,BR=If,o8=h1,qn=BK,Gd=El,i8=t4,a8=n4,ni=bc,jt=ts,Bf=YI,HR=e4,Q=M,Jr=MU,si=Jc,l_=GO,VR=KW,Bw=JO,Js=gm,Hf=JH,Hw=MH,Tk=MW,c8=bm,u8=J1,Al=GI,mr=jn,l8=jH,Vr=Y1,Cs=UH,Fl=zH,Ya=IH,f8=hz,gr=PS,Bo=mK,Xm=BW,d8=mR,jy=VW,Ho=yK,WR=bK,rs=SK,Vh=bV,Vw=SV,at=wV,Cc=Mf,h8=QH,p8=s4,Uy=r4,Zm=eO,m8=o4,g8=Sy,Te=i4,Vf=qV,hi=wy,Ww=function(e,...t){const n=Error.stackTraceLimit;Error.stackTraceLimit=2;const r=new Error;if(Error.stackTraceLimit=n,typeof e!="string")return Ck(e.length,function(...a){const u=Error.stackTraceLimit;Error.stackTraceLimit=2;const f=new Error;return Error.stackTraceLimit=u,Ik({self:this,body:e,args:a,pipeables:t,spanName:"<anonymous>",spanOptions:{context:Rh.context(!0)},errorDef:r,errorCall:f})});const s=e,o=t[0];return(a,...u)=>Ck(a.length,{[s](...f){const d=Error.stackTraceLimit;Error.stackTraceLimit=2;const p=new Error;return Error.stackTraceLimit=d,Ik({self:this,body:a,args:f,pipeables:u,spanName:s,spanOptions:o,errorDef:r,errorCall:p})}}[s])};function Ck(e,t){return Object.defineProperty(t,"length",{value:e,configurable:!0})}function Ik(e){let t,n;if(L2(e.body))t=Ch(()=>e.body.apply(e.self,e.args));else try{t=e.body.apply(e.self,e.args)}catch(a){n=a,t=Gi(a)}if(e.pipeables.length>0)try{for(const a of e.pipeables)t=a(t,...e.args)}catch(a){t=n?Mn(zt(Rn(n),Rn(a))):Gi(a)}let r=!1;const s=()=>{if(r!==!1)return r;if(e.errorCall.stack){const a=e.errorDef.stack.trim().split(`
`),u=e.errorCall.stack.trim().split(`
`);let f=a.slice(2).join(`
`).trim();f.includes("(")||(f=f.replace(/at (.*)/,"at ($1)"));let d=u.slice(2).join(`
`).trim();return d.includes("(")||(d=d.replace(/at (.*)/,"at ($1)")),r=`${f}
${d}`,r}},o=e.spanOptions&&"captureStackTrace"in e.spanOptions?e.spanOptions:{captureStackTrace:s,...e.spanOptions};return Te(t,e.spanName,o)}const Wh=VU,Kw=an,_8=vf,y8=Gc,KR=Dr,b8=jo,S8=Mm,JR=Af,w8=o1,v8=wm,E8=y(2,(e,t)=>to(UO,t)(e)),k8=e=>Km(kw(Mm,Ka(e))),$8=e=>Km(kw(Mm,yS(e))),T8=y(2,(e,t)=>Nw($8(e),()=>k8(t))),C8=e=>Km(RV(e)),I8=OR,GR=xw,QR=FR,O8=DK,R8=xR,q8=Km,Jw=xK,A8=MK,Gw=MR,YR=LK,XR=UK,Qw=zK,ZR=C8,F8="effect/QueueEnqueue",eq=Symbol.for(F8),P8="effect/QueueDequeue",Yw=Symbol.for(P8),x8="effect/QueueStrategy",Xw=Symbol.for(x8),N8="effect/BackingQueue",D8=Symbol.for(N8),Zw={_A:e=>e},M8={_A:e=>e},tq={_In:e=>e},ev={_Out:e=>e};class L8 extends no{queue;takers;shutdownHook;shutdownFlag;strategy;[eq]=tq;[Yw]=ev;constructor(t,n,r,s,o){super(),this.queue=t,this.takers=n,this.shutdownHook=r,this.shutdownFlag=s,this.strategy=o}pipe(){return Y(this,arguments)}commit(){return this.take}capacity(){return this.queue.capacity()}get size(){return de(()=>yc(this.unsafeSize(),()=>rn))}unsafeSize(){return je(this.shutdownFlag)?H():V(this.queue.length()-JS(this.takers)+this.strategy.surplusSize())}get isEmpty(){return ge(this.size,t=>t<=0)}get isFull(){return ge(this.size,t=>t>=this.capacity())}get shutdown(){return Lo(qe(t=>(b(this.shutdownFlag,oa(!0)),b(Ns(Xa(this.takers),n=>US(n,t.id()),!1,!1),wt(this.strategy.shutdown),wf(Tf(this.shutdownHook,void 0)),Hn))))}get isShutdown(){return B(()=>je(this.shutdownFlag))}get awaitShutdown(){return Pr(this.shutdownHook)}isActive(){return!je(this.shutdownFlag)}unsafeOffer(t){if(je(this.shutdownFlag))return!1;let n;if(this.queue.length()===0){const s=b(this.takers,Ps(Dt));s!==Dt?(Ei(s,t),n=!0):n=!1}else n=!1;if(n)return!0;const r=this.queue.offer(t);return pi(this.strategy,this.queue,this.takers),r}offer(t){return de(()=>{if(je(this.shutdownFlag))return rn;let n;if(this.queue.length()===0){const s=b(this.takers,Ps(Dt));s!==Dt?(Ei(s,t),n=!0):n=!1}else n=!1;if(n)return W(!0);const r=this.queue.offer(t);return pi(this.strategy,this.queue,this.takers),r?W(!0):this.strategy.handleSurplus([t],this.queue,this.takers,this.shutdownFlag)})}offerAll(t){return de(()=>{if(je(this.shutdownFlag))return rn;const n=Me(t),r=this.queue.length()===0?Me(oJ(this.takers,n.length)):ko,[s,o]=b(n,WT(r.length));for(let u=0;u<r.length;u++){const f=r[u],d=s[u];Ei(f,d)}if(o.length===0)return W(!0);const a=this.queue.offerAll(o);return pi(this.strategy,this.queue,this.takers),mf(a)?W(!0):this.strategy.handleSurplus(a,this.queue,this.takers,this.shutdownFlag)})}get take(){return qe(t=>{if(je(this.shutdownFlag))return rn;const n=this.queue.poll(Dt);if(n!==Dt)return this.strategy.unsafeOnQueueEmptySpace(this.queue,this.takers),W(n);{const r=Yc(t.id());return b(de(()=>(b(this.takers,vc(r)),pi(this.strategy,this.queue,this.takers),je(this.shutdownFlag)?rn:Pr(r))),ca(()=>B(()=>iJ(this.takers,r))))}})}get takeAll(){return de(()=>je(this.shutdownFlag)?rn:B(()=>{const t=this.queue.pollUpTo(Number.POSITIVE_INFINITY);return this.strategy.unsafeOnQueueEmptySpace(this.queue,this.takers),Us(t)}))}takeUpTo(t){return de(()=>je(this.shutdownFlag)?rn:B(()=>{const n=this.queue.pollUpTo(t);return this.strategy.unsafeOnQueueEmptySpace(this.queue,this.takers),Us(n)}))}takeBetween(t,n){return de(()=>nq(this,t,n,lt()))}}const nq=(e,t,n,r)=>n<t?W(r):b(X8(e,n),M(s=>{const o=t-s.length;return o===1?b(zy(e),ge(a=>b(r,_t(s),cl(a)))):o>1?b(zy(e),M(a=>nq(e,o-1,n-s.length-1,b(r,_t(s),cl(a))))):W(b(r,_t(s)))})),j8=e=>b(B(()=>KS(e)),M(t=>eg(tg(t),eJ()))),U8=e=>b(B(()=>KS(e)),M(t=>eg(tg(t),rq()))),z8=e=>b(B(()=>KS(e)),M(t=>eg(tg(t),tJ()))),B8=()=>b(B(()=>Tm()),M(e=>eg(tg(e),rq()))),H8=(e,t,n,r,s)=>new L8(e,t,n,r,s),eg=(e,t)=>b(Xc(),ge(n=>H8(e,Tm(),n,sa(!1),t)));class V8{mutable;[D8]=M8;constructor(t){this.mutable=t}poll(t){return Ps(this.mutable,t)}pollUpTo(t){return Cm(this.mutable,t)}offerAll(t){return GS(this.mutable,t)}offer(t){return vc(this.mutable,t)}capacity(){return Xz(this.mutable)}length(){return JS(this.mutable)}}const tg=e=>new V8(e),W8=e=>e.size,K8=e=>e.isShutdown,J8=e=>e.shutdown,G8=y(2,(e,t)=>e.offer(t)),Q8=y(2,(e,t)=>e.offerAll(t)),zy=e=>e.take,Y8=e=>e.takeAll,X8=y(2,(e,t)=>e.takeUpTo(t)),Z8=y(3,(e,t,n)=>e.takeBetween(t,n)),eJ=()=>new nJ,rq=()=>new rJ,tJ=()=>new sJ;class nJ{[Xw]=Zw;putters=Tm();surplusSize(){return JS(this.putters)}onCompleteTakersWithEmptyQueue(t){for(;!wi(this.putters)&&!wi(t);){const n=Ps(t,void 0),r=Ps(this.putters,void 0);r[2]&&Ei(r[1],!0),Ei(n,r[0])}}get shutdown(){return b(hm,M(t=>b(B(()=>Xa(this.putters)),M(n=>Ns(n,([r,s,o])=>o?b(US(s,t),Hn):Ve,!1,!1)))))}handleSurplus(t,n,r,s){return qe(o=>{const a=Yc(o.id());return b(de(()=>(this.unsafeOffer(t,a),this.unsafeOnQueueEmptySpace(n,r),pi(this,n,r),je(s)?rn:Pr(a))),ca(()=>B(()=>this.unsafeRemove(a))))})}unsafeOnQueueEmptySpace(t,n){let r=!0;for(;r&&(t.capacity()===Number.POSITIVE_INFINITY||t.length()<t.capacity());){const s=b(this.putters,Ps(Dt));if(s===Dt)r=!1;else{const o=t.offer(s[0]);o&&s[2]?Ei(s[1],!0):o||Kh(this.putters,b(Xa(this.putters),pn(s))),pi(this,t,n)}}}unsafeOffer(t,n){const r=Me(t);for(let s=0;s<r.length;s++){const o=r[s];s===r.length-1?b(this.putters,vc([o,n,!0])):b(this.putters,vc([o,n,!1]))}}unsafeRemove(t){Kh(this.putters,b(Xa(this.putters),zp(([,n])=>n!==t)))}}let rJ=class{[Xw]=Zw;surplusSize(){return 0}get shutdown(){return Ve}onCompleteTakersWithEmptyQueue(){}handleSurplus(t,n,r,s){return W(!1)}unsafeOnQueueEmptySpace(t,n){}};class sJ{[Xw]=Zw;surplusSize(){return 0}get shutdown(){return Ve}onCompleteTakersWithEmptyQueue(){}handleSurplus(t,n,r,s){return B(()=>(this.unsafeOffer(n,t),pi(this,n,r),!0))}unsafeOnQueueEmptySpace(t,n){}unsafeOffer(t,n){const r=n[Symbol.iterator]();let s,o=!0;for(;!(s=r.next()).done&&o;){if(t.capacity()===0)return;t.poll(Dt),o=t.offer(s.value)}}}const Ei=(e,t)=>Cf(e,W(t)),Kh=(e,t)=>b(e,GS(t)),Xa=e=>b(e,Cm(Number.POSITIVE_INFINITY)),oJ=(e,t)=>b(e,Cm(t)),iJ=(e,t)=>{Kh(e,b(Xa(e),zp(n=>t!==n)))},pi=(e,t,n)=>{let r=!0;for(;r&&t.length()!==0;){const s=b(n,Ps(Dt));if(s!==Dt){const o=t.poll(Dt);o!==Dt?(Ei(s,o),e.unsafeOnQueueEmptySpace(t,n)):Kh(n,b(Xa(n),pn(s))),r=!0}else r=!1}r&&t.length()===0&&!wi(n)&&e.onCompleteTakersWithEmptyQueue(n)},Wr=Symbol.for("effect/PubSub/AbsentValue"),sq=(e,t)=>n=>{n.has(e)||n.set(e,new Set),n.get(e).add(t)},aJ=(e,t)=>n=>{if(!n.has(e))return;const r=n.get(e);r.delete(t),r.size===0&&n.delete(e)},cJ=e=>de(()=>{const t=dJ(e);return bJ(t,new TJ)}),uJ=e=>e.shutdown,lJ=y(2,(e,t)=>e.publish(t)),fJ=e=>e.subscribe,dJ=e=>new mJ(e?.replay?new OJ(e.replay):void 0),hJ=(e,t,n)=>ge(Xc(),r=>pJ(e,t,e.subscribe(),Tm(),r,sa(!1),n)),pJ=(e,t,n,r,s,o,a)=>new _J(e,t,n,r,s,o,a,e.replayWindow());class mJ{replayBuffer;publisherHead={value:Wr,subscribers:0,next:null};publisherTail=this.publisherHead;publisherIndex=0;subscribersIndex=0;capacity=Number.MAX_SAFE_INTEGER;constructor(t){this.replayBuffer=t}replayWindow(){return this.replayBuffer?new RJ(this.replayBuffer):qJ}isEmpty(){return this.publisherHead===this.publisherTail}isFull(){return!1}size(){return this.publisherIndex-this.subscribersIndex}publish(t){const n=this.publisherTail.subscribers;return n!==0&&(this.publisherTail.next={value:t,subscribers:n,next:null},this.publisherTail=this.publisherTail.next,this.publisherIndex+=1),this.replayBuffer&&this.replayBuffer.offer(t),!0}publishAll(t){if(this.publisherTail.subscribers!==0)for(const n of t)this.publish(n);else this.replayBuffer&&this.replayBuffer.offerAll(t);return lt()}slide(){this.publisherHead!==this.publisherTail&&(this.publisherHead=this.publisherHead.next,this.publisherHead.value=Wr,this.subscribersIndex+=1),this.replayBuffer&&this.replayBuffer.slide()}subscribe(){return this.publisherTail.subscribers+=1,new gJ(this,this.publisherTail,this.publisherIndex,!1)}}class gJ{self;subscriberHead;subscriberIndex;unsubscribed;constructor(t,n,r,s){this.self=t,this.subscriberHead=n,this.subscriberIndex=r,this.unsubscribed=s}isEmpty(){if(this.unsubscribed)return!0;let t=!0,n=!0;for(;n;)this.subscriberHead===this.self.publisherTail?n=!1:this.subscriberHead.next.value!==Wr?(t=!1,n=!1):(this.subscriberHead=this.subscriberHead.next,this.subscriberIndex+=1);return t}size(){return this.unsubscribed?0:this.self.publisherIndex-Math.max(this.subscriberIndex,this.self.subscribersIndex)}poll(t){if(this.unsubscribed)return t;let n=!0,r=t;for(;n;)if(this.subscriberHead===this.self.publisherTail)n=!1;else{const s=this.subscriberHead.next.value;s!==Wr&&(r=s,this.subscriberHead.subscribers-=1,this.subscriberHead.subscribers===0&&(this.self.publisherHead=this.self.publisherHead.next,this.self.publisherHead.value=Wr,this.self.subscribersIndex+=1),n=!1),this.subscriberHead=this.subscriberHead.next,this.subscriberIndex+=1}return r}pollUpTo(t){const n=[],r=Wr;let s=0;for(;s!==t;){const o=this.poll(r);o===r?s=t:(n.push(o),s+=1)}return Us(n)}unsubscribe(){if(!this.unsubscribed)for(this.unsubscribed=!0,this.self.publisherTail.subscribers-=1;this.subscriberHead!==this.self.publisherTail;)this.subscriberHead.next.value!==Wr&&(this.subscriberHead.subscribers-=1,this.subscriberHead.subscribers===0&&(this.self.publisherHead=this.self.publisherHead.next,this.self.publisherHead.value=Wr,this.self.subscribersIndex+=1)),this.subscriberHead=this.subscriberHead.next}}class _J extends no{pubsub;subscribers;subscription;pollers;shutdownHook;shutdownFlag;strategy;replayWindow;[Yw]=ev;constructor(t,n,r,s,o,a,u,f){super(),this.pubsub=t,this.subscribers=n,this.subscription=r,this.pollers=s,this.shutdownHook=o,this.shutdownFlag=a,this.strategy=u,this.replayWindow=f}commit(){return this.take}pipe(){return Y(this,arguments)}capacity(){return this.pubsub.capacity}isActive(){return!je(this.shutdownFlag)}get size(){return de(()=>je(this.shutdownFlag)?rn:W(this.subscription.size()+this.replayWindow.remaining))}unsafeSize(){return je(this.shutdownFlag)?H():V(this.subscription.size()+this.replayWindow.remaining)}get isFull(){return de(()=>je(this.shutdownFlag)?rn:W(this.subscription.size()===this.capacity()))}get isEmpty(){return ge(this.size,t=>t===0)}get shutdown(){return Lo(qe(t=>(oa(this.shutdownFlag,!0),b(ww(tv(this.pollers),n=>US(n,t.id()),!1),wt(B(()=>{this.subscribers.delete(this.subscription),this.subscription.unsubscribe(),this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers)})),wf(Tf(this.shutdownHook,void 0)),Hn))))}get isShutdown(){return B(()=>je(this.shutdownFlag))}get awaitShutdown(){return Pr(this.shutdownHook)}get take(){return qe(t=>{if(je(this.shutdownFlag))return rn;if(this.replayWindow.remaining>0){const r=this.replayWindow.take();return W(r)}const n=wi(this.pollers)?this.subscription.poll(Dt):Dt;if(n===Dt){const r=Yc(t.id());return b(de(()=>(b(this.pollers,vc(r)),b(this.subscribers,sq(this.subscription,this.pollers)),this.strategy.unsafeCompletePollers(this.pubsub,this.subscribers,this.subscription,this.pollers),je(this.shutdownFlag)?rn:Pr(r))),ca(()=>B(()=>$J(this.pollers,r))))}else return this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers),W(n)})}get takeAll(){return de(()=>{if(je(this.shutdownFlag))return rn;const t=wi(this.pollers)?vJ(this.subscription):lt();return this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers),this.replayWindow.remaining>0?W(_t(this.replayWindow.takeAll(),t)):W(t)})}takeUpTo(t){return de(()=>{if(je(this.shutdownFlag))return rn;let n;if(this.replayWindow.remaining>=t){const s=this.replayWindow.takeN(t);return W(s)}else this.replayWindow.remaining>0&&(n=this.replayWindow.takeAll(),t=t-n.length);const r=wi(this.pollers)?EJ(this.subscription,t):lt();return this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers),W(n?_t(n,r):r)})}takeBetween(t,n){return de(()=>oq(this,t,n,lt()))}}const oq=(e,t,n,r)=>n<t?W(r):b(e.takeUpTo(n),M(s=>{const o=t-s.length;return o===1?b(e.take,ge(a=>b(r,_t(s),cl(a)))):o>1?b(e.take,M(a=>oq(e,o-1,n-s.length-1,b(r,_t(s),cl(a))))):W(b(r,_t(s)))}));class yJ{pubsub;subscribers;scope;shutdownHook;shutdownFlag;strategy;[eq]=tq;[Yw]=ev;constructor(t,n,r,s,o,a){this.pubsub=t,this.subscribers=n,this.scope=r,this.shutdownHook=s,this.shutdownFlag=o,this.strategy=a}capacity(){return this.pubsub.capacity}get size(){return de(()=>je(this.shutdownFlag)?rn:B(()=>this.pubsub.size()))}unsafeSize(){return je(this.shutdownFlag)?H():V(this.pubsub.size())}get isFull(){return ge(this.size,t=>t===this.capacity())}get isEmpty(){return ge(this.size,t=>t===0)}get awaitShutdown(){return Pr(this.shutdownHook)}get isShutdown(){return B(()=>je(this.shutdownFlag))}get shutdown(){return Lo(qe(t=>(b(this.shutdownFlag,oa(!0)),b(this.scope.close(LS(t.id())),wt(this.strategy.shutdown),wf(Tf(this.shutdownHook,void 0)),Hn))))}publish(t){return de(()=>je(this.shutdownFlag)?rn:this.pubsub.publish(t)?(this.strategy.unsafeCompleteSubscribers(this.pubsub,this.subscribers),W(!0)):this.strategy.handleSurplus(this.pubsub,this.subscribers,rt(t),this.shutdownFlag))}isActive(){return!je(this.shutdownFlag)}unsafeOffer(t){return je(this.shutdownFlag)?!1:this.pubsub.publish(t)?(this.strategy.unsafeCompleteSubscribers(this.pubsub,this.subscribers),!0):!1}publishAll(t){return de(()=>{if(je(this.shutdownFlag))return rn;const n=kJ(this.pubsub,t);return this.strategy.unsafeCompleteSubscribers(this.pubsub,this.subscribers),mf(n)?W(!0):this.strategy.handleSurplus(this.pubsub,this.subscribers,n,this.shutdownFlag)})}get subscribe(){const t=gm(Sw([this.scope.fork(qf),hJ(this.pubsub,this.subscribers,this.strategy)]),n=>n[0].addFinalizer(()=>n[1].shutdown));return ge(bw(t,(n,r)=>n[0].close(r)),n=>n[1])}offer(t){return this.publish(t)}offerAll(t){return this.publishAll(t)}pipe(){return Y(this,arguments)}}const bJ=(e,t)=>M(Lf(),n=>ge(Xc(),r=>SJ(e,new Map,n,r,sa(!1),t))),SJ=(e,t,n,r,s,o)=>new yJ(e,t,n,r,s,o),wJ=(e,t)=>{Cf(e,W(t))},iq=(e,t)=>b(e,GS(t)),tv=e=>b(e,Cm(Number.POSITIVE_INFINITY)),vJ=e=>e.pollUpTo(Number.POSITIVE_INFINITY),EJ=(e,t)=>e.pollUpTo(t),kJ=(e,t)=>e.publishAll(t),$J=(e,t)=>{iq(e,b(tv(e),zp(n=>n!==t)))};class TJ{get shutdown(){return Ve}handleSurplus(t,n,r,s){return W(!1)}unsafeOnPubSubEmptySpace(t,n){}unsafeCompletePollers(t,n,r,s){return CJ(this,t,n,r,s)}unsafeCompleteSubscribers(t,n){return IJ(this,t,n)}}const CJ=(e,t,n,r,s)=>{let o=!0;for(;o&&!r.isEmpty();){const a=b(s,Ps(Dt));if(a===Dt)b(n,aJ(r,s)),wi(s)?o=!1:b(n,sq(r,s));else{const u=r.poll(Dt);u===Dt?iq(s,b(tv(s),pn(a))):(wJ(a,u),e.unsafeOnPubSubEmptySpace(t,n))}}},IJ=(e,t,n)=>{for(const[r,s]of n)for(const o of s)e.unsafeCompletePollers(t,n,r,o)};class OJ{capacity;constructor(t){this.capacity=t}head={value:Wr,next:null};tail=this.head;size=0;index=0;slide(){this.index++}offer(t){this.tail.value=t,this.tail.next={value:Wr,next:null},this.tail=this.tail.next,this.size===this.capacity?this.head=this.head.next:this.size+=1}offerAll(t){for(const n of t)this.offer(n)}}class RJ{buffer;head;index;remaining;constructor(t){this.buffer=t,this.index=t.index,this.remaining=t.size,this.head=t.head}fastForward(){for(;this.index<this.buffer.index;)this.head=this.head.next,this.index++}take(){if(this.remaining===0)return;this.index<this.buffer.index&&this.fastForward(),this.remaining--;const t=this.head.value;return this.head=this.head.next,t}takeN(t){if(this.remaining===0)return lt();this.index<this.buffer.index&&this.fastForward();const n=Math.min(t,this.remaining),r=new Array(n);for(let s=0;s<n;s++){const o=this.head.value;this.head=this.head.next,r[s]=o}return this.remaining-=n,Pt(r)}takeAll(){return this.takeN(this.remaining)}}const qJ={remaining:0,take:()=>{},takeN:()=>lt(),takeAll:()=>lt()},aq=cJ,By=uJ,nv=lJ,Ok=fJ,Ic=j8,ng=U8,rg=z8,fn=B8,AJ=W8,FJ=K8,Lt=J8,Ge=G8,rv=Q8,Ro=zy,PJ=Y8,cq=Z8,uq="Continue",xJ="Close",NJ="Yield",DJ="effect/ChannelChildExecutorDecision",Rk=Symbol.for(DJ),MJ={[Rk]:Rk},lq=e=>{const t=Object.create(MJ);return t._tag=uq,t},Qd="ContinuationK",LJ="ContinuationFinalizer",fq=Symbol.for("effect/ChannelContinuation"),dq={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutDone:e=>e,_OutErr2:e=>e,_OutElem:e=>e,_OutDone2:e=>e};class sv{onSuccess;onHalt;_tag=Qd;[fq]=dq;constructor(t,n){this.onSuccess=t,this.onHalt=n}onExit(t){return eu(t)?this.onHalt(t.cause):this.onSuccess(t.value)}}class jJ{finalizer;_tag=LJ;[fq]=dq;constructor(t){this.finalizer=t}}const hq="PullAfterNext",UJ="PullAfterAllEnqueued",zJ="effect/ChannelUpstreamPullStrategy",BJ=Symbol.for(zJ),HJ={_A:e=>e},VJ={[BJ]:HJ},pq=e=>{const t=Object.create(VJ);return t._tag=hq,t.emitSeparator=e,t},mq="BracketOut",gq="Bridge",ov="ConcatAll",_q="Emit",yq="Ensuring",bq="Fail",iv="Fold",Sq="FromEffect",wq="PipeTo",vq="Provide",Eq="Read",kq="Succeed",$q="SucceedNow",Tq="Suspend",WJ="effect/Channel",Jh=Symbol.for(WJ),KJ={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},wn={[Jh]:KJ,pipe(){return Y(this,arguments)}},Cq=e=>X(e,Jh)||kr(e),JJ=y(2,(e,t)=>{const n=Object.create(wn);return n._tag=mq,n.acquire=()=>e,n.finalizer=t,n}),Iq=y(2,(e,t)=>{const n=Object.create(wn);return n._tag=iv,n.channel=e,n.k=new sv(fa,t),n}),Oq=(e,t,n)=>{const r=Object.create(wn);return r._tag=ov,r.combineInners=t,r.combineAll=n,r.onPull=()=>pq(H()),r.onEmit=()=>lq,r.value=()=>e,r.k=oe,r},GJ=y(4,(e,t,n,r)=>{const s=Object.create(wn);return s._tag=ov,s.combineInners=n,s.combineAll=r,s.onPull=()=>pq(H()),s.onEmit=()=>lq,s.value=()=>e,s.k=t,s}),av=y(2,(e,t)=>{const n=Object.create(wn);return n._tag=gq,n.input=t,n.channel=e,n}),cv=y(2,(e,t)=>{const n=Object.create(wn);return n._tag=yq,n.channel=e,n.finalizer=t,n}),Wf=e=>bt(ru(e)),bt=e=>Rq(()=>e),Rq=e=>{const t=Object.create(wn);return t._tag=bq,t.error=e,t},Ae=y(2,(e,t)=>{const n=Object.create(wn);return n._tag=iv,n.channel=e,n.k=new sv(t,bt),n}),gt=e=>{const t=Object.create(wn);return t._tag=Sq,t.effect=()=>e,t},tn=y(2,(e,t)=>{const n=Object.create(wn);return n._tag=wq,n.left=()=>e,n.right=()=>t,n}),Hy=y(2,(e,t)=>{const n=Object.create(wn);return n._tag=vq,n.context=()=>t,n.inner=e,n}),sg=e=>ar({onInput:e.onInput,onFailure:t=>Yt(Um(t),{onLeft:e.onFailure,onRight:bt}),onDone:e.onDone}),ar=e=>{const t=Object.create(wn);return t._tag=Eq,t.more=e.onInput,t.done=new sv(e.onDone,e.onFailure),t},fa=e=>qq(()=>e),qo=e=>{const t=Object.create(wn);return t._tag=$q,t.terminal=e,t},Kf=e=>{const t=Object.create(wn);return t._tag=Tq,t.channel=e,t},qq=e=>{const t=Object.create(wn);return t._tag=kq,t.evaluate=e,t},sn=qo(void 0),Qe=e=>{const t=Object.create(wn);return t._tag=_q,t.out=e,t},Jf="Done",Gf="Emit",iu="FromEffect",Qf="Read",QJ=Symbol.for("effect/ChannelState"),YJ={_E:e=>e,_R:e=>e},og={[QJ]:YJ},Ca=()=>{const e=Object.create(og);return e._tag=Jf,e},f_=()=>{const e=Object.create(og);return e._tag=Gf,e},$u=e=>{const t=Object.create(og);return t._tag=iu,t.effect=e,t},d_=(e,t,n,r)=>{const s=Object.create(og);return s._tag=Qf,s.upstream=e,s.onEffect=t,s.onEmit=n,s.onDone=r,s},Gh=e=>e._tag===iu,XJ=e=>Gh(e)?e.effect:me,qk=e=>Gh(e)?JK(e.effect):void 0,Aq="PullFromChild",Vy="PullFromUpstream",Wy="DrainChildExecutors",Fq="Emit";class Sd{childExecutor;parentSubexecutor;onEmit;_tag=Aq;constructor(t,n,r){this.childExecutor=t,this.parentSubexecutor=n,this.onEmit=r}close(t){const n=this.childExecutor.close(t),r=this.parentSubexecutor.close(t);return n!==void 0&&r!==void 0?Cc(jt(n),jt(r),(s,o)=>b(s,Sl(o))):n!==void 0?n:r!==void 0?r:void 0}enqueuePullFromChild(t){return this}}class oi{upstreamExecutor;createChild;lastDone;activeChildExecutors;combineChildResults;combineWithChildResult;onPull;onEmit;_tag=Vy;constructor(t,n,r,s,o,a,u,f){this.upstreamExecutor=t,this.createChild=n,this.lastDone=r,this.activeChildExecutors=s,this.combineChildResults=o,this.combineWithChildResult=a,this.onPull=u,this.onEmit=f}close(t){const n=this.upstreamExecutor.close(t),s=[...this.activeChildExecutors.map(o=>o!==void 0?o.childExecutor.close(t):void 0),n].reduce((o,a)=>o!==void 0&&a!==void 0?Cc(o,jt(a),(u,f)=>Sl(u,f)):o!==void 0?o:a!==void 0?jt(a):void 0,void 0);return s}enqueuePullFromChild(t){return new oi(this.upstreamExecutor,this.createChild,this.lastDone,[...this.activeChildExecutors,t],this.combineChildResults,this.combineWithChildResult,this.onPull,this.onEmit)}}class Ma{upstreamExecutor;lastDone;activeChildExecutors;upstreamDone;combineChildResults;combineWithChildResult;onPull;_tag=Wy;constructor(t,n,r,s,o,a,u){this.upstreamExecutor=t,this.lastDone=n,this.activeChildExecutors=r,this.upstreamDone=s,this.combineChildResults=o,this.combineWithChildResult=a,this.onPull=u}close(t){const n=this.upstreamExecutor.close(t),s=[...this.activeChildExecutors.map(o=>o!==void 0?o.childExecutor.close(t):void 0),n].reduce((o,a)=>o!==void 0&&a!==void 0?Cc(o,jt(a),(u,f)=>Sl(u,f)):o!==void 0?o:a!==void 0?jt(a):void 0,void 0);return s}enqueuePullFromChild(t){return new Ma(this.upstreamExecutor,this.lastDone,[...this.activeChildExecutors,t],this.upstreamDone,this.combineChildResults,this.combineWithChildResult,this.onPull)}}class h_{value;next;_tag=Fq;constructor(t,n){this.value=t,this.next=n}close(t){const n=this.next.close(t);return n}enqueuePullFromChild(t){return this}}const ZJ="Pulled",eG="NoUpstream",tG="effect/ChannelUpstreamPullRequest",nG=Symbol.for(tG),rG={_A:e=>e},Pq={[nG]:rG},Ak=e=>{const t=Object.create(Pq);return t._tag=ZJ,t.value=e,t},sG=e=>{const t=Object.create(Pq);return t._tag=eG,t.activeDownstreamCount=e,t};class mi{_activeSubexecutor=void 0;_cancelled=void 0;_closeLastSubstream=void 0;_currentChannel;_done=void 0;_doneStack=[];_emitted=void 0;_executeCloseLastSubstream;_input=void 0;_inProgressFinalizer=void 0;_providedEnv;constructor(t,n,r){this._currentChannel=t,this._executeCloseLastSubstream=r,this._providedEnv=n}run(){let t;for(;t===void 0;)if(this._cancelled!==void 0)t=this.processCancellation();else if(this._activeSubexecutor!==void 0)t=this.runSubexecutor();else try{if(this._currentChannel===void 0)t=Ca();else switch(kr(this._currentChannel)&&(this._currentChannel=gt(this._currentChannel)),this._currentChannel._tag){case mq:{t=this.runBracketOut(this._currentChannel);break}case gq:{const n=this._currentChannel.input;if(this._currentChannel=this._currentChannel.channel,this._input!==void 0){const r=this._input;this._input=void 0;const s=()=>Q(n.awaitRead(),()=>ut(()=>{const o=r.run();switch(o._tag){case Jf:return qr(r.getDone(),{onFailure:a=>n.error(a),onSuccess:a=>n.done(a)});case Gf:return Q(n.emit(r.getEmit()),()=>s());case iu:return mr(o.effect,{onFailure:a=>n.error(a),onSuccess:()=>s()});case Qf:return uv(o,()=>s(),a=>n.error(a))}}));t=$u(Q(Uw(Rt(s())),o=>$e(()=>this.addFinalizer(a=>Q(Sr(o),()=>ut(()=>{const u=this.restorePipe(a,r);return u!==void 0?u:me}))))))}break}case ov:{const n=new mi(this._currentChannel.value(),this._providedEnv,s=>$e(()=>{const o=this._closeLastSubstream===void 0?me:this._closeLastSubstream;this._closeLastSubstream=b(o,at(s))}));n._input=this._input;const r=this._currentChannel;this._activeSubexecutor=new oi(n,s=>r.k(s),void 0,[],(s,o)=>r.combineInners(s,o),(s,o)=>r.combineAll(s,o),s=>r.onPull(s),s=>r.onEmit(s)),this._closeLastSubstream=void 0,this._currentChannel=void 0;break}case _q:{this._emitted=this._currentChannel.out,this._currentChannel=this._activeSubexecutor!==void 0?void 0:sn,t=f_();break}case yq:{this.runEnsuring(this._currentChannel);break}case bq:{t=this.doneHalt(this._currentChannel.error());break}case iv:{this._doneStack.push(this._currentChannel.k),this._currentChannel=this._currentChannel.channel;break}case Sq:{const n=this._providedEnv===void 0?this._currentChannel.effect():b(this._currentChannel.effect(),qn(this._providedEnv));t=$u(mr(n,{onFailure:r=>{const s=this.doneHalt(r);return s!==void 0&&Gh(s)?s.effect:me},onSuccess:r=>{const s=this.doneSucceed(r);return s!==void 0&&Gh(s)?s.effect:me}}));break}case wq:{const n=this._input,r=new mi(this._currentChannel.left(),this._providedEnv,s=>this._executeCloseLastSubstream(s));r._input=n,this._input=r,this.addFinalizer(s=>{const o=this.restorePipe(s,n);return o!==void 0?o:me}),this._currentChannel=this._currentChannel.right();break}case vq:{const n=this._providedEnv;this._providedEnv=this._currentChannel.context(),this._currentChannel=this._currentChannel.inner,this.addFinalizer(()=>$e(()=>{this._providedEnv=n}));break}case Eq:{const n=this._currentChannel;t=d_(this._input,oe,r=>{try{this._currentChannel=n.more(r)}catch(s){this._currentChannel=n.done.onExit(bl(s))}},r=>{const s=o=>n.done.onExit(o);this._currentChannel=s(r)});break}case kq:{t=this.doneSucceed(this._currentChannel.evaluate());break}case $q:{t=this.doneSucceed(this._currentChannel.terminal);break}case Tq:{this._currentChannel=this._currentChannel.channel();break}}}catch(n){this._currentChannel=bt(Ji(n))}return t}getDone(){return this._done}getEmit(){return this._emitted}cancelWith(t){this._cancelled=t}clearInProgressFinalizer(){this._inProgressFinalizer=void 0}storeInProgressFinalizer(t){this._inProgressFinalizer=t}popAllFinalizers(t){const n=[];let r=this._doneStack.pop();for(;r;)r._tag==="ContinuationFinalizer"&&n.push(r.finalizer),r=this._doneStack.pop();const s=n.length===0?me:m_(n,t);return this.storeInProgressFinalizer(s),s}popNextFinalizers(){const t=[];for(;this._doneStack.length!==0;){const n=this._doneStack[this._doneStack.length-1];if(n._tag===Qd)return t;t.push(n),this._doneStack.pop()}return t}restorePipe(t,n){const r=this._input;return this._input=n,r!==void 0?r.close(t):me}close(t){let n;const r=this._inProgressFinalizer;r!==void 0&&(n=b(r,di($e(()=>this.clearInProgressFinalizer()))));let s;const o=this.popAllFinalizers(t);o!==void 0&&(s=b(o,di($e(()=>this.clearInProgressFinalizer()))));const a=this._activeSubexecutor===void 0?void 0:this._activeSubexecutor.close(t);if(!(a===void 0&&n===void 0&&s===void 0))return b(jt(p_(a)),Vh(jt(p_(n))),Vh(jt(p_(s))),ye(([[u,f],d])=>b(u,Sl(f),Sl(d))),mo,Q(u=>ut(()=>u)))}doneSucceed(t){if(this._doneStack.length===0)return this._done=Mt(t),this._currentChannel=void 0,Ca();const n=this._doneStack[this._doneStack.length-1];if(n._tag===Qd){this._doneStack.pop(),this._currentChannel=n.onSuccess(t);return}const r=this.popNextFinalizers();if(this._doneStack.length===0)return this._doneStack=r.reverse(),this._done=Mt(t),this._currentChannel=void 0,Ca();const s=m_(r.map(a=>a.finalizer),Mt(t));this.storeInProgressFinalizer(s);const o=b(s,di($e(()=>this.clearInProgressFinalizer())),mo,Q(()=>$e(()=>this.doneSucceed(t))));return $u(o)}doneHalt(t){if(this._doneStack.length===0)return this._done=Xt(t),this._currentChannel=void 0,Ca();const n=this._doneStack[this._doneStack.length-1];if(n._tag===Qd){this._doneStack.pop();try{this._currentChannel=n.onHalt(t)}catch(a){this._currentChannel=bt(Ji(a))}return}const r=this.popNextFinalizers();if(this._doneStack.length===0)return this._doneStack=r.reverse(),this._done=Xt(t),this._currentChannel=void 0,Ca();const s=m_(r.map(a=>a.finalizer),Xt(t));this.storeInProgressFinalizer(s);const o=b(s,di($e(()=>this.clearInProgressFinalizer())),mo,Q(()=>$e(()=>this.doneHalt(t))));return $u(o)}processCancellation(){return this._currentChannel=void 0,this._done=this._cancelled,this._cancelled=void 0,Ca()}runBracketOut(t){const n=mo(mr(this.provide(t.acquire()),{onFailure:r=>$e(()=>{this._currentChannel=bt(r)}),onSuccess:r=>$e(()=>{this.addFinalizer(s=>this.provide(t.finalizer(r,s))),this._currentChannel=Qe(r)})}));return $u(n)}provide(t){return this._providedEnv===void 0?t:b(t,qn(this._providedEnv))}runEnsuring(t){this.addFinalizer(t.finalizer),this._currentChannel=t.channel}addFinalizer(t){this._doneStack.push(new jJ(t))}runSubexecutor(){const t=this._activeSubexecutor;switch(t._tag){case Aq:return this.pullFromChild(t.childExecutor,t.parentSubexecutor,t.onEmit,t);case Vy:return this.pullFromUpstream(t);case Wy:return this.drainChildExecutors(t);case Fq:return this._emitted=t.value,this._activeSubexecutor=t.next,f_()}}replaceSubexecutor(t){this._currentChannel=void 0,this._activeSubexecutor=t}finishWithExit(t){const n=qr(t,{onFailure:r=>this.doneHalt(r),onSuccess:r=>this.doneSucceed(r)});return this._activeSubexecutor=void 0,n===void 0?me:XJ(n)}finishSubexecutorWithCloseEffect(t,...n){this.addFinalizer(()=>b(n,dn(s=>b($e(()=>s(t)),Q(o=>o!==void 0?o:me)),{discard:!0})));const r=b(t,qr({onFailure:s=>this.doneHalt(s),onSuccess:s=>this.doneSucceed(s)}));return this._activeSubexecutor=void 0,r}applyUpstreamPullStrategy(t,n,r){switch(r._tag){case hq:{const s=!t||n.some(o=>o!==void 0);return[r.emitSeparator,s?[void 0,...n]:n]}case UJ:{const s=!t||n.some(o=>o!==void 0);return[r.emitSeparator,s?[...n,void 0]:n]}}}pullFromChild(t,n,r,s){return d_(t,oe,o=>{const a=r(o);switch(a._tag){case uq:break;case xJ:{this.finishWithDoneValue(t,n,a.value);break}case NJ:{const u=n.enqueuePullFromChild(s);this.replaceSubexecutor(u);break}}this._activeSubexecutor=new h_(o,this._activeSubexecutor)},qr({onFailure:o=>{const a=this.handleSubexecutorFailure(t,n,o);return a===void 0?void 0:qk(a)},onSuccess:o=>{this.finishWithDoneValue(t,n,o)}}))}finishWithDoneValue(t,n,r){const s=n;switch(s._tag){case Vy:{const o=new oi(s.upstreamExecutor,s.createChild,s.lastDone!==void 0?s.combineChildResults(s.lastDone,r):r,s.activeChildExecutors,s.combineChildResults,s.combineWithChildResult,s.onPull,s.onEmit);this._closeLastSubstream=t.close(Mt(r)),this.replaceSubexecutor(o);break}case Wy:{const o=new Ma(s.upstreamExecutor,s.lastDone!==void 0?s.combineChildResults(s.lastDone,r):r,s.activeChildExecutors,s.upstreamDone,s.combineChildResults,s.combineWithChildResult,s.onPull);this._closeLastSubstream=t.close(Mt(r)),this.replaceSubexecutor(o);break}}}handleSubexecutorFailure(t,n,r){return this.finishSubexecutorWithCloseEffect(Xt(r),s=>n.close(s),s=>t.close(s))}pullFromUpstream(t){if(t.activeChildExecutors.length===0)return this.performPullFromUpstream(t);const n=t.activeChildExecutors[0],r=new oi(t.upstreamExecutor,t.createChild,t.lastDone,t.activeChildExecutors.slice(1),t.combineChildResults,t.combineWithChildResult,t.onPull,t.onEmit);if(n===void 0)return this.performPullFromUpstream(r);this.replaceSubexecutor(new Sd(n.childExecutor,r,n.onEmit))}performPullFromUpstream(t){return d_(t.upstreamExecutor,n=>{const r=this._closeLastSubstream===void 0?me:this._closeLastSubstream;return this._closeLastSubstream=void 0,b(this._executeCloseLastSubstream(r),at(n))},n=>{if(this._closeLastSubstream!==void 0){const a=this._closeLastSubstream;return this._closeLastSubstream=void 0,b(this._executeCloseLastSubstream(a),ye(()=>{const u=new mi(t.createChild(n),this._providedEnv,this._executeCloseLastSubstream);u._input=this._input;const[f,d]=this.applyUpstreamPullStrategy(!1,t.activeChildExecutors,t.onPull(Ak(n)));this._activeSubexecutor=new Sd(u,new oi(t.upstreamExecutor,t.createChild,t.lastDone,d,t.combineChildResults,t.combineWithChildResult,t.onPull,t.onEmit),t.onEmit),nt(f)&&(this._activeSubexecutor=new h_(f.value,this._activeSubexecutor))}))}const r=new mi(t.createChild(n),this._providedEnv,this._executeCloseLastSubstream);r._input=this._input;const[s,o]=this.applyUpstreamPullStrategy(!1,t.activeChildExecutors,t.onPull(Ak(n)));this._activeSubexecutor=new Sd(r,new oi(t.upstreamExecutor,t.createChild,t.lastDone,o,t.combineChildResults,t.combineWithChildResult,t.onPull,t.onEmit),t.onEmit),nt(s)&&(this._activeSubexecutor=new h_(s.value,this._activeSubexecutor))},n=>{if(t.activeChildExecutors.some(o=>o!==void 0)){const o=new Ma(t.upstreamExecutor,t.lastDone,[void 0,...t.activeChildExecutors],t.upstreamExecutor.getDone(),t.combineChildResults,t.combineWithChildResult,t.onPull);if(this._closeLastSubstream!==void 0){const a=this._closeLastSubstream;return this._closeLastSubstream=void 0,b(this._executeCloseLastSubstream(a),ye(()=>this.replaceSubexecutor(o)))}this.replaceSubexecutor(o);return}const r=this._closeLastSubstream,s=this.finishSubexecutorWithCloseEffect(b(n,Lz(o=>t.combineWithChildResult(t.lastDone,o))),()=>r,o=>t.upstreamExecutor.close(o));return s===void 0?void 0:qk(s)})}drainChildExecutors(t){if(t.activeChildExecutors.length===0){const o=this._closeLastSubstream;return o!==void 0&&this.addFinalizer(()=>We(o)),this.finishSubexecutorWithCloseEffect(t.upstreamDone,()=>o,a=>t.upstreamExecutor.close(a))}const n=t.activeChildExecutors[0],r=t.activeChildExecutors.slice(1);if(n===void 0){const[o,a]=this.applyUpstreamPullStrategy(!0,r,t.onPull(sG(r.reduce((u,f)=>f!==void 0?u+1:u,0))));return this.replaceSubexecutor(new Ma(t.upstreamExecutor,t.lastDone,a,t.upstreamDone,t.combineChildResults,t.combineWithChildResult,t.onPull)),nt(o)?(this._emitted=o.value,f_()):void 0}const s=new Ma(t.upstreamExecutor,t.lastDone,r,t.upstreamDone,t.combineChildResults,t.combineWithChildResult,t.onPull);this.replaceSubexecutor(new Sd(n.childExecutor,s,n.onEmit))}}const p_=e=>e!==void 0?e:me,m_=(e,t)=>b(dn(e,n=>jt(n(t))),ye(n=>b(Dz(n),pt(()=>Un))),Q(n=>ut(()=>n))),uv=(e,t,n)=>{const r=[e],s=()=>{const o=r.pop();if(o===void 0||o.upstream===void 0)return LR("Unexpected end of input for channel execution");const a=o.upstream.run();switch(a._tag){case Gf:{const u=o.onEmit(o.upstream.getEmit());return r.length===0?u===void 0?ut(t):b(u,mr({onFailure:n,onSuccess:t})):u===void 0?ut(()=>s()):b(u,mr({onFailure:n,onSuccess:()=>s()}))}case Jf:{const u=o.onDone(o.upstream.getDone());return r.length===0?u===void 0?ut(t):b(u,mr({onFailure:n,onSuccess:t})):u===void 0?ut(()=>s()):b(u,mr({onFailure:n,onSuccess:()=>s()}))}case iu:return r.push(o),b(o.onEffect(a.effect),ns(u=>ut(()=>{const f=o.onDone(Xt(u));return f===void 0?me:f})),mr({onFailure:n,onSuccess:()=>s()}));case Qf:return r.push(o),r.push(a),ut(()=>s())}};return s()},lv=y(2,(e,t)=>{const n=(r,s,o)=>zR($e(()=>new mi(e,void 0,oe)),a=>ut(()=>Yd(a.run(),a).pipe(Bf(r),at(Nt(r)),Vw(Nt(s)))),(a,u)=>{const f=a.close(u);return f===void 0?me:Hf(f,d=>wo(o,Mn(d)))});return Oo(r=>Uf([qw(t,kl),Ue(),Ue()]).pipe(Q(([s,o,a])=>r(n(o,a,s)).pipe(nr(t),Q(u=>t.addFinalizer(f=>{const d=eu(f)?DV(f.cause):void 0;return my(o).pipe(Q(p=>p?vt(a,void 0).pipe(at(wR(u)),at(vk(u))):vt(a,void 0).pipe(at(d&&_S(d)>0?Vm(u,DL(d)):Sr(u)),at(vk(u)))))}).pipe(at(r(Nt(o)))))))))}),Yd=(e,t)=>{const n=e;switch(n._tag){case iu:return b(n.effect,Q(()=>Yd(t.run(),t)));case Gf:return Yd(t.run(),t);case Jf:return ut(()=>t.getDone());case Qf:return uv(n,()=>Yd(t.run(),t),Mn)}},xq="Done",oG="Await",iG="effect/ChannelMergeDecision",aG=Symbol.for(iG),Nq={[aG]:{_R:e=>e,_E0:e=>e,_Z0:e=>e,_E:e=>e,_Z:e=>e}},cG=e=>{const t=Object.create(Nq);return t._tag=xq,t.effect=e,t},Ky=e=>{const t=Object.create(Nq);return t._tag=oG,t.f=e,t},Dq="BothRunning",Mq="LeftDone",Lq="RightDone",uG="effect/ChannelMergeState",Fk=Symbol.for(uG),fv={[Fk]:Fk},g_=(e,t)=>{const n=Object.create(fv);return n._tag=Dq,n.left=e,n.right=t,n},Pk=e=>{const t=Object.create(fv);return t._tag=Mq,t.f=e,t},xk=e=>{const t=Object.create(fv);return t._tag=Lq,t.f=e,t},jq="BackPressure",Uq="BufferSliding",lG="effect/ChannelMergeStrategy",Nk=Symbol.for(lG),zq={[Nk]:Nk},fG=e=>{const t=Object.create(zq);return t._tag=jq,t},dG=e=>{const t=Object.create(zq);return t._tag=Uq,t},hG=y(2,(e,{onBackPressure:t,onBufferSliding:n})=>{switch(e._tag){case jq:return t();case Uq:return n()}}),Aa="Empty",xu="Emit",Nu="Error",Du="Done",Bq=e=>({_tag:Aa,notifyProducer:e}),__=e=>({_tag:xu,notifyConsumers:e}),pG=e=>({_tag:Nu,cause:e}),mG=e=>({_tag:Du,done:e});class gG{ref;constructor(t){this.ref=t}awaitRead(){return si(ri(this.ref,t=>t._tag===Aa?[Nt(t.notifyProducer),t]:[me,t]))}get close(){return Lw(t=>this.error(jm(t)))}done(t){return si(ri(this.ref,n=>{switch(n._tag){case Aa:return[Nt(n.notifyProducer),n];case xu:return[dn(n.notifyConsumers,r=>vt(r,se(t)),{discard:!0}),mG(t)];case Nu:return[Hr,n];case Du:return[Hr,n]}}))}emit(t){return Q(Ue(),n=>si(ri(this.ref,r=>{switch(r._tag){case Aa:return[Nt(r.notifyProducer),r];case xu:{const s=r.notifyConsumers[0],o=r.notifyConsumers.slice(1);if(s!==void 0)return[vt(s,ie(t)),o.length===0?Bq(n):__(o)];throw new Error("Bug: Channel.SingleProducerAsyncInput.emit - Queue was empty! please report an issue at https://github.com/Effect-TS/effect/issues")}case Nu:return[Hr,r];case Du:return[Hr,r]}})))}error(t){return si(ri(this.ref,n=>{switch(n._tag){case Aa:return[Nt(n.notifyProducer),n];case xu:return[dn(n.notifyConsumers,r=>m1(r,t),{discard:!0}),pG(t)];case Nu:return[Hr,n];case Du:return[Hr,n]}}))}get take(){return this.takeWith(t=>Xt(zm(t,se)),t=>Mt(t),t=>Of(ie(t)))}takeWith(t,n,r){return Q(Ue(),s=>si(ri(this.ref,o=>{switch(o._tag){case Aa:return[at(vt(o.notifyProducer,void 0),Al(Nt(s),{onFailure:t,onSuccess:Yt({onLeft:r,onRight:n})})),__([s])];case xu:return[Al(Nt(s),{onFailure:t,onSuccess:Yt({onLeft:r,onRight:n})}),__([...o.notifyConsumers,s])];case Nu:return[We(t(o.cause)),o];case Du:return[We(r(o.done)),o]}})))}}const dv=()=>b(Ue(),Q(e=>Uo(Bq(e))),ye(e=>new gG(e))),Dk=(e,t,n)=>Ae(gt(Uo(()=>me)),r=>b(gt(mo(Js(e,s=>Ec(r,o=>n(s,o))))),Ae(t),cv(s=>Q(vi(r),o=>o(s))))),_G=y(2,(e,t)=>Iq(e,n=>Yt(Um(n),{onLeft:t,onRight:bt}))),Qh=y(2,(e,t)=>GJ(e,t,()=>{},()=>{})),ig=e=>{const t=ar({onInput:()=>t,onFailure:bt,onDone:fa});return tn(e,t)},Hq=y(2,(e,t)=>cv(e,()=>t)),yG=e=>Ae(e,oe),ag=e=>wr(e.takeWith(bt,t=>Ae(Qe(t),()=>ag(e)),fa)),Vq=()=>sg({onInput:e=>Ae(Qe(e),()=>Vq()),onFailure:Wf,onDone:qo}),Wq=y(2,(e,t)=>Ae(e,n=>qq(()=>t(n)))),bG=y(2,(e,t)=>SG(e,zm(t))),SG=y(2,(e,t)=>Iq(e,n=>bt(t(n)))),cg=y(2,(e,t)=>{const n=sg({onInput:r=>Ae(Qe(t(r)),()=>n),onFailure:Wf,onDone:qo});return tn(e,n)}),Kq=y(2,(e,t)=>{const n=ar({onInput:r=>b(gt(t(r)),Ae(Qe),Ae(()=>n)),onFailure:bt,onDone:qo});return tn(e,n)}),wG=y(3,(e,t,n)=>hv(r=>z(function*(){const s=yield*dv(),o=ag(s),a=yield*Ic(n);yield*wo(r,Lt(a));const u=yield*Ue(),f=n===Number.POSITIVE_INFINITY?m=>oe:(yield*Xm(n)).withPermits;yield*(yield*o.pipe(tn(e),ki(r))).pipe(mr({onFailure:m=>Ge(a,Mn(m)),onSuccess:Yt({onLeft:m=>at(Rt(f(n)(me)),ls(Ge(a,We(se(m))))),onRight:m=>z(function*(){const $=yield*Ue(),C=yield*Ue();yield*Ge(a,ye(Nt($),ie)),yield*vt(C,void 0).pipe(at(Oo(O=>jt(O(Nt(u))).pipe(VR(jt(O(t(m)))),Q(oe))).pipe(Hf(O=>m1(u,O)),Bf($))),f(1),nr(r)),yield*Nt(C)})})}),Hw,Rt,nr(r));const p=wr(Al(si(Ro(a)),{onFailure:bt,onSuccess:Yt({onLeft:qo,onRight:m=>Ae(Qe(m),()=>p)})}));return av(p,s)}))),vG=e=>t=>EG(e)(t,sl),EG=({bufferSize:e=16,concurrency:t,mergeStrategy:n=fG()})=>(r,s)=>hv(o=>z(function*(){const a=t==="unbounded"?Number.MAX_SAFE_INTEGER:t,u=yield*dv(),f=ag(u),d=yield*Ic(e);yield*wo(o,Lt(d));const p=yield*fn();yield*wo(o,Lt(p));const m=yield*Uo(H()),$=yield*Ue(),C=(yield*Xm(a)).withPermits,O=yield*ki(tn(f,r),o);function N(w){return w.pipe(Q(Yt({onLeft:g=>We(V(g)),onRight:g=>Ms(Ge(d,We(ie(g))),H())})),Tk({until:g=>nt(g)}),Q(g=>wH(m,Xe({onNone:()=>V(g.value),onSome:E=>V(s(E,g.value))}))),ns(g=>Il(g)?Mn(g):Ge(d,Mn(g)).pipe(at(vt($,void 0)),ls)))}yield*O.pipe(mr({onFailure:w=>Ge(d,Mn(w)).pipe(at(We(!1))),onSuccess:Yt({onLeft:w=>Bw(Rt(Nt($)),Rt(C(a)(me)),{onSelfDone:(g,E)=>Ms(Sr(E),!1),onOtherDone:(g,E)=>at(Sr(E),vi(m).pipe(Q(Xe({onNone:()=>Ge(d,We(se(w))),onSome:k=>Ge(d,We(se(s(k,w))))})),Ms(!1)))}),onRight:w=>hG(n,{onBackPressure:()=>z(function*(){const g=yield*Ue(),E=Hh(R=>ki(tn(f,w),R).pipe(Q(q=>l_(jt(N(q)),jt(Rt(Nt($))))),Q(oe)));return yield*vt(g,void 0).pipe(at(E),C(1),nr(o)),yield*Nt(g),!(yield*my($))}),onBufferSliding:()=>z(function*(){const g=yield*Ue(),E=yield*Ue(),k=yield*AJ(p);yield*Ro(p).pipe(Q(x=>vt(x,void 0)),HR(()=>k>=a)),yield*Ge(p,g);const R=Hh(x=>ki(tn(f,w),x).pipe(Q(D=>jt(N(D)).pipe(l_(jt(Rt(Nt($)))),l_(jt(Rt(Nt(g)))))),Q(oe)));return yield*vt(E,void 0).pipe(at(R),C(1),nr(o)),yield*Nt(E),!(yield*my($))})})})}),Tk({while:w=>w}),nr(o));const v=b(Ro(d),si,Al({onFailure:bt,onSuccess:Yt({onLeft:qo,onRight:w=>Ae(Qe(w),()=>v)})}),wr);return av(v,u)})),Jq=y(3,(e,t,n)=>vG(n)(cg(e,t))),Gq=y(2,(e,t)=>{function n(r){return z(function*(){const s=yield*dv(),o=ag(s),a=yield*ki(tn(o,e),r),u=yield*ki(tn(o,t.other),r);function f(p,m,$){return(C,O,N)=>{function v(w){const g=w;return g._tag===xq?We(gt(at(Sr(m),g.effect))):ye(wR(m),qr({onFailure:E=>gt(g.f(Xt(E))),onSuccess:Yt({onLeft:E=>gt(g.f(Mt(E))),onRight:E=>Yf(Qe(E),d(N(g.f)))})}))}return qr(p,{onFailure:w=>v(C(Xt(w))),onSuccess:Yt({onLeft:w=>v(C(Mt(w))),onRight:w=>We(Ae(Qe(w),()=>Ae(gt(nr(Rt($),r)),g=>d(O(g,m)))))})})}}function d(p){switch(p._tag){case Dq:{const m=Rt(Bh(p.left)),$=Rt(Bh(p.right));return wr(Bw(m,$,{onSelfDone:(C,O)=>at(Sr(O),f(C,p.right,a)(t.onSelfDone,g_,N=>Pk(N))),onOtherDone:(C,O)=>at(Sr(O),f(C,p.left,u)(t.onOtherDone,(N,v)=>g_(v,N),N=>xk(N)))}))}case Mq:return wr(ye(jt(u),qr({onFailure:m=>gt(p.f(Xt(m))),onSuccess:Yt({onLeft:m=>gt(p.f(Mt(m))),onRight:m=>Ae(Qe(m),()=>d(Pk(p.f)))})})));case Lq:return wr(ye(jt(a),qr({onFailure:m=>gt(p.f(Xt(m))),onSuccess:Yt({onLeft:m=>gt(p.f(Mt(m))),onRight:m=>Ae(Qe(m),()=>d(xk(p.f)))})})))}}return gt(us(p=>{const m=us(O=>(O.transferChildren(p.scope()),me)),$=Rt(a).pipe(di(m),nr(r)),C=Rt(u).pipe(di(m),nr(r));return Cc($,C,(O,N)=>g_(O,N))})).pipe(Ae(d),av(s))})}return hv(n)}),kG=y(2,(e,t)=>_G(e,n=>Rq(()=>Ji(t(n))))),Qq=y(2,(e,t)=>Kf(()=>{let n;const r=sg({onInput:o=>Ae(Qe(o),()=>r),onFailure:o=>(n=OG(o),bt(Ji(n))),onDone:qo}),s=ar({onInput:o=>b(Qe(o),Ae(()=>s)),onFailure:o=>NV(o)&&RG(o.defect)&&le(o.defect,n)?Wf(o.defect.error):bt(o),onDone:qo});return tn(tn(tn(e,r),t),s)})),$G=e=>Hh(t=>lv(e,t)),TG=e=>$G(ig(e)),Yq=e=>e8(t=>lv(e,t)),Xq=e=>wr(Oo(t=>ye(Aw(),n=>JJ(Hf(t(Rw(e,n)),r=>ln(n,Xt(r))),(r,s)=>ln(n,s))))),Zq=e=>ug(ye(Qm,t=>Ae(gt(e(t)),Qe))),CG=e=>Q(Qm,t=>ki(e,t)),ki=y(2,(e,t)=>Vh($e(()=>new mi(e,void 0,oe)),Bo()).pipe(Js(([n,r])=>mW(t,s=>{const o=n.close(s);return o!==void 0?qn(o,r):me})),mo,ye(([n])=>ut(()=>Jy(n.run(),n))))),Jy=(e,t)=>{const n=e;switch(n._tag){case Jf:return qr(t.getDone(),{onFailure:Mn,onSuccess:r=>We(se(r))});case Gf:return We(ie(t.getEmit()));case iu:return b(n.effect,Q(()=>Jy(t.run(),t)));case Qf:return uv(n,()=>Jy(t.run(),t),r=>Mn(r))}},wr=e=>yG(gt(e)),ug=e=>Oq(Xq(e),(t,n)=>t,(t,n)=>t),hv=e=>Oq(Zq(e),(t,n)=>t,(t,n)=>t),Mk=function(){const e=typeof arguments[0]!="string",t=e?arguments[1]:arguments[0],n=xs(e?arguments[2]:arguments[1]),r=Uf([m8(t,n),BR(),r8,_8(v8)]);if(e){const s=arguments[0];return Dk(r,([o,a])=>Hy(s,Kr(a,as,o)),([o,,a,u],f)=>Ah(o,f,a,u))}return s=>Dk(r,([o,a])=>Hy(s,Kr(a,as,o)),([o,,a,u],f)=>Ah(o,f,a,u))},lg=e=>eA(0,e.length,e),eA=(e,t,n)=>e===t?sn:b(Qe(b(n,As(e))),Ae(()=>eA(e+1,t,n))),IG=y(e=>Cq(e[1]),(e,t,n)=>n?.concurrent?Gq(e,{other:t,onSelfDone:r=>Ky(s=>ut(()=>x0(r,s))),onOtherDone:r=>Ky(s=>ut(()=>x0(s,r)))}):Ae(e,r=>Wq(t,s=>[r,s]))),Yf=y(e=>Cq(e[1]),(e,t,n)=>n?.concurrent?Wq(IG(e,t,{concurrent:!0}),r=>r[1]):Ae(e,()=>t)),Gy=Symbol.for("effect/Channel/ChannelException"),OG=e=>({_tag:"ChannelException",[Gy]:Gy,error:e}),RG=e=>X(e,Gy),Qy=Symbol.for("effect/Sink"),qG={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e};class fg{channel;[Qy]=qG;constructor(t){this.channel=t}pipe(){return Y(this,arguments)}}const AG=()=>new fg(tA(lt())),tA=e=>ar({onInput:t=>tA(b(e,_t(t))),onFailure:bt,onDone:()=>fa(e)}),FG=new fg(ig(Vq())),PG=e=>{const t=ar({onInput:n=>b(gt(e(n)),Ae(()=>t)),onFailure:bt,onDone:()=>sn});return new fg(t)},xG=e=>new fg(gt(e)),nA=e=>kr(e)?nA(xG(e)):e.channel,NG=cG,DG=Ky,rA=Wm,MG=$R,LG=_K,jG=OW,UG="Left",zG="Right",BG="Both",HG="Either",VG={_tag:UG},WG={_tag:zG},sA={_tag:BG},KG={_tag:HG},JG=e=>{switch(e){case"left":return VG;case"right":return WG;case"both":return sA;case"either":return KG;default:return e}},GG=sA;class oA{value;constructor(t){this.value=t}}const iA=(e,t)=>({ref:e,isNew:t,isChanged:!1,expected:e.versioned,newValue:e.versioned.value}),aA=e=>e.newValue,cA=(e,t)=>{e.isChanged=!0,e.newValue=t},QG=e=>{e.ref.versioned=new oA(e.newValue)},YG=e=>e.ref.versioned!==e.expected,XG=e=>e.isChanged,Yh="Invalid",pv="ReadWrite",ZG="ReadOnly",uA=e=>{for(const t of e)QG(t[1])},lA=e=>{let t=ZG;for(const[,n]of e)if(t=YG(n)?Yh:XG(n)?pv:t,t===Yh)return t;return t},eQ=e=>{const t=new Map;for(const[,n]of e){for(const r of n.ref.todos)t.set(r[0],r[1]);n.ref.todos=new Map}return t},tQ=e=>{const t=Array.from(e.entries()).sort((n,r)=>n[0]-r[0]);for(const[n,r]of t)r()},nQ=(e,t,n)=>{let r=!1;for(const[,s]of t)s.ref.todos.has(e)||(s.ref.todos.set(e,n),r=!0);return r},fA="WithSTMRuntime",Yy="OnFailure",Lk="OnRetry",Xy="OnSuccess",rQ="Provide",dA="Sync",hA="Succeed",pA="Retry",mA="Fail",gA="Die",_A="Interrupt",Za="Fail",ec="Die",tc="Interrupt",$i="Succeed",au="Retry",mv="Done",gv="Suspend",Xd="Done",Zy="Interrupted",Xh="Running",dg="effect/STM/State",Yi=Symbol.for(dg),_v=e=>X(e,Yi),yA=e=>e._tag===Xh,sQ=e=>e._tag===Xd,wd=e=>({[Yi]:Yi,_tag:Xd,exit:e,[he](){return b(J(dg),ue(J(Xd)),ue(J(e)),tt(this))},[pe](t){return _v(t)&&t._tag===Xd&&le(e,t.exit)}}),oQ=b(J(dg),ue(J(Zy)),ue(J("interrupted"))),iQ={[Yi]:Yi,_tag:Zy,[he](){return oQ},[pe](e){return _v(e)&&e._tag===Zy}},aQ=b(J(dg),ue(J(Xh)),ue(J("running"))),cQ={[Yi]:Yi,_tag:Xh,[he](){return aQ},[pe](e){return _v(e)&&e._tag===Xh}},vd=e=>{switch(e._tag){case Za:return wd(Of(e.error));case ec:return wd(bl(e.defect));case tc:return wd(Mz(e.fiberId));case $i:return wd(Mt(e.value));case au:throw new Error("BUG: STM.STMState.fromTExit - please report an issue at https://github.com/Effect-TS/effect/issues")}},cu="effect/TExit",uu=Symbol.for(cu),Xf={_A:e=>e,_E:e=>e},Zf=e=>X(e,uu),uQ=e=>e._tag===$i,lQ=e=>e._tag===au,fQ=e=>({[uu]:Xf,_tag:Za,error:e,[he](){return b(J(cu),ue(J(Za)),ue(J(e)),tt(this))},[pe](t){return Zf(t)&&t._tag===Za&&le(e,t.error)}}),dQ=e=>({[uu]:Xf,_tag:ec,defect:e,[he](){return b(J(cu),ue(J(ec)),ue(J(e)),tt(this))},[pe](t){return Zf(t)&&t._tag===ec&&le(e,t.defect)}}),hQ=e=>({[uu]:Xf,_tag:tc,fiberId:e,[he](){return b(J(cu),ue(J(tc)),ue(J(e)),tt(this))},[pe](t){return Zf(t)&&t._tag===tc&&le(e,t.fiberId)}}),jk=e=>({[uu]:Xf,_tag:$i,value:e,[he](){return b(J(cu),ue(J($i)),ue(J(e)),tt(this))},[pe](t){return Zf(t)&&t._tag===$i&&le(e,t.value)}}),pQ=b(J(cu),ue(J(au)),ue(J("retry"))),mQ={[uu]:Xf,_tag:au,[he](){return pQ},[pe](e){return Zf(e)&&lQ(e)}},gQ=e=>({_tag:mv,exit:e}),bA=e=>({_tag:gv,journal:e}),Uk={ref:0},_Q=()=>{const e=Uk.ref+1;return Uk.ref=e,e},yQ="effect/STM",bQ=Symbol.for(yQ),Ed={_R:e=>e,_E:e=>e,_A:e=>e};class so{effect_instruction_i0;_op=sf;effect_instruction_i1=void 0;effect_instruction_i2=void 0;[$k];[U_];[Qy];[Jh];get[bQ](){return Ed}constructor(t){this.effect_instruction_i0=t,this[$k]=Fi,this[U_]=Ed,this[Qy]=Ed,this[Jh]=Ed}[pe](t){return this===t}[he](){return tt(this,Op(this))}[Symbol.iterator](){return new Kc(new Nc(this))}commit(){return SQ(this,sl)}pipe(){return Y(this,arguments)}}const SQ=(e,t,n)=>qe(r=>{const s=r.id(),o=r.getFiberRef(KR),a=r.getFiberRef(JR),u=r.getFiberRef(b8),f=vQ(s,e,o,a,u);switch(f._tag){case mv:return t(f.exit),f.exit;case gv:{const d=_Q(),p={value:cQ},m=VK($=>SA(s,e,d,p,o,a,u,$));return Oo($=>b($(m),ns(C=>{let O=p.value;return yA(O)&&(p.value=iQ),O=p.value,sQ(O)?(t(O.exit),O.exit):Mn(C)})))}}}),wQ=(e,t,n,r,s,o)=>{const a=new Map,u=new wA(t,a,e,r).run(),f=lA(a);if(f===pv)uA(a);else if(f===Yh)throw new Error("BUG: STM.TryCommit.tryCommit - please report an issue at https://github.com/Effect-TS/effect/issues");switch(u._tag){case $i:return n.value=vd(u),go(Mt(u.value),a,s,o);case Za:{n.value=vd(u);const d=ru(u.error);return go(Xt(d),a,s,o)}case ec:{n.value=vd(u);const d=Ji(u.defect);return go(Xt(d),a,s,o)}case tc:{n.value=vd(u);const d=jm(e);return go(Xt(d),a,s,o)}case au:return bA(a)}},vQ=(e,t,n,r,s)=>{const o=new Map,a=new wA(t,o,e,n).run(),u=lA(o);if(u===pv&&uQ(a))uA(o);else if(u===Yh)throw new Error("BUG: STM.TryCommit.tryCommitSync - please report an issue at https://github.com/Effect-TS/effect/issues");switch(a._tag){case $i:return go(Mt(a.value),o,r,s);case Za:{const f=ru(a.error);return go(Xt(f),o,r,s)}case ec:{const f=Ji(a.defect);return go(Xt(f),o,r,s)}case tc:{const f=jm(e);return go(Xt(f),o,r,s)}case au:return bA(o)}},SA=(e,t,n,r,s,o,a,u)=>{if(yA(r.value)){const f=wQ(e,t,r,s,o,a);switch(f._tag){case mv:{EQ(f.exit,u);break}case gv:{nQ(n,f.journal,()=>SA(e,t,n,r,s,o,a,u));break}}}},go=(e,t,n,r)=>{const s=eQ(t);return s.size>0&&n.scheduleTask(()=>tQ(s),r),gQ(e)},EQ=(e,t)=>{t(e)};class wA{self;journal;fiberId;contStack=[];env;constructor(t,n,r,s){this.self=t,this.journal=n,this.fiberId=r,this.env=s}getEnv(){return this.env}pushStack(t){this.contStack.push(t)}popStack(){return this.contStack.pop()}nextSuccess(){let t=this.popStack();for(;t!==void 0&&t.effect_instruction_i0!==Xy;)t=this.popStack();return t}nextFailure(){let t=this.popStack();for(;t!==void 0&&t.effect_instruction_i0!==Yy;)t=this.popStack();return t}nextRetry(){let t=this.popStack();for(;t!==void 0&&t.effect_instruction_i0!==Lk;)t=this.popStack();return t}run(){let t=this.self,n;for(;n===void 0&&t!==void 0;)try{const r=t;if(r)switch(r._op){case"Tag":{t=hg((s,o,a)=>Up(a,r));break}case"Left":{t=eb(r.left);break}case"None":{t=eb(new Bm);break}case"Right":{t=Ut(r.right);break}case"Some":{t=Ut(r.value);break}case"Commit":{switch(r.effect_instruction_i0){case gA:{n=dQ(ct(()=>r.effect_instruction_i1()));break}case mA:{const s=this.nextFailure();s===void 0?n=fQ(ct(()=>r.effect_instruction_i1())):t=ct(()=>s.effect_instruction_i2(ct(()=>r.effect_instruction_i1())));break}case pA:{const s=this.nextRetry();s===void 0?n=mQ:t=ct(()=>s.effect_instruction_i2());break}case _A:{n=hQ(this.fiberId);break}case fA:{t=ct(()=>r.effect_instruction_i1(this));break}case Xy:case Yy:case Lk:{this.pushStack(r),t=r.effect_instruction_i1;break}case rQ:{const s=this.env;this.env=ct(()=>r.effect_instruction_i2(s)),t=b(r.effect_instruction_i1,CQ(yv(()=>this.env=s)));break}case hA:{const s=r.effect_instruction_i1,o=this.nextSuccess();o===void 0?n=jk(s):t=ct(()=>o.effect_instruction_i2(s));break}case dA:{const s=ct(()=>r.effect_instruction_i1()),o=this.nextSuccess();o===void 0?n=jk(s):t=ct(()=>o.effect_instruction_i2(s));break}}break}}}catch(r){t=$Q(r)}return n}}const kQ=y(2,(e,t)=>{const n=new so(Yy);return n.effect_instruction_i1=e,n.effect_instruction_i2=t,n}),$Q=e=>TQ(()=>e),TQ=e=>{const t=new so(gA);return t.effect_instruction_i1=e,t},hg=e=>zr(t=>Ut(e(t.journal,t.fiberId,t.getEnv()))),CQ=y(2,(e,t)=>OQ(e,{onFailure:n=>zk(t,eb(n)),onSuccess:n=>zk(t,Ut(n))})),eb=e=>IQ(()=>e),IQ=e=>{const t=new so(mA);return t.effect_instruction_i1=e,t},lu=y(2,(e,t)=>{const n=new so(Xy);return n.effect_instruction_i1=e,n.effect_instruction_i2=t,n}),OQ=y(2,(e,{onFailure:t,onSuccess:n})=>b(e,Pl(ie),kQ(r=>b(t(r),Pl(se))),lu(r=>{switch(r._tag){case"Left":return Ut(r.left);case"Right":return n(r.right)}}))),zr=e=>{const t=new so(fA);return t.effect_instruction_i1=e,t},uo=e=>{const t=new so(_A);return t.effect_instruction_i1=e,t},Pl=y(2,(e,t)=>b(e,lu(n=>yv(()=>t(n))))),Fa=new so(pA),Ut=e=>{const t=new so(hA);return t.effect_instruction_i1=e,t},yv=e=>{const t=new so(dA);return t.effect_instruction_i1=e,t},zk=y(2,(e,t)=>b(e,lu(()=>t))),Bk="BackPressure",tb="Dropping",Hk="Sliding",RQ=e=>lu(e,oe),qQ=(...e)=>AQ(()=>{const n=(e.length===1?e[0]:e[1].bind(e[0]))(b),r=n.next(),s=o=>o.done?Ut(o.value):lu(bT(o.value),a=>s(n.next(a)));return s(r)}),AQ=e=>RQ(yv(e)),Vk=Ut(void 0),FQ="effect/TRef",PQ=Symbol.for(FQ),xQ={_A:e=>e};class NQ{[PQ]=xQ;todos;versioned;constructor(t){this.versioned=new oA(t),this.todos=new Map}modify(t){return hg(n=>{const r=bv(this,n),[s,o]=t(aA(r));return cA(r,o),s})}pipe(){return Y(this,arguments)}}const vA=e=>hg(t=>{const n=new NQ(e);return t.set(n,iA(n,!0)),n}),DQ=e=>e.modify(t=>[t,t]),MQ=y(2,(e,t)=>e.modify(()=>[void 0,t])),LQ=y(2,(e,t)=>e.modify(n=>[void 0,t(n)])),bv=(e,t)=>{if(t.has(e))return t.get(e);const n=iA(e,!1);return t.set(e,n),n},ys=y(2,(e,t)=>aA(bv(e,t))),bs=y(3,(e,t,n)=>{const r=bv(e,n);cA(r,t)}),jQ="effect/TQueue/TEnqueue",UQ=Symbol.for(jQ),zQ="effect/TQueue/TDequeue",BQ=Symbol.for(zQ),HQ={_tag:tb},VQ={_Out:e=>e},WQ={_In:e=>e};class KQ{ref;requestedCapacity;strategy;[BQ]=VQ;[UQ]=WQ;constructor(t,n,r){this.ref=t,this.requestedCapacity=n,this.strategy=r}capacity(){return this.requestedCapacity}size=zr(t=>{const n=ys(this.ref,t.journal);return n===void 0?uo(t.fiberId):Ut(n.length)});isFull=Pl(this.size,t=>t===this.requestedCapacity);isEmpty=Pl(this.size,t=>t===0);shutdown=zr(t=>(bs(this.ref,void 0,t.journal),Vk));isShutdown=hg(t=>ys(this.ref,t)===void 0);awaitShutdown=lu(this.isShutdown,t=>t?Vk:Fa);offer(t){return zr(n=>{const r=b(this.ref,ys(n.journal));if(r===void 0)return uo(n.fiberId);if(r.length<this.requestedCapacity)return r.push(t),bs(this.ref,r,n.journal),Ut(!0);switch(this.strategy._tag){case Bk:return Fa;case tb:return Ut(!1);case Hk:return r.length===0||(r.shift(),r.push(t),bs(this.ref,r,n.journal)),Ut(!0)}})}offerAll(t){return zr(n=>{const r=Array.from(t),s=ys(this.ref,n.journal);if(s===void 0)return uo(n.fiberId);if(s.length+r.length<=this.requestedCapacity)return bs(this.ref,[...s,...r],n.journal),Ut(!0);switch(this.strategy._tag){case Bk:return Fa;case tb:{const o=r.slice(0,this.requestedCapacity-s.length);return bs(this.ref,[...s,...o],n.journal),Ut(!1)}case Hk:{const o=r.slice(0,this.requestedCapacity-s.length),a=s.length+o.length-this.requestedCapacity,u=s.slice(a);return bs(this.ref,[...u,...o],n.journal),Ut(!0)}}})}peek=zr(t=>{const n=ys(this.ref,t.journal);return n===void 0?uo(t.fiberId):n.length===0?Fa:Ut(n[0])});peekOption=zr(t=>{const n=ys(this.ref,t.journal);return n===void 0?uo(t.fiberId):Ut(na(n[0]))});take=zr(t=>{const n=ys(this.ref,t.journal);if(n===void 0)return uo(t.fiberId);if(n.length===0)return Fa;const r=n.shift();return bs(this.ref,n,t.journal),Ut(r)});takeAll=zr(t=>{const n=ys(this.ref,t.journal);return n===void 0?uo(t.fiberId):(bs(this.ref,[],t.journal),Ut(n))});takeUpTo(t){return zr(n=>{const r=ys(this.ref,n.journal);if(r===void 0)return uo(n.fiberId);const[s,o]=VC(Pt(r),t);return bs(this.ref,Array.from(o),n.journal),Ut(Array.from(s))})}}const JQ=y(2,(e,t)=>e.offer(t)),GQ=e=>e.peek,QQ=e=>e.take,YQ=()=>XQ(Number.MAX_SAFE_INTEGER,HQ),XQ=(e,t)=>Pl(vA([]),n=>new KQ(n,e,t)),ZQ=JQ,e9=GQ,t9=QQ,n9=YQ,r9=e=>Object.assign(e,{chunk(n){return this(We(n))},die(n){return this(Gi(n))},dieMessage(n){return this(LR(n))},done(n){return this(ut(()=>jz(n,{onFailure:V,onSuccess:rt})))},end(){return this(Er(H()))},fail(n){return this(Er(V(n)))},fromEffect(n){return this(UR(n,{onFailure:V,onSuccess:rt}))},fromEffectChunk(n){return this(b(n,Ks(V)))},halt(n){return this(Mn(b(n,zm(V))))},single(n){return this(We(rt(n)))}}),s9=(e,t)=>{let n=!1,r=[],s=!1;function o(f){if(n)return!1;if(f.length<=5e4)r.push.apply(r,f);else for(let d=0;d<f.length;d++)r.push(f[0]);return s||(s=!0,t.scheduleTask(a,0)),!0}function a(){s=!1,r.length>0&&(e.unsafeOffer(r),r=[])}function u(f){n||(n=!0,f._tag==="Success"&&r.push(f.value),a(),e.unsafeOffer(f._tag==="Success"?Un:f))}return{single(f){return n?!1:(r.push(f),s||(s=!0,t.scheduleTask(a,0)),!0)},array:o,chunk(f){return o(er(f))},done:u,end(){n||(n=!0,a(),e.unsafeOffer(Un))},halt(f){return u(Xt(f))},fail(f){return u(Of(f))},die(f){return u(bl(f))},dieMessage(f){return u(bl(new Error(f)))}}},o9="effect/Take",i9=Symbol.for(o9),a9={_A:e=>e,_E:e=>e};class pg{exit;[i9]=a9;constructor(t){this.exit=t}pipe(){return Y(this,arguments)}}const xl=e=>new pg(Mt(e)),c9=e=>ut(()=>e.exit),Nl=new pg(Of(H())),mg=e=>new pg(Xt(b(e,zm(V)))),u9=e=>Al(e,{onFailure:t=>Xe($w(t),{onNone:()=>Nl,onSome:mg}),onSuccess:xl}),EA=y(2,(e,{onEnd:t,onFailure:n,onSuccess:r})=>qr(e.exit,{onFailure:s=>Xe($w(s),{onNone:t,onSome:n}),onSuccess:r})),l9=e=>new pg(Mt(rt(e))),kA=()=>Er(H()),f9=e=>Ks(Mn(e),V),d9="effect/Stream",$A=Symbol.for(d9),h9={_R:e=>e,_E:e=>e,_A:e=>e};class Ke{channel;[$A]=h9;constructor(t){this.channel=t}pipe(){return Y(this,arguments)}}const ed=e=>X(e,$A)||kr(e),Sv=4096,p9=e=>{if(e==="unbounded")return fn();if(typeof e=="number"||e===void 0)return Ic(e??16);switch(e.strategy){case"dropping":return ng(e.bufferSize??16);case"sliding":return rg(e.bufferSize??16);default:return Ic(e.bufferSize??16)}},m9=e=>{if(e?.bufferSize==="unbounded"||e?.bufferSize===void 0&&e?.strategy===void 0)return fn();switch(e?.strategy){case"sliding":return rg(e.bufferSize??16);default:return ng(e?.bufferSize??16)}},g9=(e,t)=>it(m9(t),Lt).pipe(Js(n=>y8(JR,r=>e(s9(n,r)))),ye(n=>{const r=Ae(Ro(n),s=>xz(s)?wc(s)?sn:bt(s.cause):Yf(Qe(Pt(s)),r));return r}),ug,O9),_9=(e,t)=>b(it(p9(t),n=>Lt(n)),Q(n=>b(Bo(),Q(r=>b(e(r9(s=>b(u9(s),Q(o=>Ge(n,o)),ls,MG(r)).then(o=>{if(eu(o)&&!Il(o.cause))throw Tw(o.cause)}))),at(Uo(!1)),Q(s=>b(vi(s),ye(o=>o?kA():b(Ro(n),Q(c9),XK(()=>b(Ec(s,!0),at(Lt(n)))))))))))),Ev,vo(_g)),y9=y(2,(e,t)=>{if(t.strategy==="dropping")return b9(e,t.capacity);if(t.strategy==="sliding")return S9(e,t.capacity);const n=G9(e,t);return new Ke(ug(ye(n,r=>{const s=b(gt(Ro(r)),Ae(EA({onEnd:()=>sn,onFailure:bt,onSuccess:o=>b(Qe(o),Ae(()=>s))})));return s})))}),b9=y(2,(e,t)=>{const n=it(ng(t),r=>Lt(r));return new Ke(TA(n,He(e)))}),S9=y(2,(e,t)=>{const n=it(rg(t),r=>Lt(r));return new Ke(TA(n,He(e)))}),TA=(e,t)=>{const n=(s,o)=>{const a=u=>b(vi(o),Js(Nt),at(Ue()),Q(f=>b(Ge(s,[u,f]),at(Ec(o,f)),at(Nt(f)))),ls,gt);return ar({onInput:u=>b(Ue(),Q(f=>b(Ge(s,[xl(u),f]),Q(d=>b(Ec(o,f),HR(()=>d))))),ls,gt,Ae(()=>n(s,o))),onFailure:u=>a(mg(u)),onDone:()=>a(Nl)})},r=s=>{const o=b(gt(Ro(s)),Ae(([a,u])=>Yf(gt(vt(u,void 0)),EA(a,{onEnd:()=>sn,onFailure:bt,onSuccess:f=>b(Qe(f),Ae(()=>o))}))));return o};return ug(b(e,Q(s=>b(Ue(),Js(o=>vt(o,void 0)),Q(o=>b(Uo(o),Q(a=>b(t,tn(n(s,a)),Yq,Bt)),Ms(r(s))))))))},CA=y(2,(e,t)=>new Ke(b(He(e),Yf(He(t))))),w9=e=>fu(Gi(e)),nb=y(2,(e,t)=>new Ke(b(He(e),Hq(t)))),v9=y(2,(e,t)=>new Ke(cv(He(e),t))),E9=e=>wv(Er(V(e))),k9=y(2,(e,t)=>AA(e,zp(t))),$9=y(2,(e,t)=>{const n=r=>{const s=r.next();return s.done?ar({onInput:o=>n(o[Symbol.iterator]()),onFailure:bt,onDone:fa}):b(t(s.value),ye(o=>o?b(Qe(rt(s.value)),Ae(()=>n(r))):n(r)),wr)};return new Ke(Kf(()=>b(He(e),tn(n(lt()[Symbol.iterator]())))))}),T9=y(2,(e,t)=>AA(e,HC(t))),vo=y(e=>ed(e[0]),(e,t,n)=>{const r=n?.bufferSize??16;return n?.switch?rb(n?.concurrency,()=>Wk(e,1,r,t),s=>Wk(e,s,r,t)):rb(n?.concurrency,()=>new Ke(Qh(He(e),s=>b(s,xa(o=>He(t(o))),RM(sn,(o,a)=>b(o,Yf(a)))))),s=>new Ke(b(He(e),Qh(lg),Jq(o=>He(t(o)),n))))}),rb=(e,t,n)=>{switch(e){case void 0:return t();case"unbounded":return n(Number.MAX_SAFE_INTEGER);default:return e>1?n(e):t()}},Wk=y(4,(e,t,n,r)=>new Ke(b(He(e),Qh(lg),Jq(s=>He(r(s)),{concurrency:t,mergeStrategy:dG(),bufferSize:n})))),gg=y(e=>ed(e[0]),(e,t)=>vo(e,oe,t)),IA=e=>{const t=ar({onInput:n=>Ae(lg(n),()=>t),onFailure:bt,onDone:()=>sn});return new Ke(b(He(e),tn(t)))},C9=e=>{const t=(r,s)=>{const[o,a]=b(r,IM(f=>!wc(f))),u=b(Bp(a),Xe({onNone:()=>s,onSome:qr({onFailure:f=>Xe($w(f),{onNone:()=>sn,onSome:bt}),onSuccess:()=>sn})}));return b(Qe(b(o,HC(f=>wc(f)?V(f.value):H()))),Ae(()=>u))},n=ar({onInput:r=>t(r,n),onFailure:r=>bt(r),onDone:()=>sn});return new Ke(b(He(e),tn(n)))},I9=e=>b(e,Ml(Us),IA),OA=e=>IA(C9(b(e,Ml(t=>t.exit)))),O9=e=>new Ke(e),He=e=>{if("channel"in e)return e.channel;if(kr(e))return He(fu(e));throw new TypeError("Expected a Stream.")},sb=e=>new Ke(mf(e)?sn:Qe(e)),fu=e=>b(e,Ks(V),wv),wv=e=>new Ke(wr(u8(e,{onFailure:Xe({onNone:()=>sn,onSome:Wf}),onSuccess:t=>Qe(rt(t))}))),RA=(e,t)=>{const n=t?.maxChunkSize??Sv;if(t?.scoped){const s=ye(Ok(e),o=>Dl(o,{maxChunkSize:n,shutdown:!0}));return t.shutdown?ye(s,nb(By(e))):s}const r=vo(Ev(Ok(e)),s=>Dl(s,{maxChunkSize:n}));return t?.shutdown?nb(r,By(e)):r},R9=e=>kv(()=>bi(e)?sb(e):q9(e[Symbol.iterator]())),q9=(e,t=Sv)=>b($e(()=>{let n=[];const r=s=>b($e(()=>{let o=s.next();if(t===1)return o.done?sn:b(Qe(rt(o.value)),Ae(()=>r(s)));n=[];let a=0;for(;o.done===!1&&(n.push(o.value),a=a+1,!(a>=t));)o=s.next();return a>0?b(Qe(Pt(n)),Ae(()=>r(s))):sn}),wr);return new Ke(r(e))}),PA),A9=e=>b(e,ye(_g),yg),Dl=(e,t)=>b(cq(e,1,t?.maxChunkSize??Sv),ns(n=>b(FJ(e),Q(r=>r&&Il(n)?kA():f9(n)))),_g,t?.shutdown?nb(Lt(e)):oe),F9=(...e)=>{const t=e.length===1?e[0].evaluate:e[0],n=e.length===1?e[0].onError:e[1],r=e.length===1?e[0].releaseLockOnEnd===!0:!1;return yg(ye(it($e(()=>t().getReader()),s=>r?$e(()=>s.releaseLock()):Jm(()=>s.cancel())),s=>ob(Q(Ku({try:()=>s.read(),catch:o=>V(n(o))}),({done:o,value:a})=>o?Er(H()):We(a)))))},qA=(...e)=>R9(e),Ml=y(2,(e,t)=>new Ke(b(He(e),cg(xa(t))))),AA=y(2,(e,t)=>new Ke(b(He(e),cg(t)))),P9=y(2,(e,t)=>new Ke(b(He(e),Kq(t)))),Zh=y(2,(e,t)=>{const n=r=>{const s=r.next();if(s.done)return ar({onInput:o=>n(o[Symbol.iterator]()),onFailure:bt,onDone:fa});{const o=s.value;return wr(ye(t(o),a=>Ae(Qe(rt(a)),()=>n(r))))}};return new Ke(b(He(e),tn(Kf(()=>n(lt()[Symbol.iterator]())))))}),x9=y(3,(e,t,n)=>new Ke(b(He(e),Qh(lg),wG(n,t),cg(rt)))),N9=y(2,(e,t)=>new Ke(b(He(e),bG(t)))),D9=y(2,(e,t)=>M9(e,t,{onSelf:se,onOther:ie})),M9=y(3,(e,t,n)=>{const r=n.haltStrategy?JG(n.haltStrategy):GG,s=o=>a=>o||!wc(a)?NG(ut(()=>a)):DG(u=>ut(()=>u));return new Ke(Gq(He(Ml(e,n.onSelf)),{other:He(Ml(t,n.onOther)),onSelfDone:s(r._tag==="Either"||r._tag==="Left"),onOtherDone:s(r._tag==="Either"||r._tag==="Right")}))}),L9=fu(Dw),j9=e=>b(e,U9(oe)),U9=y(2,(e,t)=>new Ke(b(He(e),kG(t)))),z9=y(2,(e,t)=>new Ke(b(He(e),Hy(t)))),_g=e=>Z9(e,t=>b(ye(t,n=>V([n,t])),Gm(Xe({onNone:()=>We(H()),onSome:Er})))),ob=e=>_g(b(e,ye(rt))),vv=y(2,(e,t)=>He(e).pipe(Qq(nA(t)),TG)),B9=e=>vv(e,AG()),H9=e=>vv(e,FG),FA=y(2,(e,t)=>vv(e,PG(t))),V9=y(2,(e,t)=>{const n=ar({onInput:r=>Ae(Qe(xl(r)),()=>n),onFailure:r=>Qe(mg(r)),onDone:()=>Qe(Nl)});return b(tn(He(e),n),Kq(r=>Ge(t,r)),ig,Yq,ls)}),Ev=e=>new Ke(Hq(Xq(b(e,ye(rt))),me)),W9=e=>new Ke(Zq(t=>e(t).pipe(ye(rt)))),kv=e=>new Ke(Kf(()=>He(e()))),K9=y(2,(e,t)=>{if(!Number.isInteger(t))return w9(new MV(`${t} must be an integer`));const n=r=>sg({onInput:s=>{const o=b(s,ac(Math.min(r,Number.POSITIVE_INFINITY))),a=Math.max(0,r-o.length);return a>0?b(Qe(o),Ae(()=>n(a))):Qe(o)},onFailure:Wf,onDone:fa});return new Ke(b(He(e),Qq(0<t?n(t):sn)))}),J9=y(2,(e,t)=>Zh(e,n=>Ms(t(n),n))),y_=e=>ye(CG(He(e)),t=>b(t,Ks(V),Q(Yt({onLeft:()=>Er(H()),onRight:We})))),G9=y(e=>ed(e[0]),(e,t)=>Js(it(t?.strategy==="unbounded"?fn():t?.strategy==="dropping"?ng(t.capacity??2):t?.strategy==="sliding"?rg(t.capacity??2):Ic(t?.capacity??2),n=>Lt(n)),n=>Bt(V9(e,n)))),Q9=y(e=>ed(e[0]),(e,t)=>ye(Bo(),n=>Y9(e,n,t))),Y9=y(e=>ed(e[0]),(e,t,n)=>{const r=rA(t);let s,o;const a=d8(!1);return new ReadableStream({start(u){o=r(FA(e,f=>a.whenOpen($e(()=>{a.unsafeClose();for(const d of f)u.enqueue(d);s(),s=void 0})))),o.addObserver(f=>{f._tag==="Failure"?u.error(Tw(f.cause)):u.close()})},pull(){return new Promise(u=>{s=u,rs(a.open)})},cancel(){if(o)return WR(ls(Sr(o)))}},n?.strategy)}),X9=(e,t)=>{const n=r=>Xe(t(r),{onNone:()=>sn,onSome:([s,o])=>Ae(Qe(s),()=>n(o))});return new Ke(Kf(()=>n(e)))},Z9=(e,t)=>kv(()=>{const n=r=>wr(ye(t(r),Xe({onNone:()=>sn,onSome:([s,o])=>Ae(Qe(s),()=>n(o))})));return new Ke(n(e))}),PA=e=>gg(fu(e)),yg=e=>gg(Ev(e)),e7=e=>gg(W9(t=>e(t))),t7=function(){const e=typeof arguments[0]!="string",t=e?arguments[1]:arguments[0],n=xs(e?arguments[2]:arguments[1]);if(e){const r=arguments[0];return new Ke(Mk(He(r),t,n))}return r=>new Ke(Mk(He(r),t,n))},n7=y(2,(e,t)=>b(e,r7(t,(n,r)=>[n,r]))),r7=y(3,(e,t,n)=>{const r=s=>b(s,Q(o=>mf(o)?r(s):We(o)));return b(y_(e),ye(r),Vh(b(y_(t),ye(r))),Q(([s,o])=>b(wv(Bw(s,o,{onSelfDone:(a,u)=>b(ut(()=>a),Cc(Bh(u),(f,d)=>[f,d,!0])),onOtherDone:(a,u)=>b(ut(()=>a),Cc(Bh(u),(f,d)=>[d,f,!1]))})),vo(([a,u,f])=>b(fu(Uo([ka(a),ka(u)])),vo(d=>b(sb(f?b(u,xa(p=>n(ka(a),p))):b(a,xa(p=>n(p,ka(u))))),CA(b(ob(s),D9(ob(o)),Zh(Yt({onLeft:p=>b(ri(d,([m,$])=>[b(p,xa(C=>n(C,$))),[ka(p),$]])),onRight:p=>b(ri(d,([m,$])=>[b(p,xa(C=>n(m,C))),[m,ka(p)]]))})),vo(sb))))))),y_)),A9)}),s7=(e,t,n)=>g9(r=>it($e(()=>e.addEventListener(t,r.single,n)),()=>$e(()=>e.removeEventListener(t,r.single,n))),{bufferSize:typeof n=="object"?n.bufferSize:void 0}),xA="effect/Redacted",Zd=Se("effect/Redacted/redactedRegistry",()=>new WeakMap),NA=Symbol.for(xA),o7={[NA]:{_A:e=>e},pipe(){return Y(this,arguments)},toString(){return"<redacted>"},toJSON(){return"<redacted>"},[Le](){return"<redacted>"},[he](){return b(J(xA),ue(J(Zd.get(this))),tt(this))},[pe](e){return i7(e)&&le(Zd.get(this),Zd.get(e))}},i7=e=>X(e,NA),a7=e=>{const t=Object.create(o7);return Zd.set(t,e),t},Kk=Symbol.for("effect/Encoding/errors/Decode"),b_=(e,t)=>{const n={_tag:"DecodeException",[Kk]:Kk,input:e};return An(t)&&(n.message=t),n},c7=new TextEncoder,Jk=e=>{const t=e.length;let n="",r;for(r=2;r<t;r+=3)n+=Ss[e[r-2]>>2],n+=Ss[(e[r-2]&3)<<4|e[r-1]>>4],n+=Ss[(e[r-1]&15)<<2|e[r]>>6],n+=Ss[e[r]&63];return r===t+1&&(n+=Ss[e[r-2]>>2],n+=Ss[(e[r-2]&3)<<4],n+="=="),r===t&&(n+=Ss[e[r-2]>>2],n+=Ss[(e[r-2]&3)<<4|e[r-1]>>4],n+=Ss[(e[r-1]&15)<<2],n+="="),n},u7=e=>{const t=l7(e),n=t.length;if(n%4!==0)return se(b_(t,`Length must be a multiple of 4, but is ${n}`));const r=t.indexOf("=");if(r!==-1&&(r<n-2||r===n-2&&t[n-1]!=="="))return se(b_(t,"Found a '=' character, but it is not at the end"));try{const s=t.endsWith("==")?2:t.endsWith("=")?1:0,o=new Uint8Array(3*(n/4)-s);for(let a=0,u=0;a<n;a+=4,u+=3){const f=kd(t.charCodeAt(a))<<18|kd(t.charCodeAt(a+1))<<12|kd(t.charCodeAt(a+2))<<6|kd(t.charCodeAt(a+3));o[u]=f>>16,o[u+1]=f>>8&255,o[u+2]=f&255}return ie(o)}catch(s){return se(b_(t,s instanceof Error?s.message:"Invalid input"))}},l7=e=>e.replace(/[\n\r]/g,"");function kd(e){if(e>=Gk.length)throw new TypeError(`Invalid character ${String.fromCharCode(e)}`);const t=Gk[e];if(t===255)throw new TypeError(`Invalid character ${String.fromCharCode(e)}`);return t}const Ss=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],Gk=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,62,255,255,255,63,52,53,54,55,56,57,58,59,60,61,255,255,255,0,255,255,255,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,255,255,255,255,255,255,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51],f7=e=>Jk(typeof e=="string"?c7.encode(e):e),d7=e=>u7(e),ib=Symbol.for("effect/FiberHandle"),h7=e=>X(e,ib),p7={[ib]:ib,toString(){return st(this.toJSON())},toJSON(){return{_id:"FiberHandle",state:this.state}},[Le](){return this.toJSON()},pipe(){return Y(this,arguments)}},m7=e=>{const t=Object.create(p7);return t.state={_tag:"Open",fiber:void 0},t.deferred=e,t},DA=()=>it(ye(Ue(),e=>m7(e)),e=>us(t=>{const n=e.state;return n._tag==="Closed"?me:(e.state={_tag:"Closed"},n.fiber?Bf(ls(Vm(n.fiber,tr(t.id(),Ju))),e.deferred):ua(e.deferred,Un))})),MA=-1,Ju=wS(MA,0),g7=Cw(void 0,{emptyCase:Nn,failCase:Nn,dieCase:Nn,interruptCase:(e,t)=>Zp(nm(t),MA),sequentialCase:(e,t,n)=>t||n,parallelCase:(e,t,n)=>t||n}),_7=y(e=>h7(e[0]),(e,t,n)=>{if(e.state._tag==="Closed"){t.unsafeInterruptAsFork(tr(n?.interruptAs??On,Ju));return}else if(e.state.fiber!==void 0){if(n?.onlyIfMissing===!0){t.unsafeInterruptAsFork(tr(n?.interruptAs??On,Ju));return}else if(e.state.fiber===t)return;e.state.fiber.unsafeInterruptAsFork(tr(n?.interruptAs??On,Ju)),e.state.fiber=void 0}e.state.fiber=t,t.addObserver(r=>{e.state._tag==="Open"&&t===e.state.fiber&&(e.state.fiber=void 0),eu(r)&&(n?.propagateInterruption===!0?!g7(r.cause):!Ds(r.cause))&&li(e.deferred,r)})}),y7=e=>Oo(t=>us(n=>e.state._tag==="Closed"||e.state.fiber===void 0?me:at(t(Vm(e.state.fiber,tr(n.id(),Ju))),$e(()=>{e.state._tag==="Open"&&(e.state.fiber=void 0)})))),b7=function(){let e;return()=>(e===void 0&&(e=Ho(Hr)),e)}(),ep=function(){const e=arguments[0];if(kr(arguments[1]))return Qk(e,arguments[1],arguments[2]);const t=arguments[1];return n=>Qk(e,n,t)},Qk=(e,t,n)=>Lw(r=>e.state._tag==="Closed"?Hr:e.state.fiber!==void 0&&n?.onlyIfMissing===!0?$e(b7):Js(Uw(t),s=>_7(e,s,{...n,interruptAs:r}))),ab=Symbol.for("effect/FiberMap"),S7=e=>X(e,ab),w7={[ab]:ab,[Symbol.iterator](){return this.state._tag==="Closed"?LT():this.state.backing[Symbol.iterator]()},toString(){return st(this.toJSON())},toJSON(){return{_id:"FiberMap",state:this.state}},[Le](){return this.toJSON()},pipe(){return Y(this,arguments)}},v7=(e,t)=>{const n=Object.create(w7);return n.state={_tag:"Open",backing:e},n.deferred=t,n},E7=()=>it(ye(Ue(),e=>v7(g1(),e)),e=>us(t=>{const n=e.state;return n._tag==="Closed"?me:(e.state={_tag:"Closed"},vR(C3(n.backing,([,r])=>r),tr(t.id(),Gu)).pipe(Bf(e.deferred)))})),LA=-1,Gu=wS(LA,0),k7=Cw(void 0,{emptyCase:Nn,failCase:Nn,dieCase:Nn,interruptCase:(e,t)=>Zp(nm(t),LA),sequentialCase:(e,t,n)=>t||n,parallelCase:(e,t,n)=>t||n}),$7=y(e=>S7(e[0]),(e,t,n,r)=>{if(e.state._tag==="Closed"){n.unsafeInterruptAsFork(tr(r?.interruptAs??On,Gu));return}const s=Br(e.state.backing,t);if(s._tag==="Some"){if(r?.onlyIfMissing===!0){n.unsafeInterruptAsFork(tr(r?.interruptAs??On,Gu));return}else if(s.value===n)return;s.value.unsafeInterruptAsFork(tr(r?.interruptAs??On,Gu))}qa(e.state.backing,t,n),n.addObserver(o=>{if(e.state._tag==="Closed")return;const a=Br(e.state.backing,t);nt(a)&&n===a.value&&Hz(e.state.backing,t),eu(o)&&(r?.propagateInterruption===!0?!k7(o.cause):!Ds(o.cause))&&li(e.deferred,o)})}),T7=y(2,(e,t)=>e.state._tag==="Closed"?!1:Ra(e.state.backing,t)),S_=y(2,(e,t)=>us(n=>{if(e.state._tag==="Closed")return me;const r=Br(e.state.backing,t);return r._tag==="None"?me:Vm(r.value,tr(n.id(),Gu))})),C7=function(){let e;return()=>(e===void 0&&(e=Ho(Hr)),e)}(),w_=function(){const e=arguments[0];if(kr(arguments[2]))return Yk(e,arguments[1],arguments[2],arguments[3]);const t=arguments[1],n=arguments[2];return r=>Yk(e,t,r,n)},Yk=(e,t,n,r)=>Lw(s=>e.state._tag==="Closed"?Hr:r?.onlyIfMissing===!0&&T7(e,t)?$e(C7):Js(Uw(n),o=>$7(e,t,o,{...r,interruptAs:s}))),cb=Symbol.for("effect/FiberSet"),I7=e=>X(e,cb),O7={[cb]:cb,[Symbol.iterator](){return this.state._tag==="Closed"?LT():this.state.backing[Symbol.iterator]()},toString(){return st(this.toJSON())},toJSON(){return{_id:"FiberMap",state:this.state}},[Le](){return this.toJSON()},pipe(){return Y(this,arguments)}},R7=(e,t)=>{const n=Object.create(O7);return n.state={_tag:"Open",backing:e},n.deferred=t,n},q7=()=>it(ye(Ue(),e=>R7(new Set,e)),e=>us(t=>{const n=e.state;if(n._tag==="Closed")return me;e.state={_tag:"Closed"};const r=n.backing;return vR(r,tr(t.id(),UA)).pipe(Bf(e.deferred))})),jA=-1,UA=wS(jA,0),A7=Cw(void 0,{emptyCase:Nn,failCase:Nn,dieCase:Nn,interruptCase:(e,t)=>Zp(nm(t),jA),sequentialCase:(e,t,n)=>t||n,parallelCase:(e,t,n)=>t||n}),Xk=y(e=>I7(e[0]),(e,t,n)=>{if(e.state._tag==="Closed"){t.unsafeInterruptAsFork(tr(n?.interruptAs??On,UA));return}else if(e.state.backing.has(t))return;e.state.backing.add(t),t.addObserver(r=>{e.state._tag!=="Closed"&&(e.state.backing.delete(t),eu(r)&&(n?.propagateInterruption===!0?!A7(r.cause):!Ds(r.cause))&&li(e.deferred,r))})}),F7="effect/GroupBy",zA=Symbol.for(F7),P7={_R:e=>e,_E:e=>e,_K:e=>e,_V:e=>e},x7=e=>X(e,zA),N7=y(e=>x7(e[0]),(e,t,n)=>vo(e.grouped,([r,s])=>t(r,OA(Dl(s,{shutdown:!0}))),{concurrency:"unbounded",bufferSize:n?.bufferSize??16})),D7=e=>({[zA]:P7,pipe(){return Y(this,arguments)},grouped:e}),M7=y(e=>typeof e[0]!="function",(e,t,n)=>n?.key?N7(L7(e,n.key,{bufferSize:n.bufferSize}),(r,s)=>Zh(s,t)):rb(n?.concurrency,()=>Zh(e,t),r=>n?.unordered?vo(e,s=>fu(t(s)),{concurrency:r}):x9(e,r,t))),L7=y(e=>typeof e[0]!="function",(e,t,n)=>{const r=(s,o)=>ar({onInput:a=>Ae(gt(dn(j7(a,t),([u,f])=>{const d=s.get(u);return d===void 0?b(Ic(n?.bufferSize??16),Q(p=>b($e(()=>{s.set(u,p)}),at(Ge(o,l9([u,p]))),at(b(Ge(p,xl(f)),u_(m=>Ds(m)?V(me):H())))))):u_(Ge(d,xl(f)),p=>Ds(p)?V(me):H())},{discard:!0})),()=>r(s,o)),onFailure:a=>gt(Ge(o,mg(a))),onDone:()=>b(gt(b(dn(s.entries(),([a,u])=>b(Ge(u,Nl),u_(f=>Ds(f)?V(me):H())),{discard:!0}),at(Ge(o,Nl)))))});return D7(e7(s=>z(function*(){const o=new Map,a=yield*fn();return yield*wo(s,Lt(a)),yield*He(e).pipe(tn(r(o,a)),ig,lv(s),nr(s),Ms(OA(Dl(a,{shutdown:!0}))))})))}),j7=y(2,(e,t)=>{const n=[],r=e[Symbol.iterator](),s=new Map;let o;for(;(o=r.next())&&!o.done;){const a=o.value,u=t(a);if(s.has(u))s.get(u).push(a);else{const f=[a];n.push([u,f]),s.set(u,f)}}return Pt(n.map(a=>[a[0],Pt(a[1])]))});class un{path;actual;issue;_tag="Pointer";constructor(t,n,r){this.path=t,this.actual=n,this.issue=r}}class Zk{actual;message;_tag="Unexpected";constructor(t,n){this.actual=t,this.message=n}}class Tu{ast;message;_tag="Missing";actual=void 0;constructor(t,n){this.ast=t,this.message=n}}class At{ast;actual;issues;output;_tag="Composite";constructor(t,n,r,s){this.ast=t,this.actual=n,this.issues=r,this.output=s}}class v_{ast;actual;kind;issue;_tag="Refinement";constructor(t,n,r,s){this.ast=t,this.actual=n,this.kind=r,this.issue=s}}class E_{ast;actual;kind;issue;_tag="Transformation";constructor(t,n,r,s){this.ast=t,this.actual=n,this.kind=r,this.issue=s}}class Qt{ast;actual;message;_tag="Type";constructor(t,n,r){this.ast=t,this.actual=n,this.message=r}}class e${ast;actual;message;_tag="Forbidden";constructor(t,n,r){this.ast=t,this.actual=n,this.message=r}}const t$=Symbol.for("effect/Schema/ParseErrorTypeId");class U7 extends _W("ParseError"){[t$]=t$;get message(){return this.toString()}toString(){return Yu.formatIssueSync(this.issue)}toJSON(){return{_id:"ParseError",message:this.toString()}}[Le](){return this.toJSON()}}const du=e=>new U7({issue:e}),Ar=ie,hu=se,n$=o3,Tn=xT,_o=y(2,(e,t)=>Tn(e)?Yt(e,{onLeft:se,onRight:t}):Q(e,t)),Yn=y(2,(e,t)=>Tn(e)?a3(e,t):ye(e,t)),Qu=y(2,(e,t)=>Tn(e)?cf(e,t):Ks(e,t)),z7=y(2,(e,t)=>Tn(e)?i3(e,{onLeft:t.onFailure,onRight:t.onSuccess}):UR(e,t)),BA=y(2,(e,t)=>Tn(e)?Yt(e,{onLeft:t,onRight:ie}):Gm(e,t)),bg=(e,t)=>t===void 0||Ls(t)?e:e===void 0?t:{...e,...t},Sg=(e,t,n)=>{const r=nn(e,t);return(s,o)=>r(s,bg(n,o))},$v=(e,t,n)=>{const r=Sg(e,t,n);return(s,o)=>NT(r(s,o),du)},HA=(e,t,n)=>{const r=nn(e,t);return(s,o)=>r(s,{...bg(n,o),isEffectAllowed:!0})},tp=(e,t)=>$v(e.ast,!0,t),B7=(e,t)=>Sg(e.ast,!0,t),td=(e,t)=>HA(e.ast,!0,t),H7=(e,t)=>$v(e.ast,!1,t),V7=(e,t)=>Sg(e.ast,!1,t),pu=(e,t)=>HA(e.ast,!1,t),VA=tp,W7=td,wg=(e,t)=>$v(It(e.ast),!0,t),K7=(e,t)=>Sg(It(e.ast),!0,t),yn=(e,t)=>{const n=nn(It(e.ast),!0);return(r,s)=>Qr(n(r,{exact:!0,...bg(t,s)}))},Is=H7,J7=pu,G7=Se(Symbol.for("effect/ParseResult/decodeMemoMap"),()=>new WeakMap),Q7=Se(Symbol.for("effect/ParseResult/encodeMemoMap"),()=>new WeakMap),nn=(e,t)=>{const n=t?G7:Q7,r=n.get(e);if(r)return r;const s=Y7(e,t),o=_D(e),a=nt(o)?(d,p)=>s(d,bg(p,o.value)):s,u=yD(e),f=t&&nt(u)?(d,p)=>Lu(BA(a(d,p),u.value),e,d,p):a;return n.set(e,f),f},k_=e=>hr(pD(e)),$_=e=>hr(mD(e)),Y7=(e,t)=>{switch(e._tag){case"Refinement":if(t){const n=nn(e.from,!0);return(r,s)=>{s=s??Yg;const o=s?.errors==="all",a=_o(BA(n(r,s),u=>{const f=new v_(e,r,"From",u);return o&&SD(e)&&GA(u)?Xe(e.filter(r,s,e),{onNone:()=>se(f),onSome:d=>se(new At(e,r,[f,new v_(e,r,"Predicate",d)]))}):se(f)}),u=>Xe(e.filter(u,s,e),{onNone:()=>ie(u),onSome:f=>se(new v_(e,r,"Predicate",f))}));return Lu(a,e,r,s)}}else{const n=nn(It(e),!0),r=nn(WA(e.from),!1);return(s,o)=>Lu(_o(n(s,o),a=>r(a,o)),e,s,o)}case"Transformation":{const n=eY(e.transformation,t),r=t?nn(e.from,!0):nn(e.to,!1),s=t?nn(e.to,!0):nn(e.from,!1);return(o,a)=>Lu(_o(Qu(r(o,a),u=>new E_(e,o,t?"Encoded":"Type",u)),u=>_o(Qu(n(u,a??Yg,e,o),f=>new E_(e,o,"Transformation",f)),f=>Qu(s(f,a),d=>new E_(e,o,t?"Type":"Encoded",d)))),e,o,a)}case"Declaration":{const n=t?e.decodeUnknown(...e.typeParameters):e.encodeUnknown(...e.typeParameters);return(r,s)=>Lu(n(r,s??Yg,e),e,r,s)}case"Literal":return Jn(e,n=>n===e.literal);case"UniqueSymbol":return Jn(e,n=>n===e.symbol);case"UndefinedKeyword":return Jn(e,E2);case"NeverKeyword":return Jn(e,k2);case"UnknownKeyword":case"AnyKeyword":case"VoidKeyword":return ie;case"StringKeyword":return Jn(e,An);case"NumberKeyword":return Jn(e,Ls);case"BooleanKeyword":return Jn(e,Ri);case"BigIntKeyword":return Jn(e,Cp);case"SymbolKeyword":return Jn(e,ch);case"ObjectKeyword":return Jn(e,hs);case"Enums":return Jn(e,n=>e.enums.some(([r,s])=>s===n));case"TemplateLiteral":{const n=qC(e);return Jn(e,r=>An(r)&&n.test(r))}case"TupleType":{const n=e.elements.map(d=>nn(d.type,t)),r=e.rest.map(d=>nn(d.type,t));let s=e.elements.filter(d=>!d.isOptional);e.rest.length>0&&(s=s.concat(e.rest.slice(1)));const o=s.length,a=e.elements.length>0?e.elements.map((d,p)=>p).join(" | "):"never",u=k_(e),f=$_(e);return(d,p)=>{if(!P3(d))return se(new Qt(e,d));const m=p?.errors==="all",$=[];let C=0;const O=[],N=d.length;for(let E=N;E<=o-1;E++){const k=new un(E,d,new Tu(s[E-N]));if(m){$.push([C++,k]);continue}else return se(new At(e,d,k,O))}if(e.rest.length===0)for(let E=e.elements.length;E<=N-1;E++){const k=new un(E,d,new Zk(d[E],`is unexpected, expected: ${a}`));if(m){$.push([C++,k]);continue}else return se(new At(e,d,k,O))}let v=0,w;for(;v<n.length;v++)if(N<v+1){if(e.elements[v].isOptional)continue}else{const E=n[v],k=E(d[v],p);if(Tn(k)){if(Kt(k)){const R=new un(v,d,k.left);if(m){$.push([C++,R]);continue}else return se(new At(e,d,R,Cr(O)))}O.push([C++,k.right])}else{const R=C++,q=v;w||(w=[]),w.push(({es:x,output:D})=>Q(ni(k),G=>{if(Kt(G)){const P=new un(q,d,G.left);return m?(x.push([R,P]),me):se(new At(e,d,P,Cr(D)))}return D.push([R,G.right]),me}))}}if(ft(r)){const[E,...k]=r;for(;v<N-k.length;v++){const R=E(d[v],p);if(Tn(R))if(Kt(R)){const q=new un(v,d,R.left);if(m){$.push([C++,q]);continue}else return se(new At(e,d,q,Cr(O)))}else O.push([C++,R.right]);else{const q=C++,x=v;w||(w=[]),w.push(({es:D,output:G})=>Q(ni(R),P=>{if(Kt(P)){const L=new un(x,d,P.left);return m?(D.push([q,L]),me):se(new At(e,d,L,Cr(G)))}else return G.push([q,P.right]),me}))}}for(let R=0;R<k.length;R++)if(v+=R,!(N<v+1)){const q=k[R](d[v],p);if(Tn(q)){if(Kt(q)){const x=new un(v,d,q.left);if(m){$.push([C++,x]);continue}else return se(new At(e,d,x,Cr(O)))}O.push([C++,q.right])}else{const x=C++,D=v;w||(w=[]),w.push(({es:G,output:P})=>Q(ni(q),L=>{if(Kt(L)){const Z=new un(D,d,L.left);return m?(G.push([x,Z]),me):se(new At(e,d,Z,Cr(P)))}return P.push([x,L.right]),me}))}}}const g=({es:E,output:k})=>Nd(E)?se(new At(e,d,Cr(E),Cr(k))):ie(Cr(k));if(w&&w.length>0){const E=w;return ut(()=>{const k={es:Fu($),output:Fu(O)};return Q(dn(E,R=>R(k),{concurrency:u,batching:f,discard:!0}),()=>g(k))})}return g({output:O,es:$})}}case"TypeLiteral":{if(e.propertySignatures.length===0&&e.indexSignatures.length===0)return Jn(e,$2);const n=[],r={},s=[];for(const p of e.propertySignatures)n.push([nn(p.type,t),p]),r[p.name]=null,s.push(p.name);const o=e.indexSignatures.map(p=>[nn(p.parameter,t),nn(p.type,t),p.parameter]),a=Jt.make(e.indexSignatures.map(p=>p.parameter).concat(s.map(p=>ch(p)?new vC(p):new _h(p)))),u=nn(a,t),f=k_(e),d=$_(e);return(p,m)=>{if(!C2(p))return se(new Qt(e,p));const $=m?.errors==="all",C=[];let O=0;const N=m?.onExcessProperty==="error",v=m?.onExcessProperty==="preserve",w={};let g;if(N||v){g=es(p);for(const q of g){const x=u(q,m);if(Tn(x)&&Kt(x))if(N){const D=new un(q,p,new Zk(p[q],`is unexpected, expected: ${String(a)}`));if($){C.push([O++,D]);continue}else return se(new At(e,p,D,w))}else w[q]=p[q]}}let E;const k=m?.exact===!0;for(let q=0;q<n.length;q++){const x=n[q][1],D=x.name,G=Object.prototype.hasOwnProperty.call(p,D);if(!G){if(x.isOptional)continue;if(k){const Z=new un(D,p,new Tu(x));if($){C.push([O++,Z]);continue}else return se(new At(e,p,Z,w))}}const P=n[q][0],L=P(p[D],m);if(Tn(L)){if(Kt(L)){const Z=new un(D,p,G?L.left:new Tu(x));if($){C.push([O++,Z]);continue}else return se(new At(e,p,Z,w))}w[D]=L.right}else{const Z=O++,ae=D;E||(E=[]),E.push(({es:K,output:Ee})=>Q(ni(L),Ce=>{if(Kt(Ce)){const Je=new un(ae,p,G?Ce.left:new Tu(x));return $?(K.push([Z,Je]),me):se(new At(e,p,Je,Ee))}return Ee[ae]=Ce.right,me}))}}for(let q=0;q<o.length;q++){const x=o[q],D=x[0],G=x[1],P=XT(p,x[2]);for(const L of P){const Z=D(L,m);if(Tn(Z)&&Qr(Z)){const ae=G(p[L],m);if(Tn(ae))if(Kt(ae)){const K=new un(L,p,ae.left);if($){C.push([O++,K]);continue}else return se(new At(e,p,K,w))}else Object.prototype.hasOwnProperty.call(r,L)||(w[L]=ae.right);else{const K=O++,Ee=L;E||(E=[]),E.push(({es:Ce,output:Je})=>Q(ni(ae),Ie=>{if(Kt(Ie)){const et=new un(Ee,p,Ie.left);return $?(Ce.push([K,et]),me):se(new At(e,p,et,Je))}else return Object.prototype.hasOwnProperty.call(r,L)||(Je[L]=Ie.right),me}))}}}}const R=({es:q,output:x})=>{if(Nd(q))return se(new At(e,p,Cr(q),x));if(m?.propertyOrder==="original"){const D=g||es(p);for(const P of s)D.indexOf(P)===-1&&D.push(P);const G={};for(const P of D)Object.prototype.hasOwnProperty.call(x,P)&&(G[P]=x[P]);return ie(G)}return ie(x)};if(E&&E.length>0){const q=E;return ut(()=>{const x={es:Fu(C),output:Object.assign({},w)};return Q(dn(q,D=>D(x),{concurrency:f,batching:d,discard:!0}),()=>R(x))})}return R({es:C,output:w})}}case"Union":{const n=X7(e.types,t),r=es(n.keys),s=r.length,o=e.types.length,a=new Map;for(let d=0;d<o;d++)a.set(e.types[d],nn(e.types[d],t));const u=k_(e)??1,f=$_(e);return(d,p)=>{const m=[];let $=0,C=[];if(s>0)if(jb(d))for(let v=0;v<s;v++){const w=r[v],g=n.keys[w].buckets;if(Object.prototype.hasOwnProperty.call(d,w)){const E=String(d[w]);if(Object.prototype.hasOwnProperty.call(g,E))C=C.concat(g[E]);else{const{candidates:k,literals:R}=n.keys[w],q=Jt.make(R),x=k.length===o?new br([new Ct(w,q,!1,!0)],[]):Jt.make(k);m.push([$++,new At(x,d,new un(w,d,new Qt(q,d[w])))])}}else{const{candidates:E,literals:k}=n.keys[w],R=new Ct(w,Jt.make(k),!1,!0),q=E.length===o?new br([R],[]):Jt.make(E);m.push([$++,new At(q,d,new un(w,d,new Tu(R)))])}}else{const v=n.candidates.length===o?e:Jt.make(n.candidates);m.push([$++,new Qt(v,d)])}n.otherwise.length>0&&(C=C.concat(n.otherwise));let O;for(let v=0;v<C.length;v++){const w=C[v],g=a.get(w)(d,p);if(Tn(g)&&(!O||O.length===0)){if(Qr(g))return g;m.push([$++,g.left])}else{const E=$++;O||(O=[]),O.push(k=>ut(()=>"finalResult"in k?me:Q(ni(g),R=>(Qr(R)?k.finalResult=R:k.es.push([E,R.left]),me))))}}const N=v=>Nd(v)?v.length===1&&v[0][1]._tag==="Type"?se(v[0][1]):se(new At(e,d,Cr(v))):se(new Qt(e,d));if(O&&O.length>0){const v=O;return ut(()=>{const w={es:Fu(m)};return Q(dn(v,g=>g(w),{concurrency:u,batching:f,discard:!0}),()=>"finalResult"in w?w.finalResult:N(w.es))})}return N(m)}}case"Suspend":{const n=ZT(()=>nn(Ni(e.f(),e.annotations),t));return(r,s)=>n()(r,s)}}},Jn=(e,t)=>n=>t(n)?ie(n):se(new Qt(e,n)),Mu=(e,t)=>{switch(e._tag){case"Declaration":{const n=Lc(e);if(nt(n))return Mu(n.value,t);break}case"TypeLiteral":{const n=[];for(let r=0;r<e.propertySignatures.length;r++){const s=e.propertySignatures[r],o=t?G_(s.type):It(s.type);Vu(o)&&!s.isOptional&&n.push([s.name,o])}return n}case"TupleType":{const n=[];for(let r=0;r<e.elements.length;r++){const s=e.elements[r],o=t?G_(s.type):It(s.type);Vu(o)&&!s.isOptional&&n.push([r,o])}return n}case"Refinement":return Mu(e.from,t);case"Suspend":return Mu(e.f(),t);case"Transformation":return Mu(t?e.from:e.to,t)}return[]},X7=(e,t)=>{const n={},r=[],s=[];for(let o=0;o<e.length;o++){const a=e[o],u=Mu(a,t);if(u.length>0){s.push(a);for(let f=0;f<u.length;f++){const[d,p]=u[f],m=String(p.literal);n[d]=n[d]||{buckets:{},literals:[],candidates:[]};const $=n[d].buckets;if(Object.prototype.hasOwnProperty.call($,m)){if(f<u.length-1)continue;$[m].push(a),n[d].literals.push(p),n[d].candidates.push(a)}else{$[m]=[a],n[d].literals.push(p),n[d].candidates.push(a);break}}}else r.push(a)}return{keys:n,otherwise:r,candidates:s}},WA=e=>Va(e)?WA(e.from):e,Lu=(e,t,n,r)=>{if(r?.isEffectAllowed===!0||Tn(e))return e;const s=new pO,o=Ho(e,{scheduler:s});s.flush();const a=o.unsafePoll();if(a){if(wc(a))return ie(a.value);const u=a.cause;return YO(u)?se(u.error):se(new e$(t,n,jh(u)))}return se(new e$(t,n,"cannot be be resolved synchronously, this is caused by using runSync on an effect that performs async work"))},Z7=([e],[t])=>e>t?1:e<t?-1:0;function Cr(e){return e.sort(Z7).map(t=>t[1])}const eY=(e,t)=>{switch(e._tag){case"FinalTransformation":return t?e.decode:e.encode;case"ComposeTransformation":return ie;case"TypeLiteralTransformation":return n=>{let r=ie(n);for(const s of e.propertySignatureTransformations){const[o,a]=t?[s.from,s.to]:[s.to,s.from],u=t?s.decode:s.encode;r=Yn(r,d=>{const p=u(Object.prototype.hasOwnProperty.call(d,o)?V(d[o]):H());return delete d[o],nt(p)&&(d[a]=p.value),d})}return r}}},kn=(e,t=[])=>({value:e,forest:t}),Yu={formatIssue:e=>Yn(Pa(e),tY),formatIssueSync:e=>{const t=Yu.formatIssue(e);return Tn(t)?u3(t):rs(t)},formatError:e=>Yu.formatIssue(e.issue),formatErrorSync:e=>Yu.formatIssueSync(e.issue)},tY=e=>e.value+KA(`
`,e.forest),KA=(e,t)=>{let n="";const r=t.length;let s;for(let o=0;o<r;o++){s=t[o];const a=o===r-1;n+=e+(a?"└":"├")+"─ "+s.value,n+=KA(e+(r>1&&!a?"│  ":"   "),s.forest)}return n},nY=e=>{switch(e){case"Encoded":return"Encoded side transformation failure";case"Transformation":return"Transformation process failure";case"Type":return"Type side transformation failure"}},rY=e=>{switch(e){case"From":return"From side refinement failure";case"Predicate":return"Predicate refinement failure"}},JA=e=>"ast"in e?V(e.ast):H(),ub=ie(void 0),sY=e=>JA(e).pipe(Mc(dD),Xe({onNone:()=>ub,onSome:t=>{const n=t(e);return An(n)?ie({message:n,override:!1}):kr(n)?ye(n,r=>({message:r,override:!1})):An(n.message)?ie({message:n.message,override:n.override}):ye(n.message,r=>({message:r,override:n.override}))}})),Tv=e=>t=>t._tag===e,GA=Tv("Composite"),r$=Tv("Refinement"),s$=Tv("Transformation"),Xu=e=>_o(sY(e),t=>t!==void 0?!t.override&&(GA(e)||r$(e)&&e.kind==="From"||s$(e)&&e.kind!=="Transformation")?s$(e)||r$(e)?Xu(e.issue):ub:ie(t.message):ub),QA=e=>JA(e).pipe(Mc(gD),m3(t=>t(e)),hr);function oY(e){return wC(e).pipe(Rs(()=>bC(e)),Rs(()=>SC(e)),Rs(()=>xp(e)),pt(()=>`{ ${e.from} | filter }`))}function iY(e){return e.message!==void 0?e.message:`Expected ${Va(e.ast)?oY(e.ast):String(e.ast)}, actual ${yr(e.actual)}`}const aY=e=>Yn(Xu(e),t=>t??QA(e)??iY(e)),$d=e=>QA(e)??String(e.ast),cY=e=>e.message??"is forbidden",uY=e=>e.message??"is unexpected",lY=e=>{const t=hD(e.ast);if(nt(t)){const n=t.value();return An(n)?ie(n):n}return ie(e.message??"is missing")},Pa=e=>{switch(e._tag){case"Type":return Yn(aY(e),kn);case"Forbidden":return ie(kn($d(e),[kn(cY(e))]));case"Unexpected":return ie(kn(uY(e)));case"Missing":return Yn(lY(e),kn);case"Transformation":return _o(Xu(e),t=>t!==void 0?ie(kn(t)):Yn(Pa(e.issue),n=>kn($d(e),[kn(nY(e.kind),[n])])));case"Refinement":return _o(Xu(e),t=>t!==void 0?ie(kn(t)):Yn(Pa(e.issue),n=>kn($d(e),[kn(rY(e.kind),[n])])));case"Pointer":return Yn(Pa(e.issue),t=>kn(nC(e.path),[t]));case"Composite":return _o(Xu(e),t=>{if(t!==void 0)return ie(kn(t));const n=$d(e);return tC(e.issues)?Yn(dn(e.issues,Pa),r=>kn(n,r)):Yn(Pa(e.issues),r=>kn(n,[r]))})}},fY=T8,dY=E8,hY=zO,pY=I6,mY=BO,o$=Symbol.for("effect/Mailbox"),i$=Symbol.for("effect/Mailbox/ReadonlyMailbox"),ii=lt(),a$=Be(ii),Td=Be(!1),Cd=Be(!0),c$=[ii,!0];class gY extends no{scheduler;capacity;strategy;[o$]=o$;[i$]=i$;state={_tag:"Open",takers:new Set,offers:new Set,awaiters:new Set};messages=[];messagesChunk=lt();constructor(t,n,r){super(),this.scheduler=t,this.capacity=n,this.strategy=r}offer(t){return de(()=>{if(this.state._tag!=="Open")return Td;if(this.messages.length+this.messagesChunk.length>=this.capacity)switch(this.strategy){case"dropping":return Td;case"suspend":return this.capacity<=0&&this.state.takers.size>0?(this.messages.push(t),this.releaseTaker(),Cd):this.offerRemainingSingle(t);case"sliding":return this.unsafeTake(),this.messages.push(t),Cd}return this.messages.push(t),this.scheduleReleaseTaker(),Cd})}unsafeOffer(t){return this.state._tag!=="Open"?!1:this.messages.length+this.messagesChunk.length>=this.capacity?this.strategy==="sliding"?(this.unsafeTake(),this.messages.push(t),!0):this.capacity<=0&&this.state.takers.size>0?(this.messages.push(t),this.releaseTaker(),!0):!1:(this.messages.push(t),this.scheduleReleaseTaker(),!0)}offerAll(t){return de(()=>{if(this.state._tag!=="Open")return W(Us(t));const n=this.unsafeOfferAllArray(t);return n.length===0?a$:this.strategy==="dropping"?W(Pt(n)):this.offerRemainingArray(n)})}unsafeOfferAll(t){return Pt(this.unsafeOfferAllArray(t))}unsafeOfferAllArray(t){if(this.state._tag!=="Open")return Me(t);if(this.capacity===Number.POSITIVE_INFINITY||this.strategy==="sliding")return this.messages.length>0&&(this.messagesChunk=_t(this.messagesChunk,Pt(this.messages))),this.strategy==="sliding"?this.messagesChunk=this.messagesChunk.pipe(_t(Us(t)),OM(this.capacity)):bi(t)?this.messagesChunk=_t(this.messagesChunk,t):this.messages=Me(t),this.scheduleReleaseTaker(),[];const n=this.capacity<=0?this.state.takers.size:this.capacity-this.messages.length-this.messagesChunk.length;if(n===0)return Me(t);const r=[];let s=0;for(const o of t)s<n?this.messages.push(o):r.push(o),s++;return this.scheduleReleaseTaker(),r}fail(t){return this.done(yl(t))}failCause(t){return this.done(Ye(t))}unsafeDone(t){return this.state._tag!=="Open"?!1:this.state.offers.size===0&&this.messages.length===0&&this.messagesChunk.length===0?(this.finalize(t),!0):(this.state={...this.state,_tag:"Closing",exit:t},!0)}shutdown=B(()=>{if(this.state._tag==="Done")return!0;this.messages=[],this.messagesChunk=ii;const t=this.state.offers;if(this.finalize(this.state._tag==="Open"?bn:this.state.exit),t.size>0){for(const n of t)n._tag==="Single"?n.resume(Td):n.resume(Be(Pt(n.remaining.slice(n.offset))));t.clear()}return!0});done(t){return B(()=>this.unsafeDone(t))}end=this.done(bn);clear=de(()=>{if(this.state._tag==="Done")return Hd(this.state.exit,ii);const t=this.unsafeTakeAll();return this.releaseCapacity(),W(t)});takeAll=de(()=>{if(this.state._tag==="Done")return Hd(this.state.exit,c$);const t=this.unsafeTakeAll();return t.length===0?wt(this.awaitTake,this.takeAll):W([t,this.releaseCapacity()])});takeN(t){return de(()=>{if(this.state._tag==="Done")return Hd(this.state.exit,c$);if(t<=0)return W([ii,!1]);t=Math.min(t,this.capacity);let n;if(t<=this.messagesChunk.length)n=ac(this.messagesChunk,t),this.messagesChunk=Es(this.messagesChunk,t);else if(t<=this.messages.length+this.messagesChunk.length)this.messagesChunk=_t(this.messagesChunk,Pt(this.messages)),this.messages=[],n=ac(this.messagesChunk,t),this.messagesChunk=Es(this.messagesChunk,t);else return wt(this.awaitTake,this.takeN(t));return W([n,this.releaseCapacity()])})}unsafeTake(){if(this.state._tag==="Done")return l1(this.state.exit,yl(new Bm));let t;if(this.messagesChunk.length>0)t=Hp(this.messagesChunk),this.messagesChunk=Es(this.messagesChunk,1);else if(this.messages.length>0)t=this.messages[0],this.messagesChunk=Es(Pt(this.messages),1),this.messages=[];else return this.capacity<=0&&this.state.offers.size>0?(this.capacity=1,this.releaseCapacity(),this.capacity=0,this.messages.length>0?Be(this.messages.pop()):void 0):void 0;return this.releaseCapacity(),Be(t)}take=de(()=>this.unsafeTake()??wt(this.awaitTake,this.take));await=po(t=>this.state._tag==="Done"?t(this.state.exit):(this.state.awaiters.add(t),B(()=>{this.state._tag!=="Done"&&this.state.awaiters.delete(t)})));unsafeSize(){const t=this.messages.length+this.messagesChunk.length;return this.state._tag==="Done"?H():V(t)}size=B(()=>this.unsafeSize());commit(){return this.takeAll}pipe(){return Y(this,arguments)}toJSON(){return{_id:"effect/Mailbox",state:this.state._tag,size:this.unsafeSize().toJSON()}}toString(){return st(this)}[Le](){return st(this)}offerRemainingSingle(t){return po(n=>{if(this.state._tag!=="Open")return n(Td);const r={_tag:"Single",message:t,resume:n};return this.state.offers.add(r),B(()=>{this.state._tag==="Open"&&this.state.offers.delete(r)})})}offerRemainingArray(t){return po(n=>{if(this.state._tag!=="Open")return n(Be(Pt(t)));const r={_tag:"Array",remaining:t,offset:0,resume:n};return this.state.offers.add(r),B(()=>{this.state._tag==="Open"&&this.state.offers.delete(r)})})}releaseCapacity(){if(this.state._tag==="Done")return this.state.exit._tag==="Success";if(this.state.offers.size===0)return this.state._tag==="Closing"&&this.messages.length===0&&this.messagesChunk.length===0?(this.finalize(this.state.exit),this.state.exit._tag==="Success"):!1;let t=this.capacity-this.messages.length-this.messagesChunk.length;for(const n of this.state.offers){if(t===0)return!1;if(n._tag==="Single")this.messages.push(n.message),t--,n.resume(Cd),this.state.offers.delete(n);else{for(;n.offset<n.remaining.length;n.offset++){if(t===0)return!1;this.messages.push(n.remaining[n.offset]),t--}n.resume(a$),this.state.offers.delete(n)}}return!1}awaitTake=po(t=>this.state._tag==="Done"?t(this.state.exit):(this.state.takers.add(t),B(()=>{this.state._tag!=="Done"&&this.state.takers.delete(t)})));scheduleRunning=!1;scheduleReleaseTaker(){this.scheduleRunning||(this.scheduleRunning=!0,this.scheduler.scheduleTask(this.releaseTaker,0))}releaseTaker=()=>{if(this.scheduleRunning=!1,this.state._tag==="Done")return;if(this.state.takers.size===0)return;const t=E3(this.state.takers);this.state.takers.delete(t),t(bn)};unsafeTakeAll(){if(this.messagesChunk.length>0){const t=this.messages.length>0?_t(this.messagesChunk,Pt(this.messages)):this.messagesChunk;return this.messagesChunk=ii,this.messages=[],t}else if(this.messages.length>0){const t=Pt(this.messages);return this.messages=[],t}else if(this.state._tag!=="Done"&&this.state.offers.size>0)return this.capacity=1,this.releaseCapacity(),this.capacity=0,rt(this.messages.pop());return ii}finalize(t){if(this.state._tag==="Done")return;const n=this.state;this.state={_tag:"Done",exit:t};for(const r of n.takers)r(t);n.takers.clear();for(const r of n.awaiters)r(t);n.awaiters.clear()}}const _Y=e=>qe(t=>W(new gY(t.currentScheduler,typeof e=="number"?e:e?.capacity??Number.POSITIVE_INFINITY,typeof e=="number"?"suspend":e?.strategy??"suspend"))),yY=_Y,bY=Symbol.for("@effect/matcher/Matcher"),SY={[bY]:{_input:oe,_filters:oe,_result:oe,_return:oe},_tag:"ValueMatcher",add(e){return this.value._tag==="Right"?this:e._tag==="When"&&e.guard(this.provided)===!0?lb(this.provided,ie(e.evaluate(this.provided))):e._tag==="Not"&&e.guard(this.provided)===!1?lb(this.provided,ie(e.evaluate(this.provided))):this},pipe(){return Y(this,arguments)}};function lb(e,t){const n=Object.create(SY);return n.provided=e,n.value=t,n}const YA=(e,t)=>({_tag:"When",guard:e,evaluate:t}),fb=e=>{if(typeof e=="function")return e;if(Array.isArray(e)){const t=e.map(fb),n=t.length;return r=>{if(!Array.isArray(r))return!1;for(let s=0;s<n;s++)if(t[s](r[s])===!1)return!1;return!0}}else if(e!==null&&typeof e=="object"){const t=Object.entries(e).map(([r,s])=>[r,fb(s)]),n=t.length;return r=>{if(typeof r!="object"||r===null)return!1;for(let s=0;s<n;s++){const[o,a]=t[s];if(!(o in r)||a(r[o])===!1)return!1}return!0}}return t=>t===e},wY=e=>lb(e,se(e)),vY=(e,t)=>n=>n.add(YA(fb(e),t)),EY=e=>(...t)=>{const n=t[t.length-1],r=t.slice(0,-1),s=r.length===1?o=>o[e]===r[0]:o=>r.includes(o[e]);return o=>o.add(YA(s,n))},kY=EY("_tag"),$Y=e=>{if(e._tag==="ValueMatcher")return e.value;const t=e.cases.length;if(t===1){const n=e.cases[0];return r=>n._tag==="When"&&n.guard(r)===!0||n._tag==="Not"&&n.guard(r)===!1?ie(n.evaluate(r)):se(r)}return n=>{for(let r=0;r<t;r++){const s=e.cases[r];if(s._tag==="When"&&s.guard(n)===!0)return ie(s.evaluate(n));if(s._tag==="Not"&&s.guard(n)===!1)return ie(s.evaluate(n))}return se(n)}},u$="effect/Match/exhaustive: absurd",TY=e=>{const t=$Y(e);if(xT(t)){if(t._tag==="Right")return t.right;throw new Error(u$)}return n=>{const r=t(n);if(r._tag==="Right")return r.right;throw new Error(u$)}},XA=wY,T_=vY,C_=kY,ZA=TY,l$=a7,eF=qQ,CY=Fa,IY=y(e=>hs(e[0]),(e,...t)=>{const n={};for(const r of t)r in e&&(n[r]=e[r]);return n}),OY=y(e=>hs(e[0]),(e,...t)=>{const n={...e};for(const r of t)delete n[r];return n}),Oc=Symbol.for("effect/Schema");function Ze(e){return class{[Oc]=db;static ast=e;static annotations(n){return Ze(Mr(this.ast,n))}static pipe(){return Y(this,arguments)}static toString(){return String(e)}static Type;static Encoded;static Context;static[Oc]=db}}const db={_A:e=>e,_I:e=>e,_R:e=>e},f$={schemaId:uD,message:iC,missingMessage:Zb,identifier:eS,title:ps,description:lf,examples:aC,default:cC,documentation:lD,jsonSchema:uC,arbitrary:lC,pretty:fC,equivalence:dC,concurrency:hC,batching:pC,parseIssueTitle:mC,parseOptions:gC,decodingFallback:_C},Vo=e=>{if(!e)return{};const t={...e};for(const n in f$)if(n in e){const r=f$[n];t[r]=e[n],delete t[n]}return t},Mr=(e,t)=>Ni(e,Vo(t));const nd=e=>String(e.ast),Cv=e=>Ze(G_(e.ast)),fs=e=>Ze(It(e.ast)),tF=(e,t)=>{const n=pu(e,t);return(r,s)=>Qu(n(r,s),du)},RY=(e,t)=>{const n=V7(e,t);return(r,s)=>cf(n(r,s),du)},rd=tF,nF=RY,Rc=(e,t)=>{const n=td(e,t);return(r,s)=>Qu(n(r,s),du)},qY=(e,t)=>{const n=B7(e,t);return(r,s)=>cf(n(r,s),du)},AY=Rc,vg=qY,FY=(e,t)=>{const n=K7(e,t);return(r,s)=>cf(n(r,s),du)},Nr=e=>X(e,Oc)&&hs(e[Oc]);function PY(e){return tS(e)?Jt.make(jD(e,t=>new _h(t))):new _h(e[0])}function rF(e,t=PY(e)){return class extends Ze(t){static annotations(r){return rF(this.literals,Mr(this.ast,r))}static literals=[...e]}}function Ne(...e){return ft(e)?rF(e):Eg}const xY=e=>Ze(new vC(e)),NY=(e,t,n)=>Iv(e,new Dp(e.map(r=>r.ast),(...r)=>t.decode(...r.map(Ze)),(...r)=>t.encode(...r.map(Ze)),Vo(n))),DY=(e,t)=>{const n=()=>(s,o,a)=>e(s)?Ar(s):hu(new Qt(a,s)),r=n;return Iv([],new Dp([],n,r,Vo(t)))};function Iv(e,t){return class extends Ze(t){static annotations(r){return Iv(this.typeParameters,Mr(this.ast,r))}static typeParameters=[...e]}}const da=function(){if(Array.isArray(arguments[0])){const n=arguments[0],r=arguments[1],s=arguments[2];return NY(n,r,s)}const e=arguments[0],t=arguments[1];return DY(e,t)},d$=Symbol.for("effect/SchemaId/Brand"),sF=(e,t)=>n=>Pv(n,new hf(n.ast,function(o,a,u){const f=e.either(o);return Kt(f)?V(new Qt(u,o,f.left.map(d=>d.message).join(", "))):H()},Vo({schemaId:d$,[d$]:{constructor:e},...t})));class oF extends Ze(ic){}class Xr extends Ze(CD){}class Ov extends Ze(kD){}class Eg extends Ze(Mp){}class hb extends Ze(EC){}class on extends Ze(kC){}class j extends Ze(B_){}class dt extends Ze(V_){}class Xi extends Ze(W_){}const MY=e=>Jt.make(e.map(t=>t.ast));function iF(e,t=MY(e)){return class extends Ze(t){static annotations(r){return iF(this.members,Mr(this.ast,r))}static members=[...e]}}function ve(...e){return tS(e)?iF(e):ft(e)?e[0]:Eg}const aF=e=>ve(e,Ov),Rv=e=>ve(e,oF),LY=(e,t)=>new df(e.map(n=>Nr(n)?new No(n.ast,!1):n.ast),t.map(n=>Nr(n)?new ff(n.ast):n.ast),!0);function np(e,t,n=LY(e,t)){return class extends Ze(n){static annotations(s){return np(this.elements,this.rest,Mr(this.ast,s))}static elements=[...e];static rest=[...t]}}function jY(...e){return Array.isArray(e[0])?np(e[0],e.slice(1)):np(e,[])}function cF(e,t){return class extends np([],[e],t){static annotations(r){return cF(this.value,Mr(this.ast,r))}static value=e}}const De=e=>cF(e),pb=e=>e?'"?:"':'":"';class kg extends No{isReadonly;defaultValue;_tag="PropertySignatureDeclaration";constructor(t,n,r,s,o){super(t,n,s),this.isReadonly=r,this.defaultValue=o}toString(){const t=pb(this.isOptional),n=String(this.type);return`PropertySignature<${t}, ${n}, never, ${t}, ${n}>`}}class UY extends No{isReadonly;fromKey;constructor(t,n,r,s,o){super(t,n,s),this.isReadonly=r,this.fromKey=o}}class rp extends No{isReadonly;defaultValue;constructor(t,n,r,s,o){super(t,n,s),this.isReadonly=r,this.defaultValue=o}}const zY=e=>e===void 0?"never":An(e)?JSON.stringify(e):String(e);class sp{from;to;decode;encode;_tag="PropertySignatureTransformation";constructor(t,n,r,s){this.from=t,this.to=n,this.decode=r,this.encode=s}toString(){return`PropertySignature<${pb(this.to.isOptional)}, ${this.to.type}, ${zY(this.from.fromKey)}, ${pb(this.from.isOptional)}, ${this.from.type}>`}}const uF=(e,t)=>{switch(e._tag){case"PropertySignatureDeclaration":return new kg(e.type,e.isOptional,e.isReadonly,{...e.annotations,...t},e.defaultValue);case"PropertySignatureTransformation":return new sp(e.from,new rp(e.to.type,e.to.isOptional,e.to.isReadonly,{...e.to.annotations,...t},e.to.defaultValue),e.decode,e.encode)}},lF=Symbol.for("effect/PropertySignature"),qv=e=>X(e,lF);class $g{ast;[Oc];[lF]=null;_TypeToken;_Key;_EncodedToken;_HasDefault;constructor(t){this.ast=t}pipe(){return Y(this,arguments)}annotations(t){return new $g(uF(this.ast,Vo(t)))}toString(){return String(this.ast)}}const op=e=>new $g(e);class Tg extends $g{from;constructor(t,n){super(t),this.from=n}annotations(t){return new Tg(uF(this.ast,Vo(t)),this.from)}}const fF=e=>new Tg(new kg(e.ast,!1,!0,{},void 0),e),Av=y(2,(e,t)=>{const n=e.ast;switch(n._tag){case"PropertySignatureDeclaration":return op(new kg(n.type,n.isOptional,n.isReadonly,n.annotations,t));case"PropertySignatureTransformation":return op(new sp(n.from,new rp(n.to.type,n.to.isOptional,n.to.isReadonly,n.to.annotations,t),n.decode,n.encode))}}),h$=(e,t)=>Xe(e,{onNone:()=>V(t()),onSome:n=>V(n===void 0?t():n)}),ip=e=>ZD(e,ip,t=>{const n=ip(t.to);if(n)return new _r(t.from,n,t.transformation)}),BY=y(2,(e,t)=>{const n=e.ast;switch(n._tag){case"PropertySignatureDeclaration":{const r=It(n.type);return op(new sp(new UY(n.type,n.isOptional,n.isReadonly,n.annotations),new rp(ip(r)??r,!1,!0,{},n.defaultValue),s=>h$(s,t),oe))}case"PropertySignatureTransformation":{const r=n.to.type;return op(new sp(n.from,new rp(ip(r)??r,!1,n.to.isReadonly,n.to.annotations,n.to.defaultValue),s=>h$(n.decode(s),t),n.encode))}}}),dF=y(2,(e,t)=>e.pipe(BY(t.decoding),Av(t.constructor))),Sn=e=>{const t=e.ast===ic||e.ast===Mp?ic:Rv(e).ast;return new Tg(new kg(t,!0,!0,{},void 0),e)},HY=FC([Zb]),VY=(e,t)=>{const n=es(e),r=[];if(n.length>0){const o=[],a=[],u=[];for(let f=0;f<n.length;f++){const d=n[f],p=e[d];if(qv(p)){const m=p.ast;switch(m._tag){case"PropertySignatureDeclaration":{const $=m.type,C=m.isOptional,O=m.annotations;o.push(new Ct(d,$,C,!0,HY(m))),a.push(new Ct(d,It($),C,!0,O)),r.push(new Ct(d,$,C,!0,O));break}case"PropertySignatureTransformation":{const $=m.from.fromKey??d;o.push(new Ct($,m.from.type,m.from.isOptional,!0,m.from.annotations)),a.push(new Ct(d,m.to.type,m.to.isOptional,!0,m.to.annotations)),u.push(new HD($,d,m.decode,m.encode));break}}}else o.push(new Ct(d,p.ast,!1,!0)),a.push(new Ct(d,It(p.ast),!1,!0)),r.push(new Ct(d,p.ast,!1,!0))}if(ft(u)){const f=[],d=[];for(const p of t){const{indexSignatures:m,propertySignatures:$}=u0(p.key.ast,p.value.ast);$.forEach(C=>{o.push(C),a.push(new Ct(C.name,It(C.type),C.isOptional,C.isReadonly,C.annotations))}),m.forEach(C=>{f.push(C),d.push(new jc(C.parameter,It(C.type),C.isReadonly))})}return new _r(new br(o,f,{[Ha]:"Struct (Encoded side)"}),new br(a,d,{[Ha]:"Struct (Type side)"}),new yh(u))}}const s=[];for(const o of t){const{indexSignatures:a,propertySignatures:u}=u0(o.key.ast,o.value.ast);u.forEach(f=>r.push(f)),a.forEach(f=>s.push(f))}return new br(r,s)},hF=(e,t)=>{const n=es(e);for(const r of n){const s=e[r];if(t[r]===void 0&&qv(s)){const o=s.ast,a=o._tag==="PropertySignatureDeclaration"?o.defaultValue:o.to.defaultValue;a!==void 0&&(t[r]=a())}}return t};function Fv(e,t,n=VY(e,t)){return class extends Ze(n){static annotations(s){return Fv(this.fields,this.records,Mr(this.ast,s))}static fields={...e};static records=[...t];static make=(s,o)=>{const a=hF(e,{...s});return Rg(o)?a:wg(this)(a)};static pick(...s){return ne(IY(e,...s))}static omit(...s){return ne(OY(e,...s))}}}function ne(e,...t){return Fv(e,t)}const WY=e=>Ne(e).pipe(fF,Av(()=>e)),Fe=(e,t)=>ne({_tag:WY(e),...t});function pF(e,t,n){return class extends Fv({},[{key:e,value:t}],n){static annotations(s){return pF(e,t,Mr(this.ast,s))}static key=e;static value=t}}const mu=e=>pF(e.key,e.value),Ll=(...e)=>t=>Ze(ws(t.ast,e)),qc=y(2,(e,t)=>{const n=ui(It(e.ast),t),r=Ze(n.isOptional?jd(n.type):n.type);return cr(e.pipe(Ll(t)),r,{strict:!0,decode:o=>o[t],encode:o=>n.isOptional&&o===void 0?{}:{[t]:o}})});function Pv(e,t){return class extends Ze(t){static annotations(r){return Pv(this.from,Mr(this.ast,r))}static make=(r,s)=>Rg(s)?r:wg(this)(r);static from=e}}const KY=(e,t)=>n=>{const r=Xe(yC(n.ast),{onNone:()=>[e],onSome:o=>[...o,e]}),s=Ni(n.ast,Vo({[oC]:r,...t}));return Pv(n,s)},ap=e=>Ze(Pu(e.ast)),JY=e=>Ze(Oa(e.ast)),Cu=(e,t,n)=>{if(c0(e)&&c0(t)){const r=[...e.propertySignatures];for(const s of t.propertySignatures){const o=s.name,a=r.findIndex(u=>u.name===o);if(a===-1)r.push(s);else{const{isOptional:u,type:f}=r[a];r[a]=new Ct(o,cp(f,s.type,n.concat(o)),u,!0)}}return new br(r,e.indexSignatures.concat(t.indexSignatures))}throw new Error(rC(e,t,n))},GY=GD([eS]),Iu=(e,t)=>t.map(n=>new hf(n,e.filter,GY(e))),cp=(e,t,n)=>Jt.make(vs([e],[t],n)),Yo=e=>nS(e)?e.types:[e],vs=(e,t,n)=>ph(e,r=>ph(t,s=>{switch(s._tag){case"Literal":{if(An(s.literal)&&H_(r)||Ls(s.literal)&&o0(r)||Ri(s.literal)&&i0(r))return[s];break}case"StringKeyword":{if(s===B_){if(H_(r)||Vu(r)&&An(r.literal))return[r];if(Va(r))return Iu(r,vs(Yo(r.from),[s],n))}else if(r===B_)return[s];break}case"NumberKeyword":{if(s===V_){if(o0(r)||Vu(r)&&Ls(r.literal))return[r];if(Va(r))return Iu(r,vs(Yo(r.from),[s],n))}else if(r===V_)return[s];break}case"BooleanKeyword":{if(s===W_){if(i0(r)||Vu(r)&&Ri(r.literal))return[r];if(Va(r))return Iu(r,vs(Yo(r.from),[s],n))}else if(r===W_)return[s];break}case"Union":return vs(Yo(r),s.types,n);case"Suspend":return[new xi(()=>cp(r,s.f(),n))];case"Refinement":return Iu(s,vs(Yo(r),Yo(s.from),n));case"TypeLiteral":{switch(r._tag){case"Union":return vs(r.types,[s],n);case"Suspend":return[new xi(()=>cp(r.f(),s,n))];case"Refinement":return Iu(r,vs(Yo(r.from),[s],n));case"TypeLiteral":return[Cu(r,s,n)];case"Transformation":{const o=r.transformation,a=Cu(r.from,s,n),u=Cu(r.to,It(s),n);switch(o._tag){case"TypeLiteralTransformation":return[new _r(a,u,new yh(o.propertySignatureTransformations))];case"ComposeTransformation":return[new _r(a,u,rS)];case"FinalTransformation":return[new _r(a,u,new IC((f,d,p,m)=>Yn(o.decode(f,d,p,m),$=>({...f,...$})),(f,d,p,m)=>Yn(o.encode(f,d,p,m),$=>({...f,...$}))))]}}}break}case"Transformation":{if(UD(r)){if(J_(s.transformation)&&J_(r.transformation))return[new _r(Cu(r.from,s.from,n),Cu(r.to,s.to,n),new yh(s.transformation.propertySignatureTransformations.concat(r.transformation.propertySignatureTransformations)))]}else return vs([s],[r],n);break}}throw new Error(rC(r,s,n))})),mF=y(2,(e,t)=>Ze(cp(e.ast,t.ast,[]))),QY=y(e=>Nr(e[1]),(e,t)=>xv(e,t,YD(e.ast,t.ast))),jl=e=>Ze(new xi(()=>e().ast)),gF=Symbol.for("effect/SchemaId/Refine");function _F(e,t,n){return class extends Ze(n){static annotations(s){return _F(this.from,this.filter,Mr(this.ast,s))}static[gF]=e;static from=e;static filter=t;static make=(s,o)=>Rg(o)?s:wg(this)(s)}}const p$=(e,t,n)=>{if(Ri(e))return e?H():V(new Qt(t,n));if(An(e))return V(new Qt(t,n,e));if(e!==void 0){if("_tag"in e)return V(e);const r=new Qt(t,n,e.message);return V(ft(e.path)?new un(e.path,n,r):r)}return H()},YY=(e,t,n)=>{if(Z3(e))return p$(e,t,n);if(ft(e)){const r=GT(e,s=>p$(s,t,n));if(ft(r))return V(r.length===1?r[0]:new At(t,n,r))}return H()};function Cg(e,t){return n=>{function r(o,a,u){return YY(e(o,a,u),u,o)}const s=new hf(n.ast,r,Vo(t));return _F(n,r,s)}}function xv(e,t,n){return class extends Ze(n){static annotations(s){return xv(this.from,this.to,Mr(this.ast,s))}static from=e;static to=t}}const Ao=y(e=>Nr(e[0])&&Nr(e[1]),(e,t,n)=>xv(e,t,new _r(e.ast,t.ast,new IC(n.decode,n.encode)))),cr=y(e=>Nr(e[0])&&Nr(e[1]),(e,t,n)=>Ao(e,t,{strict:!0,decode:(r,s,o,a)=>Ar(n.decode(r,a)),encode:(r,s,o,a)=>Ar(n.encode(r,a))})),XY=y(2,(e,t)=>e.annotations(t)),m$=e=>e instanceof Error?e.message:String(e),ZY=e=>Ao(j.annotations({description:"a string to be decoded into JSON"}),hb,{strict:!0,decode:(t,n,r)=>n$({try:()=>JSON.parse(t,e?.reviver),catch:s=>new Qt(r,t,m$(s))}),encode:(t,n,r)=>n$({try:()=>JSON.stringify(t,e?.replacer,e?.space),catch:s=>new Qt(r,t,m$(s))})}).annotations({title:"parseJson",schemaId:ED}),Zi=(e,t)=>Nr(e)?QY(Zi(t),e):ZY(e),eX=iD,tX=(e,t)=>n=>n.pipe(Cg(r=>r>=e,{schemaId:eX,title:`greaterThanOrEqualTo(${e})`,description:"a non-negative number",jsonSchema:{minimum:e},...t})),nX=aD,rX=e=>t=>t.pipe(Cg(n=>Number.isSafeInteger(n),{schemaId:nX,title:"int",description:"an integer",jsonSchema:{type:"integer"},...e})),sX=cD,oX=(e,t,n)=>r=>r.pipe(Cg(s=>s>=e&&s<=t,{schemaId:sX,title:`between(${e}, ${t})`,description:`a number between ${e} and ${t}`,jsonSchema:{minimum:e,maximum:t},...n})),iX=e=>tX(0,{title:"nonNegative",...e});class up extends dt.pipe(rX({identifier:"Int"})){}class aX extends dt.pipe(iX({identifier:"NonNegative"})){}const Nv=(e,t,n,r)=>z7(e,{onFailure:s=>new At(n,r,s),onSuccess:t});class cX extends da(aS,{identifier:"DurationFromSelf",pretty:()=>String,arbitrary:()=>t=>t.oneof(t.constant(JC),t.bigInt({min:0n}).map(n=>Ud(n)),t.maxSafeNat().map(n=>Mi(n))),equivalence:()=>YC}){}class uX extends cr(aX.annotations({description:"a non-negative number to be decoded into a Duration"}),cX,{strict:!0,decode:t=>Mi(t),encode:t=>cc(t)}).annotations({identifier:"DurationFromMillis"}){}class Ig extends da(T2,{identifier:"Uint8ArrayFromSelf",pretty:()=>t=>`new Uint8Array(${JSON.stringify(Array.from(t))})`,arbitrary:()=>t=>t.uint8Array(),equivalence:()=>uf(le)}){}class lX extends dt.pipe(oX(0,255,{identifier:"Uint8",description:"a 8-bit unsigned integer"})){}class yF extends cr(De(lX).annotations({description:"an array of 8-bit unsigned integers to be decoded into a Uint8Array"}),Ig,{strict:!0,decode:t=>Uint8Array.from(t),encode:t=>Array.from(t)}).annotations({identifier:"Uint8Array"}){}const fX=(e,t,n)=>Ao(j.annotations({description:"a string to be decoded into a Uint8Array"}),Ig,{strict:!0,decode:(r,s,o)=>cf(t(r),a=>new Qt(o,r,a.message)),encode:r=>Ar(n(r))}).annotations({identifier:e}),dX=fX("Uint8ArrayFromBase64",d7,f7),bF=e=>Ze(Ld(e.ast));function hX(e){return cr(e,wF(bF(fs(e))),{strict:!1,decode:t=>Ba(t),encode:t=>Xe(t,{onNone:()=>[],onSome:Qn})})}const ju=y(e=>Nr(e[0]),(e,t)=>Ao(e,bF(fs(e)),{strict:!0,decode:(n,r,s)=>n.length>0?Ar(n[0]):t?Ar(t()):hu(new Qt(s,n,"Unable to retrieve the first element of an empty array")),encode:n=>Ar(Qn(n))})),g$=Symbol.for("effect/SchemaId/ValidDate"),pX=e=>t=>t.pipe(Cg(n=>!Number.isNaN(n.getTime()),{schemaId:g$,[g$]:{noInvalidDate:!0},title:"validDate",description:"a valid Date",...e})),_$=oD;class Dv extends da(mT,{identifier:"DateFromSelf",schemaId:_$,[_$]:{noInvalidDate:!1},description:"a potentially invalid Date instance",pretty:()=>t=>`new Date(${JSON.stringify(t)})`,arbitrary:()=>t=>t.date({noInvalidDate:!1}),equivalence:()=>b2}){}class mX extends cr(j.annotations({description:"a string to be decoded into a Date"}),Dv,{strict:!0,decode:t=>new Date(t),encode:t=>eC(t)}).annotations({identifier:"DateFromString"}){}class mb extends mX.pipe(pX({identifier:"Date"})){}class gX extends cr(dt.annotations({description:"a number to be decoded into a Date"}),Dv,{strict:!0,decode:t=>new Date(t),encode:t=>t.getTime()}).annotations({identifier:"DateFromNumber"}){}const _X=ne({_tag:Ne("None")}).annotations({description:"NoneEncoded"}),yX=e=>ne({_tag:Ne("Some"),value:e}).annotations({description:`SomeEncoded<${nd(e)}>`}),bX=e=>ve(_X,yX(e)).annotations({description:`OptionEncoded<${nd(e)}>`}),SF=e=>e._tag==="None"?H():V(e.value),SX=(e,t)=>n=>n.oneof(t,n.record({_tag:n.constant("None")}),n.record({_tag:n.constant("Some"),value:e(n)})).map(SF),wX=e=>Xe({onNone:()=>"none()",onSome:t=>`some(${e(t)})`}),y$=e=>(t,n,r)=>d3(t)?kt(t)?Ar(H()):Nv(e(t.value,n),V,r,t):hu(new Qt(r,t)),wF=e=>da([e],{decode:t=>y$(td(t)),encode:t=>y$(pu(t))},{description:`Option<${nd(e)}>`,pretty:wX,arbitrary:SX,equivalence:_3}),vX={_tag:"None"},EX=e=>({_tag:"Some",value:e});function Og(e){const t=e;return cr(bX(t),wF(fs(t)),{strict:!0,decode:r=>SF(r),encode:r=>Xe(r,{onNone:()=>vX,onSome:EX})})}const kX=(e,t)=>n=>{const r=n.array(e(n));return(t.depthIdentifier!==void 0?n.oneof(t,n.constant([]),r):r).map(s=>new Set(s))},$X=e=>t=>`new Set([${Array.from(t.values()).map(n=>e(n)).join(", ")}])`,TX=e=>{const t=uf(e);return nf((n,r)=>t(Array.from(n.values()),Array.from(r.values())))},b$=e=>(t,n,r)=>v2(t)?Nv(e(Array.from(t.values()),n),s=>new Set(s),r,t):hu(new Qt(r,t)),CX=(e,t)=>da([e],{decode:n=>b$(td(De(n))),encode:n=>b$(pu(De(n)))},{description:t,pretty:$X,arbitrary:kX,equivalence:TX}),IX=e=>CX(e,`ReadonlySet<${nd(e)}>`);function OX(e){return cr(De(e),IX(fs(e)),{strict:!0,decode:t=>new Set(t),encode:t=>Array.from(t)})}const RX=e=>Nr(e)||qv(e),vF=e=>es(e).every(t=>RX(e[t])),Mv=e=>"fields"in e?e.fields:Mv(e[gF]),Lv=e=>vF(e)?ne(e):Nr(e)?e:ne(Mv(e)),jv=e=>vF(e)?e:Mv(e),ha=e=>(t,n)=>nc({kind:"Class",identifier:e,schema:Lv(t),fields:jv(t),Base:gW,annotations:n}),EF=e=>Av(fF(Ne(e)),()=>e),Lr=e=>(t,n,r)=>{class s extends Fw{}s.prototype.name=t;const o=jv(n),a=Lv(n),u={_tag:EF(t)},f=Zu(u,o),d="message"in f;class p extends nc({kind:"TaggedError",identifier:t,schema:mF(a,ne(u)),fields:f,Base:s,annotations:r,disableToString:!0}){static _tag=t}return d||Object.defineProperty(p.prototype,"message",{get(){return`{ ${es(o).map(m=>`${Xb(m)}: ${yr(this[m])}`).join(", ")} }`},enumerable:!1,configurable:!0}),p},Zu=(e,t)=>{const n={...e};for(const r of es(t)){if(r in e)throw new Error(sC(r));n[r]=t[r]}return n};function Rg(e){return Ri(e)?e:e?.disableValidation??!1}const S$=Se("effect/Schema/astCache",()=>new WeakMap),qX=e=>e===void 0?[]:Array.isArray(e)?e:[e],nc=({Base:e,annotations:t,disableToString:n,fields:r,identifier:s,kind:o,schema:a})=>{const u=Symbol.for(`effect/Schema/${o}/${s}`),[f,d,p]=qX(t),m=fs(a),$=m.annotations({identifier:s,...f}),C=m.annotations({[Ha]:`${s} (Type side)`,...f}),O=a.annotations({[Ha]:`${s} (Constructor)`,...f}),N=a.annotations({[Ha]:`${s} (Encoded side)`,...p}),v=a.annotations({[Np]:s,...p,...f,...d}),w=E=>X(E,u)&&yn(C)(E),g=class extends e{constructor(E={},k=!1){E={...E},o!=="Class"&&delete E._tag,E=hF(r,E),Rg(k)||(E=wg(O)(E)),super(E,!0)}static[Oc]=db;static get ast(){let E=S$.get(this);if(E)return E;const k=da([a],{decode:()=>(R,q,x)=>R instanceof this||w(R)?Ar(R):hu(new Qt(x,R)),encode:()=>(R,q)=>R instanceof this?Ar(R):Yn(pu(C)(R,q),x=>new this(x,!0))},{identifier:s,pretty:R=>q=>`${s}(${R(q)})`,arbitrary:R=>q=>R(q).map(x=>new this(x)),equivalence:oe,[gh]:$.ast,...f});return E=cr(N,k,{strict:!0,decode:R=>new this(R,!0),encode:oe}).annotations({[gh]:v.ast,...d}).ast,S$.set(this,E),E}static pipe(){return Y(this,arguments)}static annotations(E){return Ze(this.ast).annotations(E)}static toString(){return`(${String(N)} <-> ${s})`}static make(...E){return new this(...E)}static fields={...r};static identifier=s;static extend(E){return(k,R)=>{const q=jv(k),x=Lv(k),D=Zu(r,q);return nc({kind:o,identifier:E,schema:mF(a,x),fields:D,Base:this,annotations:R})}}static transformOrFail(E){return(k,R,q)=>{const x=Zu(r,k);return nc({kind:o,identifier:E,schema:Ao(a,fs(ne(x)),R),fields:x,Base:this,annotations:q})}}static transformOrFailFrom(E){return(k,R,q)=>{const x=Zu(r,k);return nc({kind:o,identifier:E,schema:Ao(Cv(a),ne(x),R),fields:x,Base:this,annotations:q})}}get[u](){return u}};return n!==!0&&Object.defineProperty(g.prototype,"toString",{value(){return`${s}({ ${es(r).map(E=>`${Xb(E)}: ${yr(this[E])}`).join(", ")} })`},configurable:!0,writable:!0}),g},AX=ne({_tag:Ne("None")}).annotations({identifier:"FiberIdNoneEncoded"}),FX=ne({_tag:Ne("Runtime"),id:up,startTimeMillis:up}).annotations({identifier:"FiberIdRuntimeEncoded"}),PX=ne({_tag:Ne("Composite"),left:jl(()=>gb),right:jl(()=>gb)}).annotations({identifier:"FiberIdCompositeEncoded"}),gb=ve(AX,FX,PX).annotations({identifier:"FiberIdEncoded"}),xX=e=>e.letrec(t=>({None:e.record({_tag:e.constant("None")}),Runtime:e.record({_tag:e.constant("Runtime"),id:e.integer(),startTimeMillis:e.integer()}),Composite:e.record({_tag:e.constant("Composite"),left:t("FiberId"),right:t("FiberId")}),FiberId:e.oneof(t("None"),t("Runtime"),t("Composite"))})).FiberId.map(lp),_b=e=>{switch(e._tag){case"None":return"FiberId.none";case"Runtime":return`FiberId.runtime(${e.id}, ${e.startTimeMillis})`;case"Composite":return`FiberId.composite(${_b(e.right)}, ${_b(e.left)})`}},lp=e=>{switch(e._tag){case"None":return On;case"Runtime":return xL(e.id,e.startTimeMillis);case"Composite":return NL(lp(e.left),lp(e.right))}},NX=e=>ne({_tag:Ne("Die"),defect:e}),DX=ne({_tag:Ne("Empty")}),MX=e=>ne({_tag:Ne("Fail"),error:e}),LX=ne({_tag:Ne("Interrupt"),fiberId:gb});let jX=0;const yb=(e,t)=>{const n=e,r=t,s=jl(()=>o),o=ve(DX,MX(n),NX(r),LX,ne({_tag:Ne("Sequential"),left:s,right:s}),ne({_tag:Ne("Parallel"),left:s,right:s})).annotations({title:`CauseEncoded<${nd(e)}>`,[Np]:`CauseEncoded${jX++}`});return o},UX=(e,t)=>n=>n.letrec(r=>({Empty:n.record({_tag:n.constant("Empty")}),Fail:n.record({_tag:n.constant("Fail"),error:e(n)}),Die:n.record({_tag:n.constant("Die"),defect:t(n)}),Interrupt:n.record({_tag:n.constant("Interrupt"),fiberId:xX(n)}),Sequential:n.record({_tag:n.constant("Sequential"),left:r("Cause"),right:r("Cause")}),Parallel:n.record({_tag:n.constant("Parallel"),left:r("Cause"),right:r("Cause")}),Cause:n.oneof(r("Empty"),r("Fail"),r("Die"),r("Interrupt"),r("Sequential"),r("Parallel"))})).Cause.map(gi),zX=e=>t=>{const n=r=>{switch(r._tag){case"Empty":return"Cause.empty";case"Fail":return`Cause.fail(${e(r.error)})`;case"Die":return`Cause.die(${jh(r)})`;case"Interrupt":return`Cause.interrupt(${_b(r.fiberId)})`;case"Sequential":return`Cause.sequential(${n(r.left)}, ${n(r.right)})`;case"Parallel":return`Cause.parallel(${n(r.left)}, ${n(r.right)})`}};return n(t)},w$=e=>(t,n,r)=>xV(t)?Nv(e(La(t),n),gi,r,t):hu(new Qt(r,t)),BX=({defect:e,error:t})=>da([t,e],{decode:(n,r)=>w$(td(yb(n,r))),encode:(n,r)=>w$(pu(yb(n,r)))},{title:`Cause<${t.ast}>`,pretty:zX,arbitrary:UX});function gi(e){switch(e._tag){case"Empty":return AV;case"Fail":return ru(e.error);case"Die":return Ji(e.defect);case"Interrupt":return jm(lp(e.fiberId));case"Sequential":return PV(gi(e.left),gi(e.right));case"Parallel":return FV(gi(e.left),gi(e.right))}}function La(e){switch(e._tag){case"Empty":return{_tag:"Empty"};case"Fail":return{_tag:"Fail",error:e.error};case"Die":return{_tag:"Die",defect:e.defect};case"Interrupt":return{_tag:"Interrupt",fiberId:e.fiberId};case"Sequential":return{_tag:"Sequential",left:La(e.left),right:La(e.right)};case"Parallel":return{_tag:"Parallel",left:La(e.left),right:La(e.right)}}}const HX=({defect:e,error:t})=>{const n=t,r=e;return cr(yb(n,r),BX({error:fs(n),defect:fs(r)}),{strict:!1,decode:o=>gi(o),encode:o=>La(o)})};class Ac extends cr(hb,hb,{strict:!0,decode:t=>{if(hs(t)&&"message"in t&&typeof t.message=="string"){const n=new Error(t.message,{cause:t});return"name"in t&&typeof t.name=="string"&&(n.name=t.name),n.stack="stack"in t&&typeof t.stack=="string"?t.stack:"",n}return String(t)},encode:t=>t instanceof Error?{name:t.name,message:t.message}:jI(t)}).annotations({identifier:"Defect"}){}const VX=Symbol.for("effect/Schema/Serializable/symbol"),Uv=Symbol.for("effect/Schema/Serializable/symbolResult"),WX=y(2,(e,t)=>rd(e[Uv].failure)(t)),KX=y(2,(e,t)=>rd(e[Uv].success)(t)),$n=e=>(t,n,r)=>{const s=Zu({_tag:EF(t)},n.payload);return class extends nc({kind:"TaggedRequest",identifier:t,schema:ne(s),fields:s,Base:HK,annotations:r}){static _tag=t;static success=n.success;static failure=n.failure;get[VX](){return this.constructor}get[Uv](){return{failure:n.failure,success:n.success}}}},JX=_9,GX=y9,QX=v9,YX=E9,Fo=k9,kF=$9,XX=T9,Ul=gg,ZX=I9,$F=RA,Gs=Dl,eZ=F9,tZ=qA,Wo=Ml,nZ=P9,rZ=M7,sZ=N9,oZ=L9,iZ=j9,aZ=z9,cZ=B9,hn=H9,uZ=FA,TF=kv,fp=K9,xn=J9,lZ=Q9,fZ=X9,dZ=PA,CF=yg,hZ=t7,pZ=n7,zv=s7,v$=Symbol.for("effect/Subscribable"),mZ=_R,gZ="effect/SubscriptionRef",_Z=Symbol.for(gZ),yZ={_A:e=>e};class bZ extends no{ref;pubsub;semaphore;[Co]=Co;[v$]=v$;[bH]=ew;[mZ]=yR;[_Z]=yZ;constructor(t,n,r){super(),this.ref=t,this.pubsub=n,this.semaphore=r,this.get=vi(this.ref)}commit(){return this.get}get;get changes(){return b(vi(this.ref),Q(t=>ye(RA(this.pubsub,{scoped:!0}),n=>CA(qA(t),n))),this.semaphore.withPermits(1),yg)}modify(t){return this.modifyEffect(n=>We(t(n)))}modifyEffect(t){return b(vi(this.ref),Q(t),Q(([n,r])=>b(Ec(this.ref,r),Ms(n),Vw(nv(this.pubsub,r)))),this.semaphore.withPermits(1))}}const SZ=e=>b(Uf([aq(),Uo(e),Xm(1)]),ye(([t,n,r])=>new bZ(n,t,r))),wZ=y(2,(e,t)=>b(Ec(e.ref,t),Vw(nv(e.pubsub,t)),e.semaphore.withPermits(1))),dp=SZ,Zr=wZ,Bv=DQ,vZ=vA,Hv=MQ,EZ=LQ,IF=e=>t=>nZ(t,n=>b(e(n),ye(()=>n))),E$=()=>vZ([]),Uu=(e,t)=>EZ(e,n=>Pp(n,t)),kZ=e=>Hv(e,[]),OF=(e,t,n)=>eF(function*(){const r=yield*Bv(e);if(r.length<t)return yield*CY;{const s=r.splice(0,Math.min(n,r.length));return yield*Hv(e,r),s}}),$Z=(e,t)=>eF(function*(){const n=yield*Bv(e),[r,s]=JT(n,t);return yield*Hv(e,s),r}),k$=e=>Bv(e).pipe(ye(t=>t.length)),zl=y(2,(e,t)=>b(e.changes,Fo(t),fp(1),cZ,ye(Hp))),$$=Symbol.for("effect/Subscribable");class TZ extends no{get;changes;[$$]=$$;[Co]=Co;constructor(t,n){super(),this.get=t,this.changes=n}commit(){return this.get}}const qg=e=>new TZ(e.get,e.changes);y(2,(e,t)=>qg({get:ye(e.get,t),changes:Wo(e.changes,t)}));y(2,(e,t)=>qg({get:Q(e.get,t),changes:rZ(e.changes,t)}));qg({get:Dw,changes:oZ});const CZ=e=>`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}.${e.getMilliseconds().toString().padStart(3,"0")}`,IZ=e=>fY(hY,pY({formatDate:t=>`${CZ(t)} ${e}`})),OZ={};var RZ={};const RF=()=>typeof process<"u"&&RZ!==void 0||OZ!==void 0?!1:!!(typeof globalThis<"u"&&globalThis.__DEV__),qZ=e=>{const t=e?.toString();if(t!=="[object Object]")return t;try{return JSON.stringify(e,null,2)}catch(n){return console.log(e),"Error while printing error: "+n}},bb=e=>e!==void 0&&e.toLowerCase()!=="false"&&e.toLowerCase()!=="0",we=(e,...t)=>{if(console.error(e,...t),RF())debugger;throw new Error(`This should never happen: ${e}`)};var AZ=typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof window=="object"?window:typeof global=="object"?global:{},_i="1.9.0",T$=/^(\d+)\.(\d+)\.(\d+)(-(.+))?$/;function FZ(e){var t=new Set([e]),n=new Set,r=e.match(T$);if(!r)return function(){return!1};var s={major:+r[1],minor:+r[2],patch:+r[3],prerelease:r[4]};if(s.prerelease!=null)return function(f){return f===e};function o(u){return n.add(u),!1}function a(u){return t.add(u),!0}return function(f){if(t.has(f))return!0;if(n.has(f))return!1;var d=f.match(T$);if(!d)return o(f);var p={major:+d[1],minor:+d[2],patch:+d[3],prerelease:d[4]};return p.prerelease!=null||s.major!==p.major?o(f):s.major===0?s.minor===p.minor&&s.patch<=p.patch?a(f):o(f):s.minor<=p.minor?a(f):o(f)}}var PZ=FZ(_i),xZ=_i.split(".")[0],Bl=Symbol.for("opentelemetry.js.api."+xZ),Hl=AZ;function Vv(e,t,n,r){var s;r===void 0&&(r=!1);var o=Hl[Bl]=(s=Hl[Bl])!==null&&s!==void 0?s:{version:_i};if(!r&&o[e]){var a=new Error("@opentelemetry/api: Attempted duplicate registration of API: "+e);return n.error(a.stack||a.message),!1}if(o.version!==_i){var a=new Error("@opentelemetry/api: Registration of version v"+o.version+" for "+e+" does not match previously registered API v"+_i);return n.error(a.stack||a.message),!1}return o[e]=t,n.debug("@opentelemetry/api: Registered a global for "+e+" v"+_i+"."),!0}function Vl(e){var t,n,r=(t=Hl[Bl])===null||t===void 0?void 0:t.version;if(!(!r||!PZ(r)))return(n=Hl[Bl])===null||n===void 0?void 0:n[e]}function Wv(e,t){t.debug("@opentelemetry/api: Unregistering a global for "+e+" v"+_i+".");var n=Hl[Bl];n&&delete n[e]}var NZ=function(e,t){var n=typeof Symbol=="function"&&e[Symbol.iterator];if(!n)return e;var r=n.call(e),s,o=[],a;try{for(;(t===void 0||t-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(u){a={error:u}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(a)throw a.error}}return o},DZ=function(e,t,n){if(n||arguments.length===2)for(var r=0,s=t.length,o;r<s;r++)(o||!(r in t))&&(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))},MZ=function(){function e(t){this._namespace=t.namespace||"DiagComponentLogger"}return e.prototype.debug=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return Ou("debug",this._namespace,t)},e.prototype.error=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return Ou("error",this._namespace,t)},e.prototype.info=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return Ou("info",this._namespace,t)},e.prototype.warn=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return Ou("warn",this._namespace,t)},e.prototype.verbose=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return Ou("verbose",this._namespace,t)},e}();function Ou(e,t,n){var r=Vl("diag");if(r)return n.unshift(t),r[e].apply(r,DZ([],NZ(n),!1))}var Gn;(function(e){e[e.NONE=0]="NONE",e[e.ERROR=30]="ERROR",e[e.WARN=50]="WARN",e[e.INFO=60]="INFO",e[e.DEBUG=70]="DEBUG",e[e.VERBOSE=80]="VERBOSE",e[e.ALL=9999]="ALL"})(Gn||(Gn={}));function LZ(e,t){e<Gn.NONE?e=Gn.NONE:e>Gn.ALL&&(e=Gn.ALL),t=t||{};function n(r,s){var o=t[r];return typeof o=="function"&&e>=s?o.bind(t):function(){}}return{error:n("error",Gn.ERROR),warn:n("warn",Gn.WARN),info:n("info",Gn.INFO),debug:n("debug",Gn.DEBUG),verbose:n("verbose",Gn.VERBOSE)}}var jZ=function(e,t){var n=typeof Symbol=="function"&&e[Symbol.iterator];if(!n)return e;var r=n.call(e),s,o=[],a;try{for(;(t===void 0||t-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(u){a={error:u}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(a)throw a.error}}return o},UZ=function(e,t,n){if(n||arguments.length===2)for(var r=0,s=t.length,o;r<s;r++)(o||!(r in t))&&(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))},zZ="diag",hp=function(){function e(){function t(s){return function(){for(var o=[],a=0;a<arguments.length;a++)o[a]=arguments[a];var u=Vl("diag");if(u)return u[s].apply(u,UZ([],jZ(o),!1))}}var n=this,r=function(s,o){var a,u,f;if(o===void 0&&(o={logLevel:Gn.INFO}),s===n){var d=new Error("Cannot use diag as the logger for itself. Please use a DiagLogger implementation like ConsoleDiagLogger or a custom implementation");return n.error((a=d.stack)!==null&&a!==void 0?a:d.message),!1}typeof o=="number"&&(o={logLevel:o});var p=Vl("diag"),m=LZ((u=o.logLevel)!==null&&u!==void 0?u:Gn.INFO,s);if(p&&!o.suppressOverrideMessage){var $=(f=new Error().stack)!==null&&f!==void 0?f:"<failed to generate stacktrace>";p.warn("Current logger will be overwritten from "+$),m.warn("Current logger will overwrite one already registered from "+$)}return Vv("diag",m,n,!0)};n.setLogger=r,n.disable=function(){Wv(zZ,n)},n.createComponentLogger=function(s){return new MZ(s)},n.verbose=t("verbose"),n.debug=t("debug"),n.info=t("info"),n.warn=t("warn"),n.error=t("error")}return e.instance=function(){return this._instance||(this._instance=new e),this._instance},e}();function BZ(e){return Symbol.for(e)}var HZ=function(){function e(t){var n=this;n._currentContext=t?new Map(t):new Map,n.getValue=function(r){return n._currentContext.get(r)},n.setValue=function(r,s){var o=new e(n._currentContext);return o._currentContext.set(r,s),o},n.deleteValue=function(r){var s=new e(n._currentContext);return s._currentContext.delete(r),s}}return e}(),VZ=new HZ,WZ=function(e,t){var n=typeof Symbol=="function"&&e[Symbol.iterator];if(!n)return e;var r=n.call(e),s,o=[],a;try{for(;(t===void 0||t-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(u){a={error:u}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(a)throw a.error}}return o},KZ=function(e,t,n){if(n||arguments.length===2)for(var r=0,s=t.length,o;r<s;r++)(o||!(r in t))&&(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))},JZ=function(){function e(){}return e.prototype.active=function(){return VZ},e.prototype.with=function(t,n,r){for(var s=[],o=3;o<arguments.length;o++)s[o-3]=arguments[o];return n.call.apply(n,KZ([r],WZ(s),!1))},e.prototype.bind=function(t,n){return n},e.prototype.enable=function(){return this},e.prototype.disable=function(){return this},e}(),GZ=function(e,t){var n=typeof Symbol=="function"&&e[Symbol.iterator];if(!n)return e;var r=n.call(e),s,o=[],a;try{for(;(t===void 0||t-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(u){a={error:u}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(a)throw a.error}}return o},QZ=function(e,t,n){if(n||arguments.length===2)for(var r=0,s=t.length,o;r<s;r++)(o||!(r in t))&&(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))},I_="context",YZ=new JZ,Kv=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalContextManager=function(t){return Vv(I_,t,hp.instance())},e.prototype.active=function(){return this._getContextManager().active()},e.prototype.with=function(t,n,r){for(var s,o=[],a=3;a<arguments.length;a++)o[a-3]=arguments[a];return(s=this._getContextManager()).with.apply(s,QZ([t,n,r],GZ(o),!1))},e.prototype.bind=function(t,n){return this._getContextManager().bind(t,n)},e.prototype._getContextManager=function(){return Vl(I_)||YZ},e.prototype.disable=function(){this._getContextManager().disable(),Wv(I_,hp.instance())},e}(),Fc;(function(e){e[e.NONE=0]="NONE",e[e.SAMPLED=1]="SAMPLED"})(Fc||(Fc={}));var qF="0000000000000000",AF="00000000000000000000000000000000",XZ={traceId:AF,spanId:qF,traceFlags:Fc.NONE},el=function(){function e(t){t===void 0&&(t=XZ),this._spanContext=t}return e.prototype.spanContext=function(){return this._spanContext},e.prototype.setAttribute=function(t,n){return this},e.prototype.setAttributes=function(t){return this},e.prototype.addEvent=function(t,n){return this},e.prototype.addLink=function(t){return this},e.prototype.addLinks=function(t){return this},e.prototype.setStatus=function(t){return this},e.prototype.updateName=function(t){return this},e.prototype.end=function(t){},e.prototype.isRecording=function(){return!1},e.prototype.recordException=function(t,n){},e}(),Jv=BZ("OpenTelemetry Context Key SPAN");function Gv(e){return e.getValue(Jv)||void 0}function ZZ(){return Gv(Kv.getInstance().active())}function Qv(e,t){return e.setValue(Jv,t)}function eee(e){return e.deleteValue(Jv)}function tee(e,t){return Qv(e,new el(t))}function FF(e){var t;return(t=Gv(e))===null||t===void 0?void 0:t.spanContext()}var nee=/^([0-9a-f]{32})$/i,ree=/^[0-9a-f]{16}$/i;function see(e){return nee.test(e)&&e!==AF}function oee(e){return ree.test(e)&&e!==qF}function PF(e){return see(e.traceId)&&oee(e.spanId)}function iee(e){return new el(e)}var O_=Kv.getInstance(),xF=function(){function e(){}return e.prototype.startSpan=function(t,n,r){r===void 0&&(r=O_.active());var s=!!n?.root;if(s)return new el;var o=r&&FF(r);return aee(o)&&PF(o)?new el(o):new el},e.prototype.startActiveSpan=function(t,n,r,s){var o,a,u;if(!(arguments.length<2)){arguments.length===2?u=n:arguments.length===3?(o=n,u=r):(o=n,a=r,u=s);var f=a??O_.active(),d=this.startSpan(t,o,f),p=Qv(f,d);return O_.with(p,u,void 0,d)}},e}();function aee(e){return typeof e=="object"&&typeof e.spanId=="string"&&typeof e.traceId=="string"&&typeof e.traceFlags=="number"}var cee=new xF,uee=function(){function e(t,n,r,s){this._provider=t,this.name=n,this.version=r,this.options=s}return e.prototype.startSpan=function(t,n,r){return this._getTracer().startSpan(t,n,r)},e.prototype.startActiveSpan=function(t,n,r,s){var o=this._getTracer();return Reflect.apply(o.startActiveSpan,o,arguments)},e.prototype._getTracer=function(){if(this._delegate)return this._delegate;var t=this._provider.getDelegateTracer(this.name,this.version,this.options);return t?(this._delegate=t,this._delegate):cee},e}(),lee=function(){function e(){}return e.prototype.getTracer=function(t,n,r){return new xF},e}(),fee=new lee,C$=function(){function e(){}return e.prototype.getTracer=function(t,n,r){var s;return(s=this.getDelegateTracer(t,n,r))!==null&&s!==void 0?s:new uee(this,t,n,r)},e.prototype.getDelegate=function(){var t;return(t=this._delegate)!==null&&t!==void 0?t:fee},e.prototype.setDelegate=function(t){this._delegate=t},e.prototype.getDelegateTracer=function(t,n,r){var s;return(s=this._delegate)===null||s===void 0?void 0:s.getTracer(t,n,r)},e}(),ai;(function(e){e[e.INTERNAL=0]="INTERNAL",e[e.SERVER=1]="SERVER",e[e.CLIENT=2]="CLIENT",e[e.PRODUCER=3]="PRODUCER",e[e.CONSUMER=4]="CONSUMER"})(ai||(ai={}));var ja;(function(e){e[e.UNSET=0]="UNSET",e[e.OK=1]="OK",e[e.ERROR=2]="ERROR"})(ja||(ja={}));var R_=Kv.getInstance(),q_="trace",dee=function(){function e(){this._proxyTracerProvider=new C$,this.wrapSpanContext=iee,this.isSpanContextValid=PF,this.deleteSpan=eee,this.getSpan=Gv,this.getActiveSpan=ZZ,this.getSpanContext=FF,this.setSpan=Qv,this.setSpanContext=tee}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalTracerProvider=function(t){var n=Vv(q_,this._proxyTracerProvider,hp.instance());return n&&this._proxyTracerProvider.setDelegate(t),n},e.prototype.getTracerProvider=function(){return Vl(q_)||this._proxyTracerProvider},e.prototype.getTracer=function(t,n){return this.getTracerProvider().getTracer(t,n)},e.prototype.disable=function(){Wv(q_,hp.instance()),this._proxyTracerProvider=new C$},e}(),Sb=dee.getInstance();const I$=1000000000n,A_=e=>[Number(e/I$),Number(e%I$)],F_=e=>Object.entries(e).reduce((t,[n,r])=>(t[n]=NF(r),t),{}),NF=e=>typeof e=="string"||typeof e=="number"||typeof e=="boolean"?e:typeof e=="bigint"?Number(e):qi(e),eh=Symbol.for("@effect/opentelemetry/Tracer/OtelSpan"),hee={internal:ai.INTERNAL,client:ai.CLIENT,server:ai.SERVER,producer:ai.PRODUCER,consumer:ai.CONSUMER};class DF{name;parent;context;links;kind;[eh];_tag="Span";span;spanId;traceId;attributes=new Map;sampled;status;constructor(t,n,r,s,o,a,u,f){this.name=r,this.parent=s,this.context=o,this.links=a,this.kind=f,this[eh]=eh;const d=t.active();this.span=n.startSpan(r,{startTime:A_(u),links:a.length>0?a.map(m=>({context:wb(m.span),attributes:F_(m.attributes)})):void 0,kind:hee[this.kind]},s._tag==="Some"?LF(d,s.value,o):Sb.deleteSpan(d));const p=this.span.spanContext();this.spanId=p.spanId,this.traceId=p.traceId,this.status={_tag:"Started",startTime:u},this.sampled=(p.traceFlags&Fc.SAMPLED)===Fc.SAMPLED}attribute(t,n){this.span.setAttribute(t,NF(n)),this.attributes.set(t,n)}addLinks(t){this.links.push(...t),this.span.addLinks(t.map(n=>({context:wb(n.span),attributes:F_(n.attributes)})))}end(t,n){const r=A_(t);if(this.status={_tag:"Ended",endTime:t,exit:n,startTime:this.status.startTime},n._tag==="Success")this.span.setStatus({code:ja.OK});else if(Ds(n.cause))this.span.setStatus({code:ja.OK,message:jh(n.cause)}),this.span.setAttribute("span.label","⚠︎ Interrupted"),this.span.setAttribute("status.interrupted",!0);else{const s=LV(n.cause)[0];s?(s.stack=jh(n.cause,{renderErrorCause:!0}),this.span.recordException(s,r),this.span.setStatus({code:ja.ERROR,message:s.message})):this.span.setStatus({code:ja.OK})}this.span.end(r)}event(t,n,r){this.span.addEvent(t,r?F_(r):void 0,A_(n))}}const MF=Bn("@effect/opentelemetry/Tracer/OtelTracer"),pee=ye(MF,e=>L1({span(t,n,r,s,o,a){return new DF(R_,e,t,n,r,s.slice(),o,a)},context(t,n){const r=n.currentSpan;return r===void 0?t():R_.with(LF(R_.active(),r),t)}})),O$=Bn("@effect/opentelemetry/Tracer/OtelTraceFlags"),R$=Bn("@effect/opentelemetry/Tracer/OtelTraceState"),mee=Q(Zm,e=>eh in e?We(e.span):Er(new Bm)),LF=(e,t,n)=>t instanceof DF?Sb.setSpan(e,t.span):Sb.setSpanContext(e,wb(t,n)),wb=(e,t)=>({spanId:e.spanId,traceId:e.traceId,isRemote:e._tag==="ExternalSpan",traceFlags:pt(t?q$(e,t,O$):vr(e.context,O$),()=>Fc.SAMPLED),traceState:hr(t?q$(e,t,R$):vr(e.context,R$))}),q$=(e,t,n)=>Rs(vr(t,n),()=>vr(e.context,n)),gee=pee,Yv=mee,_ee=MF,Id=(e,t,n=" ")=>e.split(`
`).map(r=>n.repeat(t)+r).join(`
`),jF=e=>e!==void 0,A$={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};var F$={};const Wl=e=>{if(typeof process<"u"&&F$!==void 0)return F$[e];if(A$!==void 0)return A$[e]},Os=Wl("LS_TRACE_VERBOSE")!==void 0||Wl("VITE_LS_TRACE_VERBOSE")!==void 0,Qs=bb(Wl("LS_DEV"))||bb(Wl("VITE_LS_DEV"));bb(Wl("CI"));const yee=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],bee=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],See=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],wee=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],P$=(e,t,n)=>{let r=e;return typeof t=="string"||Array.isArray(t)?r=e.toLocaleString(t,n):(t===!0||n!==void 0)&&(r=e.toLocaleString(void 0,n)),r};function vee(e,t){if(!Number.isFinite(e))throw new TypeError(`Expected a finite number, got ${typeof e}: ${e}`);t={bits:!1,binary:!1,space:!0,...t};const n=t.bits?t.binary?wee:See:t.binary?bee:yee,r=t.space?" ":"";if(t.signed&&e===0)return` 0${r}${n[0]}`;const s=e<0,o=s?"-":t.signed?"+":"";s&&(e=-e);let a;if(t.minimumFractionDigits!==void 0&&(a={minimumFractionDigits:t.minimumFractionDigits}),t.maximumFractionDigits!==void 0&&(a={maximumFractionDigits:t.maximumFractionDigits,...a}),e<1){const p=P$(e,t.locale,a);return o+p+r+n[0]}const u=Math.min(Math.floor(t.binary?Math.log(e)/Math.log(1024):Math.log10(e)/3),n.length-1);e/=(t.binary?1024:1e3)**u,a||(e=e.toPrecision(3));const f=P$(Number(e),t.locale,a),d=n[u];return o+f+r+d}const UF=e=>Array.isArray(e);function Ys(e){debugger;throw new Error(`A case was not handled for value: ${Eee(qZ(e),1e3)}`)}const Eee=(e,t)=>e.length>t?e.slice(0,t)+"...":e,kee=e=>{const t=new Map;return(...n)=>{const r=JSON.stringify(n);if(t.has(r))return t.get(r);const s=e(...n);return t.set(r,s),s}},$ee=e=>{const t=new Map;return n=>{if(t.has(n))return t.get(n);const r=e(n);return t.set(n,r),r}},Tee=e=>typeof e?.then=="function",gu=e=>z(function*(){const t=yield*Aw();return yield*xr(n=>ln(t,n)),yield*e(t).pipe(Rw(t))}),Od=e=>zo(()=>e()).pipe(Jr(t=>kr(t)?t:Tee(t)?Jm(()=>t):We(t))),Et=e=>Hf(e,t=>z(function*(){if(Ds(t))return;const n=yield*Yv.pipe(Mw("NoSuchElementException",s=>We(void 0))),r=t.toString().split(`
`)[0];yield*Fl(r,t).pipe(s=>n===void 0?s:Ya({spanId:n.spanContext().spanId,traceId:n.spanContext().traceId})(s))})),Xn=(e,t)=>c8(l8(e).pipe(Ya(t??{})),S8,()=>Xp(mY)),Xv=e=>t=>zR($e(()=>performance.mark(`${e}:start`)),()=>t,()=>$e(()=>{performance.mark(`${e}:end`),performance.measure(e,`${e}:start`,`${e}:end`)})),zF=()=>{const e=cK();return e._tag==="None"||e.value.currentSpan===void 0?"No current fiber":""},Cee=()=>console.log(zF());globalThis.getSpanTrace=zF;globalThis.logSpanTrace=Cee;const BF=(e,t)=>{class n extends Fw{_tag=t}return n.prototype[e]=e,n.prototype.name=t,n},x$=Symbol.for("@effect/platform/Cookies"),N$=Symbol.for("@effect/platform/Cookies/Cookie"),Iee={[x$]:x$,...qp,toJSON(){return{_id:"@effect/platform/Cookies",cookies:I3(this.cookies,e=>e.toJSON())}},pipe(){return Y(this,arguments)}},Oee=e=>{const t=Object.create(Iee);return t.cookies=e,t},Ree=e=>{const t={};for(const n of e)t[n.name]=n;return Oee(t)},qee=e=>{const t=typeof e=="string"?[e]:e,n=[];for(const r of t){const s=Aee(r.trim());nt(s)&&n.push(s.value)}return Ree(n)};function Aee(e){const t=e.split(";").map(u=>u.trim()).filter(u=>u!=="");if(t.length===0)return H();const n=t[0].indexOf("=");if(n===-1)return H();const r=t[0].slice(0,n);if(!Fee.test(r))return H();const s=t[0].slice(n+1),o=Pee(s);if(t.length===1)return V(Object.assign(Object.create(D$),{name:r,value:o,valueEncoded:s}));const a={};for(let u=1;u<t.length;u++){const f=t[u],d=f.indexOf("="),p=d===-1?f:f.slice(0,d).trim(),m=d===-1?void 0:f.slice(d+1).trim();switch(p.toLowerCase()){case"domain":{if(m===void 0)break;const $=m.trim().replace(/^\./,"");$&&(a.domain=$);break}case"expires":{if(m===void 0)break;const $=new Date(m);isNaN($.getTime())||(a.expires=$);break}case"max-age":{if(m===void 0)break;const $=parseInt(m,10);isNaN($)||(a.maxAge=cS($));break}case"path":{if(m===void 0)break;m[0]==="/"&&(a.path=m);break}case"priority":{if(m===void 0)break;switch(m.toLowerCase()){case"low":a.priority="low";break;case"medium":a.priority="medium";break;case"high":a.priority="high";break}break}case"httponly":{a.httpOnly=!0;break}case"secure":{a.secure=!0;break}case"partitioned":{a.partitioned=!0;break}case"samesite":{if(m===void 0)break;switch(m.toLowerCase()){case"lax":a.sameSite="lax";break;case"strict":a.sameSite="strict";break;case"none":a.sameSite="none";break}break}}}return V(Object.assign(Object.create(D$),{name:r,value:o,valueEncoded:s,options:Object.keys(a).length>0?a:void 0}))}const Fee=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/,D$={[N$]:N$,...qp,toJSON(){return{_id:"@effect/platform/Cookies/Cookie",name:this.name,value:this.value,options:this.options}}},Pee=e=>{try{return decodeURIComponent(e)}catch{return e}},M$=Symbol.for("@effect/platform/Headers"),Kl=Object.assign(Object.create(null),{[M$]:M$,[Ap](e){return Eb(this,Om(e,VF))}}),Ag=e=>Object.assign(Object.create(Kl),e),HF=Object.create(Kl),Zv=e=>{if(e===void 0)return HF;if(Symbol.iterator in e){const n=Object.create(Kl);for(const[r,s]of e)n[r.toLowerCase()]=s;return n}const t=Object.create(Kl);for(const[n,r]of Object.entries(e))Array.isArray(r)?t[n.toLowerCase()]=r.join(", "):r!==void 0&&(t[n.toLowerCase()]=r);return t},xee=e=>Object.setPrototypeOf(e,Kl),vb=y(3,(e,t,n)=>{const r=Ag(e);return r[t.toLowerCase()]=n,r}),Nee=y(2,(e,t)=>Ag({...e,...Zv(t)})),Dee=y(2,(e,t)=>{const n=Ag(e);return Object.assign(n,t),n}),Mee=y(2,(e,t)=>{const n=Ag(e),r=s=>{if(typeof s=="string"){const o=s.toLowerCase();o in e&&delete n[o]}else for(const o in e)s.test(o)&&delete n[o]};if(Array.isArray(t))for(let s=0;s<t.length;s++)r(t[s]);else r(t);return n}),Eb=y(2,(e,t)=>{const n={...e},r=s=>{if(typeof s=="string"){const o=s.toLowerCase();o in e&&(n[o]=l$(e[o]))}else for(const o in e)s.test(o)&&(n[o]=l$(e[o]))};if(Array.isArray(t))for(let s=0;s<t.length;s++)r(t[s]);else r(t);return n}),VF=Se("@effect/platform/Headers/currentRedactedNames",()=>Kw(["authorization","cookie","set-cookie","x-api-key"])),Lee=Symbol.for("@effect/platform/HttpClientError"),WF=Lee;class KF extends BF(WF,"RequestError"){get methodAndUrl(){return`${this.request.method} ${this.request.url}`}get message(){return this.description?`${this.reason}: ${this.description} (${this.methodAndUrl})`:`${this.reason} error (${this.methodAndUrl})`}}class Xo extends BF(WF,"ResponseError"){get methodAndUrl(){return`${this.request.method} ${this.request.url}`}get message(){const t=`${this.response.status} ${this.methodAndUrl}`;return this.description?`${this.reason}: ${this.description} (${t})`:`${this.reason} error (${t})`}}const eE=e=>{const t=JF(e),n=[];for(let r=0;r<t.length;r++)if(Array.isArray(t[r][0])){const[s,o]=t[r];n.push([`${s[0]}[${s.slice(1).join("][")}]`,o])}else n.push(t[r]);return n},JF=e=>{const t=Symbol.iterator in e?Me(e):Object.entries(e),n=[];for(const[r,s]of t)if(Array.isArray(s))for(let o=0;o<s.length;o++)s[o]!==void 0&&n.push([r,String(s[o])]);else if(typeof s=="object"){const o=JF(s);for(const[a,u]of o)n.push([[r,...typeof a=="string"?[a]:a],u])}else s!==void 0&&n.push([r,String(s)]);return n},jee=[],Uee=y(2,(e,t)=>{const n=eE(t),r=n.map(([s])=>s);return Pp(QT(e,([s])=>r.includes(s)),n)}),zee=(e,t,n)=>{try{const r=new URL(e,Bee());for(let s=0;s<t.length;s++){const[o,a]=t[s];a!==void 0&&r.searchParams.append(o,a)}return n._tag==="Some"&&(r.hash=n.value),ie(r)}catch(r){return se(r)}},Bee=()=>{if("location"in globalThis&&globalThis.location!==void 0&&globalThis.location.origin!==void 0&&globalThis.location.pathname!==void 0)return location.origin+location.pathname},tl=Symbol.for("@effect/platform/HttpIncomingMessage"),Hee=(e,t)=>{const n=e.headers["content-type"]??"";let r;if(n.includes("application/json"))try{r=rs(e.json)}catch{}else if(n.includes("text/")||n.includes("urlencoded"))try{r=rs(e.text)}catch{}const s={...t,headers:Ai(e.headers),remoteAddress:e.remoteAddress.toJSON()};return r!==void 0&&(s.body=r),s},Vee=e=>xee({b3:`${e.traceId}-${e.spanId}-${e.sampled?"1":"0"}${e.parent._tag==="Some"?`-${e.parent.value.spanId}`:""}`,traceparent:`00-${e.traceId}-${e.spanId}-${e.sampled?"01":"00"}`}),P_=Symbol.for("@effect/platform/HttpBody");class Wee{[P_];constructor(){this[P_]=P_}[Le](){return this.toJSON()}toString(){return st(this)}}class Kee extends Wee{_tag="Empty";toJSON(){return{_id:"@effect/platform/HttpBody",_tag:"Empty"}}}const Jee=new Kee,L$=Symbol.for("@effect/platform/HttpClientRequest"),Gee={[L$]:L$,...qp,toJSON(){return{_id:"@effect/platform/HttpClientRequest",method:this.method,url:this.url,urlParams:this.urlParams,hash:this.hash,headers:Ai(this.headers),body:this.body.toJSON()}},pipe(){return Y(this,arguments)}};function Xs(e,t,n,r,s,o){const a=Object.create(Gee);return a.method=e,a.url=t,a.urlParams=n,a.hash=r,a.headers=s,a.body=o,a}const Qee=Xs("GET","",jee,H(),HF,Jee),pa=e=>(t,n)=>ste(Qee,{method:e,url:t,...n??void 0}),Yee=pa("GET"),Xee=pa("POST"),Zee=pa("PUT"),ete=pa("PATCH"),tte=pa("DELETE"),nte=pa("HEAD"),rte=pa("OPTIONS"),ste=y(2,(e,t)=>{let n=e;return t.method&&(n=ate(n,t.method)),t.url&&(n=cte(n,t.url)),t.headers&&(n=GF(n,t.headers)),t.urlParams&&(n=ute(n,t.urlParams)),t.hash&&(n=lte(n,t.hash)),t.body&&(n=fte(n,t.body)),t.accept&&(n=QF(n,t.accept)),t.acceptJson&&(n=ite(n)),n}),ote=y(3,(e,t,n)=>Xs(e.method,e.url,e.urlParams,e.hash,vb(e.headers,t,n),e.body)),GF=y(2,(e,t)=>Xs(e.method,e.url,e.urlParams,e.hash,Nee(e.headers,t),e.body)),QF=y(2,(e,t)=>ote(e,"Accept",t)),ite=QF("application/json"),ate=y(2,(e,t)=>Xs(t,e.url,e.urlParams,e.hash,e.headers,e.body)),cte=y(2,(e,t)=>{if(typeof t=="string")return Xs(e.method,t,e.urlParams,e.hash,e.headers,e.body);const n=new URL(t.toString()),r=eE(n.searchParams),s=n.hash?V(n.hash.slice(1)):H();return n.search="",n.hash="",Xs(e.method,n.toString(),r,s,e.headers,e.body)}),ute=y(2,(e,t)=>Xs(e.method,e.url,Uee(e.urlParams,t),e.hash,e.headers,e.body)),lte=y(2,(e,t)=>Xs(e.method,e.url,e.urlParams,V(t),e.headers,e.body)),fte=y(2,(e,t)=>{let n=e.headers;if(t._tag==="Empty"||t._tag==="FormData")n=Mee(n,["Content-type","Content-length"]);else{const r=t.contentType;r&&(n=vb(n,"content-type",r));const s=t.contentLength;s&&(n=vb(n,"content-length",s.toString()))}return Xs(e.method,e.url,e.urlParams,e.hash,n,t)}),nl=Symbol.for("@effect/platform/HttpClientResponse"),dte=(e,t)=>new hte(e,t);class hte extends z2{request;source;[tl];[nl];constructor(t,n){super(),this.request=t,this.source=n,this[tl]=tl,this[nl]=nl}toJSON(){return Hee(this,{_id:"@effect/platform/HttpClientResponse",request:this.request.toJSON(),status:this.status})}get status(){return this.source.status}get headers(){return Zv(this.source.headers)}cachedCookies;get cookies(){return this.cachedCookies?this.cachedCookies:this.cachedCookies=qee(this.source.headers.getSetCookie())}get remoteAddress(){return H()}get stream(){return this.source.body?eZ(()=>this.source.body,t=>new Xo({request:this.request,response:this,reason:"Decode",cause:t})):YX(new Xo({request:this.request,response:this,reason:"EmptyBody",description:"can not create stream from empty body"}))}get json(){return GK(this.text,{try:t=>t===""?null:JSON.parse(t),catch:t=>new Xo({request:this.request,response:this,reason:"Decode",cause:t})})}textBody;get text(){return this.textBody??=Ku({try:()=>this.source.text(),catch:t=>new Xo({request:this.request,response:this,reason:"Decode",cause:t})}).pipe(c_,rs)}get urlParamsBody(){return Q(this.text,t=>zo({try:()=>eE(new URLSearchParams(t)),catch:n=>new Xo({request:this.request,response:this,reason:"Decode",cause:n})}))}formDataBody;get formData(){return this.formDataBody??=Ku({try:()=>this.source.formData(),catch:t=>new Xo({request:this.request,response:this,reason:"Decode",cause:t})}).pipe(c_,rs)}arrayBufferBody;get arrayBuffer(){return this.arrayBufferBody??=Ku({try:()=>this.source.arrayBuffer(),catch:t=>new Xo({request:this.request,response:this,reason:"Decode",cause:t})}).pipe(c_,rs)}}const j$=Symbol.for("@effect/platform/HttpClient"),YF=Bn("@effect/platform/HttpClient"),pte=Se(Symbol.for("@effect/platform/HttpClient/tracerDisabledWhen"),()=>Kw(Nn)),mte=Se(Symbol.for("@effect/platform/HttpClient/currentTracerPropagation"),()=>Kw(!0)),gte=Uc()("@effect/platform/HttpClient/SpanNameGenerator",{defaultValue:()=>e=>`http.client ${e.method}`}),_te={[j$]:j$,pipe(){return Y(this,arguments)},...qp,toJSON(){return{_id:"@effect/platform/HttpClient"}},get(e,t){return this.execute(Yee(e,t))},head(e,t){return this.execute(nte(e,t))},post(e,t){return this.execute(Xee(e,t))},put(e,t){return this.execute(Zee(e,t))},patch(e,t){return this.execute(ete(e,t))},del(e,t){return this.execute(tte(e,t))},options(e,t){return this.execute(rte(e,t))}},XF=(e,t)=>{const n=Object.create(_te);return n.preprocess=t,n.postprocess=e,n.execute=function(r){return e(t(r))},n},pp=Se("@effect/platform/HttpClient/responseRegistry",()=>{if("FinalizationRegistry"in globalThis&&globalThis.FinalizationRegistry){const t=new FinalizationRegistry(n=>{n.abort()});return{register(n,r){t.register(n,r,n)},unregister(n){t.unregister(n)}}}const e=new Map;return{register(t,n){e.set(t,setTimeout(()=>n.abort(),5e3))},unregister(t){const n=e.get(t);n!==void 0&&(clearTimeout(n),e.delete(t))}}}),yte=e=>XF(t=>Q(t,n=>us(r=>{const s=new AbortController,o=zee(n.url,n.urlParams,n.hash);if(o._tag==="Left")return Er(new KF({request:n,reason:"InvalidUrl",cause:o.left}));const a=o.right;if(!r.getFiberRef(w8)||r.getFiberRef(pte)(n))return Oo(d=>mr(d(e(n,a,s.signal,r)),{onSuccess(p){return pp.register(p,s),We(new U$(p,s))},onFailure(p){return Il(p)&&s.abort(),Mn(p)}}));const f=Dn(r.currentContext,gte);return g8(f(n),{kind:"client",captureStackTrace:!1},d=>{d.attribute("http.request.method",n.method),d.attribute("server.address",a.origin),a.port!==""&&d.attribute("server.port",+a.port),d.attribute("url.full",a.toString()),d.attribute("url.path",a.pathname),d.attribute("url.scheme",a.protocol.slice(0,-1));const p=a.search.slice(1);p!==""&&d.attribute("url.query",p);const m=r.getFiberRef(VF),$=Eb(n.headers,m);for(const C in $)d.attribute(`http.request.header.${C}`,String($[C]));return n=r.getFiberRef(mte)?GF(n,Vee(d)):n,Oo(C=>C(e(n,a,s.signal,r)).pipe(hi(d),mr({onSuccess:O=>{d.attribute("http.response.status_code",O.status);const N=Eb(O.headers,m);for(const v in N)d.attribute(`http.response.header.${v}`,String(N[v]));return pp.register(O,s),We(new U$(O,s))},onFailure(O){return Il(O)&&s.abort(),Mn(O)}})))})})),We);class U${original;controller;constructor(t,n){this.original=t,this.controller=n}[nl]=nl;[tl]=tl;applyInterrupt(t){return ut(()=>(pp.unregister(this.original),YK(t,()=>$e(()=>{this.controller.abort()}))))}get request(){return this.original.request}get status(){return this.original.status}get headers(){return this.original.headers}get cookies(){return this.original.cookies}get remoteAddress(){return this.original.remoteAddress}get formData(){return this.applyInterrupt(this.original.formData)}get text(){return this.applyInterrupt(this.original.text)}get json(){return this.applyInterrupt(this.original.json)}get urlParamsBody(){return this.applyInterrupt(this.original.urlParamsBody)}get arrayBuffer(){return this.applyInterrupt(this.original.arrayBuffer)}get stream(){return TF(()=>(pp.unregister(this.original),QX(this.original.stream,t=>(Nz(t)&&this.controller.abort(),me))))}toJSON(){return this.original.toJSON()}[Le](){return this.original[Le]()}}const{del:ooe,execute:ioe,get:aoe,head:coe,options:uoe,patch:loe,post:foe,put:doe}=i8(YF),bte=y(2,(e,t)=>{const n=e;return XF(r=>t(n.postprocess(r)),n.preprocess)}),Ste=e=>QR(YF,Q(BR(),t=>ye(e,n=>bte(n,o8(r=>eo(t,r)))))),wte="@effect/platform/FetchHttpClient/Fetch",vte="@effect/platform/FetchHttpClient/FetchOptions",Ete=yte((e,t,n,r)=>{const s=r.getFiberRef(KR),o=s.unsafeMap.get(wte)??globalThis.fetch,a=s.unsafeMap.get(vte)??{},u=a.headers?Dee(Zv(a.headers),e.headers):e.headers,f=d=>ye(Ku({try:()=>o(t,{...a,method:e.method,headers:u,body:d,duplex:e.body._tag==="Stream"?"half":void 0,signal:n}),catch:p=>new KF({request:e,reason:"Transport",cause:p})}),p=>dte(e,p));switch(e.body._tag){case"Raw":case"Uint8Array":return f(e.body.body);case"FormData":return f(e.body.formData);case"Stream":return Q(lZ(e.body.stream),f)}return f(void 0)}),kte=Ste(We(Ete)),$te=kte;class rc extends iS("@effect/platform/Transferable/Collector")(){}const ZF=()=>{let e=[];const t=s=>{e.push(...s)},n=()=>e,r=()=>{const s=e;return e=[],s};return rc.of({unsafeAddAll:t,addAll:s=>$e(()=>t(s)),unsafeRead:n,read:$e(n),unsafeClear:r,clear:$e(r)})},Tte=$e(ZF),Cte=e=>Q(a8(rc),Xe({onNone:()=>me,onSome:t=>t.addAll(e)})),eP=y(2,(e,t)=>Ao(Cv(e),e,{strict:!0,decode:Ar,encode:n=>Ms(Cte(t(n)),n)})),Fg=eP(on,e=>[e]),sc=eP(Ig,e=>[e.buffer]),Ite=Symbol.for("@effect/platform/WorkerError"),kb=Ite,Ote=e=>X(e,kb);class Eo extends Lr()("WorkerError",{reason:Ne("spawn","decode","send","unknown","encode"),cause:Ac}){[kb]=kb;static Cause=HX({error:this,defect:Ac});static encodeCause=Is(this.Cause);static decodeCause=VA(this.Cause);get message(){switch(this.reason){case"send":return"An error occurred calling .postMessage";case"spawn":return"An error occurred while spawning a worker";case"decode":return"An error occurred during decoding";case"encode":return"An error occurred during encoding";case"unknown":return"An unexpected error occurred"}}}const Rte=Symbol.for("@effect/platform/Runner/PlatformRunner"),tP=Bn("@effect/platform/Runner/PlatformRunner"),tE=Uc()("@effect/platform/WorkerRunner/CloseLatch",{defaultValue:()=>Pz(On)}),nP=QR(tE,Ue()),qte=Wh(function*(e,t){const n=yield*us(We),r=yield*tP,s=yield*tE,o=yield*r.start(s),a=new Map;yield*Nt(s).pipe(ZK(()=>(n.currentScheduler.scheduleTask(()=>{n.unsafeInterruptAsFork(n.id())},0),me)),Bt),yield*o.run((u,[f,d,p,m])=>{if(d===1){const $=a.get(f);return $?Sr($):me}return us($=>(a.set(f,$),t?.decode?t.decode(p):We(p))).pipe(Q($=>{const C=ZF(),O=e($);let N=kr(O)?Q(O,v=>b(t?.encodeOutput?Gd(t.encodeOutput($,v),rc,C):We(v),Q(w=>o.send(u,[f,0,[w]],C.unsafeRead())))):b(O,uZ(v=>{if(t?.encodeOutput===void 0){const w=er(v);return o.send(u,[f,0,w])}return C.unsafeClear(),b(dn(v,w=>t.encodeOutput($,w)),Gd(rc,C),Q(w=>o.send(u,[f,0,w],C.unsafeRead())))}),Jr(o.send(u,[f,1])));return m&&(N=hi(N,{_tag:"ExternalSpan",traceId:m[0],spanId:m[1],sampled:m[2],context:js()})),Oo(v=>v(N).pipe(KK(Ote,w=>o.send(u,[f,3,Eo.encodeCause(ru(w))])),ns(w=>Yt(Um(w),{onLeft:g=>(C.unsafeClear(),b(t?.encodeError?Gd(t.encodeError($,g),rc,C):We(g),Q(E=>o.send(u,[f,2,E],C.unsafeRead())),ns(E=>o.send(u,[f,3,Eo.encodeCause(E)])))),onRight:g=>o.send(u,[f,3,Eo.encodeCause(g)])}))))}),di($e(()=>a.delete(f))))})}),Ate=(e,t)=>z(function*(){const n=yield*Qm;let r=js();const s=Rc(e);return yield*qte(o=>{const a=t[o._tag](o);return I8(a)?Q(GR(a,n),u=>$e(()=>{r=eo(r,u)})):kr(a)?qn(a,r):aZ(a,r)},{decode(o){return Ks(s(o),a=>new Eo({reason:"decode",cause:a}))},encodeError(o,a){return Ks(WX(o,a),u=>new Eo({reason:"encode",cause:u}))},encodeOutput(o,a){return ns(KX(o,a),u=>new Eo({reason:"encode",cause:u}))}})}),Fte=(e,t)=>q8(Ate(e,t)).pipe(Gw(nP)),Pte=e=>Hh(Wh(function*(t){const n=yield*GR(YR(e,nP),t),r=Dn(n,tE);return yield*Nt(r)})),z$=Rte,nE=tP,rP=Fte,sP=Pte,rE=e=>{try{return Ot(JSON.stringify(e.ast,null,2))}catch{return console.warn("Schema hashing failed, falling back to hashing the shortend schema AST string. This is less reliable and may cause false positives."),J(e.ast.toString())}},oP=(e,t)=>(n,r)=>z(function*(){const s=yield*Tte;return[yield*rd(e,t)(n,r).pipe(Gd(rc,s)),s.unsafeRead()]}),Rd=(e,t)=>(n,r)=>{const s=nF(e,t)(n,r);return s._tag==="Left"?we("encodeSyncDebug failed:",s.left):s.right},xte=e=>Ao(fs(e),Cv(e),{decode:J7(e),encode:W7(e)});xte(dX);const Po=ve(j,dt,Xi,Ov,De(jl(()=>Po)),mu({key:j,value:jl(()=>Po)})).annotations({title:"JsonValue"}),zn=Symbol("WebChannel"),Jl=Fe("WebChannel.DebugPing",{message:j,payload:Sn(j)}),mp=Fe("WebChannel.Ping",{requestId:j}),gp=Fe("WebChannel.Pong",{requestId:j}),Nte=ve(mp,gp),B$=e=>({send:ve(e.send,Jl,mp,gp),listen:ve(e.listen,Jl,mp,gp)}),Pg=e=>X(e,"send")&&X(e,"listen")?B$(e):B$({send:e,listen:e}),sE=e=>t=>t.pipe(kF(Ww(function*(n){return n._tag==="Right"&&yn(Jl)(n.right)?(yield*Vr(`WebChannel:ping [${e}] ${n.right.message}`,n.right.payload),!1):!0}))),Dte=({channelName:e,schema:t})=>gu(n=>z(function*(){const r=Pg(t),s=new BroadcastChannel(e);yield*xr(()=>zo(()=>s.close()).pipe(zf));const o=d=>z(function*(){const p=yield*rd(r.send)(d);s.postMessage(p)}),a=zv(s,"message").pipe(Wo(d=>vg(r.listen)(d.data)),sE(e)),u=yield*Ue().pipe(it(ua(Un))),f=!1;return{[zn]:zn,send:o,listen:a,closedDeferred:u,shutdown:ln(n,Mt("shutdown")),schema:r,supportsTransferables:f}}).pipe(Te(`WebChannel:broadcastChannel(${e})`))),Mte=({port:e,schema:t,debugId:n})=>gu(r=>z(function*(){const s=Pg(t),o=n===void 0?"messagePort":`messagePort:${n}`,a=p=>z(function*(){const[m,$]=yield*oP(s.send)(p);e.postMessage(m,$)}),u=zv(e,"message").pipe(Wo(p=>vg(s.listen)(p.data)),sE(o));e.start();const f=yield*Ue().pipe(it(ua(Un))),d=!0;return yield*xr(()=>zo(()=>e.close()).pipe(zf)),{[zn]:zn,send:a,listen:u,closedDeferred:f,shutdown:ln(r,Mt("shutdown")),schema:s,supportsTransferables:d}}).pipe(Te("WebChannel:messagePortChannel")));Se("livestore:sameThreadChannels",()=>new Map);const H$=({port:e,schema:t,debugId:n})=>gu(r=>z(function*(){const s=Pg(t),o=n===void 0?"messagePort":`messagePort:${n}`,a=new Map,u=Fe("ChannelRequest",{id:j,payload:ve(s.listen,s.send)}).annotations({title:"webmesh.ChannelRequest"}),f=Fe("ChannelRequestAck",{reqId:j}).annotations({title:"webmesh.ChannelRequestAck"}),d=ve(u,f).annotations({title:"webmesh.ChannelMessage"}),p={sendTotal:0,sendPending:0,listenTotal:0,id:n},m=N=>z(function*(){p.sendTotal++,p.sendPending++;const v=crypto.randomUUID(),[w,g]=yield*oP(d)({_tag:"ChannelRequest",id:v,payload:N}),E=yield*Ue();a.set(v,E),e.postMessage(w,g),yield*E,a.delete(v),p.sendPending--}),$=zv(e,"message").pipe(Wo(N=>vg(d)(N.data)),xn(N=>z(function*(){N._tag==="Right"&&(N.right._tag==="ChannelRequestAck"?yield*vt(a.get(N.right.reqId),void 0):N.right._tag==="ChannelRequest"&&(p.listenTotal++,e.postMessage(Is(d)({_tag:"ChannelRequestAck",reqId:N.right.id}))))})),XX(N=>N._tag==="Left"?V(N):N.right._tag==="ChannelRequest"?V(ie(N.right.payload)):H()),N=>N,sE(o));e.start();const C=yield*Ue().pipe(it(ua(Un))),O=!0;return yield*xr(()=>zo(()=>e.close()).pipe(zf)),{[zn]:zn,send:m,listen:$,closedDeferred:C,shutdown:ln(r,Mt("shutdown")),schema:s,supportsTransferables:O,debugInfo:p}}).pipe(Te("WebChannel:messagePortChannelWithAck"))),V$=(e,t)=>z(function*(){const n=yield*fn().pipe(it(Lt)),r={current:void 0};if(yield*e.listen.pipe(t?.heartbeat?kF(Ww(function*(o){if(o._tag==="Right"&&yn(Nte)(o.right)){if(o.right._tag==="WebChannel.Ping")yield*e.send(gp.make({requestId:o.right.requestId}));else{const{deferred:a,requestId:u}=r.current??we("No pending ping");u!==o.right.requestId&&we("Received pong for unexpected requestId",u,o.right.requestId),yield*vt(a,void 0)}return!1}return!0})):oe,IF(o=>rv(n,o)),hn,Bt),t?.heartbeat){const{interval:o,timeout:a}=t.heartbeat;yield*z(function*(){for(;;){yield*Ym(o);const u=crypto.randomUUID();yield*e.send(mp.make({requestId:u}));const f=yield*Ue();r.current={deferred:f,requestId:u},yield*f.pipe(zw(a),Mw("TimeoutException",()=>e.shutdown))}}).pipe(Te("WebChannel:heartbeat"),Bt)}const s=Gs(n,{maxChunkSize:1});return{[zn]:zn,send:e.send,listen:s,closedDeferred:e.closedDeferred,shutdown:e.shutdown,schema:e.schema,supportsTransferables:e.supportsTransferables,debugInfo:{innerDebugInfo:e.debugInfo,listenQueueSize:n}}}),Lte=e=>t=>{if(X(console,"createTask")===!1)return t;const n=z(function*(){const s=yield*h8;return L1({span:(o,...a)=>{const u=s.span(o,...a),f=e(o);return u.runInTask=d=>f.run(d),u},context:(o,a)=>{const u=vr(vH)(a.currentContext);if(u._tag==="None")return s.context(o,a);const f=u.value;if(f._tag==="ExternalSpan")return s.context(o,a);const d=f;return"runInTask"in d&&typeof d.runInTask=="function"?d.runInTask(()=>s.context(o,a)):s.context(o,a)}})}),r=b(n,ye(ZR),XR);return qn(t,r)},$b=Se("@effect/platform-browser/Worker/cachedPorts",()=>new Set);function jte(e){$b.add(e.ports[0])}typeof self<"u"&&"onconnect"in self&&(self.onconnect=jte);const iP=e=>nE.of({[z$]:z$,start:Wh(function*(t){const n=yield*yY();let r=0;const s=new Map,o=(u,f,d)=>$e(()=>{(s.get(u)?.[0]??e).postMessage([1,f],{transfer:d})}),a=Wh(function*(u){const f=yield*Qm,d=(yield*Rt(Bo())).pipe(LG(bM(pW))),p=yield*q7(),m=rA(d);function $(g){g._tag==="Failure"&&!Ds(g.cause)&&li(t,bl(Tw(g.cause)))}function C(g){return function(E){const k=E.data;if(k[0]===0){const R=u(g,k[1]);if(kr(R)){const q=m(R);q.addObserver($),Xk(p,q)}}else{const R=s.get(g);if(R){if(s.size===1)return li(t,Un)}else return;s.delete(g),Ho(ln(R[1],Un))}}}function O(g){li(t,new Eo({reason:"decode",cause:g.data}))}function N(g){li(t,new Eo({reason:"unknown",cause:g.data}))}function v(g){const E=qw(f,kl).pipe(Q(k=>{const R=r++;s.set(R,[g,k]);const q=C(R);return g.addEventListener("message",q),g.addEventListener("messageerror",O),"start"in g&&g.start(),g.postMessage([0]),wo(k,$e(()=>{g.removeEventListener("message",q),g.removeEventListener("messageerror",N),g.close()}))}),m);E.addObserver($),Xk(p,E)}e.addEventListener("error",N);let w;if("onconnect"in e){w=e.onconnect,e.onconnect=function(g){const E=g.ports[0];v(E)};for(const g of $b)v(g);$b.clear(),yield*wo(f,$e(()=>e.close()))}else v(e);yield*wo(f,$e(()=>{e.removeEventListener("error",N),"onconnect"in e&&(e.onconnect=w)}))});return oe({run:a,send:o,disconnects:n})})}),Ute=e=>Jw(nE,iP(e)),zte=A8(nE,()=>iP(self)),Bte=zte,Hte=Ute,Vte=(e=dw)=>Z4(t=>{const n=new MessageChannel;n.port1.postMessage(void 0),n.port2.onmessage=t},e),Wte=xC(),_p=sF(Wte)(up),Kte=xC(),Pc=sF(Kte)(up),xo=0,mn=ne({global:Pc,client:_p}).annotations({title:"LiveStore.EventSequenceNumber"}),Tb=(e,t)=>e.global!==t.global?e.global-t.global:e.client-t.client,rr=e=>e.client===0?`e${e.global}`:`e${e.global}+${e.client}`,xg=(e,t)=>e.global===t.global&&e.client===t.client,ss={global:0,client:xo},th=(e,t)=>e.global>t.global||e.global===t.global&&e.client>t.client,ea=(e,t)=>e.global>t.global||e.global===t.global&&e.client>=t.client,aP=(e,t)=>e.global>t.global||e.global===t.global&&e.client>t.client?e:t,oE=(e,t)=>t?{seqNum:{global:e.global,client:e.client+1},parentSeqNum:e}:{seqNum:{global:e.global+1,client:xo},parentSeqNum:{global:e.global,client:xo}},cP=e=>{const t=["text","integer","real","blob"];return typeof e=="object"&&e!==null&&"columnType"in e&&t.includes(e.columnType)},iE=Symbol.for("NoDefault"),uP=e=>typeof e=="object"&&e!==null&&"sql"in e&&typeof e.sql=="string",sd=e=>t=>{const n=t?.nullable??!1,r=t?.schema??fP(e),s=n===!0?aF(r):r,o=t?.default===void 0||t.default===iE?H():V(t.default);return{columnType:e,schema:s,default:o,nullable:n,primaryKey:t?.primaryKey??!1}},Jte=e=>sd(e),Or=sd("text"),Zn=sd("integer"),Gte=sd("real"),lP=sd("blob"),Ng=(e,t)=>n=>{const r=n?.nullable??!1,s=t._tag==="baseSchemaFn"?t.baseSchemaFn(n?.schema):t.baseSchema,o=r===!0?aF(s):s,a=n?.default===void 0||n.default===iE?H():V(n.default);return{columnType:e,schema:o,default:a,nullable:r,primaryKey:n?.primaryKey??!1}},aE=Ng("text",{_tag:"baseSchemaFn",baseSchemaFn:e=>Zi(e??on)}),Qte=Ng("text",{_tag:"baseSchema",baseSchema:mb}),Yte=Ng("integer",{_tag:"baseSchema",baseSchema:cr(dt,Dv,{decode:e=>new Date(e),encode:e=>e.getTime()})}),Xte=Ng("integer",{_tag:"baseSchema",baseSchema:cr(dt,Xi,{decode:e=>e===1,encode:e=>e?1:0})}),fP=e=>{switch(e){case"text":return j;case"integer":return dt;case"real":return dt;case"blob":return Ig;default:return Ys(e)}},Zte=e=>Array.isArray(e)?Object.fromEntries(e.map(t=>[t.name,t])):e,dP=(e,t,n)=>{const r={_tag:"table",name:e,columns:ene(t),indexes:tne(n??[])};return{name:e,columns:t,indexes:n,ast:r}},hP=e=>ne(Object.fromEntries(e.ast.columns.map(t=>[t.name,t.schema]))).annotations({title:e.name}),pP=e=>ne(Object.fromEntries(e.ast.columns.map(t=>[t.name,t.nullable===!0||t.default._tag==="Some"?Sn(t.schema):t.schema]))).annotations({title:e.name}),ene=e=>Object.entries(e).map(([t,n])=>({_tag:"column",name:t,schema:n.schema,default:n.default,nullable:n.nullable??!1,primaryKey:n.primaryKey??!1,type:{_tag:n.columnType}})),tne=e=>e.map(t=>({_tag:"index",columns:t.columns,name:t.name,unique:t.isUnique??!1}));var nne=Object.freeze({__proto__:null,NoDefault:iE,blob:lP,boolean:Xte,column:Jte,datetime:Qte,datetimeInteger:Yte,defaultSchemaForColumnType:fP,insertStructSchemaForTable:pP,integer:Zn,isColumnDefinition:cP,isSqlDefaultValue:uP,json:aE,makeDbSchema:Zte,real:Gte,structSchemaForTable:hP,table:dP,text:Or});const rne=e=>{let t=0,n,r;if(e.length===0)return t;for(n=0;n<e.length;n++)r=e.charCodeAt(n),t=(t<<5)-t+r,t=Math.trunc(t);return t},cE=e=>rne(JSON.stringify(nh(e))),nh=e=>{switch(e._tag){case"table":return{_tag:"table",name:e.name,columns:e.columns.map(t=>nh(t)),indexes:e.indexes.map(t=>nh(t))};case"column":return{_tag:"column",name:e.name,type:e.type._tag,primaryKey:e.primaryKey,nullable:e.nullable,default:e.default};case"index":return{_tag:"index",columns:e.columns,name:e.name,unique:e.unique,primaryKey:e.primaryKey};case"foreignKey":return{_tag:"foreignKey",references:e.references,key:e.key,columns:e.columns};case"dbSchema":return{_tag:"dbSchema",tables:e.tables.map(nh)};default:throw new Error(`Unreachable: ${e}`)}},Gl=Symbol.for("QueryBuilderAst"),ta=Symbol.for("QueryBuilder"),mP=e=>X(e,ta),sne=ne({mergeCounter:dt,eventNum:mn});ne({fileName:j},{key:j,value:on}).annotations({title:"LiveStore.PersistenceInfo"});const x_=ne({done:dt,total:dt}),one=ve(ne({stage:Ne("loading")}),ne({stage:Ne("migrating"),progress:x_}),ne({stage:Ne("rehydrating"),progress:x_}),ne({stage:Ne("syncing"),progress:x_}),ne({stage:Ne("done")})).annotations({title:"BootStatus"}),yp=Symbol.for("@livestore/session-id");class Re extends Lr()("LiveStore.UnexpectedError",{cause:Ac,note:Sn(j),payload:Sn(on)}){static mapToUnexpectedError=t=>t.pipe(Ks(n=>yn(Re)(n)?n:new Re({cause:n})),WK(n=>new Re({cause:n})));static mapToUnexpectedErrorStream=t=>t.pipe(sZ(n=>yn(Re)(n)?n:new Re({cause:n})))}class Cb extends Lr()("LiveStore.IntentionalShutdownCause",{reason:Ne("devtools-reset","devtools-import","adapter-reset","manual")}){}class hoe extends Lr()("LiveStore.StoreInterrupted",{reason:j}){}class Ua extends Lr()("LiveStore.SqliteError",{query:Sn(ne({sql:j,bindValues:ve(mu({key:j,value:on}),De(on))})),code:Sn(ve(dt,j)),cause:Ac,note:Sn(j)}){}const ine=ne({tableName:j,hashes:ne({expected:dt,actual:Sn(dt)})}),ane=ne({migrations:De(ine)}),qd=(e,t,n)=>e.length===0?"":`WHERE ${e.map(({col:s,op:o,value:a})=>{if(a===null){if(o!=="="&&o!=="!=")throw new Error(`Unsupported operator for NULL value: ${o}`);return`${s} ${o==="="?"IS":"IS NOT"} NULL`}const u=t.sqliteDef.columns[s];if(u===void 0)throw new Error(`Column ${s} not found`);if(o==="IN"||o==="NOT IN"){if(!Array.isArray(a))return we(`Expected array value for ${o} operator but got`,a);if(a.length===0)return o==="IN"?"0=1":"1=1";const d=a.map(m=>Is(u.schema)(m));n.push(...d);const p=d.map(()=>"?").join(", ");return`${s} ${o} (${p})`}else{const d=Is(u.schema)(a);return n.push(d),`${s} ${o} ?`}}).join(" AND ")}`,N_=e=>!e||e.length===0?"":` RETURNING ${e.join(", ")}`,W$=e=>{const t=[];if(e._tag==="InsertQuery"){const p=Object.keys(e.values),m=p.map(()=>"?").join(", "),$=Is(e.tableDef.insertSchema)(e.values);p.forEach(v=>{t.push($[v])});let C="INSERT",O="";if(e.onConflict)if(e.onConflict.action._tag==="replace")C="INSERT OR REPLACE";else if(O=` ON CONFLICT (${e.onConflict.targets.join(", ")}) `,e.onConflict.action._tag==="ignore")O+="DO NOTHING";else{const v=e.onConflict.action.update,w=Object.keys(v);if(w.length===0)throw new Error("No update columns provided for ON CONFLICT DO UPDATE");const g=w.map(E=>v[E]===void 0?`${E} = excluded.${E}`:`${E} = ?`).join(", ");w.forEach(E=>{const k=v[E];if(k!==void 0){const R=e.tableDef.sqliteDef.columns[E];if(R===void 0)throw new Error(`Column ${E} not found`);const q=Is(R.schema)(k);t.push(q)}}),O+=`DO UPDATE SET ${g}`}let N=`${C} INTO '${e.tableDef.sqliteDef.name}' (${p.join(", ")}) VALUES (${m})`;return N+=O,N+=N_(e.returning),{query:N,bindValues:t}}if(e._tag==="UpdateQuery"){const p=Object.keys(e.values);if(p.length===0)return console.warn(`UPDATE query requires at least one column to set (for table ${e.tableDef.sqliteDef.name}). Running no-op query instead to skip this update query.`),{query:"SELECT 1",bindValues:[]};const m=Is(ap(e.tableDef.rowSchema))(e.values);p.forEach(O=>{t.push(m[O])});let $=`UPDATE '${e.tableDef.sqliteDef.name}' SET ${p.map(O=>`${O} = ?`).join(", ")}`;const C=qd(e.where,e.tableDef,t);return C&&($+=` ${C}`),$+=N_(e.returning),{query:$,bindValues:t}}if(e._tag==="DeleteQuery"){let p=`DELETE FROM '${e.tableDef.sqliteDef.name}'`;const m=qd(e.where,e.tableDef,t);return m&&(p+=` ${m}`),p+=N_(e.returning),{query:p,bindValues:t}}if(e._tag==="CountQuery")return{query:[`SELECT COUNT(*) as count FROM '${e.tableDef.sqliteDef.name}'`,qd(e.where,e.tableDef,t)].filter(m=>m.length>0).join(" "),bindValues:t};if(e._tag==="RowQuery"){const p=e.tableDef.sqliteDef.columns.id;if(p===void 0)throw new Error("Column id not found for ROW query");const m=e.id===yp?e.id:Is(p.schema)(e.id);return{query:`SELECT * FROM '${e.tableDef.sqliteDef.name}' WHERE id = ?`,bindValues:[m]}}const r=`SELECT ${e.select.columns.length===0?"*":e.select.columns.join(", ")}`,s=`FROM '${e.tableDef.sqliteDef.name}'`,o=qd(e.where,e.tableDef,t),a=e.orderBy.length>0?`ORDER BY ${e.orderBy.map(({col:p,direction:m})=>`${p} ${m}`).join(", ")}`:"",u=e.limit._tag==="Some"?"LIMIT ?":"",f=e.offset._tag==="Some"?"OFFSET ?":"";return e.offset._tag==="Some"&&t.push(e.offset.value),e.limit._tag==="Some"&&t.push(e.limit.value),{query:[r,s,o,a,f,u].map(p=>p.trim()).filter(p=>p.length>0).join(" "),bindValues:t}},_n=(e,t=cne(e))=>{const n={select(){Ru(t);const r=[...arguments];if(r.length===1){const[o]=r;return _n(e,{...t,resultSchemaSingle:t.resultSchemaSingle.pipe(qc(o)),select:{columns:[o]}})}const s=r;return _n(e,{...t,resultSchemaSingle:s.length===0?t.resultSchemaSingle:t.resultSchemaSingle.pipe(Ll(...s)),select:{columns:s}})},where:function(){if(t._tag==="InsertQuery")return qu("Cannot use where with insert");if(t._tag==="RowQuery")return qu("Cannot use where with row");if(arguments.length===1){const f=arguments[0],d=Object.entries(f).filter(([,p])=>p!==void 0).map(([p,m])=>X(m,"op")&&X(m,"value")?{col:p,op:m.op,value:m.value}:{col:p,op:"=",value:m});switch(t._tag){case"CountQuery":case"SelectQuery":case"UpdateQuery":case"DeleteQuery":return _n(e,{...t,where:[...t.where,...d]});default:return Ys(t)}}const[r,s,o]=arguments,a=o===void 0?"=":s,u=o===void 0?s:o;switch(t._tag){case"CountQuery":case"SelectQuery":case"UpdateQuery":case"DeleteQuery":return _n(e,{...t,where:[...t.where,{col:r,op:a,value:u}]});default:return Ys(t)}},orderBy(){if(Ru(t),arguments.length===0||arguments.length>2)return qu();if(arguments.length===1){const o=arguments[0];return _n(e,{...t,orderBy:[...t.orderBy,...o]})}const[r,s]=arguments;return _n(e,{...t,orderBy:[...t.orderBy,{col:r,direction:s}]})},limit:r=>(Ru(t),_n(e,{...t,limit:V(r)})),offset:r=>(Ru(t),_n(e,{...t,offset:V(r)})),count:()=>fne(t)||t._tag==="InsertQuery"||t._tag==="UpdateQuery"||t._tag==="DeleteQuery"?qu():_n(e,{_tag:"CountQuery",tableDef:e,where:t.where,resultSchema:ne({count:dt}).pipe(qc("count"),De,ju())}),first:r=>(Ru(t),t.limit._tag==="Some"?qu(".first() can't be called after .limit()"):_n(e,{...t,limit:V(1),pickFirst:r?.fallback!==void 0&&r.fallback!=="throws"?{fallback:r.fallback}:"throws"})),insert:r=>{const s=Object.fromEntries(Object.entries(r).filter(([,o])=>o!==void 0));return _n(e,{_tag:"InsertQuery",tableDef:e,values:s,onConflict:void 0,returning:void 0,resultSchema:Xr})},onConflict:(r,s,o)=>{const a=Array.isArray(r)?r:[r];une(t);const u=XA(s).pipe(T_("ignore",()=>({targets:a,action:{_tag:"ignore"}})),T_("replace",()=>({targets:a,action:{_tag:"replace"}})),T_("update",()=>({targets:a,action:{_tag:"update",update:o}})),ZA);return _n(e,{...t,onConflict:u})},returning:(...r)=>(lne(t),_n(e,{...t,returning:r,resultSchema:e.rowSchema.pipe(Ll(...r),De)})),update:r=>{const s=Object.fromEntries(Object.entries(r).filter(([,o])=>o!==void 0));return _n(e,{_tag:"UpdateQuery",tableDef:e,values:s,where:[],returning:void 0,resultSchema:Xr})},delete:()=>_n(e,{_tag:"DeleteQuery",tableDef:e,where:[],returning:void 0,resultSchema:Xr})};return{[ta]:ta,[Gl]:t,ResultType:"only-for-type-inference",asSql:()=>W$(t),toString:()=>{try{return W$(t).query}catch(r){return console.debug("QueryBuilder.toString(): Error converting query builder to string",r,t),"Error converting query builder to string"}},...n}},cne=e=>({_tag:"SelectQuery",columns:[],pickFirst:!1,select:{columns:[]},orderBy:[],offset:H(),limit:H(),tableDef:e,where:[],resultSchemaSingle:e.rowSchema});function Ru(e){if(e._tag!=="SelectQuery")return we("Expected SelectQuery but got "+e._tag)}function une(e){if(e._tag!=="InsertQuery")return we("Expected InsertQuery but got "+e._tag)}function lne(e){if(e._tag!=="InsertQuery"&&e._tag!=="UpdateQuery"&&e._tag!=="DeleteQuery")return we("Expected WriteQuery but got "+e._tag)}const fne=e=>e._tag==="RowQuery",qu=e=>we("Invalid query builder"+(e?`: ${e}`:"")),dne=e=>{const t=e[Gl];switch(t._tag){case"SelectQuery":{const n=De(t.resultSchemaSingle);if(t.pickFirst===!1)return n;if(t.pickFirst==="throws")return n.pipe(ju());{const r=t.pickFirst.fallback();return ve(n,jY(Ne(r))).pipe(ju(()=>r))}}case"CountQuery":return ne({count:dt}).pipe(qc("count"),De,ju());case"InsertQuery":case"UpdateQuery":case"DeleteQuery":return t.returning&&t.returning.length>0?t.tableDef.rowSchema.pipe(Ll(...t.returning),De):dt;case"RowQuery":return t.tableDef.rowSchema.pipe(qc("value"),XY({title:`${t.tableDef.sqliteDef.name}.value`}),De,ju());default:Ys(t)}},{boolean:hne,integer:pne,text:K$}=nne,Ko=e=>{const{name:t,columns:n,...r}=e,s=t,o={isClientDocumentTable:!1},a=cP(n)?{value:n}:n,u=dP(s,a,r?.indexes??[]),f=hP(u),d=pP(u),p={sqliteDef:u,options:o,rowSchema:f,insertSchema:d},m=_n(p);for(const $ of Object.keys(m))p[$]=m[$];return p[Gl]=m[Gl],p[ta]=m[ta],p},Dg="__livestore_schema",mne=Ko({name:Dg,columns:{tableName:Or({primaryKey:!0}),schemaHash:Zn({nullable:!1}),updatedAt:Or({nullable:!1})}}),bp="__livestore_schema_event_defs",gP=Ko({name:bp,columns:{eventName:Or({primaryKey:!0}),schemaHash:Zn({nullable:!1}),updatedAt:Or({nullable:!1})}}),Ql="__livestore_session_changeset",Sp=Ko({name:Ql,columns:{seqNumGlobal:Zn({schema:Pc}),seqNumClient:Zn({schema:_p}),changeset:lP({nullable:!0}),debug:aE({nullable:!0})},indexes:[{columns:["seqNumGlobal","seqNumClient"],name:"idx_session_changeset_id"}]}),uE="__livestore_leader_merge_counter",gne=Ko({name:uE,columns:{id:Zn({primaryKey:!0,schema:Ne(0)}),mergeCounter:Zn({primaryKey:!0})}}),Yl=[mne,gP,Sp,gne],_ne=e=>Yl.some(t=>t.sqliteDef.name===e),ds="eventlog",Xl=Ko({name:ds,columns:{seqNumGlobal:Zn({primaryKey:!0,schema:Pc}),seqNumClient:Zn({primaryKey:!0,schema:_p}),parentSeqNumGlobal:Zn({schema:Pc}),parentSeqNumClient:Zn({schema:_p}),name:Or({}),argsJson:Or({schema:Zi(on)}),clientId:Or({}),sessionId:Or({}),schemaHash:Zn({}),syncMetadataJson:Or({schema:Zi(Og(Po))})},indexes:[{columns:["seqNumGlobal"],name:"idx_eventlog_seqNumGlobal"},{columns:["seqNumGlobal","seqNumClient"],name:"idx_eventlog_seqNum"}]}),Zl="__livestore_sync_status",yne=Ko({name:Zl,columns:{head:Zn({primaryKey:!0})}}),bne=[Xl,yne],J$=ve(j,dt,yF,Ov);ve(De(J$),mu({key:j,value:J$})).pipe(KY("PreparedBindValues"));const mt=(e,...t)=>{let n="";for(const[r,s]of t.entries())n+=e[r]+String(s);return n+e[e.length-1]},Ti=(e,t)=>{if(Array.isArray(e))return e;const n={};for(const[r,s]of Object.entries(e))t.includes(r)&&(n[`$${r}`]=s);return n},rh=(e,t,n)=>{const r=e.prepare(t),s=n?Ti(n,t):void 0;r.execute(s),r.finalize()},_P=(e,t,n)=>{const r=e.prepare(t),s=r.select(void 0);return r.finalize(),s},Sne=(e,t)=>z(function*(){const n=t.getEventDefInfos(),r=n.filter(s=>!e.eventsDefsMap.has(s.eventName));r.length>0&&(yield*new Re({cause:`Missing mutation definitions: ${r.map(s=>s.eventName).join(", ")}`}));for(const[,s]of e.eventsDefsMap){const o=n.find(a=>a.eventName===s.name);wne(s,t,o)}}),wne=(e,t,n)=>{const r=rE(e.schema);if(n===void 0){t.setEventDefInfo({schemaHash:r,eventName:e.name});return}r!==n.schemaHash&&t.setEventDefInfo({schemaHash:r,eventName:e.name})},vne=kee(()=>new Date().toISOString()),Ene=e=>z(function*(){return yield*wp({db:e,tableAst:gP.sqliteDef.ast,behaviour:"create-if-not-exists"}),{getEventDefInfos:()=>_P(e,mt`SELECT * FROM ${bp}`),setEventDefInfo:t=>{rh(e,mt`INSERT OR REPLACE INTO ${bp} (eventName, schemaHash, updatedAt) VALUES ($eventName, $schemaHash, $updatedAt)`,{eventName:t.eventName,schemaHash:t.schemaHash,updatedAt:new Date().toISOString()})}}}),kne=({db:e,schema:t,onProgress:n})=>z(function*(){for(const m of Yl)yield*wp({db:e,tableAst:m.sqliteDef.ast,behaviour:"create-if-not-exists"});const r=yield*Ene(e);yield*Sne(t,r);const s=_P(e,mt`SELECT * FROM ${Dg}`),o=Object.fromEntries(s.map(({tableName:m,schemaHash:$})=>[m,$])),a=[...Yl,...Array.from(t.state.sqlite.tables.values()).filter(m=>!_ne(m.sqliteDef.name))],u=new Set,f=[];for(const m of a){const $=m.sqliteDef.ast,C=$.name,O=o[C],N=cE($);N!==O&&(u.add({tableAst:$,schemaHash:N}),f.push({tableName:C,hashes:{expected:N,actual:O}}))}let d=0;const p=u.size;for(const{tableAst:m,schemaHash:$}of u)yield*wp({db:e,tableAst:m,schemaHash:$,behaviour:"create-if-not-exists"}),n!==void 0&&(d++,yield*n({done:d,total:p}));return{migrations:f}}),wp=({db:e,tableAst:t,schemaHash:n=cE(t),behaviour:r,skipMetaTable:s=!1})=>z(function*(){const o=t.name,a=Tne(t);rh(e,mt`create table if not exists '${o}' (${a}) strict`);for(const u of t.indexes)rh(e,$ne(o,u));if(s!==!0){const u=vne();rh(e,mt`
      INSERT INTO ${Dg} (tableName, schemaHash, updatedAt) VALUES ($tableName, $schemaHash, $updatedAt)
        ON CONFLICT (tableName) DO UPDATE SET schemaHash = $schemaHash, updatedAt = $updatedAt;
    `,{tableName:o,schemaHash:n,updatedAt:u})}}).pipe(Te("@livestore/common:migrateTable",{attributes:{"span.label":t.name,tableName:t.name}})),$ne=(e,t)=>{const n=t.unique?"UNIQUE":"";return mt`create ${n} index if not exists '${t.name}' on '${e}' (${t.columns.join(", ")})`},Tne=e=>{const t=e.columns.filter(r=>r.primaryKey).map(r=>`'${r.name}'`),n=e.columns.map(Cne);return t.length>0&&n.push(`PRIMARY KEY (${t.join(", ")})`),n.join(", ")},Cne=e=>{const t=e.type._tag,n=e.nullable===!1?"not null":"",r=(()=>{if(e.default._tag==="None")return"";if(e.default.value===null)return"default null";if(uP(e.default.value))return`default ${e.default.value.sql}`;const o=Is(e.schema)(e.default.value);return t==="text"?`default '${o}'`:`default ${o}`})();return`'${e.name}' ${t} ${n} ${r}`},Ine=({eventDef:e,materializer:t,db:n,event:r})=>{const s=tp(e.schema)(r.encoded.args),o=void 0,u=t(s,{eventDef:e,query:d=>{if(mP(d)){const{query:p,bindValues:m}=d.asSql(),$=n.select(p,Ti(m,p)),C=dne(d);return VA(C)($)}else{const{query:p,bindValues:m}=d;return n.select(p,Ti(m,p))}},currentFacts:new Map});return yP(u).map(d=>{const p=d.sql,m=typeof d=="string"?o:d.bindValues,$=typeof d=="string"?void 0:d.writeTables;return{statementSql:p,bindValues:Ti(m??{},p),writeTables:$}})},yP=e=>{if(UF(e))return e.flatMap(yP);if(mP(e)){const{query:t,bindValues:n}=e.asSql();return[{sql:t,bindValues:n,writeTables:void 0}]}else return typeof e=="string"?[{sql:e,bindValues:{},writeTables:void 0}]:[{sql:e.sql,bindValues:e.bindValues,writeTables:e.writeTables}]},lE=e=>{const{name:t,schema:n,...r}=e,s=o=>{const a=FY(n)(o);return a._tag==="Left"&&we(`Invalid event args for event '${t}':`,a.left.message,`
`),{name:t,args:o}};return Object.defineProperty(s,"name",{value:t}),Object.defineProperty(s,"schema",{value:n}),Object.defineProperty(s,"options",{value:{clientOnly:r?.clientOnly??!1,facts:r?.facts?(o,a)=>{const u=r.facts(o,a);return{modify:{set:u.modify?.set?new Set(u.modify.set):new Set,unset:u.modify?.unset?new Set(u.modify.unset):new Set},require:u.require?new Set(u.require):new Set}}:void 0,derived:r?.derived??!1}}),s},Au=e=>lE({...e,clientOnly:!1}),bP=(e,t)=>t,One=(e,t)=>t,vp=lE({name:"livestore.RawSql",schema:ne({sql:j,bindValues:Sn(mu({key:j,value:on})),writeTables:Sn(OX(j))}),clientOnly:!0,derived:!0}),Rne=bP(vp,({sql:e,bindValues:t,writeTables:n})=>({sql:e,bindValues:t??{},writeTables:n})),qne=({name:e,schema:t,...n})=>{const r={partialSet:n.partialSet??!0,default:{id:n.default.id,value:n.default.value}},s={id:Or({primaryKey:!0}),value:aE({schema:t})},o=Ko({name:e,columns:s});o.options.isClientDocumentTable=!0;const{eventDef:a,materializer:u}=Fne({name:e,valueSchema:t,defaultValue:r.default.value,partialSet:r.partialSet}),f=(...m)=>{const[$,C=r.default.id]=m;return a({id:C,value:$})};Object.defineProperty(f,"name",{value:`${e}Set`}),Object.defineProperty(f,"schema",{value:ne({id:j,value:r.partialSet?ap(t):t}).annotations({title:`${e}Set:Args`})}),Object.defineProperty(f,"options",{value:{derived:!0,clientOnly:!0,facts:void 0}});const d={get:Pne(()=>p),set:f,Value:"only-for-type-inference",default:r.default,valueSchema:t,[ef]:{derived:{setEventDef:a,setMaterializer:u},options:r}},p={...o,...d};return p},Ane=(e,t)=>typeof e!="object"||typeof t!="object"||e===null||t===null?t:Object.keys(e).reduce((n,r)=>(n[r]=t[r]??e[r],n),{}),Fne=({name:e,valueSchema:t,defaultValue:n,partialSet:r})=>{const s=lE({name:`${e}Set`,schema:ne({id:ve(j,xY(yp)),value:r?ap(t):t}).annotations({title:`${e}Set:Args`}),clientOnly:!0,derived:!0}),o=bP(s,({id:a,value:u})=>{if(a===yp)return we("SessionIdSymbol needs to be replaced before materializing the set event");if(Md(t.ast).length===0||r===!1){const d=Zi(t),p=Rd(d)(u??n),m=Rd(d)(u);return{sql:`INSERT INTO '${e}' (id, value) VALUES (?, ?) ON CONFLICT (id) DO UPDATE SET value = ?`,bindValues:[a,p,m],writeTables:new Set([e])}}else{const d=Zi(ap(t)),p=Rd(d)(Ane(n,u));let m="value";const $=[],C=Object.keys(u),O=t.pipe(Ll(...C)),N=Rd(O)(u);for(const g in N){const E=N[g];E!==void 0&&(m=`json_set(${m}, ?, json(?))`,$.push(`$.${g}`,JSON.stringify(E)))}const v=$.length>0?`ON CONFLICT (id) DO UPDATE SET value = ${m}`:"ON CONFLICT (id) DO NOTHING";return{sql:`
      INSERT INTO '${e}' (id, value)
      VALUES (?, ?)
      ${v}
    `,bindValues:[a,p,...$],writeTables:new Set([e])}}});return{eventDef:s,materializer:o}},SP=e=>e.options.isClientDocumentTable===!0,Pne=e=>(...t)=>{const n=e(),[r=n[ef].options.default.id,s={}]=t,o=s.default??n[ef].options.default.value,a={_tag:"RowQuery",tableDef:n,id:r,explicitDefaultValues:o},u=mt`SELECT * FROM '${n.sqliteDef.name}' WHERE id = ?`;return{[ta]:ta,[Gl]:a,ResultType:"only-for-type-inference",asSql:()=>({query:u,bindValues:[r]}),toString:()=>u.toString()}},ef=Symbol("ClientDocumentTableDef"),xne=Symbol.for("livestore.LiveStoreSchema"),Nne=e=>{const t=e.state,n=e.state.sqlite.tables;for(const s of Yl)n.set(s.sqliteDef.name,s);const r=new Map;if(UF(e.events))for(const s of e.events)r.set(s.name,s);else for(const s of Object.values(e.events??{}))r.has(s.name)&&we(`Duplicate event name: ${s.name}. Please use unique names for events.`),r.set(s.name,s);r.set(vp.name,vp);for(const s of n.values())SP(s)&&r.has(s.set.name)===!1&&r.set(s.set.name,s.set);return{LiveStoreSchemaSymbol:xne,_DbSchemaType:Symbol.for("livestore.DbSchemaType"),_EventDefMapType:Symbol.for("livestore.EventDefMapType"),state:t,eventsDefsMap:r,devtools:{alias:e.devtools?.alias??"default"}}},Ci=(e,t)=>{const n=e.eventsDefsMap.get(t);if(n===void 0)return we(`No mutation definition found for \`${t}\`.`);const r=e.state.materializers.get(t);return r===void 0?we(`No materializer found for \`${t}\`.`):{eventDef:n,materializer:r}},Dne=e=>{const t=Array.isArray(e.tables)?e.tables:Object.values(e.tables),n=new Map;for(const o of t){const a=o.sqliteDef;n.has(a.ast.name)&&we(`Duplicate table name: ${a.ast.name}. Please use unique names for tables.`),n.set(a.ast.name,o)}for(const o of Yl)n.set(o.sqliteDef.name,o);const r=new Map;for(const[o,a]of Object.entries(e.materializers))r.set(o,a);r.set(vp.name,Rne);for(const o of t)SP(o)&&r.set(o[ef].derived.setEventDef.name,o[ef].derived.setMaterializer);const s=cE({_tag:"dbSchema",tables:[...n.values()].map(o=>o.sqliteDef.ast)});return{sqlite:{tables:n,migrations:e.migrations??{strategy:"auto"},hash:s},materializers:r}};ne({name:j,args:on,seqNum:mn,parentSeqNum:mn,clientId:j,sessionId:j}).annotations({title:"LiveStoreEvent.AnyDecoded"});const Mne=ne({name:j,args:on,seqNum:mn,parentSeqNum:mn,clientId:j,sessionId:j}).annotations({title:"LiveStoreEvent.AnyEncoded"}),Lne=ne({name:j,args:on,seqNum:Pc,parentSeqNum:Pc,clientId:j,sessionId:j}).annotations({title:"LiveStoreEvent.AnyEncodedGlobal"}),jne=ne({name:j,args:on}),Une=e=>ve(...[...e.eventsDefsMap.values()].map(t=>ne({name:Ne(t.name),args:t.schema,seqNum:mn,parentSeqNum:mn,clientId:j,sessionId:j}))).annotations({title:"EventDef"});class gn extends ha("LiveStoreEvent.EncodedWithMeta")({name:j,args:on,seqNum:mn,parentSeqNum:mn,clientId:j,sessionId:j,meta:ne({sessionChangeset:ve(Fe("sessionChangeset",{data:yF,debug:on.pipe(Sn)}),Fe("no-op",{}),Fe("unset",{})),syncMetadata:Og(Po)}).pipe(JY,Sn,dF({constructor:()=>({sessionChangeset:{_tag:"unset"},syncMetadata:H()}),decoding:()=>({sessionChangeset:{_tag:"unset"},syncMetadata:H()})}))}){toJSON=()=>({seqNum:`${rr(this.seqNum)} → ${rr(this.parentSeqNum)} (${this.clientId}, ${this.sessionId})`,name:this.name,args:this.args});rebase=(t,n)=>new gn({...this,...oE(t,n)});static fromGlobal=(t,n)=>new gn({...t,seqNum:{global:t.seqNum,client:xo},parentSeqNum:{global:t.parentSeqNum,client:xo},meta:{sessionChangeset:{_tag:"unset"},syncMetadata:n}});toGlobal=()=>({...this,seqNum:this.seqNum.global,parentSeqNum:this.parentSeqNum.global})}const wP=(e,t)=>e.seqNum.global===t.seqNum.global&&e.seqNum.client===t.seqNum.client&&e.name===t.name&&e.clientId===t.clientId&&e.sessionId===t.sessionId&&JSON.stringify(e.args)===JSON.stringify(t.args),zne=({dbEventlog:e,schema:t,onProgress:n,materializeEvent:r})=>z(function*(){const s=e.select(`SELECT COUNT(*) AS count FROM ${ds}`)[0].count,o=$ee(p=>rE(p.schema)),a=p=>z(function*(){const m=Ci(t,p.name);o(m.eventDef)!==p.schemaHash&&(yield*Cs(`Schema hash mismatch for event definition ${p.name}. Trying to materialize event anyway.`));const $=JSON.parse(p.argsJson);yield*Rc(m.eventDef.schema)($).pipe(Ks(O=>Re.make({cause:O,note:`There was an error during rematerializing from the eventlog while decoding
the persisted event args for event definition "${p.name}".
This likely means the schema has changed in an incompatible way.
`})));const C=gn.make({seqNum:{global:p.seqNumGlobal,client:p.seqNumClient},parentSeqNum:{global:p.parentSeqNumGlobal,client:p.parentSeqNumClient},name:p.name,args:$,clientId:p.clientId,sessionId:p.sessionId});yield*r(C,{skipEventlog:!0})}).pipe(Te("@livestore/common:rematerializeFromEventlog:processEvent")),f=e.prepare(mt`\
SELECT * FROM ${ds} 
WHERE seqNumGlobal > $seqNumGlobal OR (seqNumGlobal = $seqNumGlobal AND seqNumClient > $seqNumClient)
ORDER BY seqNumGlobal ASC, seqNumClient ASC
LIMIT ${100}
`);let d=0;yield*fZ({_tag:"Initial "},p=>{if(bi(p)&&p.length===0)return H();const m=bi(p)?CM(p).pipe(yo(O=>({global:O.seqNumGlobal,client:O.seqNumClient})),pt(()=>ss)):ss,$=Us(f.select({$seqNumGlobal:m?.global,$seqNumClient:m?.client})),C=bi(p)?p:lt();return V([C,$])}).pipe(GX({capacity:2}),xn(p=>z(function*(){yield*a(p),d++,yield*n({done:d,total:s})})),hn)}).pipe(Xv("@livestore/common:rematerializeFromEventlog"),Te("@livestore/common:rematerializeFromEventlog"));class poe extends Lr()("IsOfflineError",{}){}class moe extends Lr()("InvalidPushError",{reason:ve(Fe("Unexpected",{message:j}),Fe("ServerAhead",{minimumExpectedNum:dt,providedNum:dt}))}){}class goe extends Lr()("InvalidPullError",{message:j}){}class fE extends Lr()("LeaderAheadError",{minimumExpectedNum:mn,providedNum:mn}){}class Gr extends ha("SyncState")({pending:De(gn),upstreamHead:mn,localHead:mn}){toJSON=()=>({pending:this.pending.map(t=>t.toJSON()),upstreamHead:rr(this.upstreamHead),localHead:rr(this.localHead)})}class Ep extends Fe("upstream-rebase",{rollbackEvents:De(gn),newEvents:De(gn)}){}class Ii extends Fe("upstream-advance",{newEvents:De(gn)}){}class Bne extends Fe("local-push",{newEvents:De(gn)}){}class Hne extends ve(Ep,Ii,Bne){}class vP extends ve(Ep,Ii){}class Mg extends ha("MergeContext")({payload:Hne,syncState:Gr}){toJSON=()=>({payload:XA(this.payload).pipe(C_("local-push",()=>({_tag:"local-push",newEvents:this.payload.newEvents.map(n=>n.toJSON())})),C_("upstream-advance",()=>({_tag:"upstream-advance",newEvents:this.payload.newEvents.map(n=>n.toJSON())})),C_("upstream-rebase",n=>({_tag:"upstream-rebase",newEvents:n.newEvents.map(r=>r.toJSON()),rollbackEvents:n.rollbackEvents.map(r=>r.toJSON())})),ZA),syncState:this.syncState.toJSON()})}class zu extends ha("MergeResultAdvance")({_tag:Ne("advance"),newSyncState:Gr,newEvents:De(gn),confirmedEvents:De(gn),mergeContext:Mg}){toJSON=()=>({_tag:this._tag,newSyncState:this.newSyncState.toJSON(),newEvents:this.newEvents.map(t=>t.toJSON()),confirmedEvents:this.confirmedEvents.map(t=>t.toJSON()),mergeContext:this.mergeContext.toJSON()})}class Ib extends ha("MergeResultRebase")({_tag:Ne("rebase"),newSyncState:Gr,newEvents:De(gn),rollbackEvents:De(gn),mergeContext:Mg}){toJSON=()=>({_tag:this._tag,newSyncState:this.newSyncState.toJSON(),newEvents:this.newEvents.map(t=>t.toJSON()),rollbackEvents:this.rollbackEvents.map(t=>t.toJSON()),mergeContext:this.mergeContext.toJSON()})}class EP extends ha("MergeResultReject")({_tag:Ne("reject"),expectedMinimumId:mn,mergeContext:Mg}){toJSON=()=>({_tag:this._tag,expectedMinimumId:rr(this.expectedMinimumId),mergeContext:this.mergeContext.toJSON()})}class kP extends ha("MergeResultUnexpectedError")({_tag:Ne("unexpected-error"),cause:Re}){}class _oe extends ve(zu,Ib,EP,kP){}const Ob=e=>{if(Qs)debugger;return kP.make({_tag:"unexpected-error",cause:new Re({cause:e})})},$P=({syncState:e,payload:t,isClientEvent:n,isEqualEvent:r,ignoreClientEvents:s=!1})=>{TP(e),Vne(t);const o=Mg.make({payload:t,syncState:e});switch(t._tag){case"upstream-rebase":{const a=[...t.rollbackEvents,...e.pending],u=t.newEvents.at(-1)?.seqNum??e.upstreamHead,f=G$({events:e.pending,baseEventSequenceNumber:u,isClientEvent:n});return Zo(Ib.make({_tag:"rebase",newSyncState:new Gr({pending:f,upstreamHead:u,localHead:f.at(-1)?.seqNum??u}),newEvents:[...t.newEvents,...f],rollbackEvents:a,mergeContext:o}))}case"upstream-advance":{if(t.newEvents.length===0)return Zo(zu.make({_tag:"advance",newSyncState:new Gr({pending:e.pending,upstreamHead:e.upstreamHead,localHead:e.localHead}),newEvents:[],confirmedEvents:[],mergeContext:o}));for(let f=1;f<t.newEvents.length;f++)if(th(t.newEvents[f-1].seqNum,t.newEvents[f].seqNum))return Ob(`Events must be sorted in ascending order by event number. Received: [${t.newEvents.map(d=>rr(d.seqNum)).join(", ")}]`);if(th(e.upstreamHead,t.newEvents[0].seqNum)||xg(e.upstreamHead,t.newEvents[0].seqNum))return Ob(`Incoming events must be greater than upstream head. Expected greater than: ${rr(e.upstreamHead)}. Received: [${t.newEvents.map(f=>rr(f.seqNum)).join(", ")}]`);const a=t.newEvents.at(-1).seqNum,u=Rb({existingEvents:e.pending,incomingEvents:t.newEvents,isEqualEvent:r,isClientEvent:n,ignoreClientEvents:s});if(u===-1){const f=new Set(e.pending.map(C=>`${C.seqNum.global},${C.seqNum.client}`)),d=t.newEvents.filter(C=>!f.has(`${C.seqNum.global},${C.seqNum.client}`));let p=0;const[m,$]=JT(e.pending,(C,O)=>{if(s&&n(C))return p++,!1;const N=t.newEvents.at(O-p);return N?r(C,N)===!1:!0});return Zo(zu.make({_tag:"advance",newSyncState:new Gr({pending:$,upstreamHead:a,localHead:$.at(-1)?.seqNum??aP(e.localHead,a)}),newEvents:d,confirmedEvents:m,mergeContext:o}))}else{const f=e.pending.slice(u),d=G$({events:f,baseEventSequenceNumber:a,isClientEvent:n}),p=Rb({existingEvents:t.newEvents,incomingEvents:e.pending,isEqualEvent:r,isClientEvent:n,ignoreClientEvents:s});return Zo(Ib.make({_tag:"rebase",newSyncState:new Gr({pending:d,upstreamHead:a,localHead:d.at(-1).seqNum}),newEvents:[...t.newEvents.slice(p),...d],rollbackEvents:f,mergeContext:o}))}}case"local-push":{if(t.newEvents.length===0)return Zo(zu.make({_tag:"advance",newSyncState:e,newEvents:[],confirmedEvents:[],mergeContext:o}));const a=t.newEvents.at(0);if(th(a.seqNum,e.localHead)===!1){const f=oE(e.localHead,!0).seqNum;return Zo(EP.make({_tag:"reject",expectedMinimumId:f,mergeContext:o}))}else return Zo(zu.make({_tag:"advance",newSyncState:new Gr({pending:[...e.pending,...t.newEvents],upstreamHead:e.upstreamHead,localHead:t.newEvents.at(-1).seqNum}),newEvents:t.newEvents,confirmedEvents:[],mergeContext:o}))}default:Ys(t)}},Rb=({existingEvents:e,incomingEvents:t,isEqualEvent:n,isClientEvent:r,ignoreClientEvents:s})=>{if(s){const o=e.filter(f=>!r(f)),a=Rb({existingEvents:o,incomingEvents:t,isEqualEvent:n,isClientEvent:r,ignoreClientEvents:!1});if(a===-1)return-1;const u=e[a].seqNum;return e.findIndex(f=>xg(f.seqNum,u))}return e.findIndex((o,a)=>{const u=t[a];return u&&!n(o,u)})},G$=({events:e,baseEventSequenceNumber:t,isClientEvent:n})=>{let r=t;return e.map(s=>{const o=n(s),a=s.rebase(r,o);return r=a.seqNum,a})},Vne=e=>{for(let t=1;t<e.newEvents.length;t++)if(ea(e.newEvents[t-1].seqNum,e.newEvents[t].seqNum))return Ob(`Events must be ordered in monotonically ascending order by eventNum. Received: [${e.newEvents.map(n=>rr(n.seqNum)).join(", ")}]`)},TP=e=>{for(let t=0;t<e.pending.length;t++){const n=e.pending[t],r=e.pending[t+1];if(r===void 0)break;ea(n.seqNum,r.seqNum)&&we(`Events must be ordered in monotonically ascending order by eventNum. Received: [${e.pending.map(o=>rr(o.seqNum)).join(", ")}]`,{event:n,nextEvent:r}),r.seqNum.global>n.seqNum.global?r.seqNum.client!==0&&we(`New global events must point to clientId 0 in the parentSeqNum. Received: (${rr(r.seqNum)})`,e.pending,{event:n,nextEvent:r}):xg(r.parentSeqNum,n.seqNum)===!1&&we("Events must be linked in a continuous chain via the parentSeqNum",e.pending,{event:n,nextEvent:r})}},Zo=e=>(e._tag==="unexpected-error"||e._tag==="reject"||(TP(e.newSyncState),th(e.newSyncState.upstreamHead,e.newSyncState.localHead)&&we("Local head must be greater than or equal to upstream head",{localHead:e.newSyncState.localHead,upstreamHead:e.newSyncState.upstreamHead}),ea(e.newSyncState.localHead,e.mergeContext.syncState.localHead)===!1&&we("New local head must be greater than or equal to the previous local head",{localHead:e.newSyncState.localHead,previousLocalHead:e.mergeContext.syncState.localHead}),ea(e.newSyncState.upstreamHead,e.mergeContext.syncState.upstreamHead)===!1&&we("New upstream head must be greater than or equal to the previous upstream head",{upstreamHead:e.newSyncState.upstreamHead,previousUpstreamHead:e.mergeContext.syncState.upstreamHead})),e),Wne="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let Oi=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e|=0));for(;e--;)t+=Wne[n[e]&63];return t};const Lg="0.3.0",Q$=4,Kne=ne({isConnected:Xi,timestampMs:dt,latchClosed:Xi}),sh=j,Jne=j,oh=Ne(Lg),CP=(e,t)=>Fe(e,{liveStoreVersion:oh,...t}).annotations({identifier:e}),Gne=(e,t)=>CP(e,{clientId:Jne,...t}),qt=(e,t)=>Gne(e,{requestId:sh,...t}),dE=(e,t)=>{const n=Fe(`${e}.Response.Success`,{requestId:sh,liveStoreVersion:oh,...t.success}).annotations({identifier:`${e}.Response.Success`}),r=t.error?Fe(`${e}.Response.Error`,{requestId:sh,liveStoreVersion:oh,...t.error}).annotations({identifier:`${e}.Response.Error`}):Eg;return{Request:Fe(`${e}.Request`,{requestId:sh,liveStoreVersion:oh,...t.payload}).annotations({identifier:`${e}.Request`}),Response:ve(n,r),Success:n,Error:r}};class yoe extends qt("LSD.Leader.ResetAllDataReq",{mode:Ne("all-data","only-app-db")}){}class Qne extends qt("LSD.Leader.DatabaseFileInfoReq",{}){}class Y$ extends ne({fileSize:dt,persistenceInfo:ne({fileName:j},{key:j,value:on})}){}class IP extends qt("LSD.Leader.DatabaseFileInfoRes",{state:Y$,eventlog:Y$}){}class Yne extends qt("LSD.Leader.NetworkStatusSubscribe",{subscriptionId:j}){}class Xne extends qt("LSD.Leader.NetworkStatusUnsubscribe",{subscriptionId:j}){}class OP extends qt("LSD.Leader.NetworkStatusRes",{networkStatus:Kne,subscriptionId:j}){}class Zne extends qt("LSD.Leader.SyncingInfoReq",{}){}class RP extends ne({enabled:Xi,metadata:mu({key:j,value:on})}){}class qP extends qt("LSD.Leader.SyncingInfoRes",{syncingInfo:RP}){}class ere extends qt("LSD.Leader.SyncHistorySubscribe",{subscriptionId:j}){}class tre extends qt("LSD.Leader.SyncHistoryUnsubscribe",{subscriptionId:j}){}class AP extends qt("LSD.Leader.SyncHistoryRes",{eventEncoded:Lne,metadata:Og(Po),subscriptionId:j}){}class nre extends qt("LSD.Leader.SyncHeadSubscribe",{subscriptionId:j}){}class rre extends qt("LSD.Leader.SyncHeadUnsubscribe",{subscriptionId:j}){}class FP extends qt("LSD.Leader.SyncHeadRes",{local:mn,upstream:mn,subscriptionId:j}){}class sre extends qt("LSD.Leader.SnapshotReq",{}){}class PP extends qt("LSD.Leader.SnapshotRes",{snapshot:sc}){}const za=dE("LSD.Leader.LoadDatabaseFile",{payload:{data:sc},success:{},error:{cause:ve(Fe("unsupported-file",{}),Fe("unsupported-database",{}),Fe("unexpected-error",{cause:Ac}))}});class xP extends CP("LSD.Leader.SyncPull",{payload:vP}){}class ore extends qt("LSD.Leader.CommitEventReq",{eventEncoded:jne}){}class NP extends qt("LSD.Leader.CommitEventRes",{}){}class ire extends qt("LSD.Leader.EventlogReq",{}){}class DP extends qt("LSD.Leader.EventlogRes",{eventlog:sc}){}class are extends qt("LSD.Leader.Ping",{}){}class MP extends qt("LSD.Leader.Pong",{}){}class LP extends qt("LSD.Leader.Disconnect",{}){}const hE=dE("LSD.Leader.SetSyncLatch",{payload:{closeLatch:Xi},success:{}}),pE=dE("LSD.Leader.ResetAllData",{payload:{mode:Ne("all-data","only-app-db")},success:{}}),jP=ve(sre,za.Request,ire,pE.Request,Yne,Xne,LP,ore,are,Qne,ere,tre,Zne,nre,rre,hE.Request).annotations({identifier:"LSD.Leader.MessageToApp"}),cre=ve(PP,za.Response,DP,LP,xP,OP,NP,MP,IP,AP,qP,FP,pE.Success,hE.Success).annotations({identifier:"LSD.Leader.MessageFromApp"}),ure=ve(Fe("node",{url:j}),Fe("web",{}),Fe("browser-extension",{}));ure.pipe(qc("_tag"),fs);const lre={client:{session:({storeId:e,clientId:t,sessionId:n})=>`client-session-${e}-${t}-${n}`,leader:({storeId:e,clientId:t})=>`client-leader-${e}-${t}`}},fre={sessionInfo:()=>"session-info",devtoolsClientSession:({storeId:e,clientId:t,sessionId:n})=>`devtools-channel(client-session-${e}-${t}-${n})`,devtoolsClientLeader:({storeId:e,clientId:t,sessionId:n})=>`devtools-channel(client-leader-${e}-${t}-${n})`},dre={devtoolsClientSession:(e,{storeId:t,clientId:n,sessionId:r})=>e===fre.devtoolsClientSession({storeId:t,clientId:n,sessionId:r}),devtoolsClientLeader:(e,{storeId:t,clientId:n})=>e.startsWith(`devtools-channel(client-leader-${t}-${n}`)},od=j.pipe(Sn,dF({constructor:()=>Oi(10),decoding:()=>Oi(10)})),ma={id:od,target:j,source:j,channelName:j,hops:De(j)},UP=oF.pipe(Sn);class ih extends Fe("DirectChannelRequest",{...ma,remainingHops:De(j).pipe(Sn),channelVersion:dt,reqId:Rv(j),sourceId:j}){}class zP extends Fe("DirectChannelResponseSuccess",{...ma,reqId:j,port:Fg,remainingHops:De(j),channelVersion:dt}){}class mE extends Fe("DirectChannelResponseNoTransferables",{...ma,reqId:j,remainingHops:De(j)}){}class BP extends Fe("ProxyChannelRequest",{...ma,remainingHops:UP,channelIdCandidate:j}){}class HP extends Fe("ProxyChannelResponseSuccess",{...ma,reqId:j,remainingHops:De(j),combinedChannelId:j,channelIdCandidate:j}){}class VP extends Fe("ProxyChannelPayload",{...ma,remainingHops:UP,payload:on,combinedChannelId:j}){}class WP extends Fe("ProxyChannelPayloadAck",{...ma,reqId:j,remainingHops:De(j),combinedChannelId:j}){}class qb extends Fe("NetworkEdgeAdded",{id:od,source:j,target:j}){}class Ab extends Fe("NetworkTopologyRequest",{id:od,hops:De(j),source:j,target:Ne("-")}){}class Fb extends Fe("NetworkTopologyResponse",{id:od,reqId:j,remainingHops:De(j),nodeName:j,edges:De(j),source:j,target:Ne("-")}){}const ah=Fe("BroadcastChannelPacket",{id:od,channelName:j,payload:on,hops:De(j),source:j,target:Ne("-")});class Pb extends ve(ih,zP,mE){}class KP extends ve(BP,HP,VP,WP){}class JP extends ve(Pb,KP,qb,Ab,Fb,ah){}class Ad extends Fe("DirectChannelPing",{}){}class Fd extends Fe("DirectChannelPong",{}){}class hre extends Lr()("EdgeAlreadyExistsError",{target:j}){}const rl=e=>({packetId:e.id,"span.label":e.id+(X(e,"reqId")&&e.reqId!==void 0?` for ${e.reqId}`:""),...e._tag!=="DirectChannelResponseSuccess"&&e._tag!=="ProxyChannelPayload"?{packet:e}:{}});ne({channelName:j,source:j,mode:ve(Ne("proxy"),Ne("direct"))});const pre=Ue,mre=({nodeName:e,incomingPacketsQueue:t,target:n,checkTransferableEdges:r,channelName:s,schema:o,sendPacket:a,channelVersion:u,scope:f,sourceId:d})=>z(function*(){const p=yield*pre(),m=yield*Yv.pipe(Gm(()=>We(void 0))),$={send:ve(o.send,Ad,Fd),listen:ve(o.listen,Ad,Fd)},C={current:{_tag:"Initial"}},O=({packet:g,respondToSender:E})=>z(function*(){const k=C.current;if(m?.addEvent(`process:${g._tag}`,{channelState:k._tag,packetId:g.id,packetReqId:g.reqId,packetChannelVersion:X("channelVersion")(g)?g.channelVersion:void 0}),k._tag==="Initial")return we();if(g._tag==="DirectChannelResponseNoTransferables")return yield*p1(p,g),"close";if(g.channelVersion>u)return m?.addEvent(`incoming packet has higher version (${g.channelVersion}), closing channel`),yield*ln(f,Mt("higher-version-expected")),"close";if(g.channelVersion<u){const R=ih.make({source:e,sourceId:d,target:n,channelName:s,channelVersion:u,hops:[],remainingHops:g.hops,reqId:void 0});m?.addEvent(`incoming packet has lower version (${g.channelVersion}), sending request to reconnect (${R.id})`),yield*a(R);return}if(k._tag==="Established"&&g._tag==="DirectChannelRequest")return g.sourceId===k.otherSourceId?void 0:(m?.addEvent("force-new-channel"),yield*ln(f,Mt("force-new-channel")),"close");switch(g._tag){case"DirectChannelRequest":{if(k._tag!=="RequestSent")return;if(g.reqId!==k.reqPacketId){const q=ih.make({source:e,sourceId:d,target:n,channelName:s,channelVersion:u,hops:[],remainingHops:g.hops,reqId:g.id});m?.addEvent(`Re-sending new request (${q.id}) for incoming request (${g.id})`),yield*a(q)}if(e>n){m?.addEvent("winner side: creating direct channel and sending response");const q=new MessageChannel,x=yield*H$({port:q.port1,schema:$,debugId:u}).pipe(Jr(V$));yield*E(zP.make({reqId:g.id,target:n,source:e,channelName:g.channelName,hops:[],remainingHops:g.hops.slice(0,-1),port:q.port2,channelVersion:u})),C.current={_tag:"winner:ResponseSent",channel:x,otherSourceId:g.sourceId},yield*x.listen.pipe(Ul(),Fo(yn(Ad)),fp(1),hn),yield*x.send(Fd.make({})),m?.addEvent("winner side: established"),C.current={_tag:"Established",otherSourceId:g.sourceId},yield*vt(p,x)}else m?.addEvent("loser side: waiting for response"),C.current={_tag:"loser:WaitingForResponse",otherSourceId:g.sourceId};break}case"DirectChannelResponseSuccess":{if(k._tag!=="loser:WaitingForResponse")return we(`Expected to find direct channel response from ${n}, but was in ${k._tag} state`);const R=yield*H$({port:g.port,schema:$,debugId:u}).pipe(Jr(V$)),q=yield*R.listen.pipe(Ul(),Fo(yn(Fd)),fp(1),hn,jw);yield*R.send(Ad.make({})).pipe(zw(10),jR({times:2})),yield*q,m?.addEvent("loser side: established"),C.current={_tag:"Established",otherSourceId:k.otherSourceId},yield*vt(p,R);return}default:return Ys(g)}}).pipe(Te(`handleMessagePacket:${g._tag}:${g.source}→${g.target}`,{attributes:rl(g)}));yield*z(function*(){for(;;){const g=yield*Ro(t);if((yield*O(g))==="close")return}}).pipe(Rt,Et,Bt);const N=C.current;return N._tag!=="Initial"?we(`Expected channel to be in Initial state, but was in ${N._tag} state`):(yield*z(function*(){const g=ih.make({source:e,sourceId:d,target:n,channelName:s,channelVersion:u,hops:[],reqId:void 0});C.current={_tag:"RequestSent",reqPacketId:g.id};const E=r(g);if(E!==void 0)return yield*Xn(`No transferable edges found for ${g.source}→${g.target}`),yield*Er(E);yield*a(g),m?.addEvent(`initial edge request sent (${g.id})`)}),yield*p)}).pipe(Vf(`makeDirectChannel:${u}`)),gre=({schema:e,newEdgeAvailablePubSub:t,channelName:n,checkTransferableEdges:r,nodeName:s,incomingPacketsQueue:o,target:a,sendPacket:u})=>gu(f=>z(function*(){const d=Oi(),p=yield*fn(),m=yield*n9(),$=yield*Ue(),C={pendingSends:0,totalSends:0,connectCounter:0,isConnected:!1,innerChannelRef:{current:void 0}};yield*z(function*(){const E=yield*Ue();for(;;){C.connectCounter++;const x=C.connectCounter;yield*Xn(`Connecting#${x}`);const D=yield*Aw();yield*xr(Z=>ln(D,Z));const G=yield*$F(t).pipe(xn(Z=>Xn(`new-conn:${Z}`)),fp(1),hn,Ms("new-edge"),jw),P=mre({nodeName:s,sourceId:d,incomingPacketsQueue:o,target:a,checkTransferableEdges:r,channelName:n,schema:e,channelVersion:x,sendPacket:u,scope:D}).pipe(Rw(D),nr(D),f8(H())),L=yield*VR(P,G.pipe(QK));if(L==="new-edge")yield*ln(D,Of("new-edge"));else{const Z=yield*L.pipe(jt);if(Z._tag==="Failure")yield*ln(D,Z),YO(Z.cause)&&yn(mE)(Z.cause.error)&&(yield*G.pipe(jt));else{const ae=Z.value;yield*vt(E,{channel:ae,makeDirectChannelScope:D,channelVersion:x});break}}}const{channel:k,makeDirectChannelScope:R,channelVersion:q}=yield*E;yield*Xn(`Connected#${q}`),C.isConnected=!0,C.innerChannelRef.current=k,yield*vt($,void 0),yield*k.listen.pipe(Ul(),IF(x=>rv(p,x)),hn,Et,nr(R)),yield*z(function*(){for(;;){const[x,D]=yield*e9(m);yield*k.send(x),yield*vt(D,void 0),yield*t9(m)}}).pipe(nr(R)),yield*k.closedDeferred,yield*ln(R,Mt("channel-closed")),yield*Xn(`Disconnected#${q}`),C.isConnected=!1,C.innerChannelRef.current=void 0}).pipe(Qi,Hw,Et,Bt);const O=yield*Zm.pipe(gr),N=E=>z(function*(){const k=yield*Ue();C.pendingSends++,C.totalSends++,yield*ZQ(m,[E,k]),yield*k,C.pendingSends--}).pipe(Qi,hi(O)),v=Gs(p,{maxChunkSize:1}).pipe(Wo(ie)),w=yield*Ue().pipe(it(ua(Un)));return{webChannel:{[zn]:zn,send:N,listen:v,closedDeferred:w,supportsTransferables:!0,schema:e,debugInfo:C,shutdown:ln(f,Mt("shutdown"))},initialEdgeDeferred:$}})),_re=({queue:e,nodeName:t,newEdgeAvailablePubSub:n,sendPacket:r,target:s,channelName:o,schema:a})=>gu(u=>z(function*(){const f={current:{_tag:"Initial"}},d={kind:"proxy-channel",pendingSends:0,totalSends:0,connectCounter:0,isConnected:!1},p=Oi(5);yield*Uy({channelIdCandidate:p});const m=yield*Zm.pipe(gr),$=yield*dp(!1),C=z(function*(){return yield*zl($,L=>L!==!1)}),O=P=>z(function*(){yield*Xn(`Connected (${P})`).pipe(hi(m)),f.current={_tag:"Established",listenSchema:a.listen,listenQueue:E,ackMap:k,combinedChannelId:P},yield*Zr($,f.current),d.isConnected=!0}),N=ut(()=>r(BP.make({channelName:o,hops:[],source:t,target:s,channelIdCandidate:p}))),v=P=>[p,P].sort().join("_"),w=yield*fn().pipe(it(Lt)),g=({packet:P,respondToSender:L})=>z(function*(){const ae=`target:${P.source}, channelName:${P.channelName}`,K=f.current;switch(P._tag){case"ProxyChannelRequest":{const Ee=v(P.channelIdCandidate);K._tag==="Established"?K.combinedChannelId===Ee||(yield*Cs(`[${t}] Received ProxyChannelRequest with different channel ID (${Ee}) while established with ${K.combinedChannelId}. Re-establishing.`),yield*Zr($,!1),f.current={_tag:"Pending",initiatedVia:"incoming-request"},yield*Xn("Reconnecting (received conflicting ProxyChannelRequest)").pipe(hi(m)),d.isConnected=!1,d.connectCounter++,yield*N):K._tag==="Initial"&&(yield*Zr($,!1),f.current={_tag:"Pending",initiatedVia:"incoming-request"},yield*Xn("Connecting (received ProxyChannelRequest)").pipe(hi(m)),d.isConnected=!1,d.connectCounter++),yield*L(HP.make({reqId:P.id,remainingHops:P.hops,hops:[],target:s,source:t,channelName:o,combinedChannelId:Ee,channelIdCandidate:p}));return}case"ProxyChannelResponseSuccess":{if(K._tag!=="Pending"){if(K._tag==="Established"&&K.combinedChannelId!==P.combinedChannelId)return we(`ProxyChannel[${ae}]: Expected proxy channel to have the same combinedChannelId as the packet:
${K.combinedChannelId} (channel) === ${P.combinedChannelId} (packet)`);if(K._tag==="Established")return;yield*Cs(`[${t}] Ignoring ResponseSuccess ${P.id} received in unexpected state ${K._tag}`);return}const Ee=v(P.channelIdCandidate);if(Ee!==P.combinedChannelId)return yield*Gi(`ProxyChannel[${ae}]: Expected proxy channel to have the same combinedChannelId as the packet:
${Ee} (channel) === ${P.combinedChannelId} (packet)`);yield*O(P.combinedChannelId);const Ce=f.current;if(Ce._tag==="Established"){const Je=yield*PJ(w);for(const Ie of Je){if(Ce.combinedChannelId!==Ie.combinedChannelId){yield*Cs(`[${t}] Discarding buffered payload ${Ie.id}: Combined channel ID mismatch during drain. Expected ${Ce.combinedChannelId}, got ${Ie.combinedChannelId}`);continue}const et=yield*Rc(Ce.listenSchema)(Ie.payload);yield*Ce.listenQueue.pipe(Ge(et))}}else yield*Fl(`[${t}] State is not Established immediately after setStateToEstablished was called. Cannot drain buffer. State: ${Ce._tag}`);return}case"ProxyChannelPayload":{if(K._tag==="Established"&&K.combinedChannelId!==P.combinedChannelId)return yield*Gi(`ProxyChannel[${ae}]: Expected proxy channel to have the same combinedChannelId as the packet:
${K.combinedChannelId} (channel) === ${P.combinedChannelId} (packet)`);if(yield*L(WP.make({reqId:P.id,remainingHops:P.hops,hops:[],target:s,source:t,channelName:o,combinedChannelId:K._tag==="Established"?K.combinedChannelId:P.combinedChannelId})),K._tag==="Established"){const Ee=yield*Rc(K.listenSchema)(P.payload);yield*K.listenQueue.pipe(Ge(Ee))}else yield*Ge(w,P);return}case"ProxyChannelPayloadAck":{if(K._tag!=="Established"){yield*Xn(`Not yet connected to ${s}. dropping message`),yield*Cs(`[${t}] Received Ack but not established (State: ${K._tag}). Dropping Ack for ${P.reqId}`);return}const Ee=K.ackMap.get(P.reqId)??we(`[ProxyChannel[${ae}]] Expected ack for ${P.reqId}`);yield*vt(Ee,void 0),K.ackMap.delete(P.reqId);return}default:return Ys(P)}}).pipe(Te(`handleProxyPacket:${P._tag}:${P.source}->${P.target}`,{attributes:rl(P)}));yield*Gs(e).pipe(xn(g),hn,Et,Bt);const E=yield*fn();yield*Xn("Connecting");const k=new Map;{if(f.current._tag!=="Initial")return we("Expected proxy channel to be Initial");f.current={_tag:"Pending",initiatedVia:"outgoing-request"},yield*N;const P=yield*$F(n).pipe(xn(()=>N),hn,Bt),{combinedChannelId:L}=yield*C;yield*Sr(P),yield*O(L)}const R=P=>z(function*(){const L=yield*tF(a.send)(P),Z=yield*DA(),ae=yield*Ue();d.pendingSends++,d.totalSends++;const K=z(function*(){const{combinedChannelId:Ce}=yield*zl($,Ie=>Ie!==!1);yield*z(function*(){const Ie=yield*Ue(),et=VP.make({channelName:o,payload:L,hops:[],source:t,target:s,combinedChannelId:Ce});k.set(et.id,Ie),yield*r(et),yield*Ie,yield*vt(ae,void 0),d.pendingSends--}).pipe(zw(100),jR(jG(10)),gr)}).pipe(Hf(Fl)),Ee=yield*$.changes.pipe(Fo(Ce=>Ce===!1),xn(()=>ep(Z,K)),hn,jw);yield*ep(Z,K),yield*ae,yield*Sr(Ee)}).pipe(Qi,Te("sendAckWithRetry:ProxyChannelPayload"),hi(m)),q=Gs(E).pipe(Wo(ie)),x=yield*Ue().pipe(it(ua(Un))),D=yield*Bo();return{[zn]:zn,send:R,listen:q,closedDeferred:x,supportsTransferables:!1,schema:a,shutdown:ln(u,Un),debugInfo:d,debug:{ping:(P="ping")=>R(Jl.make({message:P})).pipe(qn(D),Et,Ho)}}}).pipe(Vf("makeProxyChannel")));class gE{values=new Map;timeoutHandle;timeoutMs;constructor({timeout:t}){this.timeoutMs=cc(t)}static make=t=>z(function*(){const n=new gE({timeout:t});return yield*xr(()=>$e(()=>n.onShutdown())),n});add(t){this.values.set(t,Date.now()),this.scheduleCleanup()}has(t){return this.values.has(t)}delete(t){this.values.delete(t)}scheduleCleanup(){this.timeoutHandle===void 0&&(this.timeoutHandle=setTimeout(()=>{this.cleanup(),this.timeoutHandle=void 0},this.timeoutMs))}cleanup(){const t=Date.now();for(const[n,r]of this.values.entries())t-r>=this.timeoutMs&&this.values.delete(n)}onShutdown=()=>clearTimeout(this.timeoutHandle)}const yre=e=>z(function*(){const t=new Map,n=yield*gE.make(GC(1)),r=yield*aq().pipe(it(By)),s=new Map,o=yield*fn().pipe(it(Lt)),a=new Map,u=new Map,f=k=>{if(k._tag==="DirectChannelRequest"&&(t.size===0||t.get(k.target)?.channel.supportsTransferables===!1)||![...t.values()].some(R=>R.channel.supportsTransferables===!0))return mE.make({reqId:k.id,channelName:k.channelName,source:k.target,target:k.source,remainingHops:k.hops,hops:[]})},d=k=>z(function*(){if(yn(qb)(k)){yield*Xn("NetworkEdgeAdded",{packet:k,nodeName:e}),yield*nv(r,k.target);const R=Array.from(t).filter(([q])=>q!==k.source).map(([q,x])=>x.channel);yield*dn(R,q=>q.send(k),{concurrency:"unbounded"});return}if(yn(ah)(k)){const R=Array.from(t).filter(([D])=>!k.hops.includes(D)).map(([D,G])=>G.channel),q={...k,hops:[...k.hops,e]};if(yield*dn(R,D=>D.send(q),{concurrency:"unbounded"}),k.source===e)return;const x=u.get(k.channelName);x!==void 0&&(yield*Ge(x,k));return}if(yn(Ab)(k)){if(k.source!==e){const x=k.hops.at(-1)??we(`${e}: Expected hops for packet`,k),D=t.get(x).channel,G=Fb.make({reqId:k.id,source:k.source,target:k.target,remainingHops:k.hops.slice(0,-1),nodeName:e,edges:Array.from(t.keys())});yield*D.send(G)}const R=Array.from(t).filter(([x])=>!k.hops.includes(x)).map(([x,D])=>D.channel),q={...k,hops:[...k.hops,e]};yield*dn(R,x=>x.send(q),{concurrency:"unbounded"});return}if(yn(Fb)(k)){if(k.source===e)a.get(k.reqId).set(k.nodeName,new Set(k.edges));else{const q=k.remainingHops.at(-1)??we(`${e}: Expected remaining hops for packet`,k);yield*(t.get(q)?.channel??we(`${e}: Expected edge channel (${q}) for packet`,k,"Available edges:",Array.from(t.keys()))).send({...k,remainingHops:k.remainingHops.slice(0,-1)})}return}if(t.has(k.target)){const R=t.get(k.target).channel,q=k.source===e?[]:[...k.hops,e];yield*Uy({hasDirectEdge:!0}),yield*R.send({...k,hops:q})}else if(k.remainingHops!==void 0){const R=k.remainingHops.at(-1)??we(`${e}: Expected remaining hops for packet`,k),q=t.get(R)?.channel;if(q===void 0){yield*Cs(`${e}: Expected to find hop target ${R} in edges. Dropping packet.`,k);return}yield*q.send({...k,remainingHops:k.remainingHops.slice(0,-1),hops:[...k.hops,e]})}else{const R=k.source===e?[]:[...k.hops,e],q=Array.from(t).filter(([D])=>D!==k.source).map(([D,G])=>({name:D,channel:G.channel}));R.length===0&&q.length===0&&Qs&&(yield*Cs(e,"no route found to",k.target,k._tag,"TODO handle better"));const x={...k,hops:R};yield*Uy({edgesToForwardTo:q.map(({name:D})=>D)}),yield*dn(q,({channel:D})=>D.send(x),{concurrency:"unbounded"})}}).pipe(Te(`sendPacket:${k._tag}:${k.source}→${k.target}`,{attributes:rl(k)}),gr),p=({target:k,edgeChannel:R,replaceIfExists:q=!1})=>z(function*(){if(t.has(k))if(q)yield*m(k).pipe(gr);else return yield*new hre({target:k});const x=yield*R.listen.pipe(Ul(),xn(G=>z(function*(){const P=yield*Rc(JP)(G);if(!n.has(P.id))switch(n.add(P.id),P._tag){case"NetworkEdgeAdded":case"NetworkTopologyRequest":case"NetworkTopologyResponse":{yield*d(P);break}default:if(P.target===e){const L=`target:${P.source}, channelName:${P.channelName}`;if(!s.has(L)){const K=yield*fn().pipe(it(Lt));s.set(L,{queue:K,debugInfo:void 0})}const Z=s.get(L).queue,ae=K=>R.send(K).pipe(Te(`respondToSender:${K._tag}:${K.source}→${K.target}`,{attributes:rl(K)}),gr);yn(KP)(P)?yield*Ge(Z,{packet:P,respondToSender:ae}):yn(Pb)(P)&&(yield*Ge(Z,{packet:P,respondToSender:ae})),(P._tag==="ProxyChannelRequest"||P._tag==="DirectChannelRequest")&&(yield*Ge(o,{channelName:P.channelName,source:P.source,mode:P._tag==="ProxyChannelRequest"?"proxy":"direct"}))}else{if(yn(Pb)(P)){const L=f(P);if(L!==void 0)return yield*Xn(`No transferable edges found for ${P.source}→${P.target}`),yield*R.send(L).pipe(Te(`sendNoTransferableResponse:${P.source}→${P.target}`,{attributes:rl(L)}))}yield*d(P)}}})),hn,Rt,gr,Et,Bt);t.set(k,{channel:R,listenFiber:x});const D=qb.make({source:e,target:k});yield*d(D).pipe(gr)}).pipe(Ya({"addEdge:target":k,nodeName:e}),Te(`addEdge:${e}→${k}`,{attributes:{supportsTransferables:R.supportsTransferables}})),m=k=>z(function*(){t.has(k)||(yield*new Bm(`No edge found for ${k}`)),yield*Sr(t.get(k).listenFiber),t.delete(k)}),$=({target:k,channelName:R})=>$e(()=>s.has(`target:${k}, channelName:${R}`)),C=({target:k,channelName:R,schema:q,mode:x,timeout:D=cS(1),closeExisting:G=!1})=>z(function*(){const P=Pg(q),L=`target:${k}, channelName:${R}`;if(s.has(L)){const ae=s.get(L).debugInfo?.channel;ae&&(G?(yield*ae.shutdown,s.delete(L)):we(`Channel ${L} already exists`,ae))}if(s.has(L)===!1){const ae=yield*fn().pipe(it(Lt));s.set(L,{queue:ae,debugInfo:void 0})}const Z=s.get(L).queue;if(yield*xr(()=>$e(()=>s.delete(L))),x==="direct"){const ae=yield*fn().pipe(it(Lt));yield*cq(Z,1,10).pipe(Js(Ce=>rv(ae,Ce)),Hw,Rt,Et,Bt);const{webChannel:K,initialEdgeDeferred:Ee}=yield*gre({nodeName:e,incomingPacketsQueue:ae,newEdgeAvailablePubSub:r,target:k,channelName:R,schema:P,sendPacket:d,checkTransferableEdges:f});return s.set(L,{queue:Z,debugInfo:{channel:K,target:k}}),yield*Ee,K}else{const ae=yield*_re({nodeName:e,newEdgeAvailablePubSub:r,target:k,channelName:R,schema:P,queue:Z,sendPacket:d});return s.set(L,{queue:Z,debugInfo:{channel:ae,target:k}}),ae}}).pipe(Vf(`makeChannel:${e}→${k}(${R})`,{attributes:{target:k,channelName:R,mode:x,timeout:D}}),Ya({nodeName:e,target:k,channelName:R}));let O=!1;const N=TF(()=>{if(O)return we("listenForChannel already started");O=!0;const k=q=>`${q.channelName}:${q.source}:${q.mode}`,R=new Set;return Gs(o).pipe(Fo(q=>{const x=k(q);return R.has(x)?!1:(R.add(x),!0)}))}),v=({channelName:k,schema:R})=>gu(q=>z(function*(){if(u.has(k))return we(`Broadcast channel ${k} already exists`,u.get(k));const x={},D=yield*fn().pipe(it(Lt));u.set(k,D);const G=Z=>z(function*(){const ae=yield*rd(R)(Z),K=ah.make({channelName:k,payload:ae,source:e,target:"-",hops:[]});yield*d(K)}),P=Gs(D).pipe(Fo(yn(ah)),Wo(Z=>vg(R)(Z.payload))),L=yield*Ue().pipe(it(ua(Un)));return{[zn]:zn,send:G,listen:P,closedDeferred:L,supportsTransferables:!1,schema:{listen:R,send:R},shutdown:ln(q,Un),debugInfo:x}})),w=$e(()=>new Set(t.keys())),g=yield*Bo();return{nodeName:e,addEdge:p,removeEdge:m,hasChannel:$,makeChannel:C,listenForChannel:N,makeBroadcastChannel:v,edgeKeys:w,debug:{print:()=>{console.log("Webmesh debug info for node:",e),console.log("Edges:",t.size);for(const[k,R]of t)console.log(`  ${k}: supportsTransferables=${R.channel.supportsTransferables}`);console.log("Channels:",s.size);for(const[k,R]of s)console.log(Id(k,2),`
`,Object.entries({target:R.debugInfo?.target,supportsTransferables:R.debugInfo?.channel.supportsTransferables,...R.debugInfo?.channel.debugInfo}).map(([q,x])=>Id(`${q}=${x}`,4)).join(`
`),"    ",R.debugInfo?.channel,`
`,Id(`Queue: ${R.queue.unsafeSize().pipe(hr)}`,4),R.queue);console.log("Broadcast channels:",u.size);for(const[k,R]of u)console.log(Id(k,2))},ping:k=>{z(function*(){const R=q=>Jl.make({message:`ping from ${e} via ${q}`,payload:k});for(const[q,x]of t)yield*Vr(`sending ping via edge ${q}`),yield*x.channel.send(R(`edge ${q}`));for(const[q,x]of s){if(x.debugInfo===void 0){yield*Vr(`channel ${q} has no debug info`);continue}yield*Vr(`sending ping via channel ${q}`),yield*x.debugInfo.channel.send(R(`channel ${q}`))}}).pipe(qn(g),Et,Ho)},requestTopology:(k=1e3)=>z(function*(){const R=Ab.make({source:e,target:"-",hops:[]}),q=new Map;q.set(e,new Set(t.keys())),a.set(R.id,q),yield*d(R),yield*Vr(`Waiting ${k}ms for topology response`),yield*Ym(k),yield*Vr(`Topology response (from ${e}):`);for(const[x,D]of q)yield*Vr(`  node '${x}' has edge to: ${Array.from(D.values()).join(", ")}`)}).pipe(qn(g),Et,WR)}}}).pipe(Te(`makeMeshNode:${e}`),Ya({"makeMeshNode.nodeName":e})),GP=(e,{foreignKeys:t,lockingMode:n})=>id(e,mt`
    -- disable WAL until we have it working properly
    -- PRAGMA journal_mode=WAL;
    PRAGMA page_size=8192;
    PRAGMA foreign_keys=${"ON"};
    ${n===void 0?"":mt`PRAGMA locking_mode=${n};`}
  `,{}),id=(e,t,n)=>{const r=Ti(n,t);return zo({try:()=>e.execute(t,r),catch:s=>new Ua({cause:s,query:{bindValues:r,sql:t},code:s.code})}).pipe(ls,Te("@livestore/common:execSql",{attributes:{"span.label":t,sql:t,bindValueKeys:Object.keys(r)}}))},bre=(e,t,n)=>zo({try:()=>e.execute(t,n),catch:r=>new Ua({cause:r,query:{bindValues:n,sql:t},code:r.code})}).pipe(ls,Te("@livestore/common:execSqlPrepared",{attributes:{"span.label":t,sql:t,bindValueKeys:Object.keys(n)}})),Sre=Fe("Skip",{}),wre=Fe("Blocking",{timeout:ve(uX,dt)});ve(Sre,wre);class xt extends iS("LeaderThreadCtx")(){}class vre extends ve(Cb,Re){}const Ere=e=>z(function*(){if(e.enabled===!1)return;const{syncProcessor:t,extraIncomingMessagesQueue:n,clientId:r,storeId:s}=yield*xt;yield*X$({incomingMessages:Gs(n),sendMessage:()=>me}).pipe(Et,Bt);const{node:o,persistenceInfo:a,mode:u}=yield*e.boot;yield*o.listenForChannel.pipe(Fo(f=>dre.devtoolsClientLeader(f.channelName,{storeId:s,clientId:r})&&f.mode===u),xn(({channelName:f,source:d})=>z(function*(){const p=yield*o.makeChannel({target:d,channelName:f,schema:{listen:jP,send:cre},mode:u}),m=O=>p.send(O).pipe(Te("@livestore/common:leader-thread:devtools:sendToDevtools"),Rt,zf),$=yield*t.syncState,C=t.getMergeCounter();yield*t.pull({cursor:{mergeCounter:C,eventNum:$.localHead}}).pipe(xn(({payload:O})=>m(xP.make({payload:O,liveStoreVersion:Lg}))),hn,Bt),yield*X$({incomingMessages:p.listen.pipe(Ul(),iZ),sendMessage:m,persistenceInfo:a})}).pipe(Et,Bt)),hn)}).pipe(Te("@livestore/common:leader-thread:devtools:boot")),X$=({incomingMessages:e,sendMessage:t,persistenceInfo:n})=>z(function*(){const{syncBackend:r,makeSqliteDb:s,dbState:o,dbEventlog:a,shutdownStateSubRef:u,shutdownChannel:f,syncProcessor:d,clientId:p,devtools:m}=yield*xt,$=yield*E7(),C=new Set;yield*e.pipe(xn(O=>z(function*(){const{requestId:N}=O,v={requestId:N,liveStoreVersion:Lg,clientId:p};if(O._tag!=="LSD.Leader.Disconnect"&&!C.has(N))switch(C.add(N),O._tag){case"LSD.Leader.Ping":{yield*t(MP.make({...v}));return}case"LSD.Leader.SnapshotReq":{const w=o.export();yield*t(PP.make({snapshot:w,...v}));return}case"LSD.Leader.LoadDatabaseFile.Request":{const{data:w}=O;let g;try{const E=yield*s({_tag:"in-memory"});E.import(w);const k=E.select("select name from sqlite_master where type = 'table'");g=new Set(k.map(R=>R.name)),E.close()}catch(E){yield*Fl("Error importing database file",E),yield*t(za.Error.make({...v,cause:{_tag:"unexpected-error",cause:E}}));return}try{if(g.has(ds))yield*Zr(u,"shutting-down"),a.import(w),o.destroy();else if(g.has(Dg)&&g.has(bp))yield*Zr(u,"shutting-down"),o.import(w),a.destroy();else{yield*t(za.Error.make({...v,cause:{_tag:"unsupported-database"}}));return}yield*t(za.Success.make({...v})),yield*f.send(Cb.make({reason:"devtools-import"}))??me;return}catch(E){yield*Fl("Error importing database file",E),yield*t(za.Error.make({...v,cause:{_tag:"unexpected-error",cause:E}}));return}}case"LSD.Leader.ResetAllData.Request":{const{mode:w}=O;yield*Zr(u,"shutting-down"),o.destroy(),w==="all-data"&&a.destroy(),yield*t(pE.Success.make({...v})),yield*f.send(Cb.make({reason:"devtools-reset"}))??me;return}case"LSD.Leader.DatabaseFileInfoReq":{if(n===void 0){console.log("[@livestore/common:leader-thread:devtools] persistenceInfo is required for this request");return}const w="SELECT page_count * page_size as size FROM pragma_page_count(), pragma_page_size();",g=o.select(w,void 0)[0].size,E=a.select(w,void 0)[0].size;yield*t(IP.make({state:{fileSize:g,persistenceInfo:n.state},eventlog:{fileSize:E,persistenceInfo:n.eventlog},...v}));return}case"LSD.Leader.EventlogReq":{const w=a.export();yield*t(DP.make({eventlog:w,...v}));return}case"LSD.Leader.CommitEventReq":{yield*d.pushPartial({event:O.eventEncoded,clientId:`devtools-${p}`,sessionId:`devtools-${p}`}),yield*t(NP.make({...v}));return}case"LSD.Leader.SyncHistorySubscribe":{const{subscriptionId:w}=O;r!==void 0&&(yield*r.pull(H()).pipe(Wo(g=>g.batch),ZX,xn(({eventEncoded:g,metadata:E})=>t(AP.make({eventEncoded:g,metadata:E,subscriptionId:w,...v,requestId:Oi(10)}))),hn,Rt,Et,w_($,w)));return}case"LSD.Leader.SyncHistoryUnsubscribe":{const{requestId:w}=O;console.log("LSD.SyncHistoryUnsubscribe",w),yield*S_($,w);return}case"LSD.Leader.SyncingInfoReq":{const w=RP.make({enabled:r!==void 0,metadata:r?.metadata??{}});yield*t(qP.make({syncingInfo:w,...v}));return}case"LSD.Leader.NetworkStatusSubscribe":{if(r!==void 0){const{subscriptionId:w}=O;yield*Ym(1e3),yield*pZ(r.isConnected.changes,m.enabled?m.syncBackendLatchState.changes:tZ({latchClosed:!1})).pipe(xn(([g,{latchClosed:E}])=>t(OP.make({networkStatus:{isConnected:g,timestampMs:Date.now(),latchClosed:E},subscriptionId:w,...v,requestId:Oi(10)}))),hn,Rt,Et,w_($,w))}return}case"LSD.Leader.NetworkStatusUnsubscribe":{const{requestId:w}=O;yield*S_($,w);return}case"LSD.Leader.SyncHeadSubscribe":{const{subscriptionId:w}=O;yield*d.syncState.changes.pipe(xn(g=>t(FP.make({local:g.localHead,upstream:g.upstreamHead,subscriptionId:w,...v,requestId:Oi(10)}))),hn,Rt,Et,w_($,w));return}case"LSD.Leader.SyncHeadUnsubscribe":{const{subscriptionId:w}=O;yield*S_($,w);return}case"LSD.Leader.SetSyncLatch.Request":{const{closeLatch:w}=O;if(m.enabled===!1)return;w===!0?yield*m.syncBackendLatch.close:yield*m.syncBackendLatch.open,yield*Zr(m.syncBackendLatchState,{latchClosed:w}),yield*t(hE.Success.make({...v}));return}default:yield*Cs("TODO implement devtools message",O)}}).pipe(Te(`@livestore/common:leader-thread:onDevtoolsMessage:${O._tag}`))),Re.mapToUnexpectedErrorStream,hn)}),QP=e=>Object.entries(e),kre=e=>[">","<","="].includes(e),YP=({tableName:e,columns:t,values:n,options:r={orReplace:!1}})=>[$re({tableName:e,columns:t,options:{orReplace:r?.orReplace,keys:Object.keys(n)}}),xb({columns:t,values:n})],$re=({tableName:e,columns:t,options:n={orReplace:!1}})=>{const r=n?.keys??Object.keys(t),s=r.join(", "),o=r.map(a=>`$${a}`).join(", ");return mt`INSERT ${n.orReplace?"OR REPLACE ":""}INTO ${e} (${s}) VALUES (${o})`},Tre=({columns:e,tableName:t,updateValues:n,where:r})=>{const s=Ire(n);if(Object.keys(s).length===0)return[mt`select 1`,{}];const o=Object.keys(s).map(d=>`${d} = $update_${d}`).join(", "),a={...xb({columns:e,values:s,variablePrefix:"update_"}),...xb({columns:e,values:r,variablePrefix:"where_",skipNil:!0})},u=Cre({where:r}),f=u===""?"":`WHERE ${u}`;return[mt`UPDATE ${t} SET ${o} ${f}`,a]},xb=({columns:e,values:t,variablePrefix:n="",skipNil:r})=>{const s=b(e,QP,qs(([o,a])=>[o,u=>{if(a.nullable===!0&&u==null)return null;const f=nF(a.schema)(u);if(f._tag==="Left"){const d=Yu.formatErrorSync(f.left),p=String(a.schema.ast);console.error(`Error making bind values for SQL query for column "${o}".

Expected schema: ${p}

Error: ${d}

Value:`,u);debugger;throw f.left}else return f.right}]),Object.fromEntries);return b(Object.entries(t).filter(([,o])=>r!==!0||o!=null).flatMap(([o,a])=>{const u=s[o]??we(`No codec found for column "${o}"`);if(typeof a=="object"&&a!==null&&"op"in a)switch(a.op){case"in":return a.val.map((f,d)=>[`${n}${o}_${d}`,u(f)]);case"=":case">":case"<":return[[`${n}${o}`,u(a.val)]];default:throw new Error(`Unknown op: ${a.op}`)}else return[[`${n}${o}`,u(a)]]}),Object.fromEntries)},Cre=({where:e})=>{const t=(n,r)=>r===null?"IS NULL":typeof r=="object"&&typeof r.op=="string"&&kre(r.op)?`${r.op} $where_${n}`:typeof r=="object"&&typeof r.op=="string"&&r.op==="in"?`in (${r.val.map((s,o)=>`$where_${n}_${o}`).join(", ")})`:`= $where_${n}`;return b(e,QP,qs(([n,r])=>`${n} ${t(n,r)}`),ra(" AND "))},Ire=e=>Object.fromEntries(Object.entries(e).filter(([,t])=>t!==void 0)),Ore=e=>z(function*(){for(const t of bne)yield*wp({db:e,behaviour:"create-if-not-exists",tableAst:t.sqliteDef.ast,skipMetaTable:!0});yield*id(e,mt`INSERT INTO ${Zl} (head)
          SELECT ${ss.global}
          WHERE NOT EXISTS (SELECT 1 FROM ${Zl})`,{})}),Rre=e=>z(function*(){const{dbEventlog:t,dbState:n}=yield*xt,r=Xl.where("seqNumGlobal",">=",e.global).asSql(),s=t.select(r.query,Ti(r.bindValues,r.query)),o=tp(Xl.rowSchema.pipe(De))(s),a=Sp.where("seqNumGlobal",">=",e.global).asSql(),u=n.select(a.query,Ti(a.bindValues,a.query)),f=tp(Sp.rowSchema.pipe(De))(u);return o.map(d=>{const p=f.find(m=>m.seqNumGlobal===d.seqNumGlobal&&m.seqNumClient===d.seqNumClient);return gn.make({name:d.name,args:d.argsJson,seqNum:{global:d.seqNumGlobal,client:d.seqNumClient},parentSeqNum:{global:d.parentSeqNumGlobal,client:d.parentSeqNumClient},clientId:d.clientId,sessionId:d.sessionId,meta:{sessionChangeset:p&&p.changeset!==null?{_tag:"sessionChangeset",data:p.changeset,debug:p.debug}:{_tag:"unset"},syncMetadata:d.syncMetadataJson}})}).filter(d=>Tb(d.seqNum,e)>0).sort((d,p)=>Tb(d.seqNum,p.seqNum))}),XP=e=>{const t=e.select(mt`select seqNumGlobal, seqNumClient from ${ds} order by seqNumGlobal DESC, seqNumClient DESC limit 1`)[0];return t?{global:t.seqNumGlobal,client:t.seqNumClient}:ss},qre=e=>e.select(mt`select head from ${Zl}`)[0]?.head??ss.global,Are=(e,t)=>e.execute(mt`UPDATE ${Zl} SET head = ${t.global}`),Fre=(e,t,n,r,s)=>z(function*(){Qs&&e.parentSeqNum.global!==ss.global&&t.select(`SELECT COUNT(*) as count FROM ${ds} WHERE seqNumGlobal = ? AND seqNumClient = ?`,[e.parentSeqNum.global,e.parentSeqNum.client])[0].count===1===!1&&we(`Parent mutation ${e.parentSeqNum.global},${e.parentSeqNum.client} does not exist`),yield*id(t,...YP({tableName:ds,columns:Xl.sqliteDef.columns,values:{seqNumGlobal:e.seqNum.global,seqNumClient:e.seqNum.client,parentSeqNumGlobal:e.parentSeqNum.global,parentSeqNumClient:e.parentSeqNum.client,name:e.name,argsJson:e.args??{},clientId:r,sessionId:s,schemaHash:n,syncMetadataJson:e.meta.syncMetadata}}))}),Pre=e=>z(function*(){const{dbEventlog:t}=yield*xt;for(let n=0;n<e.length;n++){const r=e[n];yield*id(t,...Tre({tableName:ds,columns:Xl.sqliteDef.columns,where:{seqNumGlobal:r.seqNum.global,seqNumClient:r.seqNum.client},updateValues:{syncMetadataJson:r.meta.syncMetadata}}))}}),xre=e=>z(function*(){const{dbEventlog:t}=yield*xt;if(e===ss.global)return H();const n=ne({syncMetadataJson:Zi(Og(Po))}).pipe(qc("syncMetadataJson"),De,hX),r=yield*$e(()=>t.select(mt`SELECT syncMetadataJson FROM ${ds} WHERE seqNumGlobal = ${e} ORDER BY seqNumClient ASC LIMIT 1`)).pipe(Jr(AY(n)),ye(g3),gr);return V({cursor:{global:e,client:xo},metadata:r})}).pipe(Te("@livestore/common:eventlog:getSyncBackendCursorInfo",{attributes:{remoteHead:e}})),Nre=({schema:e,dbState:t,dbEventlog:n})=>z(function*(){const r=new Map([...e.eventsDefsMap.entries()].map(([s,o])=>[s,rE(o.schema)]));return(s,o)=>z(function*(){const a=o?.skipEventlog??!1,u=s.name,{eventDef:f,materializer:d}=Ci(e,u),p=Ine({eventDef:f,materializer:d,db:t,event:{encoded:s}}),m=t.session();for(const{statementSql:C,bindValues:O}of p)yield*bre(t,C,O);const $=m.changeset();if(m.finish(),yield*id(t,...YP({tableName:Ql,columns:Sp.sqliteDef.columns,values:{seqNumGlobal:s.seqNum.global,seqNumClient:s.seqNum.client,changeset:$??null,debug:Qs?p:null}})),a===!1){const C=s.name,O=r.get(C)??we(`Unknown event definition: ${C}`);yield*Fre(s,n,O,s.clientId,s.sessionId)}return{sessionChangeset:$?{_tag:"sessionChangeset",data:$,debug:Qs?p:null}:{_tag:"no-op"}}}).pipe(Te("@livestore/common:leader-thread:materializeEvent",{attributes:{eventName:s.name,eventNum:s.seqNum,"span.label":`${rr(s.seqNum)} ${s.name}`}}))}),Dre=({dbState:e,dbEventlog:t,eventNumsToRollback:n})=>z(function*(){const r=e.select(mt`SELECT * FROM ${Ql} WHERE (seqNumGlobal, seqNumClient) IN (${n.map(o=>`(${o.global}, ${o.client})`).join(", ")})`).map(o=>({seqNum:{global:o.seqNumGlobal,client:o.seqNumClient},changeset:o.changeset,debug:o.debug})).toSorted((o,a)=>Tb(o.seqNum,a.seqNum));for(let o=r.length-1;o>=0;o--){const{changeset:a}=r[o];a!==null&&e.makeChangeset(a).invert().apply()}const s=K3(100)(n.map(o=>`(${o.global}, ${o.client})`));for(const o of s)e.execute(mt`DELETE FROM ${Ql} WHERE (seqNumGlobal, seqNumClient) IN (${o.join(", ")})`);for(const o of s)t.execute(mt`DELETE FROM ${ds} WHERE (seqNumGlobal, seqNumClient) IN (${o.join(", ")})`)}).pipe(Te("@livestore/common:LeaderSyncProcessor:rollback",{attributes:{count:n.length}})),Mre=({schema:e,dbEventlogMissing:t,dbEventlog:n,dbState:r,dbStateMissing:s,initialBlockingSyncContext:o,onError:a,params:u,testing:f})=>z(function*(){const d=yield*E$(),p=u.localPushBatchSize??10,m=u.backendPushBatchSize??50,$=yield*dp(void 0),C=K=>{const{eventDef:Ee}=Ci(e,K.name);return Ee.options.clientOnly},O=yield*Bre,N={current:0},v={current:s?0:yield*Hre(r)},w=new Map,g={current:void 0},E=yield*E$(),k=yield*jy(!0),R=yield*jy(!0),q={current:ss},x=K=>{q.current=aP(q.current,K)},D=(K,Ee)=>z(function*(){if(K.length===0)return;yield*Vre(K,q.current),x(K.at(-1).seqNum);const Ce=Ee?.waitForProcessing??!1,Je=N.current;if(Ce){const Ie=yield*dn(K,()=>Ue()),et=K.map((vn,Vn)=>[vn,Ie[Vn],Je]);yield*Uu(E,et),yield*Uf(Ie)}else{const Ie=K.map(et=>[et,void 0,Je]);yield*Uu(E,Ie)}}).pipe(Te("@livestore/common:LeaderSyncProcessor:push",{attributes:{batchSize:K.length,batch:Os?K:void 0},links:g.current?.span?[{_tag:"SpanLink",span:g.current.span,attributes:{}}]:void 0})),G=({event:{name:K,args:Ee},clientId:Ce,sessionId:Je})=>z(function*(){const Ie=yield*$;if(Ie===void 0)return we("Not initialized");const{eventDef:et}=Ci(e,K),vn=new gn({name:K,args:Ee,clientId:Ce,sessionId:Je,...oE(Ie.localHead,et.options.clientOnly)});yield*D([vn])}).pipe(Mw("LeaderAheadError",gr)),P=z(function*(){const K=yield*Zm.pipe(gr),Ee=yield*Yv.pipe(Gm(()=>We(void 0))),{devtools:Ce,shutdownChannel:Je}=yield*xt,Ie=yield*Bo();g.current={otelSpan:Ee,span:K,devtoolsLatch:Ce.enabled?Ce.syncBackendLatch:void 0,runtime:Ie};const et=t?ss:XP(n),vn=t?ss.global:qre(n);if(vn>et.global)return we(`During boot the backend head (${vn}) should never be greater than the local head (${et.global})`);const Vn=t?[]:yield*Rre({global:vn,client:xo}),Ug=new Gr({pending:Vn,upstreamHead:{global:vn,client:xo},localHead:et});if(yield*Zr($,Ug),Vn.length>0){const En=Vn.filter(Jo=>{const{eventDef:EE}=Ci(e,Jo.name);return EE.options.clientOnly===!1});En.length>0&&(yield*Uu(d,En))}const _u=En=>z(function*(){a==="shutdown"&&(yield*Je.send(Re.make({cause:En})),yield*Gi(En))});yield*Lre({localPushesLatch:k,localPushesQueue:E,pullLatch:R,syncStateSref:$,syncBackendPushQueue:d,schema:e,isClientEvent:C,otelSpan:Ee,currentLocalPushGenerationRef:N,connectedClientSessionPullQueues:O,mergeCounterRef:v,mergePayloads:w,localPushBatchSize:p,testing:{delay:f?.delays?.localPushProcessing}}).pipe(Et,ns(_u),Bt);const yu=yield*DA(),ud=Ure({syncBackendPushQueue:d,otelSpan:Ee,devtoolsLatch:g.current?.devtoolsLatch,backendPushBatchSize:m}).pipe(Et,ns(_u));return yield*ep(yu,ud),yield*jre({initialBackendHead:vn,isClientEvent:C,restartBackendPushing:En=>z(function*(){yield*y7(yu),yield*kZ(d),yield*Uu(d,En),yield*ep(yu,ud)}),syncStateSref:$,localPushesLatch:k,pullLatch:R,otelSpan:Ee,initialBlockingSyncContext:o,devtoolsLatch:g.current?.devtoolsLatch,connectedClientSessionPullQueues:O,mergeCounterRef:v,mergePayloads:w,advancePushHead:x}).pipe(Et,ns(_u),Bt),{initialLeaderHead:et}}).pipe(Vf("@livestore/common:LeaderSyncProcessor:boot")),L=({cursor:K})=>z(function*(){const Ee=yield*Z({cursor:K});return Gs(Ee)}).pipe(CF),Z=({cursor:K})=>{const Ee=g.current?.runtime??we("Not initialized");return z(function*(){const Ce=yield*O.makeQueue,Je=Array.from(w.entries()).map(([Ie,et])=>({payload:et,mergeCounter:Ie})).filter(({mergeCounter:Ie})=>Ie>K.mergeCounter).toSorted((Ie,et)=>Ie.mergeCounter-et.mergeCounter).map(({payload:Ie,mergeCounter:et})=>Ie._tag==="upstream-advance"?{payload:{_tag:"upstream-advance",newEvents:U3(Ie.newEvents,vn=>ea(K.eventNum,vn.seqNum))},mergeCounter:et}:{payload:Ie,mergeCounter:et});return yield*Ce.offerAll(Je),Ce}).pipe(qn(Ee))},ae=qg({get:z(function*(){const K=yield*$;return K===void 0?we("Not initialized"):K}),changes:$.changes.pipe(Fo(jF))});return{pull:L,pullQueue:Z,push:D,pushPartial:G,boot:P,syncState:ae,getMergeCounter:()=>v.current}}),Lre=({localPushesLatch:e,localPushesQueue:t,pullLatch:n,syncStateSref:r,syncBackendPushQueue:s,schema:o,isClientEvent:a,otelSpan:u,currentLocalPushGenerationRef:f,connectedClientSessionPullQueues:d,mergeCounterRef:p,mergePayloads:m,localPushBatchSize:$,testing:C})=>z(function*(){for(;;){C.delay!==void 0&&(yield*C.delay.pipe(Te("localPushProcessingDelay")));const O=yield*OF(t,1,$);yield*e.await,yield*n.close;const N=O.filter(([q,x,D])=>D===f.current).map(([q,x])=>[q,x]);if(N.length===0){yield*n.open;continue}const[v,w]=H3(N),g=yield*r;if(g===void 0)return we("Not initialized");const E=$P({syncState:g,payload:{_tag:"local-push",newEvents:v},isClientEvent:a,isEqualEvent:wP}),k=yield*ex(p);switch(E._tag){case"unexpected-error":return u?.addEvent(`[${k}]:push:unexpected-error`,{batchSize:v.length,newEvents:Os?JSON.stringify(v):void 0}),yield*Er(E.cause);case"rebase":return we("The leader thread should never have to rebase due to a local push");case"reject":{u?.addEvent(`[${k}]:push:reject`,{batchSize:v.length,mergeResult:Os?JSON.stringify(E):void 0}),f.current++;const q=f.current,x=v.at(0).seqNum,D=yield*$Z(t,P=>P[2]>=q);if(Qs&&(yield*k$(t))>0){console.log("localPushesQueue is not empty",yield*k$(t));debugger}const G=[...w,...D.map(([P,L])=>L)].filter(jF);yield*dn(G,P=>p1(P,fE.make({minimumExpectedNum:E.expectedMinimumId,providedNum:x}))),yield*n.open;continue}case"advance":break;default:Ys(E)}yield*Zr(r,E.newSyncState),yield*d.offer({payload:Ii.make({newEvents:E.newEvents}),mergeCounter:k}),m.set(k,Ii.make({newEvents:E.newEvents})),u?.addEvent(`[${k}]:push:advance`,{batchSize:v.length,mergeResult:Os?JSON.stringify(E):void 0});const R=E.newEvents.filter(q=>{const{eventDef:x}=Ci(o,q.name);return x.options.clientOnly===!1});yield*Uu(s,R),yield*ZP({batchItems:E.newEvents,deferreds:w}),yield*n.open}}),ZP=({batchItems:e,deferreds:t})=>z(function*(){const{dbState:n,dbEventlog:r,materializeEvent:s}=yield*xt;n.execute("BEGIN TRANSACTION",void 0),r.execute("BEGIN TRANSACTION",void 0),yield*xr(o=>z(function*(){wc(o)||(n.execute("ROLLBACK",void 0),r.execute("ROLLBACK",void 0))}));for(let o=0;o<e.length;o++){const{sessionChangeset:a}=yield*s(e[o]);e[o].meta.sessionChangeset=a,t?.[o]!==void 0&&(yield*vt(t[o],void 0))}n.execute("COMMIT",void 0),r.execute("COMMIT",void 0)}).pipe(mo,Qi,Te("@livestore/common:LeaderSyncProcessor:materializeEventItems",{attributes:{batchSize:e.length}}),Et,Re.mapToUnexpectedError),jre=({initialBackendHead:e,isClientEvent:t,restartBackendPushing:n,otelSpan:r,syncStateSref:s,localPushesLatch:o,pullLatch:a,devtoolsLatch:u,initialBlockingSyncContext:f,connectedClientSessionPullQueues:d,mergeCounterRef:p,mergePayloads:m,advancePushHead:$})=>z(function*(){const{syncBackend:C,dbState:O,dbEventlog:N,schema:v}=yield*xt;if(C===void 0)return;const w=(E,k)=>z(function*(){if(E.length===0)return;u!==void 0&&(yield*u.await),yield*o.close,yield*a.await;const R=yield*s;if(R===void 0)return we("Not initialized");const q=$P({syncState:R,payload:Ii.make({newEvents:E}),isClientEvent:t,isEqualEvent:wP,ignoreClientEvents:!0}),x=yield*ex(p);if(q._tag==="reject")return we("The leader thread should never reject upstream advances");if(q._tag==="unexpected-error")return r?.addEvent(`[${x}]:pull:unexpected-error`,{newEventsCount:E.length,newEvents:Os?JSON.stringify(E):void 0}),yield*Er(q.cause);const D=E.at(-1).seqNum;if(Are(N,D),q._tag==="rebase"){r?.addEvent(`[${x}]:pull:rebase`,{newEventsCount:E.length,newEvents:Os?JSON.stringify(E):void 0,rollbackCount:q.rollbackEvents.length,mergeResult:Os?JSON.stringify(q):void 0});const G=q.newSyncState.pending.filter(P=>{const{eventDef:L}=Ci(v,P.name);return L.options.clientOnly===!1});yield*n(G),q.rollbackEvents.length>0&&(yield*Dre({dbState:O,dbEventlog:N,eventNumsToRollback:q.rollbackEvents.map(P=>P.seqNum)})),yield*d.offer({payload:Ep.make({newEvents:q.newEvents,rollbackEvents:q.rollbackEvents}),mergeCounter:x}),m.set(x,Ep.make({newEvents:q.newEvents,rollbackEvents:q.rollbackEvents}))}else if(r?.addEvent(`[${x}]:pull:advance`,{newEventsCount:E.length,mergeResult:Os?JSON.stringify(q):void 0}),yield*d.offer({payload:Ii.make({newEvents:q.newEvents}),mergeCounter:x}),m.set(x,Ii.make({newEvents:q.newEvents})),q.confirmedEvents.length>0){const G=E.filter(P=>q.confirmedEvents.some(L=>xg(P.seqNum,L.seqNum)));yield*Pre(G)}zre(O,D),$(q.newSyncState.localHead),yield*ZP({batchItems:q.newEvents,deferreds:void 0}),yield*Zr(s,q.newSyncState),k===0&&(yield*o.open)}),g=yield*xre(e);yield*C.pull(g).pipe(xn(({batch:E,remaining:k})=>z(function*(){yield*zl(C.isConnected,R=>R===!0),yield*w(E.map(R=>gn.fromGlobal(R.eventEncoded,R.metadata)),k),yield*f.update({processed:E.length,remaining:k})})),hn,Rt)}).pipe(Te("@livestore/common:LeaderSyncProcessor:backend-pulling")),Ure=({syncBackendPushQueue:e,otelSpan:t,devtoolsLatch:n,backendPushBatchSize:r})=>z(function*(){const{syncBackend:s}=yield*xt;if(s!==void 0)for(;;){yield*zl(s.isConnected,u=>u===!0);const o=yield*OF(e,1,r);yield*zl(s.isConnected,u=>u===!0),n!==void 0&&(yield*n.await),t?.addEvent("backend-push",{batchSize:o.length,batch:Os?JSON.stringify(o):void 0});const a=yield*s.push(o.map(u=>u.toGlobal())).pipe(ni);if(a._tag==="Left")return Qs&&(yield*Vr("handled backend-push-error",{error:a.left.toString()})),t?.addEvent("backend-push-error",{error:a.left.toString()}),yield*Dw}}).pipe(Rt,Te("@livestore/common:LeaderSyncProcessor:backend-pushing")),zre=(e,t)=>{e.execute(mt`DELETE FROM ${Ql} WHERE seqNumGlobal < ${t.global}`)},Bre=z(function*(){const e=new Set;return yield*xr(()=>z(function*(){for(const r of e)yield*Lt(r);e.clear()})),{makeQueue:z(function*(){const r=yield*fn().pipe(it(Lt));return yield*xr(()=>$e(()=>e.delete(r))),e.add(r),r}),offer:r=>z(function*(){if(!(r.payload._tag==="upstream-advance"&&r.payload.newEvents.length===0))for(const s of e)yield*Ge(s,r)})}}),ex=e=>z(function*(){const{dbState:t}=yield*xt;return e.current++,t.execute(mt`INSERT OR REPLACE INTO ${uE} (id, mergeCounter) VALUES (0, ${e.current})`),e.current}),Hre=e=>z(function*(){return e.select(mt`SELECT mergeCounter FROM ${uE} WHERE id = 0`)[0]?.mergeCounter??0}),Vre=(e,t)=>z(function*(){if(e.length!==0){for(let n=1;n<e.length;n++)ea(e[n-1].seqNum,e[n].seqNum)&&we(`Events must be ordered in monotonically ascending order by eventNum. Received: [${e.map(r=>rr(r.seqNum)).join(", ")}]`);if(ea(t,e[0].seqNum))return yield*fE.make({minimumExpectedNum:t,providedNum:e[0].seqNum})}}),Wre=z(function*(){const{dbState:e,dbEventlog:t,schema:n,bootStatusQueue:r,materializeEvent:s}=yield*xt,o=n.state.sqlite.migrations;let a;yield*xr(Ww("recreateDb:finalizer")(function*(d){d._tag==="Failure"&&e.destroy()}));const u=e;yield*GP(u,{foreignKeys:!0});const f=d=>z(function*(){yield*Od(()=>d?.init?.(u)).pipe(Re.mapToUnexpectedError);const p=yield*kne({db:u,schema:n,onProgress:({done:m,total:$})=>Ge(r,{stage:"migrating",progress:{done:m,total:$}})});return yield*Od(()=>d?.pre?.(u)).pipe(Re.mapToUnexpectedError),{migrationsReport:p,tmpDb:u}});switch(o.strategy){case"auto":{const d=o.hooks,p=yield*f(d);a=p.migrationsReport,yield*zne({dbEventlog:t,schema:n,materializeEvent:s,onProgress:({done:m,total:$})=>Ge(r,{stage:"rehydrating",progress:{done:m,total:$}})}),yield*Od(()=>d?.post?.(p.tmpDb)).pipe(Re.mapToUnexpectedError);break}case"manual":{const d=e.export();a={migrations:[]};const p=yield*Od(()=>o.migrate(d)).pipe(Re.mapToUnexpectedError);u.import(p);break}default:Ys(o)}return{migrationsReport:a}}).pipe(Qi,Te("@livestore/common:leader-thread:recreateDb"),Xv("@livestore/common:leader-thread:recreateDb")),Kre=({schema:e,storeId:t,clientId:n,syncPayload:r,makeSqliteDb:s,syncOptions:o,dbState:a,dbEventlog:u,devtoolsOptions:f,shutdownChannel:d,params:p,testing:m})=>z(function*(){const $=yield*fn().pipe(it(Lt)),C=u.select(mt`select count(*) as count from sqlite_master`)[0].count===0,O=a.select(mt`select count(*) as count from sqlite_master`)[0].count===0,N=o?.backend===void 0?void 0:yield*o.backend({storeId:t,clientId:n,payload:r});N!==void 0&&(yield*N.connect.pipe(Et,Bt));const v=yield*Jre({initialSyncOptions:o?.initialSyncOptions??{_tag:"Skip"},bootStatusQueue:$}),w=yield*Mre({schema:e,dbEventlogMissing:C,dbEventlog:u,dbState:a,dbStateMissing:O,initialBlockingSyncContext:v,onError:o?.onSyncError??"ignore",params:{localPushBatchSize:p?.localPushBatchSize,backendPushBatchSize:p?.backendPushBatchSize},testing:{delays:m?.syncProcessor?.delays}}),g=yield*fn().pipe(it(Lt)),E=f.enabled?{enabled:!0,syncBackendLatch:yield*jy(!0),syncBackendLatchState:yield*dp({latchClosed:!1})}:{enabled:!1},k=yield*Nre({schema:e,dbState:a,dbEventlog:u}),R={schema:e,bootStatusQueue:$,storeId:t,clientId:n,dbState:a,dbEventlog:u,makeSqliteDb:s,eventSchema:Une(e),shutdownStateSubRef:yield*dp("running"),shutdownChannel:d,syncBackend:N,syncProcessor:w,materializeEvent:k,extraIncomingMessagesQueue:g,devtools:E,initialState:{}};globalThis.__leaderThreadCtx=R;const q=Jw(xt,R);return R.initialState=yield*Gre({dbStateMissing:O,initialBlockingSyncContext:v,devtoolsOptions:f}).pipe(qn(q)),q}).pipe(Te("@livestore/common:leader-thread:boot"),Vf("@livestore/common:leader-thread"),Re.mapToUnexpectedError,Et,Qw),Jre=({initialSyncOptions:e,bootStatusQueue:t})=>z(function*(){const n={isDone:!1,processedEvents:0,total:-1},r=e._tag==="Blocking"?yield*Ue():void 0;return r!==void 0&&e._tag==="Blocking"&&(yield*vt(r,void 0).pipe(s8(e.timeout),Bt)),{blockingDeferred:r,update:({processed:s,remaining:o})=>z(function*(){n.isDone!==!0&&(n.total===-1&&(n.total=o+s),n.processedEvents+=s,yield*Ge(t,{stage:"syncing",progress:{done:n.processedEvents,total:n.total}}),o===0&&r!==void 0&&(yield*vt(r,void 0),n.isDone=!0))})}}),Gre=({dbStateMissing:e,initialBlockingSyncContext:t,devtoolsOptions:n})=>z(function*(){const{dbEventlog:r,bootStatusQueue:s,syncProcessor:o}=yield*xt;yield*Ore(r);const{migrationsReport:a}=e?yield*Wre:{migrationsReport:{migrations:[]}},{initialLeaderHead:u}=yield*o.boot;return t.blockingDeferred!==void 0&&(yield*Ge(s,{stage:"syncing",progress:{done:0,total:-1}}),yield*t.blockingDeferred.pipe(Te("@livestore/common:leader-thread:initial-sync-blocking"))),yield*Ge(s,{stage:"done"}),yield*Ere(n).pipe(Et,Bt),{migrationsReport:a,leaderHead:u}});let _E=class extends $n()("DevtoolsWebCommon.CreateConnection",{payload:{from:j,port:Fg},success:ne({}),failure:Eg}){};class Soe extends ve(_E){}class ad extends iS("@livestore/devtools-web-common:CacheService")(){static layer=({nodeName:t})=>z(function*(){const n=yield*yre(t);return globalThis.__debugWebmeshNode=n,{node:n}}).pipe(R8(ad))}const Qre=({from:e,port:t})=>JX(n=>z(function*(){const{node:r}=yield*ad,s=yield*Mte({port:t,schema:JP});yield*r.addEdge({target:e,edgeChannel:s,replaceIfExists:!0}),Qs&&(yield*Vr(`@livestore/devtools-web-common: accepted edge: ${r.nodeName} ← ${e}`)),n.single({}),yield*Xn({connectedTo:[...r.edgeKeys]})}).pipe(gr)).pipe(hZ(`@livestore/devtools-web-common:worker:create-connection:${e}`)),te=0,Yre=1,tf=10,yE=12,cd=14,lo=21,D_=25,Xre=27,Nb=100,Zre=101,jg=522,tx=778,Z$=2,kp=4,Db=8,nx=64,ese=256,tse=2048,nse=16384,rse=524288,sse=2048,eT=1,tT=2,nT=3,rT=4,sT=5,ose=512;class rx{name;mxPathname=64;_module;constructor(t,n){this.name=t,this._module=n}close(){}isReady(){return!0}hasAsyncMethod(t){return!1}xOpen(t,n,r,s,o){return cd}xDelete(t,n,r){return te}xAccess(t,n,r,s){return te}xFullPathname(t,n,r,s){return te}xGetLastError(t,n,r){return te}xClose(t){return te}xRead(t,n,r,s,o){return te}xWrite(t,n,r,s,o){return te}xTruncate(t,n,r){return te}xSync(t,n){return te}xFileSize(t,n){return te}xLock(t,n){return te}xUnlock(t,n){return te}xCheckReservedLock(t,n){return te}xFileControl(t,n,r){return yE}xSectorSize(t){return ose}xDeviceCharacteristics(t){return 0}}const ise=Object.getPrototypeOf(async function(){}).constructor;let ase=class extends rx{constructor(t,n){super(t,n)}hasAsyncMethod(t){const n=`j${t.slice(1)}`;return this[n]instanceof ise}getFilename(t){throw new Error("unimplemented")}jOpen(t,n,r,s){return cd}jDelete(t,n){return te}jAccess(t,n,r){return te}jFullPathname(t,n){const{read:r,written:s}=new TextEncoder().encodeInto(t,n);return r<t.length||s>=n.length?tf:(n[s]=0,te)}jGetLastError(t){return te}jClose(t){return te}jRead(t,n,r){return n.fill(0),jg}jWrite(t,n,r){return tx}jTruncate(t,n){return te}jSync(t,n){return te}jFileSize(t,n){return te}jLock(t,n){return te}jUnlock(t,n){return te}jCheckReservedLock(t,n){return n.setInt32(0,0,!0),te}jFileControl(t,n,r){return yE}jSectorSize(t){return super.xSectorSize(t)}jDeviceCharacteristics(t){return 0}xOpen(t,n,r,s,o){const a=this.#t(n,s),u=this.#e("Int32",o);return this.log?.("jOpen",a,r,"0x"+s.toString(16)),this.jOpen(a,r,s,u)}xDelete(t,n,r){const s=this._module.UTF8ToString(n);return this.log?.("jDelete",s,r),this.jDelete(s,r)}xAccess(t,n,r,s){const o=this._module.UTF8ToString(n),a=this.#e("Int32",s);return this.log?.("jAccess",o,r),this.jAccess(o,r,a)}xFullPathname(t,n,r,s){const o=this._module.UTF8ToString(n),a=this._module.HEAPU8.subarray(s,s+r);return this.log?.("jFullPathname",o,r),this.jFullPathname(o,a)}xGetLastError(t,n,r){const s=this._module.HEAPU8.subarray(r,r+n);return this.log?.("jGetLastError",n),this.jGetLastError(s)}xClose(t){return this.log?.("jClose",t),this.jClose(t)}xRead(t,n,r,s,o){const a=this.#n(n,r),u=M_(s,o);return this.log?.("jRead",t,r,u),this.jRead(t,a,u)}xWrite(t,n,r,s,o){const a=this.#n(n,r),u=M_(s,o);return this.log?.("jWrite",t,a,u),this.jWrite(t,a,u)}xTruncate(t,n,r){const s=M_(n,r);return this.log?.("jTruncate",t,s),this.jTruncate(t,s)}xSync(t,n){return this.log?.("jSync",t,n),this.jSync(t,n)}xFileSize(t,n){const r=this.#e("BigInt64",n);return this.log?.("jFileSize",t),this.jFileSize(t,r)}xLock(t,n){return this.log?.("jLock",t,n),this.jLock(t,n)}xUnlock(t,n){return this.log?.("jUnlock",t,n),this.jUnlock(t,n)}xCheckReservedLock(t,n){const r=this.#e("Int32",n);return this.log?.("jCheckReservedLock",t),this.jCheckReservedLock(t,r)}xFileControl(t,n,r){const s=new DataView(this._module.HEAPU8.buffer,this._module.HEAPU8.byteOffset+r);return this.log?.("jFileControl",t,n,s),this.jFileControl(t,n,s)}xSectorSize(t){return this.log?.("jSectorSize",t),this.jSectorSize(t)}xDeviceCharacteristics(t){return this.log?.("jDeviceCharacteristics",t),this.jDeviceCharacteristics(t)}#e(t,n){const r=t==="Int32"?4:8,s=`get${t}`,o=`set${t}`,a=()=>new DataView(this._module.HEAPU8.buffer,this._module.HEAPU8.byteOffset+n,r);let u=a();return new Proxy(u,{get(f,d){if(u.buffer.byteLength===0&&(u=a()),d===s)return function(m,$){if(!$)throw new Error("must be little endian");return u[d](m,$)};if(d===o)return function(m,$,C){if(!C)throw new Error("must be little endian");return u[d](m,$,C)};if(typeof d=="string"&&d.match(/^(get)|(set)/))throw new Error("invalid type");const p=u[d];return typeof p=="function"?p.bind(u):p}})}#n(t,n){let r=this._module.HEAPU8.subarray(t,t+n);return new Proxy(r,{get:(s,o,a)=>{r.buffer.byteLength===0&&(r=this._module.HEAPU8.subarray(t,t+n));const u=r[o];return typeof u=="function"?u.bind(r):u}})}#t(t,n){if(n&nx){let r=t,s=1;const o=[];for(;s;){const a=this._module.HEAPU8[r++];if(a)o.push(a);else switch(this._module.HEAPU8[r]||(s=null),s){case 1:o.push(63),s=2;break;case 2:o.push(61),s=3;break;case 3:o.push(38),s=2;break}}return new TextDecoder().decode(new Uint8Array(o))}return t?this._module.UTF8ToString(t):null}};function M_(e,t){return t*4294967296+e+(e<0?2**32:0)}class bE extends ase{mapNameToFile=new Map;mapIdToFile=new Map;static async create(t,n){const r=new bE(t,n);return await r.isReady(),r}constructor(t,n){super(t,n)}close(){for(const t of this.mapIdToFile.keys())this.jClose(t)}jOpen(t,n,r,s){const a=new URL(t||Math.random().toString(36).slice(2),"file://").pathname;let u=this.mapNameToFile.get(a);if(!u)if(r&kp)u={pathname:a,flags:r,size:0,data:new ArrayBuffer(0)},this.mapNameToFile.set(a,u);else return cd;return this.mapIdToFile.set(n,u),s.setInt32(0,r,!0),te}jClose(t){const n=this.mapIdToFile.get(t);return this.mapIdToFile.delete(t),n.flags&Db&&this.mapNameToFile.delete(n.pathname),te}jRead(t,n,r){const s=this.mapIdToFile.get(t),o=Math.min(r,s.size),u=Math.min(r+n.byteLength,s.size)-o;return u&&n.set(new Uint8Array(s.data,o,u)),u<n.byteLength?(n.fill(0,u),jg):te}jWrite(t,n,r){const s=this.mapIdToFile.get(t);if(r+n.byteLength>s.data.byteLength){const o=Math.max(r+n.byteLength,2*s.data.byteLength),a=new ArrayBuffer(o);new Uint8Array(a).set(new Uint8Array(s.data,0,s.size)),s.data=a}return new Uint8Array(s.data,r,n.byteLength).set(n),s.size=Math.max(s.size,r+n.byteLength),te}jTruncate(t,n){const r=this.mapIdToFile.get(t);return r.size=Math.min(r.size,n),te}jFileSize(t,n){const r=this.mapIdToFile.get(t);return n.setBigInt64(0,BigInt(r.size),!0),te}jDelete(t,n){const s=new URL(t,"file://").pathname;return this.mapNameToFile.delete(s),te}jAccess(t,n,r){const o=new URL(t,"file://").pathname,a=this.mapNameToFile.get(o);return r.setInt32(0,a?1:0,!0),te}}let oT;const sx=e=>{if(e.vfs_registered.has("memory-vfs")===!1){const r=new bE("memory-vfs",e.module);e.vfs_register(r,!1),oT=r}return{dbPointer:e.open_v2Sync(":memory:",void 0,"memory-vfs"),vfs:oT}},iT=({sqlite3:e,metadata:t})=>{const n=[],{dbPointer:r}=t;let s=!1;const o={_tag:"SqliteDb",metadata:t,prepare:a=>{try{const u=e.statements(r,a.trim(),{unscoped:!0});let f=!1;const d={execute:(p,m)=>{for(const $ of u){p!==void 0&&Object.keys(p).length>0&&e.bind_collection($,p);try{e.step($)}finally{m?.onRowsChanged&&m.onRowsChanged(e.changes(r)),e.reset($)}}},select:p=>{if(u.length!==1)throw new Ua({query:{bindValues:p,sql:a},code:-1,cause:"Expected only one statement when using `select`"});const m=u[0];p!==void 0&&Object.keys(p).length>0&&e.bind_collection(m,p);const $=[];try{let C;try{C=e.column_names(m)}catch{}for(;e.step(m)===Nb;)if(C!==void 0){const O={};for(let N=0;N<C.length;N++)O[C[N]]=e.column(m,N);$.push(O)}}catch(C){throw new Ua({query:{bindValues:p,sql:a},code:C.code,cause:C})}finally{e.reset(m)}return $},finalize:()=>{if(!f){f=!0;for(const p of u)e.finalize(p)}},sql:a};return n.push(d),d}catch(u){throw new Ua({query:{sql:a,bindValues:{}},code:u.code,cause:u})}},export:()=>e.serialize(r,"main"),execute:(a,u,f)=>{const d=o.prepare(a);d.execute(u,f),d.finalize()},select:(a,u)=>{const f=o.prepare(a),d=f.select(u);return f.finalize(),d},destroy:()=>{o.close(),t.deleteDb()},close:()=>{if(!s){for(const a of n)a.finalize();e.close(r),s=!0}},import:a=>{if(a instanceof Uint8Array){const d=sx(e);e.deserialize(d.dbPointer,"main",a,a.length,a.length,3),e.backup(r,"main",d.dbPointer,"main"),e.close(d.dbPointer)}else e.backup(r,"main",a.metadata.dbPointer,"main");t.configureDb(o)},session:()=>{const a=e.session_create(r,"main");return e.session_attach(a,null),{changeset:()=>e.session_changeset(a).changeset??void 0,finish:()=>{e.session_delete(a)}}},makeChangeset:a=>({invert:()=>{const f=e.changeset_invert(a);return o.makeChangeset(f)},apply:()=>{try{e.changeset_apply(r,a),a=void 0}catch(f){throw new Ua({code:f.code??-1,cause:f,note:"Failed calling makeChangeset.apply"})}}})};return t.configureDb(o),o},cse=Object.getPrototypeOf(async()=>{}).constructor;class use extends rx{constructor(t,n){super(t,n)}hasAsyncMethod(t){const n=`j${t.slice(1)}`;return this[n]instanceof cse}getFilename(t){throw new Error("unimplemented")}jOpen(t,n,r,s){return cd}jDelete(t,n){return te}jAccess(t,n,r){return te}jFullPathname(t,n){const{read:r,written:s}=new TextEncoder().encodeInto(t,n);return r<t.length||s>=n.length?tf:(n[s]=0,te)}jGetLastError(t){return te}jClose(t){return te}jRead(t,n,r){return n.fill(0),jg}jWrite(t,n,r){return tx}jTruncate(t,n){return te}jSync(t,n){return te}jFileSize(t,n){return te}jLock(t,n){return te}jUnlock(t,n){return te}jCheckReservedLock(t,n){return n.setInt32(0,0,!0),te}jFileControl(t,n,r){return yE}jSectorSize(t){return super.xSectorSize(t)}jDeviceCharacteristics(t){return 0}xOpen(t,n,r,s,o){const a=this.#t(n,s),u=this.#e("Int32",o);return this.log?.("jOpen",a,r,"0x"+s.toString(16)),this.jOpen(a,r,s,u)}xDelete(t,n,r){const s=this._module.UTF8ToString(n);return this.log?.("jDelete",s,r),this.jDelete(s,r)}xAccess(t,n,r,s){const o=this._module.UTF8ToString(n),a=this.#e("Int32",s);return this.log?.("jAccess",o,r),this.jAccess(o,r,a)}xFullPathname(t,n,r,s){const o=this._module.UTF8ToString(n),a=this._module.HEAPU8.subarray(s,s+r);return this.log?.("jFullPathname",o,r),this.jFullPathname(o,a)}xGetLastError(t,n,r){const s=this._module.HEAPU8.subarray(r,r+n);return this.log?.("jGetLastError",n),this.jGetLastError(s)}xClose(t){return this.log?.("jClose",t),this.jClose(t)}xRead(t,n,r,s,o){const a=this.#n(n,r),u=L_(s,o);return this.log?.("jRead",t,r,u),this.jRead(t,a,u)}xWrite(t,n,r,s,o){const a=this.#n(n,r),u=L_(s,o);return this.log?.("jWrite",t,a,u),this.jWrite(t,a,u)}xTruncate(t,n,r){const s=L_(n,r);return this.log?.("jTruncate",t,s),this.jTruncate(t,s)}xSync(t,n){return this.log?.("jSync",t,n),this.jSync(t,n)}xFileSize(t,n){const r=this.#e("BigInt64",n);return this.log?.("jFileSize",t),this.jFileSize(t,r)}xLock(t,n){return this.log?.("jLock",t,n),this.jLock(t,n)}xUnlock(t,n){return this.log?.("jUnlock",t,n),this.jUnlock(t,n)}xCheckReservedLock(t,n){const r=this.#e("Int32",n);return this.log?.("jCheckReservedLock",t),this.jCheckReservedLock(t,r)}xFileControl(t,n,r){const s=new DataView(this._module.HEAPU8.buffer,this._module.HEAPU8.byteOffset+r);return this.log?.("jFileControl",t,n,s),this.jFileControl(t,n,s)}xSectorSize(t){return this.log?.("jSectorSize",t),this.jSectorSize(t)}xDeviceCharacteristics(t){return this.log?.("jDeviceCharacteristics",t),this.jDeviceCharacteristics(t)}#e(t,n){const r=t==="Int32"?4:8,s=`get${t}`,o=`set${t}`,a=()=>new DataView(this._module.HEAPU8.buffer,this._module.HEAPU8.byteOffset+n,r);let u=a();return new Proxy(u,{get(f,d){if(u.buffer.byteLength===0&&(u=a()),d===s)return function(m,$){if(!$)throw new Error("must be little endian");return u[d](m,$)};if(d===o)return function(m,$,C){if(!C)throw new Error("must be little endian");return u[d](m,$,C)};if(typeof d=="string"&&/^(get)|(set)/.test(d))throw new Error("invalid type");const p=u[d];return typeof p=="function"?p.bind(u):p}})}#n(t,n){let r=this._module.HEAPU8.subarray(t,t+n);return new Proxy(r,{get:(s,o,a)=>{r.buffer.byteLength===0&&(r=this._module.HEAPU8.subarray(t,t+n));const u=r[o];return typeof u=="function"?u.bind(r):u}})}#t(t,n){if(n&nx){let r=t,s=1;const o=[];for(;s;){const a=this._module.HEAPU8[r++];if(a)o.push(a);else switch(this._module.HEAPU8[r]||(s=null),s){case 1:{o.push(63),s=2;break}case 2:{o.push(61),s=3;break}case 3:{o.push(38),s=2;break}}}return new TextDecoder().decode(new Uint8Array(o))}return t?this._module.UTF8ToString(t):null}}function L_(e,t){return t*4294967296+e+(e<0?2**32:0)}const ox=4096,SE=512,lse=4,fse=8,Mb=SE+lse,aT=SE,cT=Mb,ei=ox,dse=ese|tse|nse|rse,hse=6;class wE extends use{log=null;#e;#n;#t=new Map;#r=new Map;#o=new Set;#s=new Map;static async create(t,n,r){const s=new wE(t,n,r);return await s.isReady(),s}constructor(t,n,r){super(t,r),this.#e=n}getOpfsFileName(t){const n=this.#a(t),r=this.#r.get(n);return this.#t.get(r)}resetAccessHandle(t){const n=this.#a(t);this.#r.get(n).truncate(ei)}jOpen(t,n,r,s){try{const o=t?this.#a(t):Math.random().toString(36);let a=this.#r.get(o);if(!a&&r&kp)if(this.getSize()<this.getCapacity())[a]=this.#o.keys(),this.#i(a,o,r);else throw new Error("cannot create file");if(!a)throw new Error("file not found");const u={path:o,flags:r,accessHandle:a};return this.#s.set(n,u),s.setInt32(0,r,!0),te}catch(o){return console.error(o.message),cd}}jClose(t){const n=this.#s.get(t);return n&&(n.accessHandle.flush(),this.#s.delete(t),n.flags&Db&&this.#u(n.path)),te}jRead(t,n,r){const o=this.#s.get(t).accessHandle.read(n.subarray(),{at:ei+r});return o<n.byteLength?(n.fill(0,o,n.byteLength),jg):te}jWrite(t,n,r){return this.#s.get(t).accessHandle.write(n.subarray(),{at:ei+r})===n.byteLength?te:tf}jTruncate(t,n){return this.#s.get(t).accessHandle.truncate(ei+n),te}jSync(t,n){return this.#s.get(t).accessHandle.flush(),te}jFileSize(t,n){const s=this.#s.get(t).accessHandle.getSize()-ei;return n.setBigInt64(0,BigInt(s),!0),te}jSectorSize(t){return ox}jDeviceCharacteristics(t){return sse}jAccess(t,n,r){const s=this.#a(t);return r.setInt32(0,this.#r.has(s)?1:0,!0),te}jDelete(t,n){const r=this.#a(t);return this.#u(r),te}async close(){this.#f()}async isReady(){if(!this.#n){let t=await navigator.storage.getDirectory();for(const n of this.#e.split("/"))n&&(t=await t.getDirectoryHandle(n,{create:!0}));this.#n=t,await this.#l(),this.getCapacity()===0&&await this.addCapacity(hse)}return!0}getSize(){return this.#r.size}getCapacity(){return this.#t.size}async addCapacity(t){for(let n=0;n<t;++n){const r=Math.random().toString(36).replace("0.",""),o=await(await this.#n.getFileHandle(r,{create:!0})).createSyncAccessHandle();this.#t.set(o,r),this.#i(o,"",0)}return t}async removeCapacity(t){let n=0;for(const r of Array.from(this.#o)){if(n==t||this.getSize()===this.getCapacity())return n;const s=this.#t.get(r);r.close(),await this.#n.removeEntry(s),this.#t.delete(r),this.#o.delete(r),++n}return n}async#l(){const t=[];for await(const[n,r]of this.#n)r.kind==="file"&&t.push([n,r]);await Promise.all(t.map(async([n,r])=>{const s=await r.createSyncAccessHandle();this.#t.set(s,n);const o=this.#d(s);o?this.#r.set(o,s):this.#o.add(s)}))}#f(){for(const t of this.#t.keys())t.close();this.#t.clear(),this.#r.clear(),this.#o.clear()}#d(t){const n=new Uint8Array(Mb);t.read(n,{at:0});const s=new DataView(n.buffer,n.byteOffset).getUint32(aT);if(n[0]&&(s&Db||(s&dse)===0))return console.warn(`Remove file with unexpected flags ${s.toString(16)}`),this.#i(t,"",0),"";const o=new Uint32Array(fse/4);t.read(o,{at:cT});const a=this.#c(n);if(o.every((u,f)=>u===a[f])){const u=n.indexOf(0);return u===0&&t.truncate(ei),new TextDecoder().decode(n.subarray(0,u))}else return console.warn("Disassociating file with bad digest."),this.#i(t,"",0),""}#i(t,n,r){const s=new Uint8Array(Mb);if(new TextEncoder().encodeInto(n,s).written>=SE)throw new Error("path too long");new DataView(s.buffer,s.byteOffset).setUint32(aT,r);const u=this.#c(s);t.write(s,{at:0}),t.write(u,{at:cT}),t.flush(),n?(this.#r.set(n,t),this.#o.delete(t)):(t.truncate(ei),this.#o.add(t))}#c(t){if(!t[0])return new Uint32Array([4274806656,2899230775]);let n=3735928559,r=1103547991;for(const s of t)n=Math.imul(n^s,2654435761),r=Math.imul(r^s,1597334677);return n=Math.imul(n^n>>>16,2246822507)^Math.imul(r^r>>>13,3266489909),r=Math.imul(r^r>>>16,2246822507)^Math.imul(n^n>>>13,3266489909),new Uint32Array([n>>>0,r>>>0])}#a(t){return(typeof t=="string"?new URL(t,"file://localhost/"):t).pathname}#u(t){const n=this.#r.get(t);n&&(this.#r.delete(t),this.#i(n,"",0))}}const pse=Xm(1).pipe(rs),uT=new Map,mse=({sqlite3:e,directory:t,fileName:n})=>z(function*(){const r=t.replaceAll(/["*/:<>?\\|]/g,"_"),o=`opfs${r.length===0?"":`-${r}`}`;if(e.vfs_registered.has(o)===!1){const f=yield*Jm(()=>wE.create(o,t,e.module));e.vfs_register(f,!1),uT.set(o,f)}const a=e.open_v2Sync(n,void 0,o),u=uT.get(o);return{dbPointer:a,vfs:u}}).pipe(pse.withPermits(1));new TextDecoder;const gse=({sqlite3:e})=>t=>z(function*(){if(t._tag==="in-memory"){const{dbPointer:a,vfs:u}=sx(e);return iT({sqlite3:e,metadata:{_tag:"in-memory",vfs:u,dbPointer:a,deleteDb:()=>{},configureDb:t.configureDb??(()=>{}),persistenceInfo:{fileName:":memory:"}}})}const n=60;let r=t.fileName;t.fileName.length>n&&(yield*Cs(`dbFilename too long: '${t.fileName}'. Max ${n} chars, got ${t.fileName.length}. Hashing...`),r=`hash-${Ot(t.fileName)}.db`);const{dbPointer:s,vfs:o}=yield*mse({sqlite3:e,directory:t.opfsDirectory,fileName:r});return iT({sqlite3:e,metadata:{_tag:"opfs",vfs:o,dbPointer:s,deleteDb:()=>o.resetAccessHandle(t.fileName),configureDb:t.configureDb??(()=>{}),persistenceInfo:{fileName:r,opfsDirectory:t.opfsDirectory,opfsFileName:o.getOpfsFileName(r)}}})}),lT=0x7fffffffffffffffn,fT=-0x8000000000000000n;class ur extends Error{constructor(t,n){super(t),this.code=n}}const Ia=!1;function _se(e){const t={};e.retryOps=[];const n=e._getSqliteFree(),r=e._malloc(8),s=[r,r+4];function o(v){if(typeof v!="string")return 0;const w=new TextEncoder().encode(v),g=e._sqlite3_malloc(w.byteLength+1);return e.HEAPU8.set(w,g),e.HEAPU8[g+w.byteLength]=0,g}function a(v,w){return BigInt(w)<<32n|BigInt(v)&0xffffffffn}const u=function(){const v=BigInt(Number.MAX_SAFE_INTEGER)>>32n,w=BigInt(Number.MIN_SAFE_INTEGER)>>32n;return function(g,E){return E>v||E<w?a(g,E):E*4294967296+(g&2147483647)-(g&2147483648)}}(),f=new Set;function d(v){if(!f.has(v))throw new ur("not a database",lo)}const p=new Map;function m(v){if(!p.has(v))throw new ur("not a statement",lo)}t.bind_collection=function(v,w){m(v);const g=Array.isArray(w),E=t.bind_parameter_count(v);for(let k=1;k<=E;++k){const R=g?k-1:t.bind_parameter_name(v,k),q=w[R];q!==void 0&&t.bind(v,k,q)}return te},t.bind=function(v,w,g){switch(m(v),typeof g){case"number":return g===(g|0)?t.bind_int(v,w,g):t.bind_double(v,w,g);case"string":return t.bind_text(v,w,g);default:return g instanceof Uint8Array||Array.isArray(g)?t.bind_blob(v,w,g):g===null?t.bind_null(v,w):typeof g=="bigint"?t.bind_int64(v,w,g):g===void 0?Xre:(console.warn("unknown binding converted to null",g),t.bind_null(v,w))}},t.bind_blob=function(){const v="sqlite3_bind_blob",w=e.cwrap(v,...re("nnnnn:n"));return function(g,E,k){m(g);const R=k.byteLength??k.length,q=e._sqlite3_malloc(R);e.HEAPU8.subarray(q).set(k);const x=w(g,E,q,R,n);return O(v,x,p.get(g))}}(),t.bind_parameter_count=function(){const w=e.cwrap("sqlite3_bind_parameter_count",...re("n:n"));return function(g){return m(g),w(g)}}(),t.bind_double=function(){const v="sqlite3_bind_double",w=e.cwrap(v,...re("nnn:n"));return function(g,E,k){m(g);const R=w(g,E,k);return O(v,R,p.get(g))}}(),t.bind_int=function(){const v="sqlite3_bind_int",w=e.cwrap(v,...re("nnn:n"));return function(g,E,k){if(m(g),k>2147483647||k<-2147483648)return D_;const R=w(g,E,k);return O(v,R,p.get(g))}}(),t.bind_int64=function(){const v="sqlite3_bind_int64",w=e.cwrap(v,...re("nnnn:n"));return function(g,E,k){if(m(g),k>lT||k<fT)return D_;const R=k&0xffffffffn,q=k>>32n,x=w(g,E,Number(R),Number(q));return O(v,x,p.get(g))}}(),t.bind_null=function(){const v="sqlite3_bind_null",w=e.cwrap(v,...re("nn:n"));return function(g,E){m(g);const k=w(g,E);return O(v,k,p.get(g))}}(),t.bind_parameter_name=function(){const w=e.cwrap("sqlite3_bind_parameter_name",...re("n:s"));return function(g,E){return m(g),w(g,E)}}(),t.bind_text=function(){const v="sqlite3_bind_text",w=e.cwrap(v,...re("nnnnn:n"));return function(g,E,k){m(g);const R=o(k),q=w(g,E,R,-1,n);return O(v,q,p.get(g))}}(),t.changes=function(){const w=e.cwrap("sqlite3_changes",...re("n:n"));return function(g){return d(g),w(g)}}(),t.deserialize=function(){const w=e.cwrap("sqlite3_deserialize",...re("nnnnnn:n"));return function(g,E,k,R,q,x){d(g);const D=e._sqlite3_malloc(R);return e.HEAPU8.subarray(D).set(k),w(g,E,D,R,q,x)}}();const $=1;t.serialize=function(){const w=e.cwrap("sqlite3_serialize",...re("nsnn:n"));return function(g,E){d(g);const k=s[0];let R=w(g,E,k,0);if(R===0){R=w(g,E,k,$);const q=e.getValue(k,"*"),x=e.HEAPU8.subarray(R,R+q);return new Uint8Array(x.slice())}else{const q=e.getValue(k,"*"),x=e.HEAPU8.subarray(R,R+q);return new Uint8Array(x)}}}(),t.backup=function(){const v=e.cwrap("sqlite3_backup_init",...re("nsns:n")),w=e.cwrap("sqlite3_backup_step",...re("nn:n")),g=e.cwrap("sqlite3_backup_finish",...re("n:n"));return function(E,k,R,q){d(E),d(R);const x=v(E,k,R,q);if(x===0){const D=e.ccall("sqlite3_errmsg","string",["number"],[E]);throw new ur(`backup failed: ${D}`,Yre)}return w(x,-1),g(x)}}(),t.clear_bindings=function(){const v="sqlite3_clear_bindings",w=e.cwrap(v,...re("n:n"));return function(g){m(g);const E=w(g);return O(v,E,p.get(g))}}(),t.close=function(){const v="sqlite3_close",w=e.cwrap(v,...re("n:n"),{async:Ia});return function(g){d(g);const E=w(g);return f.delete(g),O(v,E,g)}}(),t.column=function(v,w){m(v);const g=t.column_type(v,w);switch(g){case rT:return t.column_blob(v,w);case tT:return t.column_double(v,w);case eT:const E=t.column_int(v,w),k=e.getTempRet0();return u(E,k);case sT:return null;case nT:return t.column_text(v,w);default:throw new ur("unknown type",g)}},t.column_blob=function(){const w=e.cwrap("sqlite3_column_blob",...re("nn:n"));return function(g,E){m(g);const k=t.column_bytes(g,E),R=w(g,E);if(R===0)return null;const q=e.HEAPU8.subarray(R,R+k);return new Uint8Array(q)}}(),t.column_bytes=function(){const w=e.cwrap("sqlite3_column_bytes",...re("nn:n"));return function(g,E){return m(g),w(g,E)}}(),t.column_count=function(){const w=e.cwrap("sqlite3_column_count",...re("n:n"));return function(g){return m(g),w(g)}}(),t.column_double=function(){const w=e.cwrap("sqlite3_column_double",...re("nn:n"));return function(g,E){return m(g),w(g,E)}}(),t.column_int=function(){const w=e.cwrap("sqlite3_column_int64",...re("nn:n"));return function(g,E){return m(g),w(g,E)}}(),t.column_int64=function(){const w=e.cwrap("sqlite3_column_int64",...re("nn:n"));return function(g,E){m(g);const k=w(g,E),R=e.getTempRet0();return a(k,R)}}(),t.column_name=function(){const w=e.cwrap("sqlite3_column_name",...re("nn:s"));return function(g,E){return m(g),w(g,E)}}(),t.column_names=function(v){const w=[],g=t.column_count(v);for(let E=0;E<g;++E)w.push(t.column_name(v,E));return w},t.column_text=function(){const w=e.cwrap("sqlite3_column_text",...re("nn:s"));return function(g,E){return m(g),w(g,E)}}(),t.column_type=function(){const w=e.cwrap("sqlite3_column_type",...re("nn:n"));return function(g,E){return m(g),w(g,E)}}(),t.create_function=function(v,w,g,E,k,R,q,x){d(v);function D(P){return(L,Z,ae)=>P(L,e.HEAP32.subarray(ae/4,ae/4+Z))}const G=e.create_function(v,w,g,E,k,R&&D(R),q&&D(q),x);return O("sqlite3_create_function",G,v)},t.data_count=function(){const w=e.cwrap("sqlite3_data_count",...re("n:n"));return function(g){return m(g),w(g)}}(),t.exec=function(v,w,g){const E=t.statements(v,w,{unscoped:!0});for(const k of E){let R;for(;t.step(k)===Nb;)if(g){R=R??t.column_names(k);const q=t.row(k);g(q,R),g(q,R)}}for(const k of E)t.finalize(k);return te},t.finalize=function(){const w=e.cwrap("sqlite3_finalize",...re("n:n"),{async:Ia});return function(g){const E=w(g);return p.delete(g),E}}(),t.get_autocommit=function(){const w=e.cwrap("sqlite3_get_autocommit",...re("n:n"));return function(g){return w(g)}}(),t.libversion=function(){const w=e.cwrap("sqlite3_libversion",...re(":s"));return function(){return w()}}(),t.libversion_number=function(){const w=e.cwrap("sqlite3_libversion_number",...re(":n"));return function(){return w()}}(),t.limit=function(){const w=e.cwrap("sqlite3_limit",...re("nnn:n"));return function(g,E,k){return w(g,E,k)}}(),t.open_v2=function(){const v="sqlite3_open_v2",w=e.cwrap(v,...re("snnn:n"),{async:Ia});return async function(g,E,k){E=E||kp|Z$,k=o(k);try{const R=await N(()=>w(g,s[0],E,k)),q=e.getValue(s[0],"*");return f.add(q),e.ccall("RegisterExtensionFunctions","void",["number"],[q]),O(v,R,q),q}finally{e._sqlite3_free(k)}}}(),t.open_v2Sync=function(){const v="sqlite3_open_v2",w=e.cwrap(v,...re("snnn:n"),{async:Ia});return function(g,E,k){E=E||kp|Z$,k=o(k);try{const R=w(g,s[0],E,k),q=e.getValue(s[0],"*");return f.add(q),e.ccall("RegisterExtensionFunctions","void",["number"],[q]),O(v,R,q),q}finally{e._sqlite3_free(k)}}}(),t.progress_handler=function(v,w,g,E){d(v),e.progress_handler(v,w,g,E)},t.reset=function(){const v="sqlite3_reset",w=e.cwrap(v,...re("n:n"),{async:Ia});return function(g){m(g);const E=w(g);return O(v,E,p.get(g))}}(),t.result=function(v,w){switch(typeof w){case"number":w===(w|0)?t.result_int(v,w):t.result_double(v,w);break;case"string":t.result_text(v,w);break;default:if(w instanceof Uint8Array||Array.isArray(w))t.result_blob(v,w);else if(w===null)t.result_null(v);else{if(typeof w=="bigint")return t.result_int64(v,w);console.warn("unknown result converted to null",w),t.result_null(v)}break}},t.result_blob=function(){const w=e.cwrap("sqlite3_result_blob",...re("nnnn:n"));return function(g,E){const k=E.byteLength??E.length,R=e._sqlite3_malloc(k);e.HEAPU8.subarray(R).set(E),w(g,R,k,n)}}(),t.result_double=function(){const w=e.cwrap("sqlite3_result_double",...re("nn:n"));return function(g,E){w(g,E)}}(),t.result_int=function(){const w=e.cwrap("sqlite3_result_int",...re("nn:n"));return function(g,E){w(g,E)}}(),t.result_int64=function(){const w=e.cwrap("sqlite3_result_int64",...re("nnn:n"));return function(g,E){if(E>lT||E<fT)return D_;const k=E&0xffffffffn,R=E>>32n;w(g,Number(k),Number(R))}}(),t.result_null=function(){const w=e.cwrap("sqlite3_result_null",...re("n:n"));return function(g){w(g)}}(),t.result_text=function(){const w=e.cwrap("sqlite3_result_text",...re("nnnn:n"));return function(g,E){const k=o(E);w(g,k,-1,n)}}(),t.row=function(v){const w=[],g=t.data_count(v);for(let E=0;E<g;++E){const k=t.column(v,E);w.push(k?.buffer===e.HEAPU8.buffer?k.slice():k)}return w},t.set_authorizer=function(v,w,g){d(v);function E(q,x,D,G,P,L){return[q,x,e.UTF8ToString(D),e.UTF8ToString(G),e.UTF8ToString(P),e.UTF8ToString(L)]}function k(q){return(x,D,G,P,L,Z)=>q(...E(x,D,G,P,L,Z))}const R=e.set_authorizer(v,k(w),g);return O("sqlite3_set_authorizer",R,v)},t.sql=function(){const w=e.cwrap("sqlite3_sql",...re("n:s"));return function(g){return m(g),w(g)}}(),t.statements=function(v,w,g={}){const E=e.cwrap("sqlite3_prepare_v3","number",["number","number","number","number","number","number"],{async:!1}),k=[],R=new TextEncoder().encode(w),q=R.byteLength-R.byteLength%4+12,x=e._sqlite3_malloc(q),D=x+R.byteLength+1;e.HEAPU8.set(R,x),e.HEAPU8[D-1]=0;const G=x+q-8,P=x+q-4;let L;function Z(){L&&!g.unscoped&&t.finalize(L),L=0}e.setValue(P,x,"*");do{Z();const ae=e.getValue(P,"*"),K=E(v,ae,D-P,g.flags||0,G,P);K!==te&&O("sqlite3_prepare_v3",K,v),L=e.getValue(G,"*"),L&&(p.set(L,v),k.push(L))}while(L);return k},t.step=function(){const v="sqlite3_step",w=e.cwrap(v,...re("n:n"),{async:Ia});return function(g){m(g);const E=w(g);return O(v,E,p.get(g),[Nb,Zre])}}(),t.commit_hook=function(v,w){d(v),e.commit_hook(v,w)},t.update_hook=function(v,w){d(v);function g(k,R,q,x,D){return[k,e.UTF8ToString(R),e.UTF8ToString(q),a(x,D)]}function E(k){return(R,q,x,D,G)=>k(...g(R,q,x,D,G))}e.update_hook(v,E(w))},t.session_create=function(){const v="sqlite3session_create",w=e.cwrap(v,...re("nsn:n"));return function(g,E){d(g);const k=e._malloc(4),R=w(g,E,k);return R!==te&&O(v,R,g),e.getValue(k,"i32")}}(),t.session_attach=function(){const v="sqlite3session_attach",w=e.cwrap(v,...re("ns:n"));return function(g,E){if(typeof g!="number")throw new ur("Invalid session object",lo);const k=w(g,E);return O(v,k)}}(),t.session_enable=function(){const w=e.cwrap("sqlite3session_enable",...re("nn:n"));return function(g,E){const k=E?1:0;if(typeof g!="number")throw new ur("Invalid session object",lo);if(w(g,k)!==k)throw new ur("Failed to enable session",lo)}}(),t.session_changeset=function(){const v="sqlite3session_changeset",w=e.cwrap(v,...re("nnn:n"));return function(g){if(typeof g!="number")throw new ur("Invalid session object",lo);const E=e._malloc(4),k=e._malloc(4);try{const R=w(g,E,k);if(R===te){const q=e.getValue(E,"i32"),x=e.getValue(k,"i32");if(x===0)return{result:R,size:0,changeset:null};const D=new Uint8Array(e.HEAPU8.subarray(x,x+q));return e._sqlite3_free(x),{result:R,size:q,changeset:D}}return O(v,R)}finally{e._free(E),e._free(k)}}}(),t.session_delete=function(){const w=e.cwrap("sqlite3session_delete",...re("n:v"));return function(g){if(typeof g!="number")throw new ur("Invalid session object",lo);return w(g)}}(),t.changeset_start=function(){const v="sqlite3changeset_start",w=e.cwrap(v,...re("nnn:n"));return function(g){const E=e._sqlite3_malloc(g.length);e.HEAPU8.subarray(E).set(g);const k=e._malloc(4);try{const R=w(k,g.length,E);return R!==te&&O(v,R),e.getValue(k,"i32")}finally{e._sqlite3_free(E),e._free(k)}}}(),t.changeset_finalize=function(){const w=e.cwrap("sqlite3changeset_finalize",...re("n:n"));return function(g){return w(g)}}(),t.changeset_invert=function(){const v="sqlite3changeset_invert",w=e.cwrap(v,...re("nn:nn"));return function(g){const E=e._sqlite3_malloc(g.length);e.HEAPU8.subarray(E).set(g);const k=e._malloc(4),R=e._malloc(4),q=w(g.length,E,k,R);q!==te&&O(v,q);const x=e.getValue(k,"i32"),D=e.getValue(R,"i32"),G=new Uint8Array(e.HEAPU8.buffer,D,x).slice();return e._sqlite3_free(E),e._sqlite3_free(D),G}}(),t.session_changeset_inverted=function(){const v="sqlite3session_changeset",w=e.cwrap(v,...re("nnn:n")),g="sqlite3changeset_invert",E=e.cwrap(g,...re("nn:nn"));return function(k){if(typeof k!="number")throw new ur("Invalid session object",lo);const R=e._malloc(4),q=e._malloc(4),x=e._malloc(4),D=e._malloc(4);try{const G=w(k,R,q);if(G!==te)return O(v,G);const P=e.getValue(R,"i32"),L=e.getValue(q,"i32"),Z=E(P,L,x,D);if(Z!==te)return O(g,Z);const ae=e.getValue(x,"i32"),K=e.getValue(D,"i32"),Ee=new Uint8Array(e.HEAPU8.buffer,K,ae);return e._sqlite3_free(L),e._sqlite3_free(K),{result:G,size:P,changeset:new Uint8Array(Ee)}}finally{e._free(R),e._free(q),e._free(x),e._free(D)}}}(),t.changeset_apply=function(){const v="sqlite3changeset_apply",w=e.cwrap(v,...re("nnnnnn:n"));return function(g,E,k){const R=e._sqlite3_malloc(E.length);e.HEAPU8.subarray(R).set(E);const q=1,x=()=>q,D=w(g,E.length,R,null,x,null);return e._sqlite3_free(R),D!==te&&O(v,D),D}}(),t.value=function(v){const w=t.value_type(v);switch(w){case rT:return t.value_blob(v);case tT:return t.value_double(v);case eT:const g=t.value_int(v),E=e.getTempRet0();return u(g,E);case sT:return null;case nT:return t.value_text(v);default:throw new ur("unknown type",w)}},t.value_blob=function(){const w=e.cwrap("sqlite3_value_blob",...re("n:n"));return function(g){const E=t.value_bytes(g),k=w(g);return e.HEAPU8.subarray(k,k+E)}}(),t.value_bytes=function(){const w=e.cwrap("sqlite3_value_bytes",...re("n:n"));return function(g){return w(g)}}(),t.value_double=function(){const w=e.cwrap("sqlite3_value_double",...re("n:n"));return function(g){return w(g)}}(),t.value_int=function(){const w=e.cwrap("sqlite3_value_int64",...re("n:n"));return function(g){return w(g)}}(),t.value_int64=function(){const w=e.cwrap("sqlite3_value_int64",...re("n:n"));return function(g){const E=w(g),k=e.getTempRet0();return a(E,k)}}(),t.value_text=function(){const w=e.cwrap("sqlite3_value_text",...re("n:s"));return function(g){return w(g)}}(),t.value_type=function(){const w=e.cwrap("sqlite3_value_type",...re("n:n"));return function(g){return w(g)}}();const C=new Set;t.vfs_register=function(v,w){if(C.has(v.name))return;const g=e.vfs_register(v,w),E=O("sqlite3_vfs_register",g);return C.add(v.name),E},t.vfs_registered=C;function O(v,w,g=null,E=[te]){if(E.includes(w))return w;const k=g?e.ccall("sqlite3_errmsg","string",["number"],[g]):v;throw new ur(k,w)}async function N(v){let w;do e.retryOps.length&&(await Promise.all(e.retryOps),e.retryOps=[]),w=await v();while(w&&e.retryOps.length);return w}return t}function re(e){const t=[],n=e.match(/([ns@]*):([nsv@])/);switch(n[2]){case"n":t.push("number");break;case"s":t.push("string");break;case"v":t.push(null);break}const r=[];for(let s of n[1])switch(s){case"n":r.push("number");break;case"s":r.push("string");break}return t.push(r),t}var yse=(()=>{var e=import.meta.url;return function(t={}){var n,r=t,s,o,a=new Promise((i,c)=>{s=i,o=c}),u=typeof window=="object",f=typeof WorkerGlobalScope<"u";typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"&&process.type!="renderer";var d=Object.assign({},r),p="./this.program",m=(i,c)=>{throw c},$="";function C(i){return r.locateFile?r.locateFile(i,$):$+i}var O,N;(u||f)&&(f?$=self.location.href:typeof document<"u"&&document.currentScript&&($=document.currentScript.src),e&&($=e),$.startsWith("blob:")?$="":$=$.substr(0,$.replace(/[?#].*/,"").lastIndexOf("/")+1),f&&(N=i=>{var c=new XMLHttpRequest;return c.open("GET",i,!1),c.responseType="arraybuffer",c.send(null),new Uint8Array(c.response)}),O=i=>fetch(i,{credentials:"same-origin"}).then(c=>c.ok?c.arrayBuffer():Promise.reject(new Error(c.status+" : "+c.url))));var v=r.print||console.log.bind(console),w=r.printErr||console.error.bind(console);Object.assign(r,d),d=null,r.arguments&&r.arguments,r.thisProgram&&(p=r.thisProgram);var g=r.wasmBinary,E,k=!1,R,q,x,D,G,P,L,Z,ae;function K(){var i=E.buffer;r.HEAP8=q=new Int8Array(i),r.HEAP16=D=new Int16Array(i),r.HEAPU8=x=new Uint8Array(i),r.HEAPU16=G=new Uint16Array(i),r.HEAP32=P=new Int32Array(i),r.HEAPU32=L=new Uint32Array(i),r.HEAPF32=Z=new Float32Array(i),r.HEAPF64=ae=new Float64Array(i)}var Ee=[],Ce=[],Je=[],Ie=[];function et(){if(r.preRun)for(typeof r.preRun=="function"&&(r.preRun=[r.preRun]);r.preRun.length;)_u(r.preRun.shift());fd(Ee)}function vn(){!r.noFSInit&&!_.initialized&&_.init(),_.ignorePermissions=!1,fd(Ce)}function Vn(){fd(Je)}function Ug(){if(r.postRun)for(typeof r.postRun=="function"&&(r.postRun=[r.postRun]);r.postRun.length;)ud(r.postRun.shift());fd(Ie)}function _u(i){Ee.unshift(i)}function yu(i){Ce.unshift(i)}function ud(i){Ie.unshift(i)}var En=0,Jo=null;function EE(i){return i}function zg(i){En++,r.monitorRunDependencies?.(En)}function ld(i){if(En--,r.monitorRunDependencies?.(En),En==0&&Jo){var c=Jo;Jo=null,c()}}function oo(i){r.onAbort?.(i),i="Aborted("+i+")",w(i),k=!0,i+=". Build with -sASSERTIONS for more info.";var c=new WebAssembly.RuntimeError(i);throw o(c),c}var cx="data:application/octet-stream;base64,",kE=i=>i.startsWith(cx);function ux(){if(r.locateFile){var i="wa-sqlite.wasm";return kE(i)?i:C(i)}return new URL("/assets/wa-sqlite-CWx0VZcQ.wasm",import.meta.url).href}var Bg;function $E(i){if(i==Bg&&g)return new Uint8Array(g);if(N)return N(i);throw"both async and sync fetching of the wasm failed"}function lx(i){return g?Promise.resolve().then(()=>$E(i)):O(i).then(c=>new Uint8Array(c),()=>$E(i))}function TE(i,c,l){return lx(i).then(h=>WebAssembly.instantiate(h,c)).then(l,h=>{w(`failed to asynchronously prepare wasm: ${h}`),oo(h)})}function fx(i,c,l,h){return!i&&typeof WebAssembly.instantiateStreaming=="function"&&!kE(c)&&typeof fetch=="function"?fetch(c,{credentials:"same-origin"}).then(S=>{var I=WebAssembly.instantiateStreaming(S,l);return I.then(h,function(A){return w(`wasm streaming compile failed: ${A}`),w("falling back to ArrayBuffer instantiation"),TE(c,l,h)})}):TE(c,l,h)}function dx(){return{a:h2}}function hx(){function i(h,S){return T=h.exports,E=T.la,K(),ba=T.of,yu(T.ma),ld(),T}zg();function c(h){i(h.instance)}var l=dx();if(r.instantiateWasm)try{return r.instantiateWasm(l,i)}catch(h){w(`Module.instantiateWasm callback failed with error: ${h}`),o(h)}return Bg??=ux(),fx(g,Bg,l,c).catch(o),{}}var _e,St;class CE{name="ExitStatus";constructor(c){this.message=`Program terminated with exit(${c})`,this.status=c}}var fd=i=>{for(;i.length>0;)i.shift()(r)};function IE(i,c="i8"){switch(c.endsWith("*")&&(c="*"),c){case"i1":return q[i];case"i8":return q[i];case"i16":return D[i>>1];case"i32":return P[i>>2];case"i64":oo("to do getValue(i64) use WASM_BIGINT");case"float":return Z[i>>2];case"double":return ae[i>>3];case"*":return L[i>>2];default:oo(`invalid type for getValue: ${c}`)}}r.noExitRuntime;function ga(i,c,l="i8"){switch(l.endsWith("*")&&(l="*"),l){case"i1":q[i]=c;break;case"i8":q[i]=c;break;case"i16":D[i>>1]=c;break;case"i32":P[i>>2]=c;break;case"i64":oo("to do setValue(i64) use WASM_BIGINT");case"float":Z[i>>2]=c;break;case"double":ae[i>>3]=c;break;case"*":L[i>>2]=c;break;default:oo(`invalid type for setValue: ${l}`)}}var px=i=>HE(i),mx=()=>WE(),OE=typeof TextDecoder<"u"?new TextDecoder:void 0,_a=(i,c=0,l=NaN)=>{for(var h=c+l,S=c;i[S]&&!(S>=h);)++S;if(S-c>16&&i.buffer&&OE)return OE.decode(i.subarray(c,S));for(var I="";c<S;){var A=i[c++];if(!(A&128)){I+=String.fromCharCode(A);continue}var F=i[c++]&63;if((A&224)==192){I+=String.fromCharCode((A&31)<<6|F);continue}var U=i[c++]&63;if((A&240)==224?A=(A&15)<<12|F<<6|U:A=(A&7)<<18|F<<12|U<<6|i[c++]&63,A<65536)I+=String.fromCharCode(A);else{var ee=A-65536;I+=String.fromCharCode(55296|ee>>10,56320|ee&1023)}}return I},Go=(i,c)=>i?_a(x,i,c):"",gx=(i,c,l,h)=>oo(`Assertion failed: ${Go(i)}, at: `+[c?Go(c):"unknown filename",l,h?Go(h):"unknown function"]),ot={isAbs:i=>i.charAt(0)==="/",splitPath:i=>{var c=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/;return c.exec(i).slice(1)},normalizeArray:(i,c)=>{for(var l=0,h=i.length-1;h>=0;h--){var S=i[h];S==="."?i.splice(h,1):S===".."?(i.splice(h,1),l++):l&&(i.splice(h,1),l--)}if(c)for(;l;l--)i.unshift("..");return i},normalize:i=>{var c=ot.isAbs(i),l=i.substr(-1)==="/";return i=ot.normalizeArray(i.split("/").filter(h=>!!h),!c).join("/"),!i&&!c&&(i="."),i&&l&&(i+="/"),(c?"/":"")+i},dirname:i=>{var c=ot.splitPath(i),l=c[0],h=c[1];return!l&&!h?".":(h&&(h=h.substr(0,h.length-1)),l+h)},basename:i=>{if(i==="/")return"/";i=ot.normalize(i),i=i.replace(/\/$/,"");var c=i.lastIndexOf("/");return c===-1?i:i.substr(c+1)},join:(...i)=>ot.normalize(i.join("/")),join2:(i,c)=>ot.normalize(i+"/"+c)},_x=()=>{if(typeof crypto=="object"&&typeof crypto.getRandomValues=="function")return i=>crypto.getRandomValues(i);oo("initRandomDevice")},RE=i=>(RE=_x())(i),io={resolve:(...i)=>{for(var c="",l=!1,h=i.length-1;h>=-1&&!l;h--){var S=h>=0?i[h]:_.cwd();if(typeof S!="string")throw new TypeError("Arguments to path.resolve must be strings");if(!S)return"";c=S+"/"+c,l=ot.isAbs(S)}return c=ot.normalizeArray(c.split("/").filter(I=>!!I),!l).join("/"),(l?"/":"")+c||"."},relative:(i,c)=>{i=io.resolve(i).substr(1),c=io.resolve(c).substr(1);function l(ee){for(var be=0;be<ee.length&&ee[be]==="";be++);for(var xe=ee.length-1;xe>=0&&ee[xe]==="";xe--);return be>xe?[]:ee.slice(be,xe-be+1)}for(var h=l(i.split("/")),S=l(c.split("/")),I=Math.min(h.length,S.length),A=I,F=0;F<I;F++)if(h[F]!==S[F]){A=F;break}for(var U=[],F=A;F<h.length;F++)U.push("..");return U=U.concat(S.slice(A)),U.join("/")}},Hg=[],ya=i=>{for(var c=0,l=0;l<i.length;++l){var h=i.charCodeAt(l);h<=127?c++:h<=2047?c+=2:h>=55296&&h<=57343?(c+=4,++l):c+=3}return c},Vg=(i,c,l,h)=>{if(!(h>0))return 0;for(var S=l,I=l+h-1,A=0;A<i.length;++A){var F=i.charCodeAt(A);if(F>=55296&&F<=57343){var U=i.charCodeAt(++A);F=65536+((F&1023)<<10)|U&1023}if(F<=127){if(l>=I)break;c[l++]=F}else if(F<=2047){if(l+1>=I)break;c[l++]=192|F>>6,c[l++]=128|F&63}else if(F<=65535){if(l+2>=I)break;c[l++]=224|F>>12,c[l++]=128|F>>6&63,c[l++]=128|F&63}else{if(l+3>=I)break;c[l++]=240|F>>18,c[l++]=128|F>>12&63,c[l++]=128|F>>6&63,c[l++]=128|F&63}}return c[l]=0,l-S};function Wg(i,c,l){var h=l>0?l:ya(i)+1,S=new Array(h),I=Vg(i,S,0,S.length);return c&&(S.length=I),S}var yx=()=>{if(!Hg.length){var i=null;if(typeof window<"u"&&typeof window.prompt=="function"&&(i=window.prompt("Input: "),i!==null&&(i+=`
`)),!i)return null;Hg=Wg(i,!0)}return Hg.shift()},Qo={ttys:[],init(){},shutdown(){},register(i,c){Qo.ttys[i]={input:[],output:[],ops:c},_.registerDevice(i,Qo.stream_ops)},stream_ops:{open(i){var c=Qo.ttys[i.node.rdev];if(!c)throw new _.ErrnoError(43);i.tty=c,i.seekable=!1},close(i){i.tty.ops.fsync(i.tty)},fsync(i){i.tty.ops.fsync(i.tty)},read(i,c,l,h,S){if(!i.tty||!i.tty.ops.get_char)throw new _.ErrnoError(60);for(var I=0,A=0;A<h;A++){var F;try{F=i.tty.ops.get_char(i.tty)}catch{throw new _.ErrnoError(29)}if(F===void 0&&I===0)throw new _.ErrnoError(6);if(F==null)break;I++,c[l+A]=F}return I&&(i.node.timestamp=Date.now()),I},write(i,c,l,h,S){if(!i.tty||!i.tty.ops.put_char)throw new _.ErrnoError(60);try{for(var I=0;I<h;I++)i.tty.ops.put_char(i.tty,c[l+I])}catch{throw new _.ErrnoError(29)}return h&&(i.node.timestamp=Date.now()),I}},default_tty_ops:{get_char(i){return yx()},put_char(i,c){c===null||c===10?(v(_a(i.output)),i.output=[]):c!=0&&i.output.push(c)},fsync(i){i.output&&i.output.length>0&&(v(_a(i.output)),i.output=[])},ioctl_tcgets(i){return{c_iflag:25856,c_oflag:5,c_cflag:191,c_lflag:35387,c_cc:[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},ioctl_tcsets(i,c,l){return 0},ioctl_tiocgwinsz(i){return[24,80]}},default_tty1_ops:{put_char(i,c){c===null||c===10?(w(_a(i.output)),i.output=[]):c!=0&&i.output.push(c)},fsync(i){i.output&&i.output.length>0&&(w(_a(i.output)),i.output=[])}}},bx=(i,c)=>{x.fill(0,i,i+c)},qE=(i,c)=>Math.ceil(i/c)*c,AE=i=>{i=qE(i,65536);var c=zE(65536,i);return c&&bx(c,i),c},ke={ops_table:null,mount(i){return ke.createNode(null,"/",16895,0)},createNode(i,c,l,h){if(_.isBlkdev(l)||_.isFIFO(l))throw new _.ErrnoError(63);ke.ops_table||={dir:{node:{getattr:ke.node_ops.getattr,setattr:ke.node_ops.setattr,lookup:ke.node_ops.lookup,mknod:ke.node_ops.mknod,rename:ke.node_ops.rename,unlink:ke.node_ops.unlink,rmdir:ke.node_ops.rmdir,readdir:ke.node_ops.readdir,symlink:ke.node_ops.symlink},stream:{llseek:ke.stream_ops.llseek}},file:{node:{getattr:ke.node_ops.getattr,setattr:ke.node_ops.setattr},stream:{llseek:ke.stream_ops.llseek,read:ke.stream_ops.read,write:ke.stream_ops.write,allocate:ke.stream_ops.allocate,mmap:ke.stream_ops.mmap,msync:ke.stream_ops.msync}},link:{node:{getattr:ke.node_ops.getattr,setattr:ke.node_ops.setattr,readlink:ke.node_ops.readlink},stream:{}},chrdev:{node:{getattr:ke.node_ops.getattr,setattr:ke.node_ops.setattr},stream:_.chrdev_stream_ops}};var S=_.createNode(i,c,l,h);return _.isDir(S.mode)?(S.node_ops=ke.ops_table.dir.node,S.stream_ops=ke.ops_table.dir.stream,S.contents={}):_.isFile(S.mode)?(S.node_ops=ke.ops_table.file.node,S.stream_ops=ke.ops_table.file.stream,S.usedBytes=0,S.contents=null):_.isLink(S.mode)?(S.node_ops=ke.ops_table.link.node,S.stream_ops=ke.ops_table.link.stream):_.isChrdev(S.mode)&&(S.node_ops=ke.ops_table.chrdev.node,S.stream_ops=ke.ops_table.chrdev.stream),S.timestamp=Date.now(),i&&(i.contents[c]=S,i.timestamp=S.timestamp),S},getFileDataAsTypedArray(i){return i.contents?i.contents.subarray?i.contents.subarray(0,i.usedBytes):new Uint8Array(i.contents):new Uint8Array(0)},expandFileStorage(i,c){var l=i.contents?i.contents.length:0;if(!(l>=c)){var h=1024*1024;c=Math.max(c,l*(l<h?2:1.125)>>>0),l!=0&&(c=Math.max(c,256));var S=i.contents;i.contents=new Uint8Array(c),i.usedBytes>0&&i.contents.set(S.subarray(0,i.usedBytes),0)}},resizeFileStorage(i,c){if(i.usedBytes!=c)if(c==0)i.contents=null,i.usedBytes=0;else{var l=i.contents;i.contents=new Uint8Array(c),l&&i.contents.set(l.subarray(0,Math.min(c,i.usedBytes))),i.usedBytes=c}},node_ops:{getattr(i){var c={};return c.dev=_.isChrdev(i.mode)?i.id:1,c.ino=i.id,c.mode=i.mode,c.nlink=1,c.uid=0,c.gid=0,c.rdev=i.rdev,_.isDir(i.mode)?c.size=4096:_.isFile(i.mode)?c.size=i.usedBytes:_.isLink(i.mode)?c.size=i.link.length:c.size=0,c.atime=new Date(i.timestamp),c.mtime=new Date(i.timestamp),c.ctime=new Date(i.timestamp),c.blksize=4096,c.blocks=Math.ceil(c.size/c.blksize),c},setattr(i,c){c.mode!==void 0&&(i.mode=c.mode),c.timestamp!==void 0&&(i.timestamp=c.timestamp),c.size!==void 0&&ke.resizeFileStorage(i,c.size)},lookup(i,c){throw ke.doesNotExistError},mknod(i,c,l,h){return ke.createNode(i,c,l,h)},rename(i,c,l){if(_.isDir(i.mode)){var h;try{h=_.lookupNode(c,l)}catch{}if(h)for(var S in h.contents)throw new _.ErrnoError(55)}delete i.parent.contents[i.name],i.parent.timestamp=Date.now(),i.name=l,c.contents[l]=i,c.timestamp=i.parent.timestamp},unlink(i,c){delete i.contents[c],i.timestamp=Date.now()},rmdir(i,c){var l=_.lookupNode(i,c);for(var h in l.contents)throw new _.ErrnoError(55);delete i.contents[c],i.timestamp=Date.now()},readdir(i){var c=[".",".."];for(var l of Object.keys(i.contents))c.push(l);return c},symlink(i,c,l){var h=ke.createNode(i,c,41471,0);return h.link=l,h},readlink(i){if(!_.isLink(i.mode))throw new _.ErrnoError(28);return i.link}},stream_ops:{read(i,c,l,h,S){var I=i.node.contents;if(S>=i.node.usedBytes)return 0;var A=Math.min(i.node.usedBytes-S,h);if(A>8&&I.subarray)c.set(I.subarray(S,S+A),l);else for(var F=0;F<A;F++)c[l+F]=I[S+F];return A},write(i,c,l,h,S,I){if(c.buffer===q.buffer&&(I=!1),!h)return 0;var A=i.node;if(A.timestamp=Date.now(),c.subarray&&(!A.contents||A.contents.subarray)){if(I)return A.contents=c.subarray(l,l+h),A.usedBytes=h,h;if(A.usedBytes===0&&S===0)return A.contents=c.slice(l,l+h),A.usedBytes=h,h;if(S+h<=A.usedBytes)return A.contents.set(c.subarray(l,l+h),S),h}if(ke.expandFileStorage(A,S+h),A.contents.subarray&&c.subarray)A.contents.set(c.subarray(l,l+h),S);else for(var F=0;F<h;F++)A.contents[S+F]=c[l+F];return A.usedBytes=Math.max(A.usedBytes,S+h),h},llseek(i,c,l){var h=c;if(l===1?h+=i.position:l===2&&_.isFile(i.node.mode)&&(h+=i.node.usedBytes),h<0)throw new _.ErrnoError(28);return h},allocate(i,c,l){ke.expandFileStorage(i.node,c+l),i.node.usedBytes=Math.max(i.node.usedBytes,c+l)},mmap(i,c,l,h,S){if(!_.isFile(i.node.mode))throw new _.ErrnoError(43);var I,A,F=i.node.contents;if(!(S&2)&&F&&F.buffer===q.buffer)A=!1,I=F.byteOffset;else{if(A=!0,I=AE(c),!I)throw new _.ErrnoError(48);F&&((l>0||l+c<F.length)&&(F.subarray?F=F.subarray(l,l+c):F=Array.prototype.slice.call(F,l,l+c)),q.set(F,I))}return{ptr:I,allocated:A}},msync(i,c,l,h,S){return ke.stream_ops.write(i,c,0,h,l,!1),0}}},Sx=(i,c,l,h)=>{var S=`al ${i}`;O(i).then(I=>{c(new Uint8Array(I)),S&&ld()},I=>{if(l)l();else throw`Loading data file "${i}" failed.`}),S&&zg()},wx=(i,c,l,h,S,I)=>{_.createDataFile(i,c,l,h,S,I)},vx=r.preloadPlugins||[],Ex=(i,c,l,h)=>{typeof Browser<"u"&&Browser.init();var S=!1;return vx.forEach(I=>{S||I.canHandle(c)&&(I.handle(i,c,l,h),S=!0)}),S},kx=(i,c,l,h,S,I,A,F,U,ee)=>{var be=c?io.resolve(ot.join2(i,c)):i;function xe(Oe){function fe(ce){ee?.(),F||wx(i,c,ce,h,S,U),I?.(),ld()}Ex(Oe,be,fe,()=>{A?.(),ld()})||fe(Oe)}zg(),typeof l=="string"?Sx(l,xe,A):xe(l)},$x=i=>{var c={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090},l=c[i];if(typeof l>"u")throw new Error(`Unknown file open mode: ${i}`);return l},Kg=(i,c)=>{var l=0;return i&&(l|=365),c&&(l|=146),l},_={root:null,mounts:[],devices:{},streams:[],nextInode:1,nameTable:null,currentPath:"/",initialized:!1,ignorePermissions:!0,ErrnoError:class{name="ErrnoError";constructor(i){this.errno=i}},filesystems:null,syncFSRequests:0,readFiles:{},FSStream:class{shared={};get object(){return this.node}set object(i){this.node=i}get isRead(){return(this.flags&2097155)!==1}get isWrite(){return(this.flags&2097155)!==0}get isAppend(){return this.flags&1024}get flags(){return this.shared.flags}set flags(i){this.shared.flags=i}get position(){return this.shared.position}set position(i){this.shared.position=i}},FSNode:class{node_ops={};stream_ops={};readMode=365;writeMode=146;mounted=null;constructor(i,c,l,h){i||(i=this),this.parent=i,this.mount=i.mount,this.id=_.nextInode++,this.name=c,this.mode=l,this.rdev=h}get read(){return(this.mode&this.readMode)===this.readMode}set read(i){i?this.mode|=this.readMode:this.mode&=~this.readMode}get write(){return(this.mode&this.writeMode)===this.writeMode}set write(i){i?this.mode|=this.writeMode:this.mode&=~this.writeMode}get isFolder(){return _.isDir(this.mode)}get isDevice(){return _.isChrdev(this.mode)}},lookupPath(i,c={}){if(i=io.resolve(i),!i)return{path:"",node:null};var l={follow_mount:!0,recurse_count:0};if(c=Object.assign(l,c),c.recurse_count>8)throw new _.ErrnoError(32);for(var h=i.split("/").filter(xe=>!!xe),S=_.root,I="/",A=0;A<h.length;A++){var F=A===h.length-1;if(F&&c.parent)break;if(S=_.lookupNode(S,h[A]),I=ot.join2(I,h[A]),_.isMountpoint(S)&&(!F||F&&c.follow_mount)&&(S=S.mounted.root),!F||c.follow)for(var U=0;_.isLink(S.mode);){var ee=_.readlink(I);I=io.resolve(ot.dirname(I),ee);var be=_.lookupPath(I,{recurse_count:c.recurse_count+1});if(S=be.node,U++>40)throw new _.ErrnoError(32)}}return{path:I,node:S}},getPath(i){for(var c;;){if(_.isRoot(i)){var l=i.mount.mountpoint;return c?l[l.length-1]!=="/"?`${l}/${c}`:l+c:l}c=c?`${i.name}/${c}`:i.name,i=i.parent}},hashName(i,c){for(var l=0,h=0;h<c.length;h++)l=(l<<5)-l+c.charCodeAt(h)|0;return(i+l>>>0)%_.nameTable.length},hashAddNode(i){var c=_.hashName(i.parent.id,i.name);i.name_next=_.nameTable[c],_.nameTable[c]=i},hashRemoveNode(i){var c=_.hashName(i.parent.id,i.name);if(_.nameTable[c]===i)_.nameTable[c]=i.name_next;else for(var l=_.nameTable[c];l;){if(l.name_next===i){l.name_next=i.name_next;break}l=l.name_next}},lookupNode(i,c){var l=_.mayLookup(i);if(l)throw new _.ErrnoError(l);for(var h=_.hashName(i.id,c),S=_.nameTable[h];S;S=S.name_next){var I=S.name;if(S.parent.id===i.id&&I===c)return S}return _.lookup(i,c)},createNode(i,c,l,h){var S=new _.FSNode(i,c,l,h);return _.hashAddNode(S),S},destroyNode(i){_.hashRemoveNode(i)},isRoot(i){return i===i.parent},isMountpoint(i){return!!i.mounted},isFile(i){return(i&61440)===32768},isDir(i){return(i&61440)===16384},isLink(i){return(i&61440)===40960},isChrdev(i){return(i&61440)===8192},isBlkdev(i){return(i&61440)===24576},isFIFO(i){return(i&61440)===4096},isSocket(i){return(i&49152)===49152},flagsToPermissionString(i){var c=["r","w","rw"][i&3];return i&512&&(c+="w"),c},nodePermissions(i,c){return _.ignorePermissions?0:c.includes("r")&&!(i.mode&292)||c.includes("w")&&!(i.mode&146)||c.includes("x")&&!(i.mode&73)?2:0},mayLookup(i){if(!_.isDir(i.mode))return 54;var c=_.nodePermissions(i,"x");return c||(i.node_ops.lookup?0:2)},mayCreate(i,c){var l;try{return l=_.lookupNode(i,c),20}catch{}return _.nodePermissions(i,"wx")},mayDelete(i,c,l){var h;try{h=_.lookupNode(i,c)}catch(I){return I.errno}var S=_.nodePermissions(i,"wx");if(S)return S;if(l){if(!_.isDir(h.mode))return 54;if(_.isRoot(h)||_.getPath(h)===_.cwd())return 10}else if(_.isDir(h.mode))return 31;return 0},mayOpen(i,c){return i?_.isLink(i.mode)?32:_.isDir(i.mode)&&(_.flagsToPermissionString(c)!=="r"||c&512)?31:_.nodePermissions(i,_.flagsToPermissionString(c)):44},MAX_OPEN_FDS:4096,nextfd(){for(var i=0;i<=_.MAX_OPEN_FDS;i++)if(!_.streams[i])return i;throw new _.ErrnoError(33)},getStreamChecked(i){var c=_.getStream(i);if(!c)throw new _.ErrnoError(8);return c},getStream:i=>_.streams[i],createStream(i,c=-1){return i=Object.assign(new _.FSStream,i),c==-1&&(c=_.nextfd()),i.fd=c,_.streams[c]=i,i},closeStream(i){_.streams[i]=null},dupStream(i,c=-1){var l=_.createStream(i,c);return l.stream_ops?.dup?.(l),l},chrdev_stream_ops:{open(i){var c=_.getDevice(i.node.rdev);i.stream_ops=c.stream_ops,i.stream_ops.open?.(i)},llseek(){throw new _.ErrnoError(70)}},major:i=>i>>8,minor:i=>i&255,makedev:(i,c)=>i<<8|c,registerDevice(i,c){_.devices[i]={stream_ops:c}},getDevice:i=>_.devices[i],getMounts(i){for(var c=[],l=[i];l.length;){var h=l.pop();c.push(h),l.push(...h.mounts)}return c},syncfs(i,c){typeof i=="function"&&(c=i,i=!1),_.syncFSRequests++,_.syncFSRequests>1&&w(`warning: ${_.syncFSRequests} FS.syncfs operations in flight at once, probably just doing extra work`);var l=_.getMounts(_.root.mount),h=0;function S(A){return _.syncFSRequests--,c(A)}function I(A){if(A)return I.errored?void 0:(I.errored=!0,S(A));++h>=l.length&&S(null)}l.forEach(A=>{if(!A.type.syncfs)return I(null);A.type.syncfs(A,i,I)})},mount(i,c,l){var h=l==="/",S=!l,I;if(h&&_.root)throw new _.ErrnoError(10);if(!h&&!S){var A=_.lookupPath(l,{follow_mount:!1});if(l=A.path,I=A.node,_.isMountpoint(I))throw new _.ErrnoError(10);if(!_.isDir(I.mode))throw new _.ErrnoError(54)}var F={type:i,opts:c,mountpoint:l,mounts:[]},U=i.mount(F);return U.mount=F,F.root=U,h?_.root=U:I&&(I.mounted=F,I.mount&&I.mount.mounts.push(F)),U},unmount(i){var c=_.lookupPath(i,{follow_mount:!1});if(!_.isMountpoint(c.node))throw new _.ErrnoError(28);var l=c.node,h=l.mounted,S=_.getMounts(h);Object.keys(_.nameTable).forEach(A=>{for(var F=_.nameTable[A];F;){var U=F.name_next;S.includes(F.mount)&&_.destroyNode(F),F=U}}),l.mounted=null;var I=l.mount.mounts.indexOf(h);l.mount.mounts.splice(I,1)},lookup(i,c){return i.node_ops.lookup(i,c)},mknod(i,c,l){var h=_.lookupPath(i,{parent:!0}),S=h.node,I=ot.basename(i);if(!I||I==="."||I==="..")throw new _.ErrnoError(28);var A=_.mayCreate(S,I);if(A)throw new _.ErrnoError(A);if(!S.node_ops.mknod)throw new _.ErrnoError(63);return S.node_ops.mknod(S,I,c,l)},statfs(i){var c={bsize:4096,frsize:4096,blocks:1e6,bfree:5e5,bavail:5e5,files:_.nextInode,ffree:_.nextInode-1,fsid:42,flags:2,namelen:255},l=_.lookupPath(i,{follow:!0}).node;return l?.node_ops.statfs&&Object.assign(c,l.node_ops.statfs(l.mount.opts.root)),c},create(i,c=438){return c&=4095,c|=32768,_.mknod(i,c,0)},mkdir(i,c=511){return c&=1023,c|=16384,_.mknod(i,c,0)},mkdirTree(i,c){for(var l=i.split("/"),h="",S=0;S<l.length;++S)if(l[S]){h+="/"+l[S];try{_.mkdir(h,c)}catch(I){if(I.errno!=20)throw I}}},mkdev(i,c,l){return typeof l>"u"&&(l=c,c=438),c|=8192,_.mknod(i,c,l)},symlink(i,c){if(!io.resolve(i))throw new _.ErrnoError(44);var l=_.lookupPath(c,{parent:!0}),h=l.node;if(!h)throw new _.ErrnoError(44);var S=ot.basename(c),I=_.mayCreate(h,S);if(I)throw new _.ErrnoError(I);if(!h.node_ops.symlink)throw new _.ErrnoError(63);return h.node_ops.symlink(h,S,i)},rename(i,c){var l=ot.dirname(i),h=ot.dirname(c),S=ot.basename(i),I=ot.basename(c),A,F,U;if(A=_.lookupPath(i,{parent:!0}),F=A.node,A=_.lookupPath(c,{parent:!0}),U=A.node,!F||!U)throw new _.ErrnoError(44);if(F.mount!==U.mount)throw new _.ErrnoError(75);var ee=_.lookupNode(F,S),be=io.relative(i,h);if(be.charAt(0)!==".")throw new _.ErrnoError(28);if(be=io.relative(c,l),be.charAt(0)!==".")throw new _.ErrnoError(55);var xe;try{xe=_.lookupNode(U,I)}catch{}if(ee!==xe){var Oe=_.isDir(ee.mode),fe=_.mayDelete(F,S,Oe);if(fe)throw new _.ErrnoError(fe);if(fe=xe?_.mayDelete(U,I,Oe):_.mayCreate(U,I),fe)throw new _.ErrnoError(fe);if(!F.node_ops.rename)throw new _.ErrnoError(63);if(_.isMountpoint(ee)||xe&&_.isMountpoint(xe))throw new _.ErrnoError(10);if(U!==F&&(fe=_.nodePermissions(F,"w"),fe))throw new _.ErrnoError(fe);_.hashRemoveNode(ee);try{F.node_ops.rename(ee,U,I),ee.parent=U}catch(ce){throw ce}finally{_.hashAddNode(ee)}}},rmdir(i){var c=_.lookupPath(i,{parent:!0}),l=c.node,h=ot.basename(i),S=_.lookupNode(l,h),I=_.mayDelete(l,h,!0);if(I)throw new _.ErrnoError(I);if(!l.node_ops.rmdir)throw new _.ErrnoError(63);if(_.isMountpoint(S))throw new _.ErrnoError(10);l.node_ops.rmdir(l,h),_.destroyNode(S)},readdir(i){var c=_.lookupPath(i,{follow:!0}),l=c.node;if(!l.node_ops.readdir)throw new _.ErrnoError(54);return l.node_ops.readdir(l)},unlink(i){var c=_.lookupPath(i,{parent:!0}),l=c.node;if(!l)throw new _.ErrnoError(44);var h=ot.basename(i),S=_.lookupNode(l,h),I=_.mayDelete(l,h,!1);if(I)throw new _.ErrnoError(I);if(!l.node_ops.unlink)throw new _.ErrnoError(63);if(_.isMountpoint(S))throw new _.ErrnoError(10);l.node_ops.unlink(l,h),_.destroyNode(S)},readlink(i){var c=_.lookupPath(i),l=c.node;if(!l)throw new _.ErrnoError(44);if(!l.node_ops.readlink)throw new _.ErrnoError(28);return l.node_ops.readlink(l)},stat(i,c){var l=_.lookupPath(i,{follow:!c}),h=l.node;if(!h)throw new _.ErrnoError(44);if(!h.node_ops.getattr)throw new _.ErrnoError(63);return h.node_ops.getattr(h)},lstat(i){return _.stat(i,!0)},chmod(i,c,l){var h;if(typeof i=="string"){var S=_.lookupPath(i,{follow:!l});h=S.node}else h=i;if(!h.node_ops.setattr)throw new _.ErrnoError(63);h.node_ops.setattr(h,{mode:c&4095|h.mode&-4096,timestamp:Date.now()})},lchmod(i,c){_.chmod(i,c,!0)},fchmod(i,c){var l=_.getStreamChecked(i);_.chmod(l.node,c)},chown(i,c,l,h){var S;if(typeof i=="string"){var I=_.lookupPath(i,{follow:!h});S=I.node}else S=i;if(!S.node_ops.setattr)throw new _.ErrnoError(63);S.node_ops.setattr(S,{timestamp:Date.now()})},lchown(i,c,l){_.chown(i,c,l,!0)},fchown(i,c,l){var h=_.getStreamChecked(i);_.chown(h.node,c,l)},truncate(i,c){if(c<0)throw new _.ErrnoError(28);var l;if(typeof i=="string"){var h=_.lookupPath(i,{follow:!0});l=h.node}else l=i;if(!l.node_ops.setattr)throw new _.ErrnoError(63);if(_.isDir(l.mode))throw new _.ErrnoError(31);if(!_.isFile(l.mode))throw new _.ErrnoError(28);var S=_.nodePermissions(l,"w");if(S)throw new _.ErrnoError(S);l.node_ops.setattr(l,{size:c,timestamp:Date.now()})},ftruncate(i,c){var l=_.getStreamChecked(i);if((l.flags&2097155)===0)throw new _.ErrnoError(28);_.truncate(l.node,c)},utime(i,c,l){var h=_.lookupPath(i,{follow:!0}),S=h.node;S.node_ops.setattr(S,{timestamp:Math.max(c,l)})},open(i,c,l=438){if(i==="")throw new _.ErrnoError(44);c=typeof c=="string"?$x(c):c,c&64?l=l&4095|32768:l=0;var h;if(typeof i=="object")h=i;else{i=ot.normalize(i);try{var S=_.lookupPath(i,{follow:!(c&131072)});h=S.node}catch{}}var I=!1;if(c&64)if(h){if(c&128)throw new _.ErrnoError(20)}else h=_.mknod(i,l,0),I=!0;if(!h)throw new _.ErrnoError(44);if(_.isChrdev(h.mode)&&(c&=-513),c&65536&&!_.isDir(h.mode))throw new _.ErrnoError(54);if(!I){var A=_.mayOpen(h,c);if(A)throw new _.ErrnoError(A)}c&512&&!I&&_.truncate(h,0),c&=-131713;var F=_.createStream({node:h,path:_.getPath(h),flags:c,seekable:!0,position:0,stream_ops:h.stream_ops,ungotten:[],error:!1});return F.stream_ops.open&&F.stream_ops.open(F),r.logReadFiles&&!(c&1)&&(i in _.readFiles||(_.readFiles[i]=1)),F},close(i){if(_.isClosed(i))throw new _.ErrnoError(8);i.getdents&&(i.getdents=null);try{i.stream_ops.close&&i.stream_ops.close(i)}catch(c){throw c}finally{_.closeStream(i.fd)}i.fd=null},isClosed(i){return i.fd===null},llseek(i,c,l){if(_.isClosed(i))throw new _.ErrnoError(8);if(!i.seekable||!i.stream_ops.llseek)throw new _.ErrnoError(70);if(l!=0&&l!=1&&l!=2)throw new _.ErrnoError(28);return i.position=i.stream_ops.llseek(i,c,l),i.ungotten=[],i.position},read(i,c,l,h,S){if(h<0||S<0)throw new _.ErrnoError(28);if(_.isClosed(i))throw new _.ErrnoError(8);if((i.flags&2097155)===1)throw new _.ErrnoError(8);if(_.isDir(i.node.mode))throw new _.ErrnoError(31);if(!i.stream_ops.read)throw new _.ErrnoError(28);var I=typeof S<"u";if(!I)S=i.position;else if(!i.seekable)throw new _.ErrnoError(70);var A=i.stream_ops.read(i,c,l,h,S);return I||(i.position+=A),A},write(i,c,l,h,S,I){if(h<0||S<0)throw new _.ErrnoError(28);if(_.isClosed(i))throw new _.ErrnoError(8);if((i.flags&2097155)===0)throw new _.ErrnoError(8);if(_.isDir(i.node.mode))throw new _.ErrnoError(31);if(!i.stream_ops.write)throw new _.ErrnoError(28);i.seekable&&i.flags&1024&&_.llseek(i,0,2);var A=typeof S<"u";if(!A)S=i.position;else if(!i.seekable)throw new _.ErrnoError(70);var F=i.stream_ops.write(i,c,l,h,S,I);return A||(i.position+=F),F},allocate(i,c,l){if(_.isClosed(i))throw new _.ErrnoError(8);if(c<0||l<=0)throw new _.ErrnoError(28);if((i.flags&2097155)===0)throw new _.ErrnoError(8);if(!_.isFile(i.node.mode)&&!_.isDir(i.node.mode))throw new _.ErrnoError(43);if(!i.stream_ops.allocate)throw new _.ErrnoError(138);i.stream_ops.allocate(i,c,l)},mmap(i,c,l,h,S){if((h&2)!==0&&(S&2)===0&&(i.flags&2097155)!==2)throw new _.ErrnoError(2);if((i.flags&2097155)===1)throw new _.ErrnoError(2);if(!i.stream_ops.mmap)throw new _.ErrnoError(43);if(!c)throw new _.ErrnoError(28);return i.stream_ops.mmap(i,c,l,h,S)},msync(i,c,l,h,S){return i.stream_ops.msync?i.stream_ops.msync(i,c,l,h,S):0},ioctl(i,c,l){if(!i.stream_ops.ioctl)throw new _.ErrnoError(59);return i.stream_ops.ioctl(i,c,l)},readFile(i,c={}){if(c.flags=c.flags||0,c.encoding=c.encoding||"binary",c.encoding!=="utf8"&&c.encoding!=="binary")throw new Error(`Invalid encoding type "${c.encoding}"`);var l,h=_.open(i,c.flags),S=_.stat(i),I=S.size,A=new Uint8Array(I);return _.read(h,A,0,I,0),c.encoding==="utf8"?l=_a(A):c.encoding==="binary"&&(l=A),_.close(h),l},writeFile(i,c,l={}){l.flags=l.flags||577;var h=_.open(i,l.flags,l.mode);if(typeof c=="string"){var S=new Uint8Array(ya(c)+1),I=Vg(c,S,0,S.length);_.write(h,S,0,I,void 0,l.canOwn)}else if(ArrayBuffer.isView(c))_.write(h,c,0,c.byteLength,void 0,l.canOwn);else throw new Error("Unsupported data type");_.close(h)},cwd:()=>_.currentPath,chdir(i){var c=_.lookupPath(i,{follow:!0});if(c.node===null)throw new _.ErrnoError(44);if(!_.isDir(c.node.mode))throw new _.ErrnoError(54);var l=_.nodePermissions(c.node,"x");if(l)throw new _.ErrnoError(l);_.currentPath=c.path},createDefaultDirectories(){_.mkdir("/tmp"),_.mkdir("/home"),_.mkdir("/home/web_user")},createDefaultDevices(){_.mkdir("/dev"),_.registerDevice(_.makedev(1,3),{read:()=>0,write:(h,S,I,A,F)=>A,llseek:()=>0}),_.mkdev("/dev/null",_.makedev(1,3)),Qo.register(_.makedev(5,0),Qo.default_tty_ops),Qo.register(_.makedev(6,0),Qo.default_tty1_ops),_.mkdev("/dev/tty",_.makedev(5,0)),_.mkdev("/dev/tty1",_.makedev(6,0));var i=new Uint8Array(1024),c=0,l=()=>(c===0&&(c=RE(i).byteLength),i[--c]);_.createDevice("/dev","random",l),_.createDevice("/dev","urandom",l),_.mkdir("/dev/shm"),_.mkdir("/dev/shm/tmp")},createSpecialDirectories(){_.mkdir("/proc");var i=_.mkdir("/proc/self");_.mkdir("/proc/self/fd"),_.mount({mount(){var c=_.createNode(i,"fd",16895,73);return c.node_ops={lookup(l,h){var S=+h,I=_.getStreamChecked(S),A={parent:null,mount:{mountpoint:"fake"},node_ops:{readlink:()=>I.path}};return A.parent=A,A}},c}},{},"/proc/self/fd")},createStandardStreams(i,c,l){i?_.createDevice("/dev","stdin",i):_.symlink("/dev/tty","/dev/stdin"),c?_.createDevice("/dev","stdout",null,c):_.symlink("/dev/tty","/dev/stdout"),l?_.createDevice("/dev","stderr",null,l):_.symlink("/dev/tty1","/dev/stderr"),_.open("/dev/stdin",0),_.open("/dev/stdout",1),_.open("/dev/stderr",1)},staticInit(){_.nameTable=new Array(4096),_.mount(ke,{},"/"),_.createDefaultDirectories(),_.createDefaultDevices(),_.createSpecialDirectories(),_.filesystems={MEMFS:ke}},init(i,c,l){_.initialized=!0,i??=r.stdin,c??=r.stdout,l??=r.stderr,_.createStandardStreams(i,c,l)},quit(){_.initialized=!1;for(var i=0;i<_.streams.length;i++){var c=_.streams[i];c&&_.close(c)}},findObject(i,c){var l=_.analyzePath(i,c);return l.exists?l.object:null},analyzePath(i,c){try{var l=_.lookupPath(i,{follow:!c});i=l.path}catch{}var h={isRoot:!1,exists:!1,error:0,name:null,path:null,object:null,parentExists:!1,parentPath:null,parentObject:null};try{var l=_.lookupPath(i,{parent:!0});h.parentExists=!0,h.parentPath=l.path,h.parentObject=l.node,h.name=ot.basename(i),l=_.lookupPath(i,{follow:!c}),h.exists=!0,h.path=l.path,h.object=l.node,h.name=l.node.name,h.isRoot=l.path==="/"}catch(S){h.error=S.errno}return h},createPath(i,c,l,h){i=typeof i=="string"?i:_.getPath(i);for(var S=c.split("/").reverse();S.length;){var I=S.pop();if(I){var A=ot.join2(i,I);try{_.mkdir(A)}catch{}i=A}}return A},createFile(i,c,l,h,S){var I=ot.join2(typeof i=="string"?i:_.getPath(i),c),A=Kg(h,S);return _.create(I,A)},createDataFile(i,c,l,h,S,I){var A=c;i&&(i=typeof i=="string"?i:_.getPath(i),A=c?ot.join2(i,c):i);var F=Kg(h,S),U=_.create(A,F);if(l){if(typeof l=="string"){for(var ee=new Array(l.length),be=0,xe=l.length;be<xe;++be)ee[be]=l.charCodeAt(be);l=ee}_.chmod(U,F|146);var Oe=_.open(U,577);_.write(Oe,l,0,l.length,0,I),_.close(Oe),_.chmod(U,F)}},createDevice(i,c,l,h){var S=ot.join2(typeof i=="string"?i:_.getPath(i),c),I=Kg(!!l,!!h);_.createDevice.major??=64;var A=_.makedev(_.createDevice.major++,0);return _.registerDevice(A,{open(F){F.seekable=!1},close(F){h?.buffer?.length&&h(10)},read(F,U,ee,be,xe){for(var Oe=0,fe=0;fe<be;fe++){var ce;try{ce=l()}catch{throw new _.ErrnoError(29)}if(ce===void 0&&Oe===0)throw new _.ErrnoError(6);if(ce==null)break;Oe++,U[ee+fe]=ce}return Oe&&(F.node.timestamp=Date.now()),Oe},write(F,U,ee,be,xe){for(var Oe=0;Oe<be;Oe++)try{h(U[ee+Oe])}catch{throw new _.ErrnoError(29)}return be&&(F.node.timestamp=Date.now()),Oe}}),_.mkdev(S,I,A)},forceLoadFile(i){if(i.isDevice||i.isFolder||i.link||i.contents)return!0;if(typeof XMLHttpRequest<"u")throw new Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.");try{i.contents=N(i.url),i.usedBytes=i.contents.length}catch{throw new _.ErrnoError(29)}},createLazyFile(i,c,l,h,S){class I{lengthKnown=!1;chunks=[];get(fe){if(!(fe>this.length-1||fe<0)){var ce=fe%this.chunkSize,Tt=fe/this.chunkSize|0;return this.getter(Tt)[ce]}}setDataGetter(fe){this.getter=fe}cacheLength(){var fe=new XMLHttpRequest;if(fe.open("HEAD",l,!1),fe.send(null),!(fe.status>=200&&fe.status<300||fe.status===304))throw new Error("Couldn't load "+l+". Status: "+fe.status);var ce=Number(fe.getResponseHeader("Content-length")),Tt,Wn=(Tt=fe.getResponseHeader("Accept-Ranges"))&&Tt==="bytes",Kn=(Tt=fe.getResponseHeader("Content-Encoding"))&&Tt==="gzip",$r=1024*1024;Wn||($r=ce);var Tr=(jr,wa)=>{if(jr>wa)throw new Error("invalid range ("+jr+", "+wa+") or no bytes requested!");if(wa>ce-1)throw new Error("only "+ce+" bytes available! programmer error!");var cn=new XMLHttpRequest;if(cn.open("GET",l,!1),ce!==$r&&cn.setRequestHeader("Range","bytes="+jr+"-"+wa),cn.responseType="arraybuffer",cn.overrideMimeType&&cn.overrideMimeType("text/plain; charset=x-user-defined"),cn.send(null),!(cn.status>=200&&cn.status<300||cn.status===304))throw new Error("Couldn't load "+l+". Status: "+cn.status);return cn.response!==void 0?new Uint8Array(cn.response||[]):Wg(cn.responseText||"",!0)},wu=this;wu.setDataGetter(jr=>{var wa=jr*$r,cn=(jr+1)*$r-1;if(cn=Math.min(cn,ce-1),typeof wu.chunks[jr]>"u"&&(wu.chunks[jr]=Tr(wa,cn)),typeof wu.chunks[jr]>"u")throw new Error("doXHR failed!");return wu.chunks[jr]}),(Kn||!ce)&&($r=ce=1,ce=this.getter(0).length,$r=ce,v("LazyFiles on gzip forces download of the whole file when length is accessed")),this._length=ce,this._chunkSize=$r,this.lengthKnown=!0}get length(){return this.lengthKnown||this.cacheLength(),this._length}get chunkSize(){return this.lengthKnown||this.cacheLength(),this._chunkSize}}if(typeof XMLHttpRequest<"u"){if(!f)throw"Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc";var A=new I,F={isDevice:!1,contents:A}}else var F={isDevice:!1,url:l};var U=_.createFile(i,c,F,h,S);F.contents?U.contents=F.contents:F.url&&(U.contents=null,U.url=F.url),Object.defineProperties(U,{usedBytes:{get:function(){return this.contents.length}}});var ee={},be=Object.keys(U.stream_ops);be.forEach(Oe=>{var fe=U.stream_ops[Oe];ee[Oe]=(...ce)=>(_.forceLoadFile(U),fe(...ce))});function xe(Oe,fe,ce,Tt,Wn){var Kn=Oe.node.contents;if(Wn>=Kn.length)return 0;var $r=Math.min(Kn.length-Wn,Tt);if(Kn.slice)for(var Tr=0;Tr<$r;Tr++)fe[ce+Tr]=Kn[Wn+Tr];else for(var Tr=0;Tr<$r;Tr++)fe[ce+Tr]=Kn.get(Wn+Tr);return $r}return ee.read=(Oe,fe,ce,Tt,Wn)=>(_.forceLoadFile(U),xe(Oe,fe,ce,Tt,Wn)),ee.mmap=(Oe,fe,ce,Tt,Wn)=>{_.forceLoadFile(U);var Kn=AE(fe);if(!Kn)throw new _.ErrnoError(48);return xe(Oe,q,Kn,fe,ce),{ptr:Kn,allocated:!0}},U.stream_ops=ee,U}},Pe={DEFAULT_POLLMASK:5,calculateAt(i,c,l){if(ot.isAbs(c))return c;var h;if(i===-100)h=_.cwd();else{var S=Pe.getStreamFromFD(i);h=S.path}if(c.length==0){if(!l)throw new _.ErrnoError(44);return h}return ot.join2(h,c)},doStat(i,c,l){var h=i(c);P[l>>2]=h.dev,P[l+4>>2]=h.mode,L[l+8>>2]=h.nlink,P[l+12>>2]=h.uid,P[l+16>>2]=h.gid,P[l+20>>2]=h.rdev,St=[h.size>>>0,(_e=h.size,+Math.abs(_e)>=1?_e>0?+Math.floor(_e/4294967296)>>>0:~~+Math.ceil((_e-+(~~_e>>>0))/4294967296)>>>0:0)],P[l+24>>2]=St[0],P[l+28>>2]=St[1],P[l+32>>2]=4096,P[l+36>>2]=h.blocks;var S=h.atime.getTime(),I=h.mtime.getTime(),A=h.ctime.getTime();return St=[Math.floor(S/1e3)>>>0,(_e=Math.floor(S/1e3),+Math.abs(_e)>=1?_e>0?+Math.floor(_e/4294967296)>>>0:~~+Math.ceil((_e-+(~~_e>>>0))/4294967296)>>>0:0)],P[l+40>>2]=St[0],P[l+44>>2]=St[1],L[l+48>>2]=S%1e3*1e3*1e3,St=[Math.floor(I/1e3)>>>0,(_e=Math.floor(I/1e3),+Math.abs(_e)>=1?_e>0?+Math.floor(_e/4294967296)>>>0:~~+Math.ceil((_e-+(~~_e>>>0))/4294967296)>>>0:0)],P[l+56>>2]=St[0],P[l+60>>2]=St[1],L[l+64>>2]=I%1e3*1e3*1e3,St=[Math.floor(A/1e3)>>>0,(_e=Math.floor(A/1e3),+Math.abs(_e)>=1?_e>0?+Math.floor(_e/4294967296)>>>0:~~+Math.ceil((_e-+(~~_e>>>0))/4294967296)>>>0:0)],P[l+72>>2]=St[0],P[l+76>>2]=St[1],L[l+80>>2]=A%1e3*1e3*1e3,St=[h.ino>>>0,(_e=h.ino,+Math.abs(_e)>=1?_e>0?+Math.floor(_e/4294967296)>>>0:~~+Math.ceil((_e-+(~~_e>>>0))/4294967296)>>>0:0)],P[l+88>>2]=St[0],P[l+92>>2]=St[1],0},doMsync(i,c,l,h,S){if(!_.isFile(c.node.mode))throw new _.ErrnoError(43);if(h&2)return 0;var I=x.slice(i,i+l);_.msync(c,I,S,l,h)},getStreamFromFD(i){var c=_.getStreamChecked(i);return c},varargs:void 0,getStr(i){var c=Go(i);return c}};function Tx(i,c){try{return i=Pe.getStr(i),_.chmod(i,c),0}catch(l){if(typeof _>"u"||l.name!=="ErrnoError")throw l;return-l.errno}}function Cx(i,c,l,h){try{if(c=Pe.getStr(c),c=Pe.calculateAt(i,c),l&-8)return-28;var S=_.lookupPath(c,{follow:!0}),I=S.node;if(!I)return-44;var A="";return l&4&&(A+="r"),l&2&&(A+="w"),l&1&&(A+="x"),A&&_.nodePermissions(I,A)?-2:0}catch(F){if(typeof _>"u"||F.name!=="ErrnoError")throw F;return-F.errno}}function Ix(i,c){try{return _.fchmod(i,c),0}catch(l){if(typeof _>"u"||l.name!=="ErrnoError")throw l;return-l.errno}}function Ox(i,c,l){try{return _.fchown(i,c,l),0}catch(h){if(typeof _>"u"||h.name!=="ErrnoError")throw h;return-h.errno}}var dd=()=>{var i=P[+Pe.varargs>>2];return Pe.varargs+=4,i},Rx=dd;function qx(i,c,l){Pe.varargs=l;try{var h=Pe.getStreamFromFD(i);switch(c){case 0:{var S=dd();if(S<0)return-28;for(;_.streams[S];)S++;var I;return I=_.dupStream(h,S),I.fd}case 1:case 2:return 0;case 3:return h.flags;case 4:{var S=dd();return h.flags|=S,0}case 12:{var S=Rx(),A=0;return D[S+A>>1]=2,0}case 13:case 14:return 0}return-28}catch(F){if(typeof _>"u"||F.name!=="ErrnoError")throw F;return-F.errno}}function Ax(i,c){try{var l=Pe.getStreamFromFD(i);return Pe.doStat(_.stat,l.path,c)}catch(h){if(typeof _>"u"||h.name!=="ErrnoError")throw h;return-h.errno}}var bu=(i,c)=>c+2097152>>>0<4194305-!!i?(i>>>0)+c*4294967296:NaN;function Fx(i,c,l){var h=bu(c,l);try{return isNaN(h)?61:(_.ftruncate(i,h),0)}catch(S){if(typeof _>"u"||S.name!=="ErrnoError")throw S;return-S.errno}}var ao=(i,c,l)=>Vg(i,x,c,l);function Px(i,c){try{if(c===0)return-28;var l=_.cwd(),h=ya(l)+1;return c<h?-68:(ao(l,i,c),h)}catch(S){if(typeof _>"u"||S.name!=="ErrnoError")throw S;return-S.errno}}function xx(i,c){try{return i=Pe.getStr(i),Pe.doStat(_.lstat,i,c)}catch(l){if(typeof _>"u"||l.name!=="ErrnoError")throw l;return-l.errno}}function Nx(i,c,l){try{return c=Pe.getStr(c),c=Pe.calculateAt(i,c),c=ot.normalize(c),c[c.length-1]==="/"&&(c=c.substr(0,c.length-1)),_.mkdir(c,l,0),0}catch(h){if(typeof _>"u"||h.name!=="ErrnoError")throw h;return-h.errno}}function Dx(i,c,l,h){try{c=Pe.getStr(c);var S=h&256,I=h&4096;return h=h&-6401,c=Pe.calculateAt(i,c,I),Pe.doStat(S?_.lstat:_.stat,c,l)}catch(A){if(typeof _>"u"||A.name!=="ErrnoError")throw A;return-A.errno}}function Mx(i,c,l,h){Pe.varargs=h;try{c=Pe.getStr(c),c=Pe.calculateAt(i,c);var S=h?dd():0;return _.open(c,l,S).fd}catch(I){if(typeof _>"u"||I.name!=="ErrnoError")throw I;return-I.errno}}function Lx(i,c,l,h){try{if(c=Pe.getStr(c),c=Pe.calculateAt(i,c),h<=0)return-28;var S=_.readlink(c),I=Math.min(h,ya(S)),A=q[l+I];return ao(S,l,h+1),q[l+I]=A,I}catch(F){if(typeof _>"u"||F.name!=="ErrnoError")throw F;return-F.errno}}function jx(i){try{return i=Pe.getStr(i),_.rmdir(i),0}catch(c){if(typeof _>"u"||c.name!=="ErrnoError")throw c;return-c.errno}}function Ux(i,c){try{return i=Pe.getStr(i),Pe.doStat(_.stat,i,c)}catch(l){if(typeof _>"u"||l.name!=="ErrnoError")throw l;return-l.errno}}function zx(i,c,l){try{return c=Pe.getStr(c),c=Pe.calculateAt(i,c),l===0?_.unlink(c):l===512?_.rmdir(c):oo("Invalid flags passed to unlinkat"),0}catch(h){if(typeof _>"u"||h.name!=="ErrnoError")throw h;return-h.errno}}var FE=i=>L[i>>2]+P[i+4>>2]*4294967296;function Bx(i,c,l,h){try{c=Pe.getStr(c),c=Pe.calculateAt(i,c,!0);var S=Date.now(),I,A;if(!l)I=S,A=S;else{var F=FE(l),U=P[l+8>>2];U==1073741823?I=S:U==1073741822?I=-1:I=F*1e3+U/(1e3*1e3),l+=16,F=FE(l),U=P[l+8>>2],U==1073741823?A=S:U==1073741822?A=-1:A=F*1e3+U/(1e3*1e3)}return(A!=-1||I!=-1)&&_.utime(c,I,A),0}catch(ee){if(typeof _>"u"||ee.name!=="ErrnoError")throw ee;return-ee.errno}}var Hx=i=>i%4===0&&(i%100!==0||i%400===0),Vx=[0,31,60,91,121,152,182,213,244,274,305,335],Wx=[0,31,59,90,120,151,181,212,243,273,304,334],Kx=i=>{var c=Hx(i.getFullYear()),l=c?Vx:Wx,h=l[i.getMonth()]+i.getDate()-1;return h};function Jx(i,c,l){var h=bu(i,c),S=new Date(h*1e3);P[l>>2]=S.getSeconds(),P[l+4>>2]=S.getMinutes(),P[l+8>>2]=S.getHours(),P[l+12>>2]=S.getDate(),P[l+16>>2]=S.getMonth(),P[l+20>>2]=S.getFullYear()-1900,P[l+24>>2]=S.getDay();var I=Kx(S)|0;P[l+28>>2]=I,P[l+36>>2]=-(S.getTimezoneOffset()*60);var A=new Date(S.getFullYear(),0,1),F=new Date(S.getFullYear(),6,1).getTimezoneOffset(),U=A.getTimezoneOffset(),ee=(F!=U&&S.getTimezoneOffset()==Math.min(U,F))|0;P[l+32>>2]=ee}function Gx(i,c,l,h,S,I,A,F){var U=bu(S,I);try{if(isNaN(U))return 61;var ee=Pe.getStreamFromFD(h),be=_.mmap(ee,i,U,c,l),xe=be.ptr;return P[A>>2]=be.allocated,L[F>>2]=xe,0}catch(Oe){if(typeof _>"u"||Oe.name!=="ErrnoError")throw Oe;return-Oe.errno}}function Qx(i,c,l,h,S,I,A){var F=bu(I,A);try{var U=Pe.getStreamFromFD(S);l&2&&Pe.doMsync(i,U,c,h,F)}catch(ee){if(typeof _>"u"||ee.name!=="ErrnoError")throw ee;return-ee.errno}}var Yx=(i,c,l,h)=>{var S=new Date().getFullYear(),I=new Date(S,0,1),A=new Date(S,6,1),F=I.getTimezoneOffset(),U=A.getTimezoneOffset(),ee=Math.max(F,U);L[i>>2]=ee*60,P[c>>2]=+(F!=U);var be=fe=>{var ce=fe>=0?"-":"+",Tt=Math.abs(fe),Wn=String(Math.floor(Tt/60)).padStart(2,"0"),Kn=String(Tt%60).padStart(2,"0");return`UTC${ce}${Wn}${Kn}`},xe=be(F),Oe=be(U);U<F?(ao(xe,l,17),ao(Oe,h,17)):(ao(xe,h,17),ao(Oe,l,17))},Xx=()=>Date.now(),Zx=()=>performance.now(),eN=()=>2147483648,tN=i=>{var c=E.buffer,l=(i-c.byteLength+65535)/65536|0;try{return E.grow(l),K(),1}catch{}},nN=i=>{var c=x.length;i>>>=0;var l=eN();if(i>l)return!1;for(var h=1;h<=4;h*=2){var S=c*(1+.2/h);S=Math.min(S,i+100663296);var I=Math.min(l,qE(Math.max(i,S),65536)),A=tN(I);if(A)return!0}return!1},Jg={},rN=()=>p||"./this.program",Su=()=>{if(!Su.strings){var i=(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",c={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:i,_:rN()};for(var l in Jg)Jg[l]===void 0?delete c[l]:c[l]=Jg[l];var h=[];for(var l in c)h.push(`${l}=${c[l]}`);Su.strings=h}return Su.strings},sN=(i,c)=>{for(var l=0;l<i.length;++l)q[c++]=i.charCodeAt(l);q[c]=0},oN=(i,c)=>{var l=0;return Su().forEach((h,S)=>{var I=c+l;L[i+S*4>>2]=I,sN(h,I),l+=h.length+1}),0},iN=(i,c)=>{var l=Su();L[i>>2]=l.length;var h=0;return l.forEach(S=>h+=S.length+1),L[c>>2]=h,0};function aN(i){try{var c=Pe.getStreamFromFD(i);return _.close(c),0}catch(l){if(typeof _>"u"||l.name!=="ErrnoError")throw l;return l.errno}}function cN(i,c){try{var l=0,h=0,S=0,I=Pe.getStreamFromFD(i),A=I.tty?2:_.isDir(I.mode)?3:_.isLink(I.mode)?7:4;return q[c]=A,D[c+2>>1]=S,St=[l>>>0,(_e=l,+Math.abs(_e)>=1?_e>0?+Math.floor(_e/4294967296)>>>0:~~+Math.ceil((_e-+(~~_e>>>0))/4294967296)>>>0:0)],P[c+8>>2]=St[0],P[c+12>>2]=St[1],St=[h>>>0,(_e=h,+Math.abs(_e)>=1?_e>0?+Math.floor(_e/4294967296)>>>0:~~+Math.ceil((_e-+(~~_e>>>0))/4294967296)>>>0:0)],P[c+16>>2]=St[0],P[c+20>>2]=St[1],0}catch(F){if(typeof _>"u"||F.name!=="ErrnoError")throw F;return F.errno}}var uN=(i,c,l,h)=>{for(var S=0,I=0;I<l;I++){var A=L[c>>2],F=L[c+4>>2];c+=8;var U=_.read(i,q,A,F,h);if(U<0)return-1;if(S+=U,U<F)break}return S};function lN(i,c,l,h){try{var S=Pe.getStreamFromFD(i),I=uN(S,c,l);return L[h>>2]=I,0}catch(A){if(typeof _>"u"||A.name!=="ErrnoError")throw A;return A.errno}}function fN(i,c,l,h,S){var I=bu(c,l);try{if(isNaN(I))return 61;var A=Pe.getStreamFromFD(i);return _.llseek(A,I,h),St=[A.position>>>0,(_e=A.position,+Math.abs(_e)>=1?_e>0?+Math.floor(_e/4294967296)>>>0:~~+Math.ceil((_e-+(~~_e>>>0))/4294967296)>>>0:0)],P[S>>2]=St[0],P[S+4>>2]=St[1],A.getdents&&I===0&&h===0&&(A.getdents=null),0}catch(F){if(typeof _>"u"||F.name!=="ErrnoError")throw F;return F.errno}}function dN(i){try{var c=Pe.getStreamFromFD(i);return c.stream_ops?.fsync?c.stream_ops.fsync(c):0}catch(l){if(typeof _>"u"||l.name!=="ErrnoError")throw l;return l.errno}}var hN=(i,c,l,h)=>{for(var S=0,I=0;I<l;I++){var A=L[c>>2],F=L[c+4>>2];c+=8;var U=_.write(i,q,A,F,h);if(U<0)return-1;if(S+=U,U<F)break}return S};function pN(i,c,l,h){try{var S=Pe.getStreamFromFD(i),I=hN(S,c,l);return L[h>>2]=I,0}catch(A){if(typeof _>"u"||A.name!=="ErrnoError")throw A;return A.errno}}var ze=function(){const i=typeof Asyncify=="object"?Asyncify.handleAsync.bind(Asyncify):null;r.handleAsync=i;const c=new Map;r.setCallback=(l,h)=>c.set(l,h),r.getCallback=l=>c.get(l),r.deleteCallback=l=>c.delete(l),ze=function(l,h,...S){const I=c.get(h);let A=null;const F=typeof I=="function"?I:I[A=Go(S.shift())];if(l){if(i)return i(()=>F.apply(I,S));throw new Error("Synchronous WebAssembly cannot call async function")}const U=F.apply(I,S);if(typeof U?.then=="function")throw console.error("unexpected Promise",F),new Error(`${A} unexpectedly returned a Promise`);return U}};function mN(...i){return ze(!1,...i)}function gN(...i){return ze(!0,...i)}function _N(...i){return ze(!1,...i)}function yN(...i){return ze(!0,...i)}function bN(...i){return ze(!1,...i)}function SN(...i){return ze(!0,...i)}function wN(...i){return ze(!1,...i)}function vN(...i){return ze(!0,...i)}function EN(...i){return ze(!1,...i)}function kN(...i){return ze(!0,...i)}function $N(...i){return ze(!1,...i)}function TN(...i){return ze(!0,...i)}function CN(...i){return ze(!1,...i)}function IN(...i){return ze(!0,...i)}function ON(...i){return ze(!1,...i)}function RN(...i){return ze(!0,...i)}function qN(...i){return ze(!1,...i)}function AN(...i){return ze(!0,...i)}function FN(...i){return ze(!1,...i)}function PN(...i){return ze(!0,...i)}function xN(...i){return ze(!1,...i)}function NN(...i){return ze(!0,...i)}function DN(...i){return ze(!1,...i)}function MN(...i){return ze(!0,...i)}function LN(...i){return ze(!1,...i)}function jN(...i){return ze(!0,...i)}function UN(...i){return ze(!1,...i)}function zN(...i){return ze(!0,...i)}function BN(...i){return ze(!1,...i)}function HN(...i){return ze(!0,...i)}function VN(...i){return ze(!1,...i)}function WN(...i){return ze(!0,...i)}var KN=i=>{R=i,m(i,new CE(i))},JN=(i,c)=>{R=i,KN(i)},GN=i=>{if(i instanceof CE||i=="unwind")return R;m(1,i)},PE=(i,c)=>{i<128?c.push(i):c.push(i%128|128,i>>7)},QN=i=>{for(var c={i:"i32",j:"i64",f:"f32",d:"f64",e:"externref",p:"i32"},l={parameters:[],results:i[0]=="v"?[]:[c[i[0]]]},h=1;h<i.length;++h)l.parameters.push(c[i[h]]);return l},YN=(i,c)=>{var l=i.slice(0,1),h=i.slice(1),S={i:127,p:127,j:126,f:125,d:124,e:111};c.push(96),PE(h.length,c);for(var I=0;I<h.length;++I)c.push(S[h[I]]);l=="v"?c.push(0):c.push(1,S[l])},XN=(i,c)=>{if(typeof WebAssembly.Function=="function")return new WebAssembly.Function(QN(c),i);var l=[1];YN(c,l);var h=[0,97,115,109,1,0,0,0,1];PE(l.length,h),h.push(...l),h.push(2,7,1,1,101,1,102,0,0,7,5,1,1,102,0,0);var S=new WebAssembly.Module(new Uint8Array(h)),I=new WebAssembly.Instance(S,{e:{f:i}}),A=I.exports.f;return A},ba,ZN=i=>ba.get(i),e2=(i,c)=>{if(Sa)for(var l=i;l<i+c;l++){var h=ZN(l);h&&Sa.set(h,l)}},Sa,t2=i=>(Sa||(Sa=new WeakMap,e2(0,ba.length)),Sa.get(i)||0),xE=[],n2=()=>{if(xE.length)return xE.pop();try{ba.grow(1)}catch(i){throw i instanceof RangeError?"Unable to grow wasm table. Set ALLOW_TABLE_GROWTH.":i}return ba.length-1},NE=(i,c)=>ba.set(i,c),r2=(i,c)=>{var l=t2(i);if(l)return l;var h=n2();try{NE(h,i)}catch(I){if(!(I instanceof TypeError))throw I;var S=XN(i,c);NE(h,S)}return Sa.set(i,h),h},DE=i=>{var c=r["_"+i];return c},ME=(i,c)=>{q.set(i,c)},LE=i=>VE(i),s2=i=>{var c=ya(i)+1,l=LE(c);return ao(i,l,c),l},co=(i,c,l,h,S)=>{var I={string:ce=>{var Tt=0;return ce!=null&&ce!==0&&(Tt=s2(ce)),Tt},array:ce=>{var Tt=LE(ce.length);return ME(ce,Tt),Tt}};function A(ce){return c==="string"?Go(ce):c==="boolean"?!!ce:ce}var F=DE(i),U=[],ee=0;if(h)for(var be=0;be<h.length;be++){var xe=I[l[be]];xe?(ee===0&&(ee=mx()),U[be]=xe(h[be])):U[be]=h[be]}var Oe=F(...U);function fe(ce){return ee!==0&&px(ee),A(ce)}return Oe=fe(Oe),Oe},o2=(i,c,l,h)=>{var S=!l||l.every(A=>A==="number"||A==="boolean"),I=c!=="string";return I&&S&&!h?DE(i):(...A)=>co(i,c,l,A)},i2=i=>BE(),a2=(i,c,l)=>{if(l??=2147483647,l<2)return 0;l-=2;for(var h=c,S=l<i.length*2?l/2:i.length,I=0;I<S;++I){var A=i.charCodeAt(I);D[c>>1]=A,c+=2}return D[c>>1]=0,c-h},c2=(i,c,l)=>{if(l??=2147483647,l<4)return 0;for(var h=c,S=h+l-4,I=0;I<i.length;++I){var A=i.charCodeAt(I);if(A>=55296&&A<=57343){var F=i.charCodeAt(++I);A=65536+((A&1023)<<10)|F&1023}if(P[c>>2]=A,c+=4,c+4>S)break}return P[c>>2]=0,c-h},u2=i=>{for(var c="";;){var l=x[i++];if(!l)return c;c+=String.fromCharCode(l)}},jE=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0,l2=(i,c)=>{for(var l=i,h=l>>1,S=h+c/2;!(h>=S)&&G[h];)++h;if(l=h<<1,l-i>32&&jE)return jE.decode(x.subarray(i,l));for(var I="",A=0;!(A>=c/2);++A){var F=D[i+A*2>>1];if(F==0)break;I+=String.fromCharCode(F)}return I},f2=(i,c)=>{for(var l=0,h="";!(l>=c/4);){var S=P[i+l*4>>2];if(S==0)break;if(++l,S>=65536){var I=S-65536;h+=String.fromCharCode(55296|I>>10,56320|I&1023)}else h+=String.fromCharCode(S)}return h};function d2(i){for(var c=[],l=0;l<i.length;l++){var h=i[l];h>255&&(h&=255),c.push(String.fromCharCode(h))}return c.join("")}_.createPreloadedFile=kx,_.staticInit(),ke.doesNotExistError=new _.ErrnoError(44),ke.doesNotExistError.stack="<generic error, no stack>",ze();var h2={a:gx,Y:Tx,$:Cx,Z:Ix,X:Ox,b:qx,W:Ax,y:Fx,Q:Px,U:xx,N:Nx,S:Dx,L:Mx,J:Lx,I:jx,V:Ux,G:zx,F:Bx,w:Jx,u:Gx,v:Qx,M:Yx,n:Xx,m:Zx,D:nN,O:oN,P:iN,o:aN,E:cN,K:lN,x:fN,R:dN,H:pN,s:mN,t:gN,ga:_N,ka:yN,i:bN,j:SN,c:wN,d:vN,ca:EN,da:kN,ea:$N,fa:TN,g:CN,h:IN,z:ON,A:RN,e:qN,f:AN,aa:FN,ba:PN,B:xN,C:NN,p:DN,q:MN,ha:LN,ia:jN,ja:UN,r:zN,k:BN,l:HN,T:VN,_:WN},T=hx();r._sqlite3_status64=(i,c,l,h)=>(r._sqlite3_status64=T.na)(i,c,l,h),r._sqlite3_status=(i,c,l,h)=>(r._sqlite3_status=T.oa)(i,c,l,h),r._sqlite3_db_status=(i,c,l,h,S)=>(r._sqlite3_db_status=T.pa)(i,c,l,h,S),r._sqlite3_msize=i=>(r._sqlite3_msize=T.qa)(i),r._sqlite3_vfs_find=i=>(r._sqlite3_vfs_find=T.ra)(i),r._sqlite3_vfs_register=(i,c)=>(r._sqlite3_vfs_register=T.sa)(i,c),r._sqlite3_vfs_unregister=i=>(r._sqlite3_vfs_unregister=T.ta)(i),r._sqlite3_release_memory=i=>(r._sqlite3_release_memory=T.ua)(i),r._sqlite3_soft_heap_limit64=(i,c)=>(r._sqlite3_soft_heap_limit64=T.va)(i,c),r._sqlite3_memory_used=()=>(r._sqlite3_memory_used=T.wa)(),r._sqlite3_hard_heap_limit64=(i,c)=>(r._sqlite3_hard_heap_limit64=T.xa)(i,c),r._sqlite3_memory_highwater=i=>(r._sqlite3_memory_highwater=T.ya)(i),r._sqlite3_malloc=i=>(r._sqlite3_malloc=T.za)(i),r._sqlite3_malloc64=(i,c)=>(r._sqlite3_malloc64=T.Aa)(i,c),r._sqlite3_free=i=>(r._sqlite3_free=T.Ba)(i),r._sqlite3_realloc=(i,c)=>(r._sqlite3_realloc=T.Ca)(i,c),r._sqlite3_realloc64=(i,c,l)=>(r._sqlite3_realloc64=T.Da)(i,c,l),r._sqlite3_str_vappendf=(i,c,l)=>(r._sqlite3_str_vappendf=T.Ea)(i,c,l),r._sqlite3_str_append=(i,c,l)=>(r._sqlite3_str_append=T.Fa)(i,c,l),r._sqlite3_str_appendchar=(i,c,l)=>(r._sqlite3_str_appendchar=T.Ga)(i,c,l),r._sqlite3_str_appendall=(i,c)=>(r._sqlite3_str_appendall=T.Ha)(i,c),r._sqlite3_str_appendf=(i,c,l)=>(r._sqlite3_str_appendf=T.Ia)(i,c,l),r._sqlite3_str_finish=i=>(r._sqlite3_str_finish=T.Ja)(i),r._sqlite3_str_errcode=i=>(r._sqlite3_str_errcode=T.Ka)(i),r._sqlite3_str_length=i=>(r._sqlite3_str_length=T.La)(i),r._sqlite3_str_value=i=>(r._sqlite3_str_value=T.Ma)(i),r._sqlite3_str_reset=i=>(r._sqlite3_str_reset=T.Na)(i),r._sqlite3_str_new=i=>(r._sqlite3_str_new=T.Oa)(i),r._sqlite3_vmprintf=(i,c)=>(r._sqlite3_vmprintf=T.Pa)(i,c),r._sqlite3_mprintf=(i,c)=>(r._sqlite3_mprintf=T.Qa)(i,c),r._sqlite3_vsnprintf=(i,c,l,h)=>(r._sqlite3_vsnprintf=T.Ra)(i,c,l,h),r._sqlite3_snprintf=(i,c,l,h)=>(r._sqlite3_snprintf=T.Sa)(i,c,l,h),r._sqlite3_log=(i,c,l)=>(r._sqlite3_log=T.Ta)(i,c,l),r._sqlite3_randomness=(i,c)=>(r._sqlite3_randomness=T.Ua)(i,c),r._sqlite3_stricmp=(i,c)=>(r._sqlite3_stricmp=T.Va)(i,c),r._sqlite3_strnicmp=(i,c,l)=>(r._sqlite3_strnicmp=T.Wa)(i,c,l),r._sqlite3_os_init=()=>(r._sqlite3_os_init=T.Xa)(),r._sqlite3_os_end=()=>(r._sqlite3_os_end=T.Ya)(),r._sqlite3_serialize=(i,c,l,h)=>(r._sqlite3_serialize=T.Za)(i,c,l,h),r._sqlite3_prepare_v2=(i,c,l,h,S)=>(r._sqlite3_prepare_v2=T._a)(i,c,l,h,S),r._sqlite3_step=i=>(r._sqlite3_step=T.$a)(i),r._sqlite3_column_int64=(i,c)=>(r._sqlite3_column_int64=T.ab)(i,c),r._sqlite3_reset=i=>(r._sqlite3_reset=T.bb)(i),r._sqlite3_exec=(i,c,l,h,S)=>(r._sqlite3_exec=T.cb)(i,c,l,h,S),r._sqlite3_column_int=(i,c)=>(r._sqlite3_column_int=T.db)(i,c),r._sqlite3_finalize=i=>(r._sqlite3_finalize=T.eb)(i),r._sqlite3_deserialize=(i,c,l,h,S,I,A,F)=>(r._sqlite3_deserialize=T.fb)(i,c,l,h,S,I,A,F),r._sqlite3_database_file_object=i=>(r._sqlite3_database_file_object=T.gb)(i),r._sqlite3_backup_init=(i,c,l,h)=>(r._sqlite3_backup_init=T.hb)(i,c,l,h),r._sqlite3_backup_step=(i,c)=>(r._sqlite3_backup_step=T.ib)(i,c),r._sqlite3_backup_finish=i=>(r._sqlite3_backup_finish=T.jb)(i),r._sqlite3_backup_remaining=i=>(r._sqlite3_backup_remaining=T.kb)(i),r._sqlite3_backup_pagecount=i=>(r._sqlite3_backup_pagecount=T.lb)(i),r._sqlite3_clear_bindings=i=>(r._sqlite3_clear_bindings=T.mb)(i),r._sqlite3_value_blob=i=>(r._sqlite3_value_blob=T.nb)(i),r._sqlite3_value_text=i=>(r._sqlite3_value_text=T.ob)(i),r._sqlite3_value_bytes=i=>(r._sqlite3_value_bytes=T.pb)(i),r._sqlite3_value_bytes16=i=>(r._sqlite3_value_bytes16=T.qb)(i),r._sqlite3_value_double=i=>(r._sqlite3_value_double=T.rb)(i),r._sqlite3_value_int=i=>(r._sqlite3_value_int=T.sb)(i),r._sqlite3_value_int64=i=>(r._sqlite3_value_int64=T.tb)(i),r._sqlite3_value_subtype=i=>(r._sqlite3_value_subtype=T.ub)(i),r._sqlite3_value_pointer=(i,c)=>(r._sqlite3_value_pointer=T.vb)(i,c),r._sqlite3_value_text16=i=>(r._sqlite3_value_text16=T.wb)(i),r._sqlite3_value_text16be=i=>(r._sqlite3_value_text16be=T.xb)(i),r._sqlite3_value_text16le=i=>(r._sqlite3_value_text16le=T.yb)(i),r._sqlite3_value_type=i=>(r._sqlite3_value_type=T.zb)(i),r._sqlite3_value_encoding=i=>(r._sqlite3_value_encoding=T.Ab)(i),r._sqlite3_value_nochange=i=>(r._sqlite3_value_nochange=T.Bb)(i),r._sqlite3_value_frombind=i=>(r._sqlite3_value_frombind=T.Cb)(i),r._sqlite3_value_dup=i=>(r._sqlite3_value_dup=T.Db)(i),r._sqlite3_value_free=i=>(r._sqlite3_value_free=T.Eb)(i),r._sqlite3_result_blob=(i,c,l,h)=>(r._sqlite3_result_blob=T.Fb)(i,c,l,h),r._sqlite3_result_blob64=(i,c,l,h,S)=>(r._sqlite3_result_blob64=T.Gb)(i,c,l,h,S),r._sqlite3_result_double=(i,c)=>(r._sqlite3_result_double=T.Hb)(i,c),r._sqlite3_result_error=(i,c,l)=>(r._sqlite3_result_error=T.Ib)(i,c,l),r._sqlite3_result_error16=(i,c,l)=>(r._sqlite3_result_error16=T.Jb)(i,c,l),r._sqlite3_result_int=(i,c)=>(r._sqlite3_result_int=T.Kb)(i,c),r._sqlite3_result_int64=(i,c,l)=>(r._sqlite3_result_int64=T.Lb)(i,c,l),r._sqlite3_result_null=i=>(r._sqlite3_result_null=T.Mb)(i),r._sqlite3_result_pointer=(i,c,l,h)=>(r._sqlite3_result_pointer=T.Nb)(i,c,l,h),r._sqlite3_result_subtype=(i,c)=>(r._sqlite3_result_subtype=T.Ob)(i,c),r._sqlite3_result_text=(i,c,l,h)=>(r._sqlite3_result_text=T.Pb)(i,c,l,h),r._sqlite3_result_text64=(i,c,l,h,S,I)=>(r._sqlite3_result_text64=T.Qb)(i,c,l,h,S,I),r._sqlite3_result_text16=(i,c,l,h)=>(r._sqlite3_result_text16=T.Rb)(i,c,l,h),r._sqlite3_result_text16be=(i,c,l,h)=>(r._sqlite3_result_text16be=T.Sb)(i,c,l,h),r._sqlite3_result_text16le=(i,c,l,h)=>(r._sqlite3_result_text16le=T.Tb)(i,c,l,h),r._sqlite3_result_value=(i,c)=>(r._sqlite3_result_value=T.Ub)(i,c),r._sqlite3_result_error_toobig=i=>(r._sqlite3_result_error_toobig=T.Vb)(i),r._sqlite3_result_zeroblob=(i,c)=>(r._sqlite3_result_zeroblob=T.Wb)(i,c),r._sqlite3_result_zeroblob64=(i,c,l)=>(r._sqlite3_result_zeroblob64=T.Xb)(i,c,l),r._sqlite3_result_error_code=(i,c)=>(r._sqlite3_result_error_code=T.Yb)(i,c),r._sqlite3_result_error_nomem=i=>(r._sqlite3_result_error_nomem=T.Zb)(i),r._sqlite3_user_data=i=>(r._sqlite3_user_data=T._b)(i),r._sqlite3_context_db_handle=i=>(r._sqlite3_context_db_handle=T.$b)(i),r._sqlite3_vtab_nochange=i=>(r._sqlite3_vtab_nochange=T.ac)(i),r._sqlite3_vtab_in_first=(i,c)=>(r._sqlite3_vtab_in_first=T.bc)(i,c),r._sqlite3_vtab_in_next=(i,c)=>(r._sqlite3_vtab_in_next=T.cc)(i,c),r._sqlite3_aggregate_context=(i,c)=>(r._sqlite3_aggregate_context=T.dc)(i,c),r._sqlite3_get_auxdata=(i,c)=>(r._sqlite3_get_auxdata=T.ec)(i,c),r._sqlite3_set_auxdata=(i,c,l,h)=>(r._sqlite3_set_auxdata=T.fc)(i,c,l,h),r._sqlite3_column_count=i=>(r._sqlite3_column_count=T.gc)(i),r._sqlite3_data_count=i=>(r._sqlite3_data_count=T.hc)(i),r._sqlite3_column_blob=(i,c)=>(r._sqlite3_column_blob=T.ic)(i,c),r._sqlite3_column_bytes=(i,c)=>(r._sqlite3_column_bytes=T.jc)(i,c),r._sqlite3_column_bytes16=(i,c)=>(r._sqlite3_column_bytes16=T.kc)(i,c),r._sqlite3_column_double=(i,c)=>(r._sqlite3_column_double=T.lc)(i,c),r._sqlite3_column_text=(i,c)=>(r._sqlite3_column_text=T.mc)(i,c),r._sqlite3_column_value=(i,c)=>(r._sqlite3_column_value=T.nc)(i,c),r._sqlite3_column_text16=(i,c)=>(r._sqlite3_column_text16=T.oc)(i,c),r._sqlite3_column_type=(i,c)=>(r._sqlite3_column_type=T.pc)(i,c),r._sqlite3_column_name=(i,c)=>(r._sqlite3_column_name=T.qc)(i,c),r._sqlite3_column_name16=(i,c)=>(r._sqlite3_column_name16=T.rc)(i,c),r._sqlite3_bind_blob=(i,c,l,h,S)=>(r._sqlite3_bind_blob=T.sc)(i,c,l,h,S),r._sqlite3_bind_blob64=(i,c,l,h,S,I)=>(r._sqlite3_bind_blob64=T.tc)(i,c,l,h,S,I),r._sqlite3_bind_double=(i,c,l)=>(r._sqlite3_bind_double=T.uc)(i,c,l),r._sqlite3_bind_int=(i,c,l)=>(r._sqlite3_bind_int=T.vc)(i,c,l),r._sqlite3_bind_int64=(i,c,l,h)=>(r._sqlite3_bind_int64=T.wc)(i,c,l,h),r._sqlite3_bind_null=(i,c)=>(r._sqlite3_bind_null=T.xc)(i,c),r._sqlite3_bind_pointer=(i,c,l,h,S)=>(r._sqlite3_bind_pointer=T.yc)(i,c,l,h,S),r._sqlite3_bind_text=(i,c,l,h,S)=>(r._sqlite3_bind_text=T.zc)(i,c,l,h,S),r._sqlite3_bind_text64=(i,c,l,h,S,I,A)=>(r._sqlite3_bind_text64=T.Ac)(i,c,l,h,S,I,A),r._sqlite3_bind_text16=(i,c,l,h,S)=>(r._sqlite3_bind_text16=T.Bc)(i,c,l,h,S),r._sqlite3_bind_value=(i,c,l)=>(r._sqlite3_bind_value=T.Cc)(i,c,l),r._sqlite3_bind_zeroblob=(i,c,l)=>(r._sqlite3_bind_zeroblob=T.Dc)(i,c,l),r._sqlite3_bind_zeroblob64=(i,c,l,h)=>(r._sqlite3_bind_zeroblob64=T.Ec)(i,c,l,h),r._sqlite3_bind_parameter_count=i=>(r._sqlite3_bind_parameter_count=T.Fc)(i),r._sqlite3_bind_parameter_name=(i,c)=>(r._sqlite3_bind_parameter_name=T.Gc)(i,c),r._sqlite3_bind_parameter_index=(i,c)=>(r._sqlite3_bind_parameter_index=T.Hc)(i,c),r._sqlite3_db_handle=i=>(r._sqlite3_db_handle=T.Ic)(i),r._sqlite3_stmt_readonly=i=>(r._sqlite3_stmt_readonly=T.Jc)(i),r._sqlite3_stmt_isexplain=i=>(r._sqlite3_stmt_isexplain=T.Kc)(i),r._sqlite3_stmt_explain=(i,c)=>(r._sqlite3_stmt_explain=T.Lc)(i,c),r._sqlite3_stmt_busy=i=>(r._sqlite3_stmt_busy=T.Mc)(i),r._sqlite3_next_stmt=(i,c)=>(r._sqlite3_next_stmt=T.Nc)(i,c),r._sqlite3_stmt_status=(i,c,l)=>(r._sqlite3_stmt_status=T.Oc)(i,c,l),r._sqlite3_sql=i=>(r._sqlite3_sql=T.Pc)(i),r._sqlite3_expanded_sql=i=>(r._sqlite3_expanded_sql=T.Qc)(i),r._sqlite3_value_numeric_type=i=>(r._sqlite3_value_numeric_type=T.Rc)(i),r._sqlite3_blob_open=(i,c,l,h,S,I,A,F)=>(r._sqlite3_blob_open=T.Sc)(i,c,l,h,S,I,A,F),r._sqlite3_blob_close=i=>(r._sqlite3_blob_close=T.Tc)(i),r._sqlite3_blob_read=(i,c,l,h)=>(r._sqlite3_blob_read=T.Uc)(i,c,l,h),r._sqlite3_blob_write=(i,c,l,h)=>(r._sqlite3_blob_write=T.Vc)(i,c,l,h),r._sqlite3_blob_bytes=i=>(r._sqlite3_blob_bytes=T.Wc)(i),r._sqlite3_blob_reopen=(i,c,l)=>(r._sqlite3_blob_reopen=T.Xc)(i,c,l),r._sqlite3_set_authorizer=(i,c,l)=>(r._sqlite3_set_authorizer=T.Yc)(i,c,l),r._sqlite3_strglob=(i,c)=>(r._sqlite3_strglob=T.Zc)(i,c),r._sqlite3_strlike=(i,c,l)=>(r._sqlite3_strlike=T._c)(i,c,l),r._sqlite3_errmsg=i=>(r._sqlite3_errmsg=T.$c)(i),r._sqlite3_auto_extension=i=>(r._sqlite3_auto_extension=T.ad)(i),r._sqlite3_cancel_auto_extension=i=>(r._sqlite3_cancel_auto_extension=T.bd)(i),r._sqlite3_reset_auto_extension=()=>(r._sqlite3_reset_auto_extension=T.cd)(),r._sqlite3_prepare=(i,c,l,h,S)=>(r._sqlite3_prepare=T.dd)(i,c,l,h,S),r._sqlite3_prepare_v3=(i,c,l,h,S,I)=>(r._sqlite3_prepare_v3=T.ed)(i,c,l,h,S,I),r._sqlite3_prepare16=(i,c,l,h,S)=>(r._sqlite3_prepare16=T.fd)(i,c,l,h,S),r._sqlite3_prepare16_v2=(i,c,l,h,S)=>(r._sqlite3_prepare16_v2=T.gd)(i,c,l,h,S),r._sqlite3_prepare16_v3=(i,c,l,h,S,I)=>(r._sqlite3_prepare16_v3=T.hd)(i,c,l,h,S,I),r._sqlite3_get_table=(i,c,l,h,S,I)=>(r._sqlite3_get_table=T.id)(i,c,l,h,S,I),r._sqlite3_free_table=i=>(r._sqlite3_free_table=T.jd)(i),r._sqlite3_create_module=(i,c,l,h)=>(r._sqlite3_create_module=T.kd)(i,c,l,h),r._sqlite3_create_module_v2=(i,c,l,h,S)=>(r._sqlite3_create_module_v2=T.ld)(i,c,l,h,S),r._sqlite3_drop_modules=(i,c)=>(r._sqlite3_drop_modules=T.md)(i,c),r._sqlite3_declare_vtab=(i,c)=>(r._sqlite3_declare_vtab=T.nd)(i,c),r._sqlite3_vtab_on_conflict=i=>(r._sqlite3_vtab_on_conflict=T.od)(i),r._sqlite3_vtab_config=(i,c,l)=>(r._sqlite3_vtab_config=T.pd)(i,c,l),r._sqlite3_vtab_collation=(i,c)=>(r._sqlite3_vtab_collation=T.qd)(i,c),r._sqlite3_vtab_in=(i,c,l)=>(r._sqlite3_vtab_in=T.rd)(i,c,l),r._sqlite3_vtab_rhs_value=(i,c,l)=>(r._sqlite3_vtab_rhs_value=T.sd)(i,c,l),r._sqlite3_vtab_distinct=i=>(r._sqlite3_vtab_distinct=T.td)(i),r._sqlite3_keyword_name=(i,c,l)=>(r._sqlite3_keyword_name=T.ud)(i,c,l),r._sqlite3_keyword_count=()=>(r._sqlite3_keyword_count=T.vd)(),r._sqlite3_keyword_check=(i,c)=>(r._sqlite3_keyword_check=T.wd)(i,c),r._sqlite3_complete=i=>(r._sqlite3_complete=T.xd)(i),r._sqlite3_complete16=i=>(r._sqlite3_complete16=T.yd)(i),r._sqlite3_libversion=()=>(r._sqlite3_libversion=T.zd)(),r._sqlite3_libversion_number=()=>(r._sqlite3_libversion_number=T.Ad)(),r._sqlite3_threadsafe=()=>(r._sqlite3_threadsafe=T.Bd)(),r._sqlite3_initialize=()=>(r._sqlite3_initialize=T.Cd)(),r._sqlite3_shutdown=()=>(r._sqlite3_shutdown=T.Dd)(),r._sqlite3_config=(i,c)=>(r._sqlite3_config=T.Ed)(i,c),r._sqlite3_db_mutex=i=>(r._sqlite3_db_mutex=T.Fd)(i),r._sqlite3_db_release_memory=i=>(r._sqlite3_db_release_memory=T.Gd)(i),r._sqlite3_db_cacheflush=i=>(r._sqlite3_db_cacheflush=T.Hd)(i),r._sqlite3_db_config=(i,c,l)=>(r._sqlite3_db_config=T.Id)(i,c,l),r._sqlite3_last_insert_rowid=i=>(r._sqlite3_last_insert_rowid=T.Jd)(i),r._sqlite3_set_last_insert_rowid=(i,c,l)=>(r._sqlite3_set_last_insert_rowid=T.Kd)(i,c,l),r._sqlite3_changes64=i=>(r._sqlite3_changes64=T.Ld)(i),r._sqlite3_changes=i=>(r._sqlite3_changes=T.Md)(i),r._sqlite3_total_changes64=i=>(r._sqlite3_total_changes64=T.Nd)(i),r._sqlite3_total_changes=i=>(r._sqlite3_total_changes=T.Od)(i),r._sqlite3_txn_state=(i,c)=>(r._sqlite3_txn_state=T.Pd)(i,c),r._sqlite3_close=i=>(r._sqlite3_close=T.Qd)(i),r._sqlite3_close_v2=i=>(r._sqlite3_close_v2=T.Rd)(i),r._sqlite3_busy_handler=(i,c,l)=>(r._sqlite3_busy_handler=T.Sd)(i,c,l),r._sqlite3_progress_handler=(i,c,l,h)=>(r._sqlite3_progress_handler=T.Td)(i,c,l,h),r._sqlite3_busy_timeout=(i,c)=>(r._sqlite3_busy_timeout=T.Ud)(i,c),r._sqlite3_interrupt=i=>(r._sqlite3_interrupt=T.Vd)(i),r._sqlite3_is_interrupted=i=>(r._sqlite3_is_interrupted=T.Wd)(i),r._sqlite3_create_function=(i,c,l,h,S,I,A,F)=>(r._sqlite3_create_function=T.Xd)(i,c,l,h,S,I,A,F),r._sqlite3_create_function_v2=(i,c,l,h,S,I,A,F,U)=>(r._sqlite3_create_function_v2=T.Yd)(i,c,l,h,S,I,A,F,U),r._sqlite3_create_window_function=(i,c,l,h,S,I,A,F,U,ee)=>(r._sqlite3_create_window_function=T.Zd)(i,c,l,h,S,I,A,F,U,ee),r._sqlite3_create_function16=(i,c,l,h,S,I,A,F)=>(r._sqlite3_create_function16=T._d)(i,c,l,h,S,I,A,F),r._sqlite3_overload_function=(i,c,l)=>(r._sqlite3_overload_function=T.$d)(i,c,l),r._sqlite3_trace_v2=(i,c,l,h)=>(r._sqlite3_trace_v2=T.ae)(i,c,l,h),r._sqlite3_commit_hook=(i,c,l)=>(r._sqlite3_commit_hook=T.be)(i,c,l),r._sqlite3_update_hook=(i,c,l)=>(r._sqlite3_update_hook=T.ce)(i,c,l),r._sqlite3_rollback_hook=(i,c,l)=>(r._sqlite3_rollback_hook=T.de)(i,c,l),r._sqlite3_autovacuum_pages=(i,c,l,h)=>(r._sqlite3_autovacuum_pages=T.ee)(i,c,l,h),r._sqlite3_wal_autocheckpoint=(i,c)=>(r._sqlite3_wal_autocheckpoint=T.fe)(i,c),r._sqlite3_wal_hook=(i,c,l)=>(r._sqlite3_wal_hook=T.ge)(i,c,l),r._sqlite3_wal_checkpoint_v2=(i,c,l,h,S)=>(r._sqlite3_wal_checkpoint_v2=T.he)(i,c,l,h,S),r._sqlite3_wal_checkpoint=(i,c)=>(r._sqlite3_wal_checkpoint=T.ie)(i,c),r._sqlite3_error_offset=i=>(r._sqlite3_error_offset=T.je)(i),r._sqlite3_errmsg16=i=>(r._sqlite3_errmsg16=T.ke)(i),r._sqlite3_errcode=i=>(r._sqlite3_errcode=T.le)(i),r._sqlite3_extended_errcode=i=>(r._sqlite3_extended_errcode=T.me)(i),r._sqlite3_system_errno=i=>(r._sqlite3_system_errno=T.ne)(i),r._sqlite3_errstr=i=>(r._sqlite3_errstr=T.oe)(i),r._sqlite3_limit=(i,c,l)=>(r._sqlite3_limit=T.pe)(i,c,l),r._sqlite3_open=(i,c)=>(r._sqlite3_open=T.qe)(i,c),r._sqlite3_open_v2=(i,c,l,h)=>(r._sqlite3_open_v2=T.re)(i,c,l,h),r._sqlite3_open16=(i,c)=>(r._sqlite3_open16=T.se)(i,c),r._sqlite3_create_collation=(i,c,l,h,S)=>(r._sqlite3_create_collation=T.te)(i,c,l,h,S),r._sqlite3_create_collation_v2=(i,c,l,h,S,I)=>(r._sqlite3_create_collation_v2=T.ue)(i,c,l,h,S,I),r._sqlite3_create_collation16=(i,c,l,h,S)=>(r._sqlite3_create_collation16=T.ve)(i,c,l,h,S),r._sqlite3_collation_needed=(i,c,l)=>(r._sqlite3_collation_needed=T.we)(i,c,l),r._sqlite3_collation_needed16=(i,c,l)=>(r._sqlite3_collation_needed16=T.xe)(i,c,l),r._sqlite3_get_clientdata=(i,c)=>(r._sqlite3_get_clientdata=T.ye)(i,c),r._sqlite3_set_clientdata=(i,c,l,h)=>(r._sqlite3_set_clientdata=T.ze)(i,c,l,h),r._sqlite3_get_autocommit=i=>(r._sqlite3_get_autocommit=T.Ae)(i),r._sqlite3_table_column_metadata=(i,c,l,h,S,I,A,F,U)=>(r._sqlite3_table_column_metadata=T.Be)(i,c,l,h,S,I,A,F,U),r._sqlite3_sleep=i=>(r._sqlite3_sleep=T.Ce)(i),r._sqlite3_extended_result_codes=(i,c)=>(r._sqlite3_extended_result_codes=T.De)(i,c),r._sqlite3_file_control=(i,c,l,h)=>(r._sqlite3_file_control=T.Ee)(i,c,l,h),r._sqlite3_test_control=(i,c)=>(r._sqlite3_test_control=T.Fe)(i,c),r._sqlite3_create_filename=(i,c,l,h,S)=>(r._sqlite3_create_filename=T.Ge)(i,c,l,h,S),r._sqlite3_free_filename=i=>(r._sqlite3_free_filename=T.He)(i),r._sqlite3_uri_parameter=(i,c)=>(r._sqlite3_uri_parameter=T.Ie)(i,c),r._sqlite3_uri_key=(i,c)=>(r._sqlite3_uri_key=T.Je)(i,c),r._sqlite3_uri_boolean=(i,c,l)=>(r._sqlite3_uri_boolean=T.Ke)(i,c,l),r._sqlite3_uri_int64=(i,c,l,h)=>(r._sqlite3_uri_int64=T.Le)(i,c,l,h),r._sqlite3_filename_database=i=>(r._sqlite3_filename_database=T.Me)(i),r._sqlite3_filename_journal=i=>(r._sqlite3_filename_journal=T.Ne)(i),r._sqlite3_filename_wal=i=>(r._sqlite3_filename_wal=T.Oe)(i),r._sqlite3_db_name=(i,c)=>(r._sqlite3_db_name=T.Pe)(i,c),r._sqlite3_db_filename=(i,c)=>(r._sqlite3_db_filename=T.Qe)(i,c),r._sqlite3_db_readonly=(i,c)=>(r._sqlite3_db_readonly=T.Re)(i,c),r._sqlite3_compileoption_used=i=>(r._sqlite3_compileoption_used=T.Se)(i),r._sqlite3_compileoption_get=i=>(r._sqlite3_compileoption_get=T.Te)(i),r._sqlite3session_create=(i,c,l)=>(r._sqlite3session_create=T.Ue)(i,c,l),r._sqlite3session_delete=i=>(r._sqlite3session_delete=T.Ve)(i),r._sqlite3session_attach=(i,c)=>(r._sqlite3session_attach=T.We)(i,c),r._sqlite3session_changeset=(i,c,l)=>(r._sqlite3session_changeset=T.Xe)(i,c,l),r._sqlite3session_enable=(i,c)=>(r._sqlite3session_enable=T.Ye)(i,c),r._sqlite3changeset_start=(i,c,l)=>(r._sqlite3changeset_start=T.Ze)(i,c,l),r._sqlite3changeset_finalize=i=>(r._sqlite3changeset_finalize=T._e)(i),r._sqlite3changeset_invert=(i,c,l,h)=>(r._sqlite3changeset_invert=T.$e)(i,c,l,h),r._sqlite3changeset_apply=(i,c,l,h,S,I)=>(r._sqlite3changeset_apply=T.af)(i,c,l,h,S,I),r._sqlite3_sourceid=()=>(r._sqlite3_sourceid=T.bf)(),r._malloc=i=>(r._malloc=T.cf)(i),r._free=i=>(r._free=T.df)(i),r._RegisterExtensionFunctions=i=>(r._RegisterExtensionFunctions=T.ef)(i),r._getSqliteFree=()=>(r._getSqliteFree=T.ff)();var UE=r._main=(i,c)=>(UE=r._main=T.gf)(i,c);r._libauthorizer_set_authorizer=(i,c,l)=>(r._libauthorizer_set_authorizer=T.hf)(i,c,l),r._libfunction_create_function=(i,c,l,h,S,I,A,F)=>(r._libfunction_create_function=T.jf)(i,c,l,h,S,I,A,F),r._libhook_commit_hook=(i,c,l)=>(r._libhook_commit_hook=T.kf)(i,c,l),r._libhook_update_hook=(i,c,l)=>(r._libhook_update_hook=T.lf)(i,c,l),r._libprogress_progress_handler=(i,c,l,h)=>(r._libprogress_progress_handler=T.mf)(i,c,l,h),r._libvfs_vfs_register=(i,c,l,h,S,I)=>(r._libvfs_vfs_register=T.nf)(i,c,l,h,S,I);var zE=(i,c)=>(zE=T.pf)(i,c),BE=()=>(BE=T.qf)(),HE=i=>(HE=T.rf)(i),VE=i=>(VE=T.sf)(i),WE=()=>(WE=T.tf)();r._sqlite3_version=5472,r.getTempRet0=i2,r.ccall=co,r.cwrap=o2,r.addFunction=r2,r.setValue=ga,r.getValue=IE,r.UTF8ToString=Go,r.stringToUTF8=ao,r.lengthBytesUTF8=ya,r.intArrayFromString=Wg,r.intArrayToString=d2,r.AsciiToString=u2,r.UTF16ToString=l2,r.stringToUTF16=a2,r.UTF32ToString=f2,r.stringToUTF32=c2,r.writeArrayToMemory=ME;var hd;Jo=function i(){hd||KE(),hd||(Jo=i)};function p2(){var i=UE,c=0,l=0;try{var h=i(c,l);return JN(h,!0),h}catch(S){return GN(S)}}function KE(){if(En>0||(et(),En>0))return;function i(){hd||(hd=!0,r.calledRun=!0,!k&&(vn(),Vn(),s(r),r.onRuntimeInitialized?.(),JE&&p2(),Ug()))}r.setStatus?(r.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>r.setStatus(""),1),i()},1)):i()}if(r.preInit)for(typeof r.preInit=="function"&&(r.preInit=[r.preInit]);r.preInit.length>0;)r.preInit.pop()();var JE=!0;return r.noInitialRun&&(JE=!1),KE(),function(){const i=Object.getPrototypeOf(async function(){}).constructor;let c=0;r.set_authorizer=function(l,h,S){c&&(r.deleteCallback(c),r._sqlite3_free(c),c=0),c=r._sqlite3_malloc(4),ga(c,h instanceof i?1:0,"i32");const I=co("libauthorizer_set_authorizer","number",["number","number","number"],[l,h?1:0,c]);return!I&&h&&r.setCallback(c,(A,F,U,ee,be,xe)=>h(S,F,U,ee,be,xe)),I}}(),function(){const i=Object.getPrototypeOf(async function(){}).constructor,c=["xFunc","xStep","xFinal"],l=new Map;r.create_function=function(h,S,I,A,F,U,ee,be){const xe=r._sqlite3_malloc(4),Oe={xFunc:U,xStep:ee,xFinal:be};ga(xe,c.reduce((ce,Tt,Wn)=>Oe[Tt]instanceof i?ce|1<<Wn:ce,0),"i32");const fe=co("libfunction_create_function","number",["number","string","number","number","number","number","number","number"],[h,S,I,A,xe,U?1:0,ee?1:0,be?1:0]);if(!fe){if(l.has(S)){const ce=l.get(S);r.deleteCallback(ce)}l.set(S,xe),r.setCallback(xe,{xFunc:U,xStep:ee,xFinal:be})}return fe}}(),function(){const i=Object.getPrototypeOf(async function(){}).constructor;let c=0;r.update_hook=function(l,h){c&&(r.deleteCallback(c),r._sqlite3_free(c),c=0),c=r._sqlite3_malloc(4),ga(c,h instanceof i?1:0,"i32"),co("libhook_update_hook","void",["number","number","number"],[l,h?1:0,c]),h&&r.setCallback(c,(S,I,A,F,U,ee)=>h(I,A,F,U,ee))}}(),function(){const i=Object.getPrototypeOf(async function(){}).constructor;let c=0;r.commit_hook=function(l,h){c&&(r.deleteCallback(c),r._sqlite3_free(c),c=0),c=r._sqlite3_malloc(4),ga(c,h instanceof i?1:0,"i32"),co("libhook_commit_hook","void",["number","number","number"],[l,h?1:0,c]),h&&r.setCallback(c,S=>h())}}(),function(){const i=Object.getPrototypeOf(async function(){}).constructor;let c=0;r.progress_handler=function(l,h,S,I){c&&(r.deleteCallback(c),r._sqlite3_free(c),c=0),c=r._sqlite3_malloc(4),ga(c,S instanceof i?1:0,"i32"),co("libprogress_progress_handler","number",["number","number","number","number"],[l,h,S?1:0,c]),S&&r.setCallback(c,A=>S(I))}}(),function(){const i=["xOpen","xDelete","xAccess","xFullPathname","xRandomness","xSleep","xCurrentTime","xGetLastError","xCurrentTimeInt64","xClose","xRead","xWrite","xTruncate","xSync","xFileSize","xLock","xUnlock","xCheckReservedLock","xFileControl","xSectorSize","xDeviceCharacteristics","xShmMap","xShmLock","xShmBarrier","xShmUnmap"],c=new Map;r.vfs_register=function(l,h){let S=0,I=0;i.forEach((F,U)=>{l[F]&&(S|=1<<U,l.hasAsyncMethod(F)&&(I|=1<<U))});const A=r._sqlite3_malloc(4);try{const F=co("libvfs_vfs_register","number",["string","number","number","number","number","number"],[l.name,l.mxPathname,S,I,h?1:0,A]);if(!F){if(c.has(l.name)){const ee=c.get(l.name);r.deleteCallback(ee)}const U=IE(A,"*");c.set(l.name,U),r.setCallback(U,l)}return F}finally{r._sqlite3_free(A)}}}(),n=a,n}})();const bse=async()=>{const e=await yse(),t=_se(e);return t.module=e,t},vE=typeof navigator>"u"||navigator.storage===void 0?new Proxy({},{get:()=>Promise.reject(new Error("Can't get OPFS root handle in this environment as navigator.storage is undefined"))}):navigator.storage.getDirectory(),Sse=async e=>{const t=await vE;if(e===void 0)return t;let n=t;const r=e?.split("/").filter(Boolean);for(;r.length>0;)n=await n.getDirectoryHandle(r.shift());return n},ix=async(e=vE,t=Number.POSITIVE_INFINITY,n="")=>{if(t<0)return;const r=await e,s=r.values();for await(const o of s){const a=o.kind==="directory",u=o.kind==="file"?await o.getFile().then(f=>vee(f.size)):void 0;if(console.log(`${n}${a?"📁":"📄"} ${o.name} ${u?`(${u})`:""}`),a){const f=await r.getDirectoryHandle(o.name);await ix(f,t-1,`${n}  `)}}},wse=async e=>{if(e.kind==="directory")for await(const t of e.keys())await e.removeEntry(t,{recursive:!0})};var vse=Object.freeze({__proto__:null,deleteAll:wse,getDirHandle:Sse,printTree:ix,rootHandlePromise:vE});class voe extends Lr()("PersistedSqliteError",{cause:Ac}){}const Ese=(e,t)=>{if(e===void 0||e===""||e==="/")return`livestore-${t}@${Q$}`;if(e.includes("/"))throw new Error(`@livestore/adapter-web:worker:sanitizeOpfsDir: Nested directories are not yet supported ('${e}')`);return`${e}@${Q$}`},kse=e=>`state${e.state.sqlite.migrations.strategy==="manual"?"fixed":e.state.sqlite.hash.toString()}.db`,$se=e=>Dte({channelName:`livestore.shutdown.${e}`,schema:vre}),Tse=ne({type:Ne("opfs"),directory:Sn(j)}),Cse=ve(Tse);mu({key:j,value:Po});var Lb;(function(e){class t extends $n()("InitialMessage",{payload:{port:Fg,storeId:j,clientId:j},success:Xr,failure:Re}){}e.InitialMessage=t;class n extends ve(t){}e.Request=n})(Lb||(Lb={}));var Pn;(function(e){class t extends $n()("InitialMessage",{payload:{storageOptions:Cse,devtoolsEnabled:Xi,storeId:j,clientId:j,debugInstanceId:j,syncPayload:Rv(Po)},success:Xr,failure:Re}){}e.InitialMessage=t;class n extends $n()("BootStatusStream",{payload:{},success:one,failure:Re}){}e.BootStatusStream=n;class r extends $n()("PushToLeader",{payload:{batch:De(Mne)},success:Xr,failure:ve(Re,fE)}){}e.PushToLeader=r;class s extends $n()("PullStream",{payload:{cursor:sne},success:ne({payload:vP,mergeCounter:dt}),failure:Re}){}e.PullStream=s;class o extends $n()("Export",{payload:{},success:sc,failure:Re}){}e.Export=o;class a extends $n()("ExportEventlog",{payload:{},success:sc,failure:Re}){}e.ExportEventlog=a;class u extends $n()("GetRecreateSnapshot",{payload:{},success:ne({snapshot:sc,migrationsReport:ane}),failure:Re}){}e.GetRecreateSnapshot=u;class f extends $n()("GetLeaderHead",{payload:{},success:mn,failure:Re}){}e.GetLeaderHead=f;class d extends $n()("GetLeaderSyncState",{payload:{},success:Gr,failure:Re}){}e.GetLeaderSyncState=d;class p extends $n()("Shutdown",{payload:{},success:Xr,failure:Re}){}e.Shutdown=p;class m extends $n()("ExtraDevtoolsMessage",{payload:{message:jP},success:Xr,failure:Re}){}e.ExtraDevtoolsMessage=m,e.Request=ve(t,n,r,s,o,a,u,f,d,p,m,_E)})(Pn||(Pn={}));var dT;(function(e){class t extends Fe("FromClientSession",{initialMessage:Pn.InitialMessage}){}e.InitialMessagePayloadFromClientSession=t;class n extends $n()("InitialMessage",{payload:{payload:ve(t,Fe("FromWebBridge",{})),liveStoreVersion:Ne(Lg)},success:Xr,failure:Re}){}e.InitialMessage=n;class r extends $n()("UpdateMessagePort",{payload:{port:Fg},success:Xr,failure:Re}){}e.UpdateMessagePort=r;class s extends ve(n,r,Pn.BootStatusStream,Pn.PushToLeader,Pn.PullStream,Pn.Export,Pn.GetRecreateSnapshot,Pn.ExportEventlog,Pn.GetLeaderHead,Pn.GetLeaderSyncState,Pn.Shutdown,Pn.ExtraDevtoolsMessage,_E){}e.Request=s})(dT||(dT={}));RF()&&(globalThis.__debugLiveStoreUtils={opfs:vse,blobUrl:e=>URL.createObjectURL(new Blob([e],{type:"application/octet-stream"})),runSync:e=>rs(e),runFork:e=>Ho(e)});const Ise=e=>{Ose(e).pipe(Ho)},Ose=e=>{const t=e.otelOptions?.tracer?XR(ye(gee,ZR)).pipe(YR(Jw(_ee,e.otelOptions.tracer))):void 0;return Rse(e).pipe(Gw(Bte),sP,Qi,Et,Ya({thread:self.name}),qn(IZ(self.name)),qn($te),Qs?Lte(n=>console.createTask(n)):oe,t?qn(t):oe,t8(Vte()),n8(4096),dY(YS))},Rse=e=>rP(Lb.InitialMessage,{InitialMessage:({port:t,storeId:n,clientId:r})=>z(function*(){return yield*qse(e).pipe(Gw(Hte(t)),sP,Qi,Te("@livestore/adapter-web:worker:wrapper:InitialMessage:innerFiber"),Et,qn(ad.layer({nodeName:lre.client.leader({storeId:n,clientId:r})})),Bt),O8}).pipe(Te("@livestore/adapter-web:worker:wrapper:InitialMessage"),Qw)}),qse=({schema:e,sync:t})=>rP(Pn.Request,{InitialMessage:({storageOptions:n,storeId:r,clientId:s,devtoolsEnabled:o,debugInstanceId:a,syncPayload:u})=>z(function*(){const f=yield*Jm(()=>bse()),d=gse({sqlite3:f}),p=yield*Bo(),m=v=>d({_tag:"opfs",opfsDirectory:Ese(n.directory,r),fileName:v==="state"?kse(e):"eventlog.db",configureDb:w=>GP(w,{foreignKeys:!0}).pipe(qn(p),rs)}).pipe(it(w=>zo(()=>w.close()).pipe(zf))),[$,C]=yield*Uf([m("state"),m("eventlog")],{concurrency:2}),O=yield*Ase({devtoolsEnabled:o,dbState:$,dbEventlog:C}),N=yield*$se(r);return Kre({schema:e,storeId:r,clientId:s,makeSqliteDb:d,syncOptions:t,dbState:$,dbEventlog:C,devtoolsOptions:O,shutdownChannel:N,syncPayload:u})}).pipe(Et,Re.mapToUnexpectedError,Xv("@livestore/adapter-web:worker:InitialMessage"),Te("@livestore/adapter-web:worker:InitialMessage"),p8({debugInstanceId:a}),Qw),GetRecreateSnapshot:()=>z(function*(){const n=yield*xt;return{snapshot:n.dbState.export(),migrationsReport:n.initialState.migrationsReport}}).pipe(Re.mapToUnexpectedError,Te("@livestore/adapter-web:worker:GetRecreateSnapshot")),PullStream:({cursor:n})=>z(function*(){const{syncProcessor:r}=yield*xt;return r.pull({cursor:n})}).pipe(CF),PushToLeader:({batch:n})=>Jr(xt,({syncProcessor:r})=>r.push(n.map(s=>new gn(s)),{waitForProcessing:!0})).pipe(mo,Te("@livestore/adapter-web:worker:PushToLeader")),Export:()=>Jr(xt,n=>n.dbState.export()).pipe(Re.mapToUnexpectedError,Te("@livestore/adapter-web:worker:Export")),ExportEventlog:()=>Jr(xt,n=>n.dbEventlog.export()).pipe(Re.mapToUnexpectedError,Te("@livestore/adapter-web:worker:ExportEventlog")),BootStatusStream:()=>Jr(xt,n=>Gs(n.bootStatusQueue)).pipe(dZ),GetLeaderHead:()=>z(function*(){const n=yield*xt;return XP(n.dbEventlog)}).pipe(Re.mapToUnexpectedError,Te("@livestore/adapter-web:worker:GetLeaderHead")),GetLeaderSyncState:()=>z(function*(){return yield*(yield*xt).syncProcessor.syncState}).pipe(Re.mapToUnexpectedError,Te("@livestore/adapter-web:worker:GetLeaderSyncState")),Shutdown:()=>z(function*(){yield*Vr("[@livestore/adapter-web:worker] Shutdown"),yield*Ym(300)}).pipe(Re.mapToUnexpectedError,Te("@livestore/adapter-web:worker:Shutdown")),ExtraDevtoolsMessage:({message:n})=>Jr(xt,r=>r.extraIncomingMessagesQueue.offer(n)).pipe(Re.mapToUnexpectedError,Te("@livestore/adapter-web:worker:ExtraDevtoolsMessage")),"DevtoolsWebCommon.CreateConnection":Qre}),Ase=({devtoolsEnabled:e,dbState:t,dbEventlog:n})=>z(function*(){if(e===!1)return{enabled:!1};const{node:r}=yield*ad;return{enabled:!0,boot:z(function*(){const s={state:t.metadata.persistenceInfo,eventlog:n.metadata.persistenceInfo};return{node:r,persistenceInfo:s,mode:"direct"}})}}),ci={todos:Ko({name:"todos",columns:{id:K$({primaryKey:!0}),text:K$({default:""}),completed:hne({default:!1}),deletedAt:pne({nullable:!0,schema:gX})}}),uiState:qne({name:"uiState",schema:ne({newTodoText:j,filter:Ne("all","active","completed")}),default:{id:yp,value:{newTodoText:"",filter:"all"}}})},ax={todoCreated:Au({name:"v1.TodoCreated",schema:ne({id:j,text:j})}),todoCompleted:Au({name:"v1.TodoCompleted",schema:ne({id:j})}),todoUncompleted:Au({name:"v1.TodoUncompleted",schema:ne({id:j})}),todoDeleted:Au({name:"v1.TodoDeleted",schema:ne({id:j,deletedAt:mb})}),todoClearedCompleted:Au({name:"v1.TodoClearedCompleted",schema:ne({deletedAt:mb})}),uiStateSet:ci.uiState.set},Fse=One(ax,{"v1.TodoCreated":({id:e,text:t})=>ci.todos.insert({id:e,text:t,completed:!1}),"v1.TodoCompleted":({id:e})=>ci.todos.update({completed:!0}).where({id:e}),"v1.TodoUncompleted":({id:e})=>ci.todos.update({completed:!1}).where({id:e}),"v1.TodoDeleted":({id:e,deletedAt:t})=>ci.todos.update({deletedAt:t}).where({id:e}),"v1.TodoClearedCompleted":({deletedAt:e})=>ci.todos.update({deletedAt:e}).where({completed:!0})}),Pse=Dne({tables:ci,materializers:Fse}),xse=Nne({events:ax,state:Pse});Ise({schema:xse});
